{"version":3,"file":"605.js?_cache=952831a20fa6704127df","mappings":"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","sources":["webpack://grafana-metricsdrilldown-app/./shared/user-preferences/pref-keys.ts","webpack://grafana-metricsdrilldown-app/./App/useCatchExceptions.ts","webpack://grafana-metricsdrilldown-app/./shared/services/levels.ts","webpack://grafana-metricsdrilldown-app/./shared/services/sorting.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/helpers/displayStatus.ts","webpack://grafana-metricsdrilldown-app/./App/ErrorView.tsx","webpack://grafana-metricsdrilldown-app/./shared/utils/utils.feature-toggles.ts","webpack://grafana-metricsdrilldown-app/./shared/user-preferences/userStorage.ts","webpack://grafana-metricsdrilldown-app/./shared/tracking/interactions.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/helpers/localCompare.ts","webpack://grafana-metricsdrilldown-app/./App/InlineBanner.tsx","webpack://grafana-metricsdrilldown-app/./App/AppContext.tsx","webpack://grafana-metricsdrilldown-app/./App/Routes.tsx","webpack://grafana-metricsdrilldown-app/./AppDataTrail/header/GiveFeedbackButton.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/components/SceneDrawer.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/helpers/areArraysEqual.ts","webpack://grafana-metricsdrilldown-app/./shared/shared.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/AdHocFiltersForMetricsVariable.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/events/EventMetricsVariableActivated.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/events/EventMetricsVariableDeactivated.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/events/EventMetricsVariableLoaded.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/withLifecycleEvents.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/MetricsVariable.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/matchers/isClassicHistogramMetric.ts","webpack://grafana-metricsdrilldown-app/./AppDataTrail/MetricDatasourceHelper/types/language-provider/versionCheck.ts","webpack://grafana-metricsdrilldown-app/./AppDataTrail/MetricDatasourceHelper/types/language-provider/v11-6-x.ts","webpack://grafana-metricsdrilldown-app/./AppDataTrail/MetricDatasourceHelper/types/language-provider/v12-0-0.ts","webpack://grafana-metricsdrilldown-app/./AppDataTrail/MetricDatasourceHelper/types/language-provider/v12-1-0-plus.ts","webpack://grafana-metricsdrilldown-app/./AppDataTrail/MetricDatasourceHelper/MetricDatasourceHelper.ts","webpack://grafana-metricsdrilldown-app/./shared/utils/utils.variables.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/labels/LabelsDataSource.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/labels/LabelsVariable.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/MetricsSorter/events/EventSortByChanged.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/MetricsSorter/fetchers/fetchAlertingMetrics.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/MetricsSorter/fetchers/fetchDashboardMetrics.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/MetricsSorter/MetricUsageFetcher.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/MetricsSorter/MetricsSorter.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/LayoutSwitcher.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/FilteredMetricsVariable.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/QuickSearch/CountsProvider/CountsProvider.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/QuickSearch/CountsProvider/MetricVariableCountsProvider.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/QuickSearch/EventQuickSearchChanged.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/QuickSearch/QuickSearch.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/list-controls/ListControls.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/MetricsVariableFilterEngine.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/RelatedMetrics/sortRelatedMetrics.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/MetricsVariableSortEngine.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/components/SceneByVariableRepeater.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/components/ShowMoreButton.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/MetricsList/UsageData.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/MetricsList/WithUsageDataPreviewPanel.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/custom-icons/GroupsIcon.tsx","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/EventConfigurePanel.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/ConfigurePanelAction.tsx","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/SelectAction.tsx","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/EventPanelTypeChanged.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/presets/types.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/promql-functions.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/getPreferredConfigForMetric.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/available-panel-types.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/panel-heights.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/query-resolutions.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/matchers/isStatusUpDownMetric.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/matchers/getPanelTypeForMetric.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/units/getUnit.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/buildQueryExpression.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/heatmap/getHeatmapQueryRunnerParams.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/matchers/isCounterMetric.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/percentiles/getPercentilesQueryRunnerParams.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/stat/getStatQueryRunnerParams.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/statushistory/value-mappings.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/statushistory/getStatushistoryQueryRunnerParams.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/timeseries/getTimeseriesQueryRunnerParams.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/behaviors/extremeValueFilterBehavior/isAllDataNaN.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/behaviors/extremeValueFilterBehavior/extremeValueFilterBehavior.tsx","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/matchers/isCounterFromMetadata.ts","webpack://grafana-metricsdrilldown-app/./shared/utils/utils.queries.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/timeseries/transformations/addRefId.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/timeseries/transformations/addUnspecifiedLabel.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/timeseries/transformations/sliceSeries.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/timeseries/buildTimeseriesPanel.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/panelBuilder.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/heatmap/buildHeatmapPanel.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/percentiles/buildPercentilesPanel.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/statushistory/buildStatushistoryPanel.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/stat/buildStatPanel.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/GmdVizPanel.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/MetricsList/MetricsList.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/MetricsGroupByList/MetricsGroupByRow.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/labels/LabelValuesVariable.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/MetricsGroupByList/MetricsGroupByList.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/MetricsFilterSection/EventFiltersChanged.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/MetricsFilterSection/rule-group-labels.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/EventSectionValueChanged.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/SectionTitle.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/MetricsFilterSection/CheckboxWithCount.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/MetricsFilterSection/CheckBoxList.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/MetricsFilterSection/MetricsFilterSection.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/computeMetricPrefixGroups.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/computeMetricSuffixGroups.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/metrics-variables/computeRulesGroups.ts","webpack://grafana-metricsdrilldown-app/./AppDataTrail/MetricsDrilldownDataSourceVariable.ts","webpack://grafana-metricsdrilldown-app/./shared/bookmarks/genBookmarkKey.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/BookmarksList/BookmarkListItem.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/BookmarksList/BookmarksList.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/LabelsBrowser/LabelsList.tsx","webpack://grafana-metricsdrilldown-app/./shared/bookmarks/useBookmarks.ts","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/LabelsBrowser/LabelsBrowser.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/sections/Settings.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/SideBarButton.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/custom-icons/RulesIcon.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/SideBar/SideBar.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/MetricsReducer.tsx","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/matchers/getMetricType.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/matchers/isAgeMetric.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/presets/config-presets-ages.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/presets/config-presets-histograms.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/presets/config-presets-status-updown.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/presets/config-presets-timeseries.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/presets/getConfigPresetsForMetric.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/ConfigurePanelForm/EventApplyPanelConfig.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/ConfigurePanelForm/EventCancelConfigurePanel.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/config/percentiles-options.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/ConfigurePanelForm/WithConfigPanelOptions.tsx","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/ConfigurePanelForm/ConfigurePanelForm.tsx","webpack://grafana-metricsdrilldown-app/./AppDataTrail/header/PluginInfo/PluginLogo.tsx","webpack://grafana-metricsdrilldown-app/./AppDataTrail/header/PluginInfo/PluginInfo.tsx","webpack://grafana-metricsdrilldown-app/./shared/constants/ui.ts","webpack://grafana-metricsdrilldown-app/./AppDataTrail/header/SelectNewMetricButton.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelsList/events/EventForceSyncYAxis.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelsList/events/EventResetSyncYAxis.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelsList/events/EventTimeseriesDataReceived.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelsList/behaviors/syncYAxis.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/GroupBySelector/GroupBySelector.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/GroupByVariable.tsx","webpack://grafana-metricsdrilldown-app/./shared/utils/utils.styles.ts","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/types/timeseries/behaviors/addCardinalityInfo.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelsList/behaviors/publishTimeseriesData.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelsList/SelectLabelAction.tsx","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/BookmarkHeaderAction.tsx","webpack://grafana-metricsdrilldown-app/./shared/GmdVizPanel/components/GmdVizPanelVariantSelector.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/MetricGraphScene.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/PanelMenu/actions/CopyUrlAction.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/PanelMenu/actions/ExploreAction.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/PanelMenu/actions/investigation/AddToExplorationsButton.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/PanelMenu/actions/investigation/InvestigationAction.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/PanelMenu/PanelMenu.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelsList/MetricLabelsList.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelValuesList/AddToFiltersGraphAction.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelValuesList/getLabelValueFromDataFrame.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelValuesList/SortBySelector.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelValuesList/SceneByFrameRepeater.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelValuesList/LabelValuesCountProvider.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/MetricLabelValuesList/MetricLabelValuesList.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/Breakdown/LabelBreakdownScene.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/RelatedMetrics/PrefixFilterDropdown.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/RelatedMetrics/RelatedListControls.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/RelatedMetrics/RelatedMetricsScene.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/MetricActionBar.tsx","webpack://grafana-metricsdrilldown-app/./Integrations/logs/labelsCrossReference.ts","webpack://grafana-metricsdrilldown-app/./Integrations/logs/lokiRecordingRules.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/RelatedLogs/RelatedLogsOrchestrator.ts","webpack://grafana-metricsdrilldown-app/./MetricScene/RelatedLogs/NoRelatedLogsFound.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/RelatedLogs/OpenInLogsDrilldownButton.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/RelatedLogs/RelatedLogsScene.tsx","webpack://grafana-metricsdrilldown-app/./MetricScene/MetricScene.tsx","webpack://grafana-metricsdrilldown-app/./AppDataTrail/DataTrail.tsx","webpack://grafana-metricsdrilldown-app/./MetricsReducer/helpers/registerRuntimeDataSources.ts","webpack://grafana-metricsdrilldown-app/./shared/utils/utils.scopes.ts","webpack://grafana-metricsdrilldown-app/./shared/utils/utils.ts"],"sourcesContent":["export const PREF_KEYS = {\n  DATASOURCE: 'datasource',\n  RECENT_METRICS: 'recent-metrics',\n  BOOKMARKS: 'bookmarks',\n  METRIC_PREFS: 'metric-prefs',\n  BREAKDOWN_SORTBY: 'breakdown.sortby',\n  SIDEBAR_SECTION: 'sidebar.section',\n};\n","import { useEffect, useState } from 'react';\n\nimport { logger } from '../shared/logger/logger';\n\nexport function ensureErrorObject(error: any, defaultMessage: string): Error {\n  if (error instanceof Error) {\n    return error;\n  }\n  if (typeof error === 'string') {\n    return new Error(error);\n  }\n  if (typeof error.message === 'string') {\n    const e = new Error(error.message);\n    for (const prop of Object.getOwnPropertyNames(error)) {\n      (e as any)[prop] = error[prop];\n    }\n    return e;\n  }\n  return new Error(defaultMessage);\n}\n\n/**\n * Determines if an error should be treated as an application-breaking error.\n * Filters out known non-critical errors like browser extension errors and ResizeObserver warnings.\n */\nfunction shouldTreatAsApplicationError(errorEvent: ErrorEvent): boolean {\n  // Check if error is from a browser extension\n  if (errorEvent.filename) {\n    const protocol = new URL(errorEvent.filename).protocol;\n\n    if (protocol.endsWith('extension:')) {\n      logger.error(new Error(`Browser extension error: ${errorEvent.message}`), {\n        filename: errorEvent.filename,\n        lineno: errorEvent.lineno?.toString(),\n        colno: errorEvent.colno?.toString(),\n      });\n      return false;\n    }\n  }\n\n  // Check for null error with message (like ResizeObserver warnings)\n  if (errorEvent.error === null && errorEvent.message) {\n    logger.error(new Error(`Non-critical error: ${errorEvent.message}`), {\n      filename: errorEvent.filename,\n      lineno: errorEvent.lineno?.toString(),\n      colno: errorEvent.colno?.toString(),\n    });\n    return false;\n  }\n\n  return true;\n}\n\nexport function useCatchExceptions(): [Error | undefined, React.Dispatch<React.SetStateAction<Error | undefined>>] {\n  const [error, setError] = useState<Error>();\n\n  // even though we wrap the app in an ErrorBoundary, some errors are not caught,\n  // so we have to set global handlers to catch these (e.g. error thrown from some click handlers)\n  useEffect(() => {\n    const onError = (errorEvent: ErrorEvent) => {\n      if (!shouldTreatAsApplicationError(errorEvent)) {\n        return;\n      }\n\n      setError(ensureErrorObject(errorEvent.error, 'Uncaught exception!'));\n    };\n\n    const onUnHandledRejection = (event: PromiseRejectionEvent) => {\n      // TODO: remove me when we remove MetricSelectScene\n      // indeed, it seems there's always  a cancelled request when landing on the view :man_shrug:\n      // Ideally, the code in DataTrail should handle the cancellation but we do it here because it's easier\n      if (event.reason.type === 'cancelled') {\n        setError(undefined);\n        return;\n      }\n\n      setError(ensureErrorObject(event.reason, 'Unhandled rejection!'));\n    };\n\n    window.addEventListener('error', onError);\n    window.addEventListener('unhandledrejection', onUnHandledRejection);\n    return () => {\n      window.removeEventListener('unhandledrejection', onUnHandledRejection);\n      window.removeEventListener('error', onError);\n    };\n  }, []);\n\n  return [error, setError];\n}\n","import { type DataFrame } from '@grafana/data';\n\nexport function getLabelValueFromDataFrame(frame: DataFrame) {\n  const labels = frame.fields[1]?.labels;\n\n  if (!labels) {\n    return null;\n  }\n\n  const keys = Object.keys(labels);\n  if (keys.length === 0) {\n    return null;\n  }\n\n  return labels[keys[0]];\n}\n","import { OutlierDetector, type OutlierOutput } from '@bsull/augurs/outlier';\nimport {\n  doStandardCalcs,\n  fieldReducers,\n  FieldType,\n  outerJoinDataFrames,\n  ReducerID,\n  type DataFrame,\n} from '@grafana/data';\nimport { memoize } from 'lodash';\n\nimport { displayWarning } from 'MetricsReducer/helpers/displayStatus';\nimport { localeCompare } from 'MetricsReducer/helpers/localCompare';\n\nimport { getLabelValueFromDataFrame } from './levels';\nimport { reportExploreMetrics } from '../tracking/interactions';\n\nexport type SortSeriesByOption = 'alphabetical' | 'alphabetical-reversed' | 'outliers' | ReducerID.stdDev;\ntype SortSeriesDirection = 'asc' | 'desc';\n\n// Alphabetical sort\nconst sortAlphabetical = (series: DataFrame[], direction: SortSeriesDirection = 'asc') => {\n  const compareFn: (a: string, b: string) => number =\n    direction === 'asc' ? (a, b) => localeCompare(a, b) : (a, b) => localeCompare(b, a);\n\n  return series.sort((a, b) => {\n    const labelA = getLabelValueFromDataFrame(a);\n    if (!labelA) {\n      return 0;\n    }\n\n    const labelB = getLabelValueFromDataFrame(b);\n    if (!labelB) {\n      return 0;\n    }\n\n    return compareFn(labelA, labelB);\n  });\n};\n\n// Field reducer sort\nconst sortByFieldReducer = (series: DataFrame[], sortBy: string, direction: SortSeriesDirection = 'asc') => {\n  const fieldReducer = fieldReducers.get(sortBy);\n\n  const seriesCalcs = series.map((dataFrame) => {\n    const field = dataFrame.fields[1];\n    if (!field) {\n      return {\n        value: 0,\n        dataFrame,\n      };\n    }\n\n    const value = fieldReducer.reduce?.(field, true, true) ?? doStandardCalcs(field, true, true);\n    return {\n      value: value[sortBy] ?? 0,\n      dataFrame,\n    };\n  });\n\n  seriesCalcs.sort(direction === 'asc' ? (a, b) => a.value - b.value : (a, b) => b.value - a.value);\n\n  return seriesCalcs.map(({ dataFrame }) => dataFrame);\n};\n\n// Outlier sort\nconst sortByOutliers = (series: DataFrame[], direction: 'asc' | 'desc' = 'asc') => {\n  if (!wasmSupported()) {\n    throw new Error('WASM not supported');\n  }\n\n  const outliers = getOutliers(series);\n\n  const seriesCalcs = series.map((dataFrame, index) => ({\n    value: calculateOutlierValue(outliers, index),\n    dataFrame: dataFrame,\n  }));\n\n  seriesCalcs.sort(direction === 'asc' ? (a, b) => a.value - b.value : (a, b) => b.value - a.value);\n\n  return seriesCalcs.map(({ dataFrame }) => dataFrame);\n};\n\nconst getOutliers = (series: DataFrame[]): OutlierOutput => {\n  // Combine all frames into one by joining on time.\n  const joined = outerJoinDataFrames({ frames: series });\n  if (!joined) {\n    throw new Error('Error while joining frames into a single one');\n  }\n\n  // Get number fields: these are our series.\n  const joinedSeries = joined.fields.filter((f) => f.type === FieldType.number);\n  const points = joinedSeries.map((series) => new Float64Array(series.values));\n\n  return OutlierDetector.dbscan({ sensitivity: 0.9 }).detect(points);\n};\n\nconst calculateOutlierValue = (outliers: OutlierOutput, index: number): number => {\n  if (outliers.seriesResults[index].isOutlier) {\n    return -outliers.seriesResults[index].outlierIntervals.length;\n  }\n  return 0;\n};\n\nexport const sortSeries = memoize(\n  (origSeries: DataFrame[], sortBy: SortSeriesByOption, direction: SortSeriesDirection = 'asc') => {\n    if (!origSeries.length) {\n      return [];\n    }\n\n    const series = [...origSeries];\n\n    // Alphabetical sorting\n    if (sortBy === 'alphabetical') {\n      return sortAlphabetical(series, 'asc');\n    }\n\n    if (sortBy === 'alphabetical-reversed') {\n      return sortAlphabetical(series, 'desc');\n    }\n\n    // Outlier detection sorting\n    if (sortBy === 'outliers') {\n      try {\n        return sortByOutliers(series, direction);\n      } catch (e) {\n        const msg = `Error while sorting by outlying series: \"${(e as Error).toString()}\"!`;\n        displayWarning([msg, 'Falling back to standard deviation to identify the most variable series.']);\n\n        return sortByFieldReducer(series, ReducerID.stdDev, direction);\n      }\n    }\n\n    // Field reducer sorting (default case)\n    return sortByFieldReducer(series, sortBy, direction);\n  },\n  (series: DataFrame[], sortBy: string, direction: SortSeriesDirection = 'asc') => {\n    const firstTimestamp = seriesIsNotEmpty(series) ? series[0].fields[0].values[0] : 0;\n    const lastTimestamp = seriesIsNotEmpty(series)\n      ? series[series.length - 1].fields[0].values[series[series.length - 1].fields[0].values.length - 1]\n      : 0;\n\n    const firstValue = series.length > 0 ? getLabelValueFromDataFrame(series[0]) : '';\n    const lastValue = series.length > 0 ? getLabelValueFromDataFrame(series[series.length - 1]) : '';\n\n    const key = `${firstValue}_${lastValue}_${firstTimestamp}_${lastTimestamp}_${series.length}_${sortBy}_${direction}`;\n\n    return key;\n  }\n);\n\nfunction seriesIsNotEmpty(series: DataFrame[]) {\n  return series.length > 0 && series[0].fields.length > 0 && series[0].fields[0].values.length > 0;\n}\n\nexport const wasmSupported = () => {\n  const support = typeof WebAssembly === 'object';\n\n  if (!support) {\n    reportExploreMetrics('wasm_not_supported', {});\n  }\n\n  return support;\n};\n","import { AppEvents } from '@grafana/data';\nimport { getAppEvents } from '@grafana/runtime';\n\nimport { logger } from 'shared/logger/logger';\n\nexport function displayError(error: Error, msgs: Array<string | React.ReactElement>) {\n  const context = msgs.reduce((acc, msg, i) => ({ ...acc, [`info${i + 1}`]: msg }), { handheldBy: 'displayError' });\n\n  logger.error(error, context);\n\n  getAppEvents().publish({\n    type: AppEvents.alertError.name,\n    payload: msgs,\n  });\n}\n\nexport function displayWarning(msgs: Array<string | React.ReactElement>) {\n  logger.warn(msgs);\n\n  getAppEvents().publish({\n    type: AppEvents.alertWarning.name,\n    payload: msgs,\n  });\n}\n\nexport function displaySuccess(msgs: Array<string | React.ReactElement>) {\n  getAppEvents().publish({\n    type: AppEvents.alertSuccess.name,\n    payload: msgs,\n  });\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { Collapse, TextLink, useStyles2 } from '@grafana/ui';\nimport React, { useCallback, useState } from 'react';\nimport { useLocation, useNavigate } from 'react-router-dom';\n\nimport { InlineBanner } from './InlineBanner';\n\ntype ErrorViewProps = { error: Error };\n\nexport function ErrorView({ error }: Readonly<ErrorViewProps>) {\n  const styles = useStyles2(getStyles);\n\n  const navigate = useNavigate();\n  const { pathname, search } = useLocation();\n\n  const onClickReload = useCallback(() => {\n    const searchParams = new URLSearchParams(search);\n    const newSearchParams = new URLSearchParams();\n\n    // these are safe keys to keep\n    ['from', 'to', 'timezone']\n      .filter((key) => searchParams.has(key))\n      .forEach((key) => newSearchParams.set(key, searchParams.get(key)!));\n\n    navigate({ pathname, search: newSearchParams.toString() });\n    window.location.reload();\n  }, [navigate, pathname, search]);\n\n  const [isCollapseOpen, setIsCollapseOpen] = useState(false);\n\n  return (\n    <div className={styles.container}>\n      <InlineBanner\n        severity=\"error\"\n        title=\"Fatal error!\"\n        error={error}\n        errorContext={{ handheldBy: 'React error boundary' }}\n        message={\n          <>\n            <p className={styles.message}>\n              Please{' '}\n              <TextLink href=\"#\" onClick={onClickReload}>\n                try reloading the page\n              </TextLink>{' '}\n              or, if the problem persists, contact your organization admin. Sorry for the inconvenience.\n            </p>\n            <p>\n              <Collapse\n                className={styles.callStack}\n                collapsible\n                label=\"View stack trace\"\n                isOpen={isCollapseOpen}\n                onToggle={() => setIsCollapseOpen(!isCollapseOpen)}\n              >\n                <pre>\n                  <code>{error.stack}</code>\n                </pre>\n              </Collapse>\n            </p>\n          </>\n        }\n      />\n    </div>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      margin: theme.spacing(2),\n    }),\n    message: css({\n      margin: theme.spacing(2, 0, 1, 0),\n    }),\n    callStack: css({\n      backgroundColor: 'transparent',\n      border: '0 none',\n\n      '& button': css({\n        paddingLeft: theme.spacing(1.5),\n      }),\n\n      '& button:focus': css({\n        outline: 'none',\n        boxShadow: 'none',\n      }),\n\n      '& button > svg': css({\n        marginLeft: theme.spacing(-2),\n        marginRight: theme.spacing(0.5),\n      }),\n\n      '& [class$=\"collapse__loader\"]': css({\n        display: 'none',\n      }),\n    }),\n  };\n}\n","import { type FeatureToggles } from '@grafana/data';\nimport { config } from '@grafana/runtime';\n\n/**\n * Feature toggles defined in Hosted Grafana (not OSS).\n * @remarks See https://github.com/grafana/hosted-grafana/wiki/All-Things-Feature-Toggles#grafana-plugins for details.\n */\nexport const HGFeatureToggles = {\n  // Add new feature toggles here\n  sidebarOpenByDefault: 'metricsDrilldownDefaultOpenSidebar',\n} as const;\n\ntype HGFeatureToggleName = (typeof HGFeatureToggles)[keyof typeof HGFeatureToggles];\n\ntype OssAndHGFeatureToggles = FeatureToggles & {\n  [key in HGFeatureToggleName]: boolean;\n};\n\nexport function isFeatureToggleEnabled(featureToggle: HGFeatureToggleName): boolean {\n  return (config.featureToggles as OssAndHGFeatureToggles)[featureToggle] ?? false;\n}\n","import { reportExploreMetrics } from 'shared/tracking/interactions';\n\nimport { PREF_KEYS } from './pref-keys';\nimport pluginJson from '../../plugin.json';\n\nclass UserStorage {\n  private service: string;\n\n  constructor(service: string) {\n    this.service = service;\n  }\n\n  // TODO: temporary, let's wait for the new version to be in prod to remove it\n  public migrate() {\n    let hasMigrations = false;\n\n    const migrations = [\n      { legacyKey: 'metricsDrilldownDataSource', newKey: PREF_KEYS.DATASOURCE },\n      { legacyKey: 'metrics-drilldown-recent-metrics/v1', newKey: PREF_KEYS.RECENT_METRICS },\n      { legacyKey: 'grafana.trails.bookmarks', newKey: PREF_KEYS.BOOKMARKS },\n      { legacyKey: 'grafana.trails.breakdown.sort.labels.by', newKey: PREF_KEYS.BREAKDOWN_SORTBY },\n    ];\n\n    for (const { legacyKey, newKey } of migrations) {\n      let existingItem = localStorage.getItem(legacyKey);\n      if (existingItem === null) {\n        continue;\n      }\n\n      try {\n        existingItem = JSON.parse(existingItem);\n      } catch {}\n\n      this.setItem(newKey, existingItem);\n      localStorage.removeItem(legacyKey);\n\n      hasMigrations = true;\n    }\n\n    if (hasMigrations) {\n      reportExploreMetrics('user_preferences_migrated', {});\n    }\n  }\n\n  private buildStorageKey(key: string) {\n    return `${this.service}.${key}`;\n  }\n\n  getItem(key: string): any {\n    const storageKey = this.buildStorageKey(key);\n    const item = localStorage.getItem(storageKey);\n    return item === null ? null : JSON.parse(item);\n  }\n\n  setItem(key: string, value: any): void {\n    const storageKey = this.buildStorageKey(key);\n    localStorage.setItem(storageKey, JSON.stringify(value));\n  }\n\n  removeItem(key: string): void {\n    const storageKey = this.buildStorageKey(key);\n    localStorage.removeItem(storageKey);\n  }\n\n  clear() {\n    localStorage.clear();\n  }\n}\n\nexport const userStorage = new UserStorage(pluginJson.id);\n","import { type AdHocVariableFilter } from '@grafana/data';\nimport { config, reportInteraction } from '@grafana/runtime';\n\nimport { type ExposedComponentName } from 'exposedComponents/components';\nimport { type PanelConfigPreset } from 'shared/GmdVizPanel/config/presets/types';\nimport { type MetricType } from 'shared/GmdVizPanel/matchers/getMetricType';\nimport { type PanelType } from 'shared/GmdVizPanel/types/available-panel-types';\nimport { getFaro } from 'shared/logger/faro/faro';\nimport { type SortSeriesByOption } from 'shared/services/sorting';\nimport { type SnakeCase } from 'shared/utils/utils.types';\n\nimport { type ActionViewType } from '../../MetricScene/MetricActionBar';\nimport { type LayoutType } from '../../MetricsReducer/list-controls/LayoutSwitcher';\nimport { type SortingOption as MetricsReducerSortByOption } from '../../MetricsReducer/list-controls/MetricsSorter/MetricsSorter';\nimport { GIT_COMMIT } from '../../version';\nimport { PLUGIN_ID } from '../constants/plugin';\nimport { HGFeatureToggles, isFeatureToggleEnabled } from '../utils/utils.feature-toggles';\n\nexport type ViewName = 'metrics-reducer' | 'metric-details';\n\ntype Interactions = {\n  // User selected a label to view its breakdown.\n  groupby_label_changed: {\n    label: string;\n  };\n  breakdown_panel_selected: {\n    label: string;\n  };\n  // User changed a label filter\n  label_filter_changed: {\n    label: string;\n    action: 'added' | 'removed' | 'changed';\n    cause: 'breakdown' | 'adhoc_filter';\n  };\n  // User changed the breakdown layout\n  breakdown_layout_changed: { layout: LayoutType };\n  // A metric exploration has started due to one of the following causes\n  exploration_started: {\n    cause: 'bookmark_clicked';\n  };\n  // A user has changed a bookmark\n  bookmark_changed: {\n    action: // Toggled on or off from the bookmark icon\n    | 'toggled_on'\n      | 'toggled_off'\n      // Deleted from the sidebar bookmarks list\n      | 'deleted';\n  };\n  // User changes metric explore settings\n  settings_changed: { stickyMainGraph?: boolean };\n  // User clicks on tab to change the action view\n  metric_action_view_changed: {\n    view: ActionViewType;\n\n    // The number of related logs\n    related_logs_count?: number;\n  };\n  // User clicks on one of the action buttons associated with a selected metric\n  selected_metric_action_clicked: {\n    action: // Opens the metric queries in Explore\n    | 'open_in_explore'\n      // Clicks on the share URL button\n      | 'share_url'\n      // Deselects the current selected metrics by clicking the \"Select new metric\" button\n      | 'unselect'\n      // When in embedded mode, clicked to open the exploration from the embedded view\n      | 'open_from_embedded';\n  };\n  // User clicks on one of the action buttons associated with related logs\n  related_logs_action_clicked: {\n    action: // Opens Logs Drilldown\n    | 'open_logs_drilldown'\n      // Logs data source changed\n      | 'logs_data_source_changed';\n  };\n  // User selects a metric\n  metric_selected: {\n    from: // By clicking \"Select\" on a metric panel when on the no-metric-selected metrics list view\n    | 'metric_list'\n      // By clicking \"Select\" on a metric panel when on the related metrics tab\n      | 'related_metrics';\n    // The number of search terms activated when the selection was made\n    searchTermCount: number | null;\n  };\n  // User opens/closes the prefix filter dropdown\n  prefix_filter_clicked: {\n    from: // By clicking \"Select\" on a metric panel when on the no-metric-selected metrics list view\n    | 'metric_list'\n      // By clicking \"Select\" on a metric panel when on the related metrics tab\n      | 'related_metrics';\n    action: // Opens the dropdown\n    | 'open'\n      // Closes the dropdown\n      | 'close';\n  };\n  // User types in the quick search bar\n  quick_search_used: {};\n  sorting_changed:\n    | {\n        // By clicking on the sort by variable in the metrics reducer\n        from: 'metrics-reducer';\n        // The sort by option selected\n        sortBy: MetricsReducerSortByOption;\n      }\n    | {\n        // By clicking on the sort by component in the label breakdown\n        from: 'label-breakdown';\n        // The sort by option selected\n        sortBy: SortSeriesByOption;\n      };\n  wasm_not_supported: {};\n  native_histogram_examples_closed: {};\n  native_histogram_example_clicked: {\n    metric: string;\n  };\n  // User toggles the Wingman sidebar\n  metrics_sidebar_toggled: {\n    action: // Opens the sidebar section\n    | 'opened'\n      // Closes the sidebar section\n      | 'closed';\n    section?: string;\n  };\n  // User clicks into the prefix filter section of the sidebar\n  sidebar_prefix_filter_section_clicked: {};\n  // User applies any prefix filter from the sidebar\n  sidebar_prefix_filter_applied: {\n    // Number of prefix filters applied (optional)\n    filter_count?: number;\n  };\n  // User clicks into the suffix filter section of the sidebar\n  sidebar_suffix_filter_section_clicked: {};\n  // User applies any suffix filter from the sidebar\n  sidebar_suffix_filter_applied: {\n    // Number of suffix filters applied (optional)\n    filter_count?: number;\n  };\n  // User selects a rules filter from the Wingman sidebar\n  sidebar_rules_filter_selected: {\n    filter_type: 'non_rules_metrics' | 'recording_rules';\n  };\n  // User applies a label filter from the sidebar\n  sidebar_group_by_label_filter_applied: {\n    label: string;\n  };\n  app_initialized: {\n    view: ViewName;\n    uel_epid: string;\n  };\n  // User took an action to view an exposed component\n  exposed_component_viewed: {\n    component: SnakeCase<ExposedComponentName>;\n  };\n  // User selects a different layout (grid/rows/single)\n  layout_changed: { layout: LayoutType };\n  // User changes the panel type for a histogram metric (e.g., from heatmap to percentiles)\n  histogram_panel_type_changed: { panelType: PanelType };\n  // App migrated some legacy user prefs (see src/UserPreferences/userStorage.ts)\n  user_preferences_migrated: {};\n  // User opens the \"Configure panel\"\n  configure_panel_opened: { metricType: MetricType };\n  // User applies a panel config\n  panel_config_applied: { metricType: MetricType; configId: string };\n  // User restores the default panel config\n  default_panel_config_restored: { metricType: MetricType };\n  // An invalid metric config has been found\n  invalid_metric_config: { metricConfig: PanelConfigPreset };\n  // the user has clicked on the \"Give feedback\" button in the app header\n  give_feedback_clicked: {};\n};\n\ntype OtherEvents = {\n  extreme_value_filter_behavior_triggered: {\n    expression: string;\n  };\n};\n\ntype AllEvents = Interactions & OtherEvents;\n\nconst INTERACTION_NAME_PREFIX = 'grafana_explore_metrics_';\n\nexport function reportExploreMetrics<E extends keyof AllEvents, P extends AllEvents[E]>(event: E, payload: P) {\n  reportInteraction(`${INTERACTION_NAME_PREFIX}${event}`, {\n    ...payload,\n    meta: {\n      // same naming as Faro (see src/tracking/faro/faro.ts)\n      appRelease: config.apps[PLUGIN_ID].version,\n      appVersion: GIT_COMMIT,\n    },\n  });\n\n  // Extra event tracking with Faro for \"Default Open Sidebar\" experiment\n  if (event.includes('sidebar')) {\n    getFaro()?.api.pushEvent(event, {\n      // Convert all payload values to strings\n      ...Object.fromEntries(Object.entries(payload).map(([key, value]) => [key, String(value)])),\n      defaultOpenSidebar: String(isFeatureToggleEnabled(HGFeatureToggles.sidebarOpenByDefault)),\n    });\n  }\n}\n\n/**\n * Reports a single label filter change event\n */\nfunction reportLabelFilterChange(label: string, action: 'added' | 'removed' | 'changed') {\n  reportExploreMetrics('label_filter_changed', {\n    label,\n    action,\n    cause: 'adhoc_filter',\n  });\n}\n\n/**\n * Detects and reports changes to an existing filter\n */\nfunction detectChangedFilters(newFilters: AdHocVariableFilter[], oldFilters: AdHocVariableFilter[]) {\n  for (const oldFilter of oldFilters) {\n    for (const newFilter of newFilters) {\n      if (oldFilter.key === newFilter.key && oldFilter.value !== newFilter.value) {\n        reportLabelFilterChange(oldFilter.key, 'changed');\n      }\n    }\n  }\n}\n\n/**\n * Detects and reports removed filters\n */\nfunction detectRemovedFilters(newFilters: AdHocVariableFilter[], oldFilters: AdHocVariableFilter[]) {\n  for (const oldFilter of oldFilters) {\n    const stillExists = newFilters.some((newFilter) => newFilter.key === oldFilter.key);\n    if (!stillExists) {\n      reportLabelFilterChange(oldFilter.key, 'removed');\n    }\n  }\n}\n\n/**\n * Detects and reports added filters\n */\nfunction detectAddedFilters(newFilters: AdHocVariableFilter[], oldFilters: AdHocVariableFilter[]) {\n  for (const newFilter of newFilters) {\n    const isNew = !oldFilters.some((oldFilter) => oldFilter.key === newFilter.key);\n    if (isNew) {\n      reportLabelFilterChange(newFilter.key, 'added');\n    }\n  }\n}\n\n/** Detect the single change in filters and report the event, assuming it came from manipulating the adhoc filter */\nexport function reportChangeInLabelFilters(newFilters: AdHocVariableFilter[], oldFilters: AdHocVariableFilter[]) {\n  if (newFilters.length === oldFilters.length) {\n    // Same number of filters - check for changed values\n    detectChangedFilters(newFilters, oldFilters);\n  } else if (newFilters.length < oldFilters.length) {\n    // Filters were removed\n    detectRemovedFilters(newFilters, oldFilters);\n  } else {\n    // Filters were added\n    detectAddedFilters(newFilters, oldFilters);\n  }\n}\n","export const localeCompare = new Intl.Collator('en', { sensitivity: 'base' }).compare;\n","import { Alert, type AlertVariant } from '@grafana/ui';\nimport React from 'react';\n\nimport { ensureErrorObject } from './useCatchExceptions';\nimport { logger, type ErrorContext } from '../shared/logger/logger';\n\ntype InlineBannerProps = {\n  severity: AlertVariant;\n  title: string;\n  message?: string | React.ReactNode;\n  error?: Error;\n  errorContext?: ErrorContext;\n  children?: React.ReactNode;\n};\n\n// adds HTTP status, if available\nfunction formatErrorMessage(error: any) {\n  const message = error.message || error.toString();\n  const infos = [];\n  if (error.statusText) {\n    infos.push(error.statusText);\n  }\n  if (error.status) {\n    infos.push(`HTTP ${error.status}`);\n  }\n  return infos.length ? `${message} (${infos.join(' - ')})` : message;\n}\n\nexport function InlineBanner({ severity, title, message, error, errorContext, children }: Readonly<InlineBannerProps>) {\n  let errorObject;\n\n  if (error) {\n    errorObject = ensureErrorObject(error, 'Unknown error!');\n\n    logger.error(errorObject, {\n      ...(errorObject.cause || {}),\n      ...errorContext,\n      bannerTitle: title,\n    });\n  }\n\n  return (\n    <Alert title={title} severity={severity}>\n      {errorObject && (\n        <>\n          {formatErrorMessage(errorObject)}\n          <br />\n        </>\n      )}\n      {message}\n      {children}\n    </Alert>\n  );\n}\n","import { createContext, useContext } from 'react';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\nimport { newMetricsTrail } from 'shared/utils/utils';\n\ninterface AppContextState {\n  trail: DataTrail;\n}\n\nexport const defaultTrail = newMetricsTrail();\n\nexport const AppContext = createContext<AppContextState>({\n  trail: defaultTrail,\n});\n\nexport function useMetricsAppContext() {\n  return useContext(AppContext);\n}\n","import React, { lazy } from 'react';\nimport { Navigate, Route, Routes, useLocation } from 'react-router-dom';\n\nimport { ROUTES } from 'shared/constants/routes';\n\nimport { useMetricsAppContext } from './AppContext';\n\nexport const Trail = lazy(() => import('./Trail'));\n\n// For /trail links, redirect to /drilldown with the same search params\nconst TrailRedirect = () => {\n  const location = useLocation();\n  return <Navigate to={`${ROUTES.Drilldown}${location.search}`} replace />;\n};\n\nexport const AppRoutes = () => {\n  const { trail } = useMetricsAppContext();\n\n  return (\n    <Routes>\n      <Route path={ROUTES.Drilldown} element={<Trail trail={trail} />} />\n      <Route path={ROUTES.Trail} element={<TrailRedirect />} />\n      {/* catch-all route */}\n      <Route path=\"*\" element={<Navigate to={ROUTES.Drilldown} replace />} />\n    </Routes>\n  );\n};\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { Icon, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\n\n// TODO: review on the 25th of September 2025 (see https://github.com/grafana/metrics-drilldown/issues/579)\n// const FEEDBACK_FORM_URL_QUALTRICS = 'https://grafana.qualtrics.com/jfe/form/SV_9FXX8XzCNe7G1g2';\nconst FEEDBACK_FORM_URL_GOOGLE = 'https://forms.gle/dKHDM4GDXVYPny3L6';\n\nfunction trackUsage() {\n  reportExploreMetrics('give_feedback_clicked', {});\n}\n\nexport const GiveFeedbackButton = () => {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.wrapper}>\n      <a\n        href={FEEDBACK_FORM_URL_GOOGLE}\n        className={styles.feedback}\n        title=\"Share your thoughts about Metrics in Grafana.\"\n        target=\"_blank\"\n        rel=\"noreferrer noopener\"\n        onClick={trackUsage}\n      >\n        <Icon name=\"comment-alt-message\" /> Give feedback\n      </a>\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    wrapper: css({\n      position: 'absolute',\n      top: 0,\n      right: 0,\n    }),\n    feedback: css({\n      color: theme.colors.text.secondary,\n      fontSize: theme.typography.bodySmall.fontSize,\n      '&:hover': {\n        color: theme.colors.text.link,\n      },\n    }),\n  };\n};\n","import { SceneObjectBase, type SceneComponentProps, type SceneObject, type SceneObjectState } from '@grafana/scenes';\nimport { Drawer } from '@grafana/ui';\nimport React from 'react';\n\ninterface SceneDrawerState extends SceneObjectState {\n  key?: string;\n  isOpen?: boolean;\n  title?: string;\n  subTitle?: string;\n  body?: SceneObject;\n}\n\nexport class SceneDrawer extends SceneObjectBase<SceneDrawerState> {\n  constructor(state?: SceneDrawerState) {\n    super({\n      key: 'drawer',\n      isOpen: false,\n      ...state,\n    });\n  }\n\n  open = ({\n    title,\n    subTitle,\n    body,\n  }: {\n    title?: SceneDrawerState['title'];\n    subTitle?: SceneDrawerState['subTitle'];\n    body?: SceneDrawerState['body'];\n  }) => {\n    this.setState({ ...this.state, isOpen: true, title, subTitle, body });\n  };\n\n  close = () => {\n    this.setState({ isOpen: false });\n  };\n\n  static readonly Component = ({ model }: SceneComponentProps<SceneDrawer>) => {\n    const { isOpen, title, subTitle, body } = model.useState();\n\n    return (\n      <>\n        {body && isOpen && (\n          <Drawer size=\"lg\" title={title} subtitle={subTitle} closeOnMaskClick onClose={model.close}>\n            <body.Component model={body} />\n          </Drawer>\n        )}\n      </>\n    );\n  };\n}\n","import { isEqual } from 'lodash';\n\nexport const areArraysEqual = (array1: any[], array2: any[]) =>\n  array1.length === array2.length && isEqual(array1, array2);\n","import { BusEventBase, BusEventWithPayload } from '@grafana/data';\nimport { type SceneObjectUrlValues } from '@grafana/scenes';\n\nexport const VAR_FILTERS = 'filters';\nexport const VAR_FILTERS_EXPR = '${filters}';\nexport const VAR_METRIC = 'metric';\nexport const VAR_METRIC_EXPR = '${metric}';\nexport const VAR_GROUP_BY = 'groupby';\nexport const VAR_DATASOURCE = 'ds';\nexport const VAR_DATASOURCE_EXPR = '${ds}';\nexport const VAR_LOGS_DATASOURCE = 'logsDs';\nexport const VAR_LOGS_DATASOURCE_EXPR = '${logsDs}';\nexport const VAR_OTHER_METRIC_FILTERS = 'other_metric_filters';\n\nexport const LOGS_METRIC = '$__logs__';\n\nexport const trailDS = { uid: VAR_DATASOURCE_EXPR };\n\nexport type MakeOptional<T, K extends keyof T> = Pick<Partial<T>, K> & Omit<T, K>;\n\ntype MetricSelectedEventPayload = {\n  metric?: string;\n  urlValues?: SceneObjectUrlValues;\n};\n\nexport class MetricSelectedEvent extends BusEventWithPayload<MetricSelectedEventPayload> {\n  public static readonly type = 'metric-selected-event';\n}\n\nexport class RefreshMetricsEvent extends BusEventBase {\n  public static readonly type = 'refresh-metrics-event';\n}\n","import { VariableHide, type AdHocVariableFilter } from '@grafana/data';\nimport { utf8Support } from '@grafana/prometheus';\nimport { AdHocFiltersVariable, sceneGraph } from '@grafana/scenes';\n\nimport { VAR_FILTERS } from 'shared/shared';\n\nexport const VAR_METRICS_VAR_FILTERS = 'metrics_filters';\n\n// This mirror variable keeps the main AdHoc filters in sync, allowing us to construct an expression that includes __name__ label matchers to\n// enable MetricsVariable to fetch the metrics list when __name__ is included (see DataTrail.tsx for the main AdHoc filters)\nexport class AdHocFiltersForMetricsVariable extends AdHocFiltersVariable {\n  constructor() {\n    super({\n      key: VAR_METRICS_VAR_FILTERS,\n      name: VAR_METRICS_VAR_FILTERS,\n      hide: VariableHide.hideVariable,\n      allowCustomValue: true,\n      applyMode: 'manual',\n      expressionBuilder: (filters: AdHocVariableFilter[]) =>\n        filters.map((filter) => `${utf8Support(filter.key)}${filter.operator}\"${filter.value}\"`).join(','),\n      skipUrlSync: true,\n    });\n\n    this.addActivationHandler(() => {\n      const filtersVariable = sceneGraph.findByKeyAndType(this, VAR_FILTERS, AdHocFiltersVariable);\n\n      const update = (newState: any) => {\n        this.setState({\n          baseFilters: newState.baseFilters,\n          filters: newState.filters,\n        });\n      };\n\n      update(filtersVariable.state);\n\n      const sub = filtersVariable.subscribeToState((newState, prevState) => {\n        if (newState.baseFilters !== prevState.baseFilters || newState.filters !== prevState.filters) {\n          update(newState);\n        }\n      });\n\n      return () => {\n        sub.unsubscribe();\n      };\n    });\n  }\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\ninterface EventMetricsVariableActivatedPayload {\n  key: string;\n}\n\nexport class EventMetricsVariableActivated extends BusEventWithPayload<EventMetricsVariableActivatedPayload> {\n  public static readonly type = 'metrics-variable-activated';\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\ninterface EventMetricsVariableDeactivatedPayload {\n  key: string;\n}\n\nexport class EventMetricsVariableDeactivated extends BusEventWithPayload<EventMetricsVariableDeactivatedPayload> {\n  public static readonly type = 'metrics-variable-deactivated';\n}\n","import { BusEventWithPayload } from '@grafana/data';\nimport { type VariableValueOption } from '@grafana/scenes';\n\ninterface EventMetricsVariableLoadedPayload {\n  key: string;\n  options: VariableValueOption[];\n}\n\nexport class EventMetricsVariableLoaded extends BusEventWithPayload<EventMetricsVariableLoadedPayload> {\n  public static readonly type = 'metrics-variable-loaded';\n}\n","import { type MultiValueVariable, type MultiValueVariableState } from '@grafana/scenes';\n\nimport { EventMetricsVariableActivated } from './events/EventMetricsVariableActivated';\nimport { EventMetricsVariableDeactivated } from './events/EventMetricsVariableDeactivated';\nimport { EventMetricsVariableLoaded } from './events/EventMetricsVariableLoaded';\n\n/**\n * Adds the publication of lifecycle events to a metrics variable:\n *\n * - `EventMetricsVariableActivated`\n * - `EventMetricsVariableDeactivated`\n * - `EventMetricsVariableLoaded`\n *\n * This is particularly useful for filtering and sorting the variable options, while keeping the\n * different pieces of code decoupled.\n *\n * The filtering and sorting logic is centralized in the `MetricsReducer` class.\n */\nexport function withLifecycleEvents<T extends MultiValueVariable>(variable: T): T {\n  const key = variable.state.key as string;\n\n  if (!key) {\n    throw new TypeError(\n      `Variable \"${variable.state.name}\" has no key. Please provide a key in order to publish its lifecycle events.`\n    );\n  }\n\n  variable.addActivationHandler(() => {\n    variable.publishEvent(new EventMetricsVariableActivated({ key }), true);\n\n    // We make sure filtering and sorting work in a scenario where the user goes from the MetricsReducer to the MetricScene and back.\n    // Indeed, sometimes, the variable already has its options and does not load new ones (issue reported in a dev env).\n    if (!variable.state.loading && variable.state.options.length) {\n      variable.publishEvent(new EventMetricsVariableLoaded({ key, options: variable.state.options }), true);\n    }\n\n    const sub = variable.subscribeToState((newState: MultiValueVariableState, prevState: MultiValueVariableState) => {\n      if (!newState.loading && prevState.loading) {\n        variable.publishEvent(new EventMetricsVariableLoaded({ key, options: newState.options }), true);\n      }\n    });\n\n    return () => {\n      sub.unsubscribe();\n      variable.publishEvent(new EventMetricsVariableDeactivated({ key }), true);\n    };\n  });\n\n  return variable;\n}\n","import { VariableHide, VariableRefresh, VariableSort } from '@grafana/data';\nimport { QueryVariable, type SceneObjectState } from '@grafana/scenes';\n\nimport { type LabelMatcher } from 'shared/GmdVizPanel/buildQueryExpression';\nimport { trailDS } from 'shared/shared';\n\nimport { VAR_METRICS_VAR_FILTERS } from './AdHocFiltersForMetricsVariable';\nimport { withLifecycleEvents } from './withLifecycleEvents';\n\nexport const VAR_METRICS_VARIABLE = 'metrics-wingman';\n\nexport type MetricOptions = Array<{ label: string; value: string }>;\n\ninterface MetricsVariableState extends SceneObjectState {\n  key?: string;\n  name?: string;\n  labelMatcher?: LabelMatcher;\n  addLifeCycleEvents?: boolean;\n}\n\nexport class MetricsVariable extends QueryVariable {\n  constructor({ key, name, labelMatcher, addLifeCycleEvents }: MetricsVariableState = {}) {\n    super({\n      key: key || VAR_METRICS_VARIABLE,\n      name: name || VAR_METRICS_VARIABLE,\n      label: 'Metrics',\n      datasource: trailDS,\n      query: labelMatcher\n        ? `label_values({${labelMatcher.key}${labelMatcher.operator}\"${labelMatcher.value}\",$${VAR_METRICS_VAR_FILTERS}}, __name__)`\n        : `label_values({$${VAR_METRICS_VAR_FILTERS}}, __name__)`,\n      includeAll: true,\n      value: '$__all',\n      skipUrlSync: true,\n      refresh: VariableRefresh.onTimeRangeChanged,\n      sort: VariableSort.alphabeticalAsc,\n      hide: VariableHide.hideVariable,\n    });\n\n    if (addLifeCycleEvents) {\n      // required for filtering and sorting\n      return withLifecycleEvents<MetricsVariable>(this);\n    }\n  }\n}\n","export const isClassicHistogramMetric = (metric: string) => metric.endsWith('_bucket');\n","import { isPrometheusDatasourceV11_6_x } from './v11-6-x';\nimport { isPrometheusDatasourceV12_0_0 } from './v12-0-0';\nimport { isPrometheusDatasourceV12_1_0Plus } from './v12-1-0-plus';\n\nexport const languageProviderVersionIs = {\n  '11.6.x': isPrometheusDatasourceV11_6_x,\n  '12.0.0': isPrometheusDatasourceV12_0_0,\n  '12.1.0-plus': isPrometheusDatasourceV12_1_0Plus,\n};\n","import {\n  type AbstractQuery,\n  type AdHocVariableFilter,\n  type LanguageProvider,\n  type Scope,\n  type TimeRange,\n} from '@grafana/data';\nimport { type PrometheusDatasource, type PromMetricsMetadata, type PromQuery } from '@grafana/prometheus';\nimport { type BackendSrvRequest } from '@grafana/runtime';\n\nimport { type PromQLLabelMatcher } from 'shared/utils/utils.promql';\n\nimport { type PrometheusRuntimeDatasource } from '../../../MetricDatasourceHelper/MetricDatasourceHelper';\n\ninterface PromQlLanguageProviderElevenDotSix extends LanguageProvider {\n  histogramMetrics: string[];\n  timeRange: TimeRange;\n  metrics: string[];\n  metricsMetadata?: PromMetricsMetadata;\n  startTask: Promise<any>;\n  datasource: PrometheusDatasource;\n  labelKeys: string[];\n  labelFetchTs: number;\n  getDefaultCacheHeaders():\n    | {\n        headers: {\n          'X-Grafana-Cache': string;\n        };\n      }\n    | undefined;\n  cleanText(s: string): string;\n  get syntax(): Prism.Grammar;\n  request: (url: string, defaultValue: any, params?: {}, options?: Partial<BackendSrvRequest>) => Promise<any>;\n  start: (timeRange?: TimeRange) => Promise<any[]>;\n  loadMetricsMetadata(): Promise<void>;\n  getLabelKeys(): string[];\n  importFromAbstractQuery(labelBasedQuery: AbstractQuery): PromQuery;\n  exportToAbstractQuery(query: PromQuery): AbstractQuery;\n  getSeries(selector: string, withName?: boolean): Promise<Record<string, string[]>>;\n  /**\n   * @param key\n   */\n  fetchLabelValues: (key: string) => Promise<string[]>;\n  getLabelValues(key: string): Promise<string[]>;\n  /**\n   * Fetches all label keys\n   */\n  fetchLabels: (timeRange?: TimeRange, queries?: PromQuery[]) => Promise<string[]>;\n  /**\n   * Gets series values\n   * Function to replace old getSeries calls in a way that will provide faster endpoints for new prometheus instances,\n   * while maintaining backward compatability\n   * @param labelName\n   * @param selector\n   */\n  getSeriesValues: (labelName: string, selector: string) => Promise<string[]>;\n  /**\n   * Fetches all values for a label, with optional match[]\n   * @param name\n   * @param match\n   * @param timeRange\n   * @param requestId\n   */\n  fetchSeriesValuesWithMatch: (\n    name: string,\n    match: string,\n    requestId?: string,\n    timeRange?: TimeRange\n  ) => Promise<string[]>;\n  /**\n   * Gets series labels\n   * Function to replace old getSeries calls in a way that will provide faster endpoints for new prometheus instances,\n   * while maintaining backward compatability. The old API call got the labels and the values in a single query,\n   * but with the new query we need two calls, one to get the labels, and another to get the values.\n   *\n   * @param selector\n   * @param otherLabels\n   */\n  getSeriesLabels: (selector: string, otherLabels: PromQLLabelMatcher[]) => Promise<string[]>;\n  /**\n   * Fetch labels using the best endpoint that datasource supports.\n   * This is cached by its args but also by the global timeRange currently selected as they can change over requested time.\n   * @param name\n   * @param withName\n   */\n  fetchLabelsWithMatch: (name: string, withName?: boolean) => Promise<Record<string, string[]>>;\n  /**\n   * Fetch labels for a series using /series endpoint. This is cached by its args but also by the global timeRange currently selected as\n   * they can change over requested time.\n   * @param name\n   * @param withName\n   * @param withLimit\n   */\n  fetchSeriesLabels: (name: string, withName?: boolean, withLimit?: string) => Promise<Record<string, string[]>>;\n  /**\n   * Fetch labels for a series using /labels endpoint.  This is cached by its args but also by the global timeRange currently selected as\n   * they can change over requested time.\n   * @param name\n   * @param withName\n   */\n  fetchSeriesLabelsMatch: (name: string, withName?: boolean) => Promise<Record<string, string[]>>;\n  /**\n   * Fetch series for a selector. Use this for raw results. Use fetchSeriesLabels() to get labels.\n   * @param match\n   */\n  fetchSeries: (match: string) => Promise<Array<Record<string, string>>>;\n  /**\n   * Fetch this only one as we assume this won't change over time. This is cached differently from fetchSeriesLabels\n   * because we can cache more aggressively here and also we do not want to invalidate this cache the same way as in\n   * fetchSeriesLabels.\n   */\n  fetchDefaultSeries: () => Promise<{}>;\n  /**\n   * Fetch labels or values for a label based on the queries, scopes, filters and time range\n   * @param timeRange\n   * @param queries\n   * @param scopes\n   * @param adhocFilters\n   * @param labelName\n   * @param limit\n   * @param requestId\n   */\n  fetchSuggestions: (\n    timeRange?: TimeRange,\n    queries?: PromQuery[],\n    scopes?: Scope[],\n    adhocFilters?: AdHocVariableFilter[],\n    labelName?: string,\n    limit?: number,\n    requestId?: string\n  ) => Promise<string[]>;\n}\n\nexport function isPrometheusDatasourceV11_6_x(ds: PrometheusRuntimeDatasource): ds is PrometheusRuntimeDatasource & {\n  languageProvider: PromQlLanguageProviderElevenDotSix;\n} {\n  const languageProvider = ds.languageProvider as PromQlLanguageProviderElevenDotSix;\n\n  return (\n    // eslint-disable-next-line sonarjs/deprecation\n    typeof languageProvider.fetchLabelValues === 'function' && languageProvider.fetchLabelValues.length === 1\n  );\n}\n","import {\n  type AbstractQuery,\n  type AdHocVariableFilter,\n  type LanguageProvider,\n  type Scope,\n  type TimeRange,\n} from '@grafana/data';\nimport { type PrometheusDatasource, type PromMetricsMetadata, type PromQuery } from '@grafana/prometheus';\nimport { type BackendSrvRequest } from '@grafana/runtime';\n\nimport { type PrometheusRuntimeDatasource } from 'AppDataTrail/MetricDatasourceHelper/MetricDatasourceHelper';\nimport { type PromQLLabelMatcher } from 'shared/utils/utils.promql';\n\ninterface PromQlLanguageProviderTwelveDotZero extends LanguageProvider {\n  histogramMetrics: string[];\n  metrics: string[];\n  metricsMetadata?: PromMetricsMetadata;\n  startTask: Promise<any>;\n  datasource: PrometheusDatasource;\n  labelKeys: string[];\n  labelFetchTs: number;\n  getDefaultCacheHeaders():\n    | {\n        headers: {\n          'X-Grafana-Cache': string;\n        };\n      }\n    | undefined;\n  cleanText(s: string): string;\n  get syntax(): Prism.Grammar;\n  request: (url: string, defaultValue: any, params?: {}, options?: Partial<BackendSrvRequest>) => Promise<any>;\n  start: (timeRange?: TimeRange) => Promise<any[]>;\n  loadMetricsMetadata(): Promise<void>;\n  getLabelKeys(): string[];\n  importFromAbstractQuery(labelBasedQuery: AbstractQuery): PromQuery;\n  exportToAbstractQuery(query: PromQuery): AbstractQuery;\n  getSeries(timeRange: TimeRange, selector: string, withName?: boolean): Promise<Record<string, string[]>>;\n  fetchLabelValues: (range: TimeRange, key: string) => Promise<string[]>;\n  getLabelValues(range: TimeRange, key: string): Promise<string[]>;\n  /**\n   * Fetches all label keys\n   */\n  fetchLabels: (timeRange: TimeRange, queries?: PromQuery[]) => Promise<string[]>;\n  /**\n   * Gets series values\n   * Function to replace old getSeries calls in a way that will provide faster endpoints\n   * for new prometheus instances, while maintaining backward compatability\n   */\n  getSeriesValues: (timeRange: TimeRange, labelName: string, selector: string) => Promise<string[]>;\n  /**\n   * Fetches all values for a label, with optional match[]\n   * @param name\n   * @param match\n   * @param timeRange\n   * @param requestId\n   */\n  fetchSeriesValuesWithMatch: (\n    timeRange: TimeRange,\n    name: string,\n    match: string,\n    requestId?: string\n  ) => Promise<string[]>;\n  /**\n   * Gets series labels\n   * Function to replace old getSeries calls in a way that will provide faster endpoints for new prometheus instances,\n   * while maintaining backward compatability. The old API call got the labels and the values in a single query,\n   * but with the new query we need two calls, one to get the labels, and another to get the values.\n   *\n   * @param selector\n   * @param otherLabels\n   */\n  getSeriesLabels: (timeRange: TimeRange, selector: string, otherLabels: PromQLLabelMatcher[]) => Promise<string[]>;\n  /**\n   * Fetch labels using the best endpoint that datasource supports.\n   * This is cached by its args but also by the global timeRange currently selected as they can change over requested time.\n   */\n  fetchLabelsWithMatch: (timeRange: TimeRange, name: string, withName?: boolean) => Promise<Record<string, string[]>>;\n  /**\n   * Fetch labels for a series using /series endpoint. This is cached by its args but also by the global timeRange currently selected as\n   * they can change over requested time.\n   */\n  fetchSeriesLabels: (\n    timeRange: TimeRange,\n    name: string,\n    withName?: boolean,\n    withLimit?: string\n  ) => Promise<Record<string, string[]>>;\n  /**\n   * Fetch labels for a series using /labels endpoint.  This is cached by its args but also by the global timeRange currently selected as\n   * they can change over requested time.\n   */\n  fetchSeriesLabelsMatch: (timeRange: TimeRange, name: string, withName?: boolean) => Promise<Record<string, string[]>>;\n  /**\n   * Fetch series for a selector. Use this for raw results. Use fetchSeriesLabels() to get labels.\n   */\n  fetchSeries: (timeRange: TimeRange, match: string) => Promise<Array<Record<string, string>>>;\n  /**\n   * Fetch this only one as we assume this won't change over time. This is cached differently from fetchSeriesLabels\n   * because we can cache more aggressively here and also we do not want to invalidate this cache the same way as in\n   * fetchSeriesLabels.\n   */\n  fetchDefaultSeries: (timeRange: TimeRange) => Promise<{}>;\n  /**\n   * Fetch labels or values for a label based on the queries, scopes, filters and time range\n   * @param timeRange\n   * @param queries\n   * @param scopes\n   * @param adhocFilters\n   * @param labelName\n   * @param limit\n   * @param requestId\n   */\n  fetchSuggestions: (\n    timeRange?: TimeRange,\n    queries?: PromQuery[],\n    scopes?: Scope[],\n    adhocFilters?: AdHocVariableFilter[],\n    labelName?: string,\n    limit?: number,\n    requestId?: string\n  ) => Promise<string[]>;\n}\n\nexport function isPrometheusDatasourceV12_0_0(ds: PrometheusRuntimeDatasource): ds is PrometheusRuntimeDatasource & {\n  languageProvider: PromQlLanguageProviderTwelveDotZero;\n} {\n  const languageProvider = ds.languageProvider as PromQlLanguageProviderTwelveDotZero;\n\n  // eslint-disable-next-line sonarjs/deprecation\n  return typeof languageProvider.fetchLabelValues === 'function' && languageProvider.fetchLabelValues.length > 1;\n}\n","import { type PrometheusDatasource } from '@grafana/prometheus';\n\nimport { type PrometheusRuntimeDatasource } from 'AppDataTrail/MetricDatasourceHelper/MetricDatasourceHelper';\n\nexport function isPrometheusDatasourceV12_1_0Plus(ds: PrometheusRuntimeDatasource): ds is PrometheusDatasource {\n  return typeof (ds.languageProvider as PrometheusDatasource['languageProvider']).queryLabelKeys === 'function';\n}\n","import {\n  type DataSourceGetTagKeysOptions,\n  type DataSourceGetTagValuesOptions,\n  type MetricFindValue,\n  type TimeRange,\n} from '@grafana/data';\nimport {\n  type PrometheusDatasource,\n  type PromMetricsMetadata,\n  type PromMetricsMetadataItem,\n  type PromQuery,\n} from '@grafana/prometheus';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { sceneGraph, type DataSourceVariable, type SceneObject, type VariableValueOption } from '@grafana/scenes';\nimport { type Unsubscribable } from 'rxjs';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\nimport { displayError, displayWarning } from 'MetricsReducer/helpers/displayStatus';\nimport { areArraysEqual } from 'MetricsReducer/metrics-variables/helpers/areArraysEqual';\nimport { MetricsVariable, VAR_METRICS_VARIABLE } from 'MetricsReducer/metrics-variables/MetricsVariable';\nimport { isClassicHistogramMetric } from 'shared/GmdVizPanel/matchers/isClassicHistogramMetric';\nimport { isPrometheusDataSource } from 'shared/utils/utils.datasource';\n\nimport { VAR_DATASOURCE, VAR_DATASOURCE_EXPR } from '../../shared/shared';\nimport { languageProviderVersionIs } from './types/language-provider/versionCheck';\n\n/**\n * When we fetch the Prometheus data source with `@grafana/runtime`, its language provider\n * could be one of multiple flavors that we need to support. We use this type to represent\n * the Prometheus data source before we have checked the version of the language provider.\n * The language provider version is then checked with the `languageProviderVersionIs` helper.\n */\nexport type PrometheusRuntimeDatasource = Omit<PrometheusDatasource, 'languageProvider'> & {\n  languageProvider: unknown;\n};\n\nexport class MetricDatasourceHelper {\n  private initialized = false;\n  private trail: DataTrail;\n  private datasource?: PrometheusRuntimeDatasource;\n  private cache = {\n    metadata: new Map<string, PromMetricsMetadataItem>(),\n    classicHistograms: new Set<string>(),\n  };\n  private subs: Unsubscribable[] = [];\n\n  constructor(trail: DataTrail) {\n    this.trail = trail;\n  }\n\n  private async getRuntimeDatasource(): Promise<PrometheusRuntimeDatasource | undefined> {\n    if (!this.datasource) {\n      const ds = await getDataSourceSrv().get(VAR_DATASOURCE_EXPR, { __sceneObject: { value: this.trail } });\n      this.datasource = isPrometheusDataSource(ds) ? ds : undefined;\n    }\n    return this.datasource;\n  }\n\n  public init() {\n    this.initialized = true;\n    this.reset();\n\n    for (const sub of this.subs) {\n      sub.unsubscribe();\n    }\n\n    this.subs = [];\n\n    const metricsVariable = sceneGraph.findByKeyAndType(this.trail, VAR_METRICS_VARIABLE, MetricsVariable);\n    this.subs.push(\n      metricsVariable.subscribeToState((newState, prevState) => {\n        if (!areArraysEqual(newState.options, prevState.options)) {\n          this.onNewMetrics(newState.options);\n        }\n      })\n    );\n\n    this.onNewMetrics(metricsVariable.state.options);\n  }\n\n  public reset() {\n    // Prevents duplicate metadata fetching during DataTrail initialization.\n    // This method is called twice when landing on a DataTrail:\n    // 1. During activation via init() -> reset()\n    // 2. After activation via onReferencedVariableValueChanged() (called automatically)\n    // The early return prevents the second call from clearing the cache and refetching\n    // metadata that was already loaded during the first call.\n    if (!this.initialized) {\n      return;\n    }\n\n    this.datasource = undefined;\n\n    this.cache = {\n      metadata: new Map(),\n      classicHistograms: new Set(),\n    };\n\n    this.fetchMetricsMetadata().catch(() => {});\n  }\n\n  private onNewMetrics(metricsVariableOptions: VariableValueOption[]) {\n    for (const metricData of metricsVariableOptions) {\n      const name = metricData.value as string;\n\n      if (isClassicHistogramMetric(name)) {\n        this.cache.classicHistograms.add(name);\n      }\n    }\n  }\n\n  /**\n   * Identify native histograms by 2 strategies.\n   * 1. querying classic histograms and all metrics,\n   * then comparing the results and build the collection of native histograms.\n   * 2. querying all metrics and checking if the metric is a histogram type and does not have the bucket suffix.\n   *\n   * classic histogram = test_metric_bucket\n   * native histogram = test_metric\n   */\n  public async isNativeHistogram(metric: string): Promise<boolean> {\n    if (this.cache.classicHistograms.has(metric)) {\n      return false;\n    }\n\n    // Prometheus creates a classic histogram metric, which is useful when the metadata is not available\n    // TODO: add reference for future review\n    if (this.cache.classicHistograms.has(`${metric}_bucket`)) {\n      return true;\n    }\n\n    try {\n      const metadata = await this.getMetadataForMetric(metric);\n      return metadata?.type === 'histogram';\n    } catch (error) {\n      displayWarning([`Error while fetching ${metric} metadata!`, (error as Error).toString()]);\n      return false;\n    }\n  }\n\n  /**\n   * We fetch all the metadata at once in init() but it can lead to inconsistencies in the UI because\n   * it usually takes a couple of Prometheus scrape intervals to have all the metadata available.\n   * Additionally, fetching them separately and caching them once we have a result gives another chance to Prometheus while the user navigates across the app.\n   */\n  public async getMetadataForMetric(metric: string): Promise<PromMetricsMetadataItem | undefined> {\n    if (this.cache.metadata.has(metric)) {\n      return this.cache.metadata.get(metric)!;\n    }\n\n    const ds = await this.getRuntimeDatasource();\n    if (!ds) {\n      return;\n    }\n\n    const response = await (ds.languageProvider as any).request(`/api/v1/metadata?metric=${metric}`);\n    const metadata = response[metric]?.[0];\n\n    if (metadata) {\n      this.cache.metadata.set(metric, metadata);\n    }\n\n    return metadata;\n  }\n\n  private async fetchMetricsMetadata() {\n    const ds = await this.getRuntimeDatasource();\n    if (!ds) {\n      return;\n    }\n\n    const queryMetadata = getQueryMetricsMetadata(ds);\n    let metadata = await queryMetadata();\n\n    if (!metadata) {\n      const loadMetadata = getLoadMetricsMetadata(ds, queryMetadata);\n      metadata = await loadMetadata();\n    }\n\n    if (metadata) {\n      for (const [metric, metricMetadata] of Object.entries(metadata)) {\n        this.cache.metadata.set(metric, metricMetadata);\n      }\n    }\n  }\n\n  /**\n   * Used for additional filtering for adhoc vars labels in Metrics Drilldown.\n   * @param options\n   * @returns\n   */\n  public async getTagKeys(options: DataSourceGetTagKeysOptions<PromQuery>): Promise<MetricFindValue[]> {\n    const ds = await this.getRuntimeDatasource();\n    if (!ds) {\n      return [];\n    }\n\n    const keys = await ds.getTagKeys(options);\n    return keys;\n  }\n\n  /**\n   * Used for additional filtering for adhoc vars label values in Metrics Drilldown.\n   * @param options\n   * @returns\n   */\n  public async getTagValues(options: DataSourceGetTagValuesOptions<PromQuery>) {\n    const ds = await this.getRuntimeDatasource();\n    if (!ds) {\n      return [];\n    }\n\n    options.key = unwrapQuotes(options.key);\n    const keys = await ds.getTagValues(options);\n    return keys;\n  }\n\n  /**\n   * Fetches available labels from a Prometheus datasource with version compatibility.\n   *\n   * This method abstracts the complexity of supporting multiple versions of `@grafana/prometheus`\n   * spanning from 11.6.0 up to the latest 12.x versions. It detects which API style the current\n   * datasource supports and calls the appropriate method with the correct signature.\n   * It handles three different `@grafana/prometheus` API styles:\n   *\n   * 1. **(12.1.0+)**: Uses the modern `queryLabelKeys` method\n   * 2. **(12.0.0)**: Uses `fetchLabelsWithMatch` with timeRange parameter\n   * 3. **(11.6.0-11.x)**: Uses `fetchLabelsWithMatch` without timeRange parameter\n   *\n   * @param params - Configuration object containing datasource, time range, and matcher\n   * @param params.ds - The Prometheus datasource instance\n   * @param params.timeRange - Time range for the query\n   * @param params.matcher - PromQL matcher string to filter labels (e.g., '{job=\"prometheus\"}')\n   * @returns Promise that resolves to an array of available label keys\n   *\n   * @example\n   * ```typescript\n   * const labels = await MetricDatasourceHelper.fetchLabels({\n   *   ds: prometheusDatasource,\n   *   timeRange: { from: 'now-1h', to: 'now' },\n   *   matcher: '{job=\"prometheus\"}'\n   * });\n   * ```\n   */\n  public static fetchLabels(params: FetchLabelsOptions): Promise<string[]> {\n    const { timeRange, matcher } = params;\n    const ds = params.ds;\n\n    if (languageProviderVersionIs['12.1.0-plus'](ds)) {\n      return ds.languageProvider.queryLabelKeys(timeRange, matcher);\n    } else if (languageProviderVersionIs['12.0.0'](ds)) {\n      return ds.languageProvider.fetchLabelsWithMatch(timeRange, matcher).then((labels) => Object.keys(labels));\n    } else if (languageProviderVersionIs['11.6.x'](ds)) {\n      return ds.languageProvider.fetchLabelsWithMatch(matcher).then((labels) => Object.keys(labels));\n    }\n\n    throw new Error('Unsupported language provider version');\n  }\n\n  /**\n   * Fetches available values for a specific label from a Prometheus datasource with version compatibility.\n   *\n   * This method abstracts the complexity of supporting multiple versions of `@grafana/prometheus`\n   * spanning from 11.6.0 up to the latest 12.x versions. It detects which API style the current\n   * datasource supports and calls the appropriate method with the correct signature.\n   * It handles three different `@grafana/prometheus` API styles:\n   *\n   * 1. **(12.1.0+)**: Uses the modern `queryLabelValues` method\n   * 2. **(12.0.0)**: Uses `fetchLabelValues` or `fetchSeriesValuesWithMatch` with timeRange parameter\n   * 3. **(11.6.0-11.x)**: Uses `fetchLabelValues` or `fetchSeriesValuesWithMatch` without timeRange parameter\n   *\n   * @param params - Configuration object containing datasource, label name, time range, and optional matcher\n   * @param params.ds - The Prometheus datasource instance\n   * @param params.labelName - The name of the label to fetch values for (e.g., 'job', 'instance')\n   * @param params.timeRange - Time range for the query\n   * @param params.matcher - Optional PromQL matcher string to filter results (e.g., '{job=\"prometheus\"}')\n   * @returns Promise that resolves to an array of available values for the specified label\n   *\n   * @example\n   * ```typescript\n   * const jobValues = await MetricDatasourceHelper.fetchLabelValues({\n   *   ds: prometheusDatasource,\n   *   labelName: 'job',\n   *   timeRange: { from: 'now-1h', to: 'now' },\n   *   matcher: '{__name__=~\".*_total\"}'\n   * });\n   * ```\n   */\n  public static fetchLabelValues(params: FetchLabelValuesOptions) {\n    const { labelName, timeRange, matcher = '' } = params;\n    const ds = params.ds as PrometheusRuntimeDatasource;\n\n    if (languageProviderVersionIs['12.1.0-plus'](ds)) {\n      return ds.languageProvider.queryLabelValues(timeRange, labelName, matcher);\n    }\n\n    if (languageProviderVersionIs['12.0.0'](ds)) {\n      // If a matcher isn't provided, use the simpler `fetchLabelValues` method.\n      const fetchLabelValuesWithOptionalMatcher = matcher\n        ? ds.languageProvider.fetchSeriesValuesWithMatch\n        : ds.languageProvider.fetchLabelValues;\n\n      return fetchLabelValuesWithOptionalMatcher(timeRange, labelName, matcher);\n    }\n\n    if (languageProviderVersionIs['11.6.x'](ds)) {\n      // If a matcher isn't provided, use the simpler `fetchLabelValues` method.\n      const fetchLabelValuesWithOptionalMatcher = matcher\n        ? ds.languageProvider.fetchSeriesValuesWithMatch\n        : ds.languageProvider.fetchLabelValues;\n\n      return fetchLabelValuesWithOptionalMatcher(labelName, matcher);\n    }\n\n    throw new Error('Unsupported language provider version');\n  }\n\n  public static async getPrometheusDataSourceForScene(\n    sceneObject: SceneObject\n  ): Promise<PrometheusDatasource | undefined> {\n    try {\n      const dsVariable = sceneGraph.findByKey(sceneObject, VAR_DATASOURCE) as DataSourceVariable;\n      const uid = (dsVariable?.state.value as string) ?? '';\n      const ds = await getDataSourceSrv().get({ uid });\n\n      return ds as unknown as PrometheusDatasource; // we trust that VAR_DATASOURCE has been set to a Prometheus datasource\n    } catch (error) {\n      displayError(error as Error, ['Error while getting the Prometheus data source!']);\n      return undefined;\n    }\n  }\n\n  public async getPrometheusBuildInfo(): Promise<PrometheusBuildInfo | undefined> {\n    const ds = await this.getRuntimeDatasource();\n    if (!ds) {\n      return;\n    }\n\n    // request is part of the base Prometheus language provider interface so we shouldn't have to worry about versioning here\n    const response = await (ds.languageProvider as PrometheusDatasource['languageProvider']).request(\n      '/api/v1/status/buildinfo'\n    );\n\n    if (!response.application) {\n      response.application = 'Prometheus';\n      response.repository = 'https://github.com/prometheus/prometheus'; // fix typo in response ;)\n    }\n\n    if (response.buildDate) {\n      response.buildDate = response.buildDate.replace(/(\\d{4})(\\d{2})(\\d{2})(.+)/, '$1-$2-$3');\n    }\n\n    return response;\n  }\n}\n\nexport type PrometheusBuildInfo = {\n  application?: string;\n  version: string;\n  buildDate?: string;\n  branch?: string;\n  repository: string;\n  revision: string;\n};\n\ninterface FetchLabelsOptions {\n  ds: PrometheusRuntimeDatasource;\n  timeRange: TimeRange;\n  matcher: string;\n}\n\ninterface FetchLabelValuesOptions {\n  ds: PrometheusRuntimeDatasource;\n  timeRange: TimeRange;\n  labelName: string;\n  matcher?: string;\n}\n\nexport function getMetricDescription(metadata?: PromMetricsMetadataItem) {\n  if (!metadata) {\n    return undefined;\n  }\n\n  const { type, help, unit } = metadata;\n\n  const lines = [\n    help, //\n    type && `**Type:** *${type}*`,\n    unit && `**Unit:** ${unit}`,\n  ];\n\n  return lines.join('\\n\\n');\n}\n\nfunction unwrapQuotes(value: string): string {\n  if (value === '' || !isWrappedInQuotes(value)) {\n    return value;\n  }\n  return value.slice(1, -1);\n}\n\nfunction isWrappedInQuotes(value: string): boolean {\n  const wrappedInQuotes = /^\".*\"$/;\n  return wrappedInQuotes.test(value);\n}\n\nfunction getQueryMetricsMetadata(ds: PrometheusRuntimeDatasource) {\n  if (languageProviderVersionIs['12.1.0-plus'](ds)) {\n    return ds.languageProvider.queryMetricsMetadata;\n  }\n\n  if (languageProviderVersionIs['12.0.0'](ds) || languageProviderVersionIs['11.6.x'](ds)) {\n    return () => Promise.resolve(ds.languageProvider.metricsMetadata);\n  }\n\n  throw new Error('Unsupported language provider version');\n}\n\nfunction getLoadMetricsMetadata(\n  ds: PrometheusRuntimeDatasource,\n  queryMetadata: () => Promise<PromMetricsMetadata | undefined>\n) {\n  if (languageProviderVersionIs['12.1.0-plus'](ds)) {\n    return ds.languageProvider.retrieveMetricsMetadata;\n  }\n\n  if (languageProviderVersionIs['12.0.0'](ds) || languageProviderVersionIs['11.6.x'](ds)) {\n    return () => (ds.languageProvider.loadMetricsMetadata?.() ?? Promise.resolve()).then(() => queryMetadata());\n  }\n\n  throw new Error('Unsupported language provider version');\n}\n","import {\n  type AdHocFiltersVariable,\n  type CustomVariable,\n  type QueryVariable,\n  type SceneVariable,\n} from '@grafana/scenes';\n\ntype MaybeVariable = SceneVariable | null | undefined;\n\nexport function isAdHocFiltersVariable(variable: MaybeVariable): variable is AdHocFiltersVariable {\n  return variable !== null && variable?.state.type === 'adhoc';\n}\n\nexport function isCustomVariable(variable: MaybeVariable): variable is CustomVariable {\n  return variable !== null && variable?.state.type === 'custom';\n}\n\nexport function isQueryVariable(variable: MaybeVariable): variable is QueryVariable {\n  return variable !== null && variable?.state.type === 'query';\n}\n","import {\n  FieldType,\n  LoadingState,\n  type DataQueryResponse,\n  type LegacyMetricFindQueryOptions,\n  type MetricFindValue,\n  type TestDataSourceResponse,\n} from '@grafana/data';\nimport { type PrometheusDatasource } from '@grafana/prometheus';\nimport { RuntimeDataSource, sceneGraph, type SceneObject } from '@grafana/scenes';\n\nimport { MetricDatasourceHelper } from 'AppDataTrail/MetricDatasourceHelper/MetricDatasourceHelper';\nimport { VAR_FILTERS } from 'shared/shared';\nimport { isAdHocFiltersVariable } from 'shared/utils/utils.variables';\n\nimport { displayWarning } from '../helpers/displayStatus';\nimport { localeCompare } from '../helpers/localCompare';\n\n// TODO can we get rid of it and use e.g. undefined or an empty string?\nexport const NULL_GROUP_BY_VALUE = '(none)';\n\nexport class LabelsDataSource extends RuntimeDataSource {\n  static readonly uid = 'grafana-prometheus-labels-datasource';\n\n  constructor() {\n    super(LabelsDataSource.uid, LabelsDataSource.uid);\n  }\n\n  async query(): Promise<DataQueryResponse> {\n    return {\n      state: LoadingState.Done,\n      data: [\n        {\n          name: 'Labels',\n          fields: [\n            {\n              name: null,\n              type: FieldType.other,\n              values: [],\n              config: {},\n            },\n          ],\n          length: 0,\n        },\n      ],\n    };\n  }\n\n  async metricFindQuery(matcher: string, options: LegacyMetricFindQueryOptions): Promise<MetricFindValue[]> {\n    const sceneObject = options.scopedVars?.__sceneObject?.valueOf() as SceneObject;\n\n    const ds = await MetricDatasourceHelper.getPrometheusDataSourceForScene(sceneObject);\n    if (!ds) {\n      return [];\n    }\n\n    const [, labelName] = matcher.match(/valuesOf\\((.+)\\)/) ?? [];\n    if (labelName) {\n      const labelValues = await LabelsDataSource.fetchLabelValues(labelName, sceneObject);\n      return labelValues.map((value) => ({ value, text: value }));\n    }\n\n    let labelOptions: MetricFindValue[] = [];\n\n    try {\n      labelOptions = await this.fetchLabels(ds, sceneObject, matcher);\n    } catch (error) {\n      displayWarning(['Error while fetching labels! Defaulting to an empty array.', (error as Error).toString()]);\n    }\n\n    return [{ value: NULL_GROUP_BY_VALUE, text: '(none)' }, ...labelOptions] as MetricFindValue[];\n  }\n\n  private async fetchLabels(ds: PrometheusDatasource, sceneObject: SceneObject, matcher: string) {\n    // there is probably a more graceful way to implement this, but this is what the DS offers us.\n    // if a DS does not support the labels match API, we need getTagKeys to handle the empty matcher\n    if (!LabelsDataSource.getLabelsMatchAPISupport(ds)) {\n      // the Prometheus series endpoint cannot accept an empty matcher\n      // when there are no filters, we cannot send the matcher passed to this function because Prometheus evaluates it as empty and returns an error\n      const filters = LabelsDataSource.getFiltersFromVariable(sceneObject);\n      const response = await ds.getTagKeys(filters);\n\n      return this.processLabelOptions(\n        response.map(({ text }) => ({\n          value: text,\n          text,\n        }))\n      );\n    }\n\n    const response = await MetricDatasourceHelper.fetchLabels({\n      ds,\n      timeRange: sceneGraph.getTimeRange(sceneObject).state.value,\n      matcher,\n    });\n\n    return this.processLabelOptions(\n      response.map((label) => ({\n        value: label,\n        text: label,\n      }))\n    );\n  }\n\n  private static getLabelsMatchAPISupport(ds: PrometheusDatasource) {\n    try {\n      return ds.hasLabelsMatchAPISupport();\n    } catch (error) {\n      displayWarning([\n        'Error while checking if the current data source supports the labels match API! Defaulting to false.',\n        (error as Error).toString(),\n      ]);\n      return false;\n    }\n  }\n\n  private static getFiltersFromVariable(sceneObject: SceneObject): { filters: any[] } {\n    const filtersVariable = sceneGraph.lookupVariable(VAR_FILTERS, sceneObject);\n\n    if (isAdHocFiltersVariable(filtersVariable)) {\n      return { filters: filtersVariable.state.filters };\n    }\n\n    return { filters: [] };\n  }\n\n  private processLabelOptions(options: Array<{ value: string; text: string }>): Array<{ value: string; text: string }> {\n    return options.filter(({ value }) => !value.startsWith('__')).sort((a, b) => localeCompare(a.value, b.value));\n  }\n\n  static async fetchLabelValues(labelName: string, sceneObject: SceneObject): Promise<string[]> {\n    const ds = await MetricDatasourceHelper.getPrometheusDataSourceForScene(sceneObject);\n    if (!ds) {\n      return [];\n    }\n\n    try {\n      return await MetricDatasourceHelper.fetchLabelValues({\n        ds,\n        labelName,\n        timeRange: sceneGraph.getTimeRange(sceneObject).state.value,\n      });\n    } catch (error) {\n      displayWarning([\n        `Error while retrieving label \"${labelName}\" values! Defaulting to an empty array.`,\n        (error as Error).toString(),\n      ]);\n      return [];\n    }\n  }\n\n  async testDatasource(): Promise<TestDataSourceResponse> {\n    return {\n      status: 'success',\n      message: 'OK',\n    };\n  }\n}\n","import { css } from '@emotion/css';\nimport { VariableHide, VariableRefresh, type GrafanaTheme2 } from '@grafana/data';\nimport {\n  AdHocFiltersVariable,\n  DataSourceVariable,\n  QueryVariable,\n  sceneGraph,\n  type MultiValueVariable,\n  type SceneComponentProps,\n} from '@grafana/scenes';\nimport { Label, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { localeCompare } from 'MetricsReducer/helpers/localCompare';\nimport { VAR_DATASOURCE, VAR_FILTERS, VAR_FILTERS_EXPR } from 'shared/shared';\n\nimport { LabelsDataSource, NULL_GROUP_BY_VALUE } from './LabelsDataSource';\n\nexport const VAR_WINGMAN_GROUP_BY = 'labelsWingman';\n\nexport class LabelsVariable extends QueryVariable {\n  constructor() {\n    super({\n      key: VAR_WINGMAN_GROUP_BY,\n      name: VAR_WINGMAN_GROUP_BY,\n      label: 'Group by label',\n      placeholder: 'Group by label...',\n      datasource: { uid: LabelsDataSource.uid },\n      query: '',\n      includeAll: false,\n      isMulti: false,\n      allowCustomValue: false,\n      refresh: VariableRefresh.onTimeRangeChanged,\n      hide: VariableHide.hideVariable,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  onActivate() {\n    this.subscribeToState((newState, prevState) => {\n      if (newState.query !== prevState.query) {\n        // store the current value in a static option so we can preserve it in the UI even if new options don't contain it\n        this.setState({\n          staticOptions: [{ value: newState.value as string, label: newState.value as string }],\n        });\n\n        this.refreshOptions();\n      }\n\n      if (newState.options !== prevState.options) {\n        const { value } = this.state;\n\n        if (newState.options.some((o) => o.value === value)) {\n          this.setState({\n            staticOptions: [],\n            // eslint-disable-next-line sonarjs/no-misleading-array-reverse\n            options: newState.options.sort((a, b) => localeCompare(a.label, b.label)),\n          });\n        }\n      }\n    });\n\n    this._subs.add(\n      sceneGraph.findByKeyAndType(this, VAR_DATASOURCE, DataSourceVariable).subscribeToState((newState, prevState) => {\n        if (newState.value !== prevState.value) {\n          this.setState({ value: NULL_GROUP_BY_VALUE });\n          this.refreshOptions();\n        }\n      })\n    );\n\n    this._subs.add(\n      sceneGraph.findByKeyAndType(this, VAR_FILTERS, AdHocFiltersVariable).subscribeToState((newState, prevState) => {\n        if (newState.filterExpression !== prevState.filterExpression) {\n          this.updateQuery();\n        }\n      })\n    );\n\n    // hack to ensure that labels are loaded when landing: sometimes filters are not interpolated and fetching labels give no results\n    this.updateQuery();\n  }\n\n  private updateQuery() {\n    const filterExpression = sceneGraph.interpolate(this, VAR_FILTERS_EXPR, {});\n    this.setState({ query: `{__name__=~\".+\",${filterExpression}}` });\n  }\n\n  static readonly Component = ({ model }: SceneComponentProps<MultiValueVariable>) => {\n    const styles = useStyles2(getStyles);\n    const { label } = model.useState();\n\n    return (\n      <div className={styles.container}>\n        <Label className={styles.label}>{label}</Label>\n        <QueryVariable.Component model={model} />\n      </div>\n    );\n  };\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  container: css`\n    display: flex;\n    align-items: center;\n    gap: 0;\n\n    [class*='input-wrapper'] {\n      width: 240px;\n    }\n  `,\n  label: css`\n    height: 32px;\n    white-space: nowrap;\n    margin: 0;\n    background-color: ${theme.colors.background.primary};\n    padding: ${theme.spacing(1)};\n    border-radius: ${theme.shape.radius.default};\n    border: 1px solid ${theme.colors.border.weak};\n    border-right: none;\n  `,\n});\n","import { BusEventWithPayload } from '@grafana/data';\n\nimport { type SortingOption } from '../MetricsSorter';\n\ninterface EventSortByChangedPayload {\n  sortBy: SortingOption;\n}\n\nexport class EventSortByChanged extends BusEventWithPayload<EventSortByChangedPayload> {\n  public static readonly type = 'sort-by-changed';\n}\n","import { getBackendSrv, type BackendSrvRequest } from '@grafana/runtime';\n\nimport { logger } from 'shared/logger/logger';\n\nimport { extractMetricNames } from '../../../../shared/utils/utils.promql';\n\nimport type { MetricUsageDetails } from './fetchDashboardMetrics';\ninterface AlertingRule {\n  id: number;\n  uid: string;\n  title: string;\n  data: Array<{\n    refId: string;\n    queryType: string;\n    datasourceUid: string;\n    model: {\n      expr?: string;\n      expression?: string;\n      type?: string;\n      datasource?: {\n        type: string;\n        uid: string;\n      };\n    };\n  }>;\n}\n\nconst usageRequestOptions: Partial<BackendSrvRequest> = {\n  showSuccessAlert: false,\n  showErrorAlert: false,\n} as const;\n\n// TODO: update parseAlertingRules to do what the dashboards function does\nfunction transformCountsToAlertingUsage(counts: Record<string, number>): Record<string, MetricUsageDetails> {\n  const result: Record<string, MetricUsageDetails> = {};\n  for (const metric in counts) {\n    result[metric] = {\n      usageType: 'alerting-usage',\n      count: counts[metric],\n    };\n  }\n  return result;\n}\n\n/**\n * Fetches metric usage data from alerting rules\n * @returns A record mapping metric names to their occurrence count in alerting rules\n */\nexport async function fetchAlertingMetrics(): Promise<Record<string, MetricUsageDetails>> {\n  try {\n    const alertingRules = await getBackendSrv().get<AlertingRule[]>(\n      '/api/v1/provisioning/alert-rules',\n      undefined,\n      'grafana-metricsdrilldown-app-alert-rule-metric-usage',\n      usageRequestOptions\n    );\n\n    const metricCounts = await parseAlertingRules(alertingRules);\n    return transformCountsToAlertingUsage(metricCounts);\n  } catch (err) {\n    const error = typeof err === 'string' ? new Error(err) : (err as Error);\n    logger.error(error, {\n      message: 'Failed to fetch alerting rules',\n    });\n    // Return empty object when fetch fails\n    return {};\n  }\n}\n\nasync function parseAlertingRules(alertingRules: AlertingRule[]): Promise<Record<string, number>> {\n  // Create a map to count metric occurrences\n  const metricCounts: Record<string, number> = {};\n\n  const relevantRules = alertingRules.filter((rule) => rule?.data.length > 0);\n\n  for (const rule of relevantRules) {\n    // Skip non-Prometheus queries or expression queries (like threshold or reduce expressions)\n    const prometheusQueries = rule.data.filter(\n      (query) => typeof query.model?.expr === 'string' && query.datasourceUid !== '__expr__'\n    );\n\n    const queryPromises = prometheusQueries.map(async (query) => {\n      try {\n        // Extract metrics from the PromQL expression\n        const metrics = await extractMetricNames(query.model.expr as string);\n\n        // Count each metric occurrence\n        for (const metric of metrics) {\n          metricCounts[metric] = (metricCounts[metric] || 0) + 1;\n        }\n      } catch (error) {\n        // Log parsing errors but continue processing other expressions\n        logger.warn(error, {\n          message: `Failed to parse PromQL expression in alert rule ${rule.title}`,\n        });\n      }\n    });\n\n    await Promise.all(queryPromises);\n  }\n\n  return metricCounts;\n}\n","import { getBackendSrv, type BackendSrvRequest } from '@grafana/runtime';\nimport { type Dashboard, type Panel } from '@grafana/schema';\nimport { limitFunction } from 'p-limit';\n\nimport { logger } from 'shared/logger/logger';\n\nimport { isPrometheusDataSource } from '../../../../shared/utils/utils.datasource';\nimport { extractMetricNames } from '../../../../shared/utils/utils.promql';\n\ninterface DashboardSearchItem {\n  id: number;\n  uid: string;\n  title: string;\n  url: string;\n  folderTitle?: string;\n  folderUid?: string;\n  tags: string[];\n  isStarred: boolean;\n}\n\nexport type MetricUsageDetails =\n  | {\n      usageType: 'dashboard-usage';\n      count: number;\n      dashboards: Record<string, { count: number; uid: string; url: string }>;\n    } // e.g., {\"Dashboard A\": { count: 2, uid: \"123\" }}\n  | { usageType: 'alerting-usage'; count: number }; // TODO: implement `alerts: Record<string, number>`\n\ntype MetricUsageMap = Record<string, MetricUsageDetails>;\n\nconst usageRequestOptions: Partial<BackendSrvRequest> = {\n  showSuccessAlert: false,\n  showErrorAlert: false,\n} as const;\n\ntype DashboardWithUrl = Dashboard & { url: string };\n\nconst dashboardRequestMap = new Map<string, Promise<DashboardWithUrl | null>>();\n\nconst getDashboardLimited = limitFunction(\n  async (dashboardUid: string, url, dashboardRequestsFailedCount: number) => {\n    let promise = dashboardRequestMap.get(dashboardUid);\n\n    if (!promise) {\n      promise = getBackendSrv()\n        .get<{ dashboard: Dashboard }>(\n          `/api/dashboards/uid/${dashboardUid}`,\n          undefined,\n          `grafana-metricsdrilldown-app-dashboard-metric-usage-${dashboardUid}`,\n          usageRequestOptions\n        )\n        .then(({ dashboard }) => ({ ...dashboard, url } as DashboardWithUrl))\n        .catch((error) => {\n          // Prevent excessive noise\n          if (dashboardRequestsFailedCount <= 5) {\n            logger.error(error, { dashboardUid });\n          }\n\n          dashboardRequestsFailedCount++;\n          return Promise.resolve(null);\n        })\n        .finally(() => {\n          dashboardRequestMap.delete(dashboardUid);\n        });\n      dashboardRequestMap.set(dashboardUid, promise);\n    }\n\n    return promise;\n  },\n  { concurrency: 50 }\n);\n\n/**\n * Fetches metric usage data from dashboards\n * @returns A record mapping metric names to their dashboard usage data\n */\nexport async function fetchDashboardMetrics(): Promise<Record<string, MetricUsageDetails>> {\n  try {\n    const dashboards = await getBackendSrv().get<DashboardSearchItem[]>(\n      '/api/search',\n      {\n        type: 'dash-db',\n        limit: 500,\n      },\n      'grafana-metricsdrilldown-app-dashboard-search',\n      usageRequestOptions\n    );\n\n    let dashboardRequestsFailedCount = 0;\n\n    const metricCounts = await Promise.all(\n      dashboards.map(({ uid, url }) => getDashboardLimited(uid, url, dashboardRequestsFailedCount))\n    ).then(async (response) => await parseDashboardSearchResponse(response));\n\n    return metricCounts;\n  } catch (err) {\n    const error = typeof err === 'string' ? new Error(err) : (err as Error);\n    logger.error(error, {\n      message: 'Failed to fetch dashboard metrics',\n    });\n    return {};\n  }\n}\n\nfunction getDashboardsWithPanels(\n  dashboardSearchResponse: Array<DashboardWithUrl | null>\n): Array<DashboardWithUrl & { panels: NonNullable<Panel[]> }> {\n  return dashboardSearchResponse.filter((dashboard) => dashboard && dashboard?.panels?.length) as Array<\n    DashboardWithUrl & { panels: NonNullable<Panel[]> }\n  >;\n}\n\nfunction getPanelsWithTargets(panels: Panel[]): Array<Panel & { targets: NonNullable<Panel['targets']> }> {\n  return panels.filter(\n    (panel) => isPrometheusDataSource(panel.datasource) && 'targets' in panel && panel.targets?.length\n  ) as Array<Panel & { targets: NonNullable<Panel['targets']> }>;\n}\n\nasync function processTargetsForMetrics(\n  targets: NonNullable<Panel['targets']>,\n  dashboardName: string,\n  dashboardUid: string,\n  dashboardUrl: string,\n  dashboardData: Record<string, MetricUsageDetails>\n): Promise<void> {\n  for (const target of targets) {\n    const expr = typeof target.expr === 'string' ? target.expr : '';\n    const metrics = await extractMetricNames(expr);\n\n    for (const metric of metrics) {\n      updateMetricUsage(metric, dashboardName, dashboardUid, dashboardUrl, dashboardData);\n    }\n  }\n}\n\nfunction updateMetricUsage(\n  metric: string,\n  dashboardName: string,\n  dashboardUid: string,\n  dashboardUrl: string,\n  dashboardData: Record<string, MetricUsageDetails>\n): void {\n  if (!dashboardData[metric]) {\n    dashboardData[metric] = { usageType: 'dashboard-usage', count: 0, dashboards: {} };\n  }\n\n  dashboardData[metric].count++;\n  if (dashboardData[metric].usageType === 'dashboard-usage') {\n    dashboardData[metric].dashboards[dashboardName] = {\n      count: (dashboardData[metric].dashboards[dashboardName]?.count || 0) + 1,\n      uid: dashboardUid || 'unknown',\n      url: dashboardUrl,\n    };\n  }\n}\n\nasync function parseDashboardSearchResponse(\n  dashboardSearchResponse: Array<DashboardWithUrl | null>\n): Promise<MetricUsageMap> {\n  // Create a map to track metric names and their usage details\n  const dashboardData: Record<string, MetricUsageDetails> = {};\n\n  for (const dashboard of getDashboardsWithPanels(dashboardSearchResponse)) {\n    for (const panel of getPanelsWithTargets(dashboard.panels)) {\n      await processTargetsForMetrics(\n        panel.targets,\n        dashboard.title || `Dashboard ${dashboard.uid}`,\n        dashboard.uid || 'unknown',\n        dashboard.url,\n        dashboardData\n      );\n    }\n  }\n\n  return dashboardData;\n}\n","import { fetchAlertingMetrics } from './fetchers/fetchAlertingMetrics';\nimport { fetchDashboardMetrics, type MetricUsageDetails } from './fetchers/fetchDashboardMetrics';\n\ninterface MetricsUsageState {\n  metrics: Record<string, MetricUsageDetails>;\n  metricsPromise: Promise<Record<string, MetricUsageDetails>> | undefined;\n  fetcher: () => Promise<Record<string, MetricUsageDetails>>;\n}\n\nexport type MetricUsageType = 'dashboard-usage' | 'alerting-usage';\n// Fetches and stores metric usage data for dashboards and alerting rules\nexport class MetricUsageFetcher {\n  private _usageState: Record<MetricUsageType, MetricsUsageState> = {\n    'dashboard-usage': {\n      metrics: {},\n      metricsPromise: undefined,\n      fetcher: fetchDashboardMetrics,\n    },\n    'alerting-usage': {\n      metrics: {},\n      metricsPromise: undefined,\n      fetcher: fetchAlertingMetrics,\n    },\n  };\n\n  public getUsageMetrics(usageType: MetricUsageType): Promise<Record<string, MetricUsageDetails>> {\n    const hasExistingMetrics =\n      this._usageState[usageType].metrics && Object.keys(this._usageState[usageType].metrics).length > 0;\n\n    if (hasExistingMetrics) {\n      return Promise.resolve(this._usageState[usageType].metrics);\n    }\n\n    if (!this._usageState[usageType].metricsPromise) {\n      this._usageState[usageType].metricsPromise = this._usageState[usageType].fetcher().then((metrics) => {\n        this._usageState[usageType].metrics = metrics;\n        this._usageState[usageType].metricsPromise = undefined;\n        return metrics;\n      });\n    }\n\n    return this._usageState[usageType].metricsPromise;\n  }\n\n  public getUsageForMetric(metricName: string, usageType: MetricUsageType): Promise<number> {\n    return this.getUsageMetrics(usageType).then((metrics) => metrics[metricName]?.count ?? 0);\n  }\n\n  public getUsageDetailsForMetric(metricName: string, usageType: MetricUsageType): Promise<MetricUsageDetails> {\n    return this.getUsageMetrics(usageType).then(\n      (metrics) =>\n        metrics[metricName] ??\n        (usageType === 'dashboard-usage'\n          ? { usageType: 'dashboard-usage', count: 0, dashboards: {} }\n          : { usageType: 'alerting-usage', count: 0 })\n    );\n  }\n}\n","import {\n  CustomVariable,\n  sceneGraph,\n  SceneObjectBase,\n  SceneVariableSet,\n  VariableValueSelectors,\n  type SceneComponentProps,\n  type SceneObject,\n  type SceneObjectState,\n  type VariableValueOption,\n} from '@grafana/scenes';\nimport React from 'react';\n\nimport { localeCompare } from 'MetricsReducer/helpers/localCompare';\nimport { logger } from 'shared/logger/logger';\nimport { PREF_KEYS } from 'shared/user-preferences/pref-keys';\nimport { userStorage } from 'shared/user-preferences/userStorage';\n\nimport { EventSortByChanged } from './events/EventSortByChanged';\nimport { type MetricUsageDetails } from './fetchers/fetchDashboardMetrics';\nimport { MetricUsageFetcher, type MetricUsageType } from './MetricUsageFetcher';\nexport type SortingOption = 'default' | 'dashboard-usage' | 'alerting-usage';\n\nconst MAX_RECENT_METRICS = 6;\nconst RECENT_METRICS_EXPIRY_DAYS = 30;\n\ninterface RecentMetric {\n  name: string;\n  timestamp: number;\n}\n\n/**\n * Adds a metric to the recent metrics list in localStorage\n * @param metricName The name of the metric to add\n */\nexport function addRecentMetric(metricName: string): void {\n  try {\n    const recentMetrics = getRecentMetrics();\n    const now = Date.now();\n\n    // Remove the metric if it already exists and add it with new timestamp\n    const filteredMetrics = recentMetrics.filter((m) => m.name !== metricName);\n    filteredMetrics.unshift({ name: metricName, timestamp: now });\n\n    // Keep only the most recent metrics\n    const updatedMetrics = filteredMetrics.slice(0, MAX_RECENT_METRICS);\n    userStorage.setItem(PREF_KEYS.RECENT_METRICS, updatedMetrics);\n  } catch (error) {\n    const errorObject = error instanceof Error ? error : new Error(String(error));\n\n    logger.error(errorObject, {\n      ...(errorObject.cause || {}),\n      metricName,\n    });\n  }\n}\n\n/**\n * Gets the list of recent metrics from localStorage, removing expired ones\n * @returns Array of recent metric names\n */\nexport function getRecentMetrics(): RecentMetric[] {\n  try {\n    const recentMetrics: RecentMetric[] = userStorage.getItem(PREF_KEYS.RECENT_METRICS) || [];\n    if (!recentMetrics.length) {\n      return [];\n    }\n\n    const now = Date.now();\n    const thirtyDaysAgo = now - RECENT_METRICS_EXPIRY_DAYS * 24 * 60 * 60 * 1000;\n\n    // Filter out expired metrics\n    const validMetrics = recentMetrics.filter((metric) => metric.timestamp > thirtyDaysAgo);\n\n    // If any metrics were removed, update storage\n    if (validMetrics.length !== recentMetrics.length) {\n      userStorage.setItem(PREF_KEYS.RECENT_METRICS, validMetrics);\n    }\n\n    return validMetrics;\n  } catch (error) {\n    logger.error(error as Error, { message: 'Failed to get recent metrics:' });\n    return [];\n  }\n}\n\ninterface MetricsSorterState extends SceneObjectState {\n  $variables: SceneVariableSet;\n  inputControls: SceneObject;\n}\n\nconst sortByOptions: VariableValueOption[] = [\n  { label: 'Default', value: 'default' },\n  { label: 'Dashboard Usage', value: 'dashboard-usage' },\n  { label: 'Alerting Usage', value: 'alerting-usage' },\n] as const;\n\nexport const VAR_WINGMAN_SORT_BY = 'metrics-reducer-sort-by';\n\nexport class MetricsSorter extends SceneObjectBase<MetricsSorterState> {\n  initialized = false;\n  supportedSortByOptions = new Set<SortingOption>(['default', 'dashboard-usage', 'alerting-usage']);\n  private usageFetcher = new MetricUsageFetcher();\n\n  constructor(state: Partial<MetricsSorterState>) {\n    super({\n      ...state,\n      key: 'metrics-sorter',\n      $variables: new SceneVariableSet({\n        variables: [\n          new CustomVariable({\n            name: VAR_WINGMAN_SORT_BY,\n            label: 'Sort by',\n            value: 'default',\n            query: sortByOptions.map((option) => `${option.label} : ${option.value}`).join(','),\n            description:\n              'Sort metrics by default (alphabetically, with recently-selected metrics first), by prevalence in dashboard panel queries, or by prevalence in alerting rules',\n          }),\n        ],\n      }),\n      inputControls: new VariableValueSelectors({ layout: 'horizontal' }),\n    });\n\n    this.addActivationHandler(() => this.activationHandler());\n  }\n\n  private activationHandler() {\n    const sortByVar = sceneGraph.getVariables(this).getByName(VAR_WINGMAN_SORT_BY) as CustomVariable;\n\n    if (!this.supportedSortByOptions.has(sortByVar.getValue() as SortingOption)) {\n      // Migration for the old sortBy values\n      sortByVar.changeValueTo('default');\n    }\n\n    this._subs.add(\n      sortByVar.subscribeToState((newState, prevState) => {\n        if (newState.value !== prevState.value) {\n          this.publishEvent(new EventSortByChanged({ sortBy: newState.value as SortingOption }), true);\n        }\n      })\n    );\n  }\n\n  public getUsageDetailsForMetric(metricName: string, usageType: MetricUsageType): Promise<MetricUsageDetails> {\n    return this.usageFetcher.getUsageDetailsForMetric(metricName, usageType);\n  }\n\n  // Converts MetricUsageDetails format to simple counts (Record<string, number>) for backward compatibility with sorting logic\n  public getUsageMetrics(usageType: MetricUsageType): Promise<Record<string, number>> {\n    return this.usageFetcher.getUsageMetrics(usageType).then((metrics) => {\n      const metricsToCounts: Record<string, number> = {};\n      for (const metric in metrics) {\n        metricsToCounts[metric] = metrics[metric].count;\n      }\n      return metricsToCounts;\n    });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<MetricsSorter>) => {\n    const { inputControls } = model.useState();\n\n    return (\n      <div data-testid=\"sort-by-select\">\n        <inputControls.Component model={inputControls} />\n      </div>\n    );\n  };\n}\n\n/**\n * Sort metrics by an arbitrary count (descending)\n * @param metrics Array of metric names\n * @param counts A record mapping metric names to an arbitrary count\n * @returns Sorted array of metric names\n */\nexport function sortMetricsByCount(metrics: string[], counts: Record<string, number>): string[] {\n  return [...metrics].sort((a, b) => {\n    const scoreA = counts[a] || 0;\n    const scoreB = counts[b] || 0;\n\n    // Primary sort by score (descending)\n    if (scoreB !== scoreA) {\n      return scoreB - scoreA;\n    }\n\n    // Secondary sort alphabetically for metrics with the same score\n    return localeCompare(a, b);\n  });\n}\n\n/**\n * Sort metrics in alphabetical order\n * @param metrics Array of metric names\n * @returns Sorted array of metric names in alphabetical order\n */\nfunction sortMetricsAlphabetically(metrics: string[]): string[] {\n  return [...metrics].sort((a, b) => localeCompare(a, b));\n}\n\n/**\n * Sort metrics with recent metrics first (by recency), then alphabetically\n * @param metrics Array of metric names\n * @returns Sorted array of metric names\n */\nexport function sortMetricsWithRecentFirst(metrics: string[]): string[] {\n  const allRecentMetrics = getRecentMetrics().map((m) => m.name);\n  const allRecentMetricsSet = new Set(allRecentMetrics);\n  const [recent, nonRecent] = metrics.reduce<[string[], string[]]>(\n    ([recent, nonRecent], metric) => {\n      if (allRecentMetricsSet.has(metric)) {\n        recent.push(metric);\n      } else {\n        nonRecent.push(metric);\n      }\n      return [recent, nonRecent];\n    },\n    [[], []]\n  );\n  const sortedNonRecent = sortMetricsAlphabetically(nonRecent);\n  // `recentMetrics` are already sorted by recency, so we just need to filter them\n  const sortedRecent = allRecentMetrics.filter((m) => recent.includes(m));\n\n  return [...sortedRecent, ...sortedNonRecent];\n}\n","import {\n  SceneObjectBase,\n  SceneObjectUrlSyncConfig,\n  type SceneComponentProps,\n  type SceneObjectState,\n  type SceneObjectUrlValues,\n} from '@grafana/scenes';\nimport { RadioButtonGroup } from '@grafana/ui';\nimport React from 'react';\n\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\n\nexport enum LayoutType {\n  GRID = 'grid',\n  ROWS = 'rows',\n  SINGLE = 'single',\n}\n\nexport interface LayoutSwitcherState extends SceneObjectState {\n  urlSearchParamName: string;\n  layout: LayoutType;\n  options: Array<{ label: string; value: LayoutType }>;\n}\n\nexport class LayoutSwitcher extends SceneObjectBase<LayoutSwitcherState> {\n  protected _urlSync = new SceneObjectUrlSyncConfig(this, {\n    keys: [this.state.urlSearchParamName],\n  });\n\n  static readonly DEFAULT_OPTIONS = [\n    { label: 'Grid', value: LayoutType.GRID },\n    { label: 'Rows', value: LayoutType.ROWS },\n  ];\n\n  static readonly DEFAULT_LAYOUT = LayoutType.GRID;\n\n  constructor({\n    urlSearchParamName,\n    options,\n  }: {\n    urlSearchParamName?: LayoutSwitcherState['urlSearchParamName'];\n    options?: LayoutSwitcherState['options'];\n  }) {\n    super({\n      key: 'layout-switcher',\n      urlSearchParamName: urlSearchParamName || 'layout',\n      options: options || LayoutSwitcher.DEFAULT_OPTIONS,\n      layout: LayoutSwitcher.DEFAULT_LAYOUT,\n    });\n  }\n\n  getUrlState() {\n    return {\n      [this.state.urlSearchParamName]: this.state.layout,\n    };\n  }\n\n  updateFromUrl(values: SceneObjectUrlValues) {\n    const stateUpdate: Partial<LayoutSwitcherState> = {};\n    const newLayout = values[this.state.urlSearchParamName] as LayoutType;\n\n    if (newLayout !== this.state.layout) {\n      stateUpdate.layout = this.state.options.find((o) => o.value === newLayout)\n        ? newLayout\n        : LayoutSwitcher.DEFAULT_LAYOUT;\n    }\n\n    this.setState(stateUpdate);\n  }\n\n  private onChange = (layout: LayoutType) => {\n    reportExploreMetrics('layout_changed', { layout });\n    this.setState({ layout });\n  };\n\n  static readonly Component = ({ model }: SceneComponentProps<LayoutSwitcher>) => {\n    const { options, layout } = model.useState();\n\n    return (\n      <RadioButtonGroup\n        aria-label=\"Layout switcher\"\n        options={options}\n        value={layout}\n        onChange={model.onChange}\n        fullWidth={false}\n      />\n    );\n  };\n}\n","import { CustomVariable, sceneGraph } from '@grafana/scenes';\n\nimport { MetricsVariable, VAR_METRICS_VARIABLE } from './MetricsVariable';\nimport { withLifecycleEvents } from './withLifecycleEvents';\n\nexport const VAR_FILTERED_METRICS_VARIABLE = 'filtered-metrics-wingman';\n\nexport class FilteredMetricsVariable extends CustomVariable {\n  constructor() {\n    super({\n      key: VAR_FILTERED_METRICS_VARIABLE,\n      name: VAR_FILTERED_METRICS_VARIABLE,\n      label: 'Filtered Metrics',\n      loading: false,\n      error: null,\n      options: [],\n      includeAll: true,\n      value: '$__all',\n      skipUrlSync: true,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n\n    // required for filtering and sorting\n    return withLifecycleEvents<FilteredMetricsVariable>(this);\n  }\n\n  private onActivate() {\n    const metricsVariable = sceneGraph.findByKeyAndType(this, VAR_METRICS_VARIABLE, MetricsVariable);\n    const { loading, error, options } = metricsVariable.state;\n\n    this.setState({ loading, error, options });\n\n    this._subs.add(\n      metricsVariable.subscribeToState((newState) => {\n        this.setState({\n          loading: newState.loading,\n          error: newState.error,\n          options: newState.options,\n        });\n      })\n    );\n  }\n}\n","import { SceneObjectBase, type SceneObjectState } from '@grafana/scenes';\n\nexport type CountsData = {\n  current: number;\n  total: number;\n};\n\ninterface CountsProviderState extends SceneObjectState {\n  counts: CountsData;\n}\n\nexport class CountsProvider<T extends CountsProviderState = CountsProviderState> extends SceneObjectBase<T> {\n  constructor(state: Partial<T>) {\n    super({\n      ...state,\n      counts: { current: 0, total: 0 },\n    } as T);\n  }\n\n  public useCounts(): CountsData {\n    return this.useState().counts;\n  }\n}\n","import { sceneGraph, type MultiValueVariable } from '@grafana/scenes';\n\nimport { VAR_FILTERED_METRICS_VARIABLE } from 'MetricsReducer/metrics-variables/FilteredMetricsVariable';\nimport { areArraysEqual } from 'MetricsReducer/metrics-variables/helpers/areArraysEqual';\nimport { VAR_METRICS_VARIABLE } from 'MetricsReducer/metrics-variables/MetricsVariable';\n\nimport { CountsProvider } from './CountsProvider';\n\nexport class MetricVariableCountsProvider extends CountsProvider {\n  constructor() {\n    super({ key: 'MetricVariableCountsProvider' });\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    const nonFilteredVariable = sceneGraph.lookupVariable(VAR_METRICS_VARIABLE, this) as MultiValueVariable;\n    const filteredVariable = sceneGraph.lookupVariable(VAR_FILTERED_METRICS_VARIABLE, this) as MultiValueVariable;\n\n    this.setInitCounts(nonFilteredVariable, filteredVariable);\n\n    this._subs.add(\n      nonFilteredVariable.subscribeToState((newState, prevState) => {\n        if (!areArraysEqual(newState.options, prevState.options)) {\n          this.setState({\n            counts: {\n              current: filteredVariable.state.options.length,\n              total: newState.options.length,\n            },\n          });\n        }\n      })\n    );\n\n    this._subs.add(\n      filteredVariable.subscribeToState((newState, prevState) => {\n        if (!newState.loading && !prevState.loading && !areArraysEqual(newState.options, prevState.options)) {\n          this.setState({\n            counts: {\n              current: newState.options.length,\n              total: nonFilteredVariable.state.options.length,\n            },\n          });\n        }\n      })\n    );\n  }\n\n  private setInitCounts(nonFilteredVariable: MultiValueVariable, filteredVariable: MultiValueVariable) {\n    const initCounts = { current: 0, total: 0 };\n\n    // We make sure the count of metrics is not 0 in a scenario where the user goes from the MetricsReducer to the MetricScene and back.\n    // Indeed, sometimes, the variables already have their options and do not load new ones.\n    if (!nonFilteredVariable.state.loading && nonFilteredVariable.state.options.length) {\n      initCounts.total = nonFilteredVariable.state.options.length;\n    }\n\n    if (!filteredVariable.state.loading && filteredVariable.state.options.length) {\n      initCounts.current = filteredVariable.state.options.length;\n    }\n\n    this.setState({ counts: initCounts });\n  }\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\ninterface EventQuickSearchChangedPayload {\n  searchText: string;\n}\n\nexport class EventQuickSearchChanged extends BusEventWithPayload<EventQuickSearchChangedPayload> {\n  public static readonly type = 'quick-search-changed';\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport {\n  SceneObjectBase,\n  SceneObjectUrlSyncConfig,\n  VariableDependencyConfig,\n  type SceneObjectState,\n  type SceneObjectUrlValues,\n} from '@grafana/scenes';\nimport { IconButton, Input, Tag, Tooltip, useStyles2 } from '@grafana/ui';\nimport { debounce } from 'lodash';\nimport React, { type KeyboardEvent } from 'react';\n\nimport { VAR_DATASOURCE } from 'shared/shared';\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\n\nimport { type CountsProvider } from './CountsProvider/CountsProvider';\nimport { EventQuickSearchChanged } from './EventQuickSearchChanged';\n\ninterface QuickSearchState extends SceneObjectState {\n  urlSearchParamName: string;\n  targetName: string;\n  countsProvider: CountsProvider;\n  displayCounts: boolean;\n  value: string;\n}\n\nexport class QuickSearch extends SceneObjectBase<QuickSearchState> {\n  protected _variableDependency = new VariableDependencyConfig(this, {\n    variableNames: [VAR_DATASOURCE],\n    onReferencedVariableValueChanged: () => {\n      this.setState({ value: '' });\n    },\n  });\n\n  protected _urlSync = new SceneObjectUrlSyncConfig(this, {\n    keys: [this.state.urlSearchParamName],\n  });\n\n  getUrlState() {\n    return { [this.state.urlSearchParamName]: this.state.value };\n  }\n\n  updateFromUrl(values: SceneObjectUrlValues) {\n    const newValue = (values[this.state.urlSearchParamName] as string) || '';\n\n    if (newValue !== this.state.value) {\n      this.setState({ value: newValue });\n    }\n  }\n\n  public constructor({\n    urlSearchParamName,\n    targetName,\n    countsProvider,\n    displayCounts,\n  }: {\n    urlSearchParamName: QuickSearchState['urlSearchParamName'];\n    targetName: QuickSearchState['targetName'];\n    countsProvider: QuickSearchState['countsProvider'];\n    displayCounts?: QuickSearchState['displayCounts'];\n  }) {\n    super({\n      key: 'quick-search',\n      urlSearchParamName,\n      targetName,\n      countsProvider,\n      displayCounts: Boolean(displayCounts),\n      value: '',\n    });\n  }\n\n  public toggleCountsDisplay(displayCounts: boolean) {\n    this.setState({ displayCounts });\n  }\n\n  private notifyValueChange = debounce((value: string) => {\n    this.publishEvent(new EventQuickSearchChanged({ searchText: value }), true);\n  }, 250);\n\n  private updateValue(value: string) {\n    const wasEmpty = this.state.value === '';\n    const isNewSearch = wasEmpty && value !== '';\n\n    if (isNewSearch) {\n      reportExploreMetrics('quick_search_used', {});\n    }\n\n    this.setState({ value });\n    this.notifyValueChange(value);\n  }\n\n  private onChange = (e: React.FormEvent<HTMLInputElement>) => {\n    this.updateValue(e.currentTarget.value);\n  };\n\n  private clear = () => {\n    this.updateValue('');\n  };\n\n  private onKeyDown = (e: KeyboardEvent<HTMLInputElement>) => {\n    if (e.key === 'Escape') {\n      e.preventDefault();\n      this.clear();\n    }\n  };\n\n  private useHumanFriendlyCountsMessage() {\n    const { targetName, countsProvider, displayCounts } = this.state;\n    const counts = countsProvider.useCounts();\n\n    if (!displayCounts) {\n      return {\n        tagName: '',\n        tooltipContent: '',\n      };\n    }\n\n    if (counts.current === counts.total) {\n      return {\n        tagName: `${counts.current}`,\n        tooltipContent: counts.current !== 1 ? `${counts.current} ${targetName}s in total` : `1 ${targetName} in total`,\n      };\n    }\n\n    return {\n      tagName: `${counts.current}/${counts.total}`,\n      tooltipContent:\n        counts.current !== 1\n          ? `${counts.current} out of ${counts.total} ${targetName}s in total`\n          : `1 out of ${counts.total} ${targetName}s in total`,\n    };\n  }\n\n  static readonly Component = ({ model }: { model: QuickSearch }) => {\n    const styles = useStyles2(getStyles);\n    const { targetName, value, countsProvider } = model.useState();\n    const { tagName, tooltipContent } = model.useHumanFriendlyCountsMessage();\n\n    return (\n      <Input\n        value={value}\n        onChange={model.onChange}\n        onKeyDown={model.onKeyDown}\n        placeholder={`Quick search ${targetName}s`}\n        prefix={<i className=\"fa fa-search\" />}\n        suffix={\n          <>\n            <countsProvider.Component model={countsProvider} />\n            {tagName && (\n              <Tooltip content={tooltipContent} placement=\"top\">\n                <Tag className={styles.counts} name={tagName} colorIndex={9} />\n              </Tooltip>\n            )}\n            <IconButton\n              name=\"times\"\n              variant=\"secondary\"\n              tooltip=\"Clear search\"\n              onClick={model.clear}\n              disabled={!value}\n            />\n          </>\n        }\n      />\n    );\n  };\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  counts: css`\n    margin-right: ${theme.spacing(1)};\n    border-radius: 11px;\n    padding: 2px ${theme.spacing(1)};\n    color: ${theme.colors.text.primary};\n    background-color: ${theme.colors.background.secondary};\n  `,\n});\n","import { css } from '@emotion/css';\nimport { type SelectableValue } from '@grafana/data';\nimport {\n  EmbeddedScene,\n  SceneFlexItem,\n  SceneFlexLayout,\n  type SceneComponentProps,\n  type SceneObjectState,\n  type SceneReactObject,\n  type SceneVariableSet,\n} from '@grafana/scenes';\nimport { useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { LayoutSwitcher } from './LayoutSwitcher';\nimport { MetricsSorter } from './MetricsSorter/MetricsSorter';\nimport { type CountsProvider } from './QuickSearch/CountsProvider/CountsProvider';\nimport { MetricVariableCountsProvider } from './QuickSearch/CountsProvider/MetricVariableCountsProvider';\nimport { QuickSearch } from './QuickSearch/QuickSearch';\n\ninterface ListControlsState extends SceneObjectState {\n  $variables?: SceneVariableSet;\n  inputControls?: SceneReactObject;\n  onChange?: (value: SelectableValue<string>) => void; // Keeping for backward compatibility\n}\n\n// @ts-ignore to fix build error. Is there a Scenes friend way of doing this?\nexport class ListControls extends EmbeddedScene {\n  constructor(state: Partial<ListControlsState>) {\n    super({\n      ...state,\n      key: 'list-controls',\n      body: new SceneFlexLayout({\n        direction: 'row',\n        width: '100%',\n        maxHeight: '32px',\n        children: [\n          new SceneFlexItem({\n            body: new QuickSearch({\n              urlSearchParamName: 'search_txt',\n              targetName: 'metric',\n              countsProvider: new MetricVariableCountsProvider() as unknown as CountsProvider,\n            }),\n          }),\n          new SceneFlexItem({\n            width: 'auto',\n            body: new MetricsSorter({}),\n          }),\n          new SceneFlexItem({\n            width: 'auto',\n            body: new LayoutSwitcher({}),\n          }),\n        ],\n      }),\n    });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<ListControls>) => {\n    const styles = useStyles2(getStyles);\n    const { body } = model.useState();\n\n    return (\n      <div className={styles.headerWrapper}>\n        <body.Component model={body} />\n      </div>\n    );\n  };\n}\n\nfunction getStyles() {\n  return {\n    headerWrapper: css({\n      display: 'flex',\n      alignItems: 'center',\n      '& > div': {\n        display: 'flex',\n        alignItems: 'center',\n        '& > div': {\n          display: 'flex',\n          alignItems: 'center',\n        },\n      },\n    }),\n  };\n}\n","import { SceneVariableValueChangedEvent, type QueryVariable, type VariableValueOption } from '@grafana/scenes';\nimport { cloneDeep, isEqual } from 'lodash';\n\nimport { type MetricOptions } from './MetricsVariable';\n\nexport type MetricFilters = {\n  categories: string[];\n  prefixes: string[];\n  suffixes: string[];\n  names: string[];\n};\n\nexport class MetricsVariableFilterEngine {\n  private variable: QueryVariable;\n  private initOptions: VariableValueOption[] = [];\n  private filters: MetricFilters = {\n    categories: [],\n    prefixes: [],\n    suffixes: [],\n    names: [],\n  };\n\n  constructor(variable: QueryVariable) {\n    this.variable = variable;\n  }\n\n  public setInitOptions(options: VariableValueOption[]) {\n    this.initOptions = cloneDeep(options);\n  }\n\n  /**\n   * Get a copy of the current filters\n   */\n  public getFilters(): MetricFilters {\n    return this.filters;\n  }\n\n  /**\n   * Compute options based on filters.\n   * @param options The options to filter\n   * @param filters The filters to apply\n   * @returns Filtered options\n   */\n  public static getFilteredOptions(options: VariableValueOption[], filters: MetricFilters): MetricOptions {\n    let filteredOptions = options as MetricOptions;\n\n    if (filters.categories.length > 0) {\n      filteredOptions = MetricsVariableFilterEngine.applyCategoryFilters(filteredOptions, filters.categories);\n    }\n\n    if (filters.prefixes.length > 0) {\n      filteredOptions = MetricsVariableFilterEngine.applyPrefixFilters(filteredOptions, filters.prefixes);\n    }\n\n    if (filters.suffixes.length > 0) {\n      filteredOptions = MetricsVariableFilterEngine.applySuffixFilters(filteredOptions, filters.suffixes);\n    }\n\n    if (filters.names.length > 0) {\n      filteredOptions = MetricsVariableFilterEngine.applyNameFilters(filteredOptions, filters.names);\n    }\n\n    return filteredOptions;\n  }\n\n  public applyFilters(filters: Partial<MetricFilters> = this.filters, settings = { forceUpdate: false, notify: true }) {\n    const updatedFilters: MetricFilters = {\n      ...this.filters,\n      ...filters,\n    };\n\n    if (!settings.forceUpdate && isEqual(this.filters, updatedFilters)) {\n      return;\n    }\n\n    if (\n      !updatedFilters.categories.length &&\n      !updatedFilters.prefixes.length &&\n      !updatedFilters.suffixes.length &&\n      !updatedFilters.names.length\n    ) {\n      this.filters = updatedFilters;\n\n      this.variable.setState({ options: this.initOptions });\n\n      if (settings.notify) {\n        this.notifyUpdate();\n      }\n\n      return;\n    }\n\n    this.filters = updatedFilters;\n\n    const filteredOptions = MetricsVariableFilterEngine.getFilteredOptions(this.initOptions, this.filters);\n\n    this.variable.setState({ options: filteredOptions });\n\n    if (settings.notify) {\n      this.notifyUpdate();\n    }\n  }\n\n  private static applyCategoryFilters(options: MetricOptions, categories: string[]): MetricOptions {\n    let filteredOptions: MetricOptions = [];\n\n    for (const category of categories) {\n      const categoryRegex = MetricsVariableFilterEngine.buildRegex(category, 'i'); // see e.g. computeRulesGroups (could apply to other categories in the future)\n      filteredOptions = filteredOptions.concat(options.filter((option) => categoryRegex.test(option.value)));\n    }\n\n    return filteredOptions;\n  }\n\n  private static applyPrefixFilters(options: MetricOptions, prefixes: string[]): MetricOptions {\n    const pattern = prefixes\n      .map((prefix) => {\n        // Multi-value support (see computeMetricPrefixGroups)\n        if (prefix.includes('|')) {\n          return `${prefix\n            .split('|')\n            .map((p) => `^${p}([^a-z0-9]|$)`)\n            .join('|')}`;\n        }\n\n        return `^${prefix}([^a-z0-9]|$)`;\n      })\n      .join('|');\n\n    const prefixesRegex = MetricsVariableFilterEngine.buildRegex(`(${pattern})`);\n\n    const filteredOptions = options.filter((option) => prefixesRegex.test(option.value as string));\n\n    return filteredOptions;\n  }\n\n  private static applySuffixFilters(options: MetricOptions, suffixes: string[]): MetricOptions {\n    const pattern = suffixes\n      .map((suffix) => {\n        // Multi-value support (see computeMetricSuffixGroups)\n        if (suffix.includes('|')) {\n          return `${suffix\n            .split('|')\n            .map((s) => `(^|[^a-z0-9])${s}$`)\n            .join('|')}`;\n        }\n\n        return `(^|[^a-z0-9])${suffix}$`;\n      })\n      .join('|');\n\n    const suffixesRegex = MetricsVariableFilterEngine.buildRegex(`(${pattern})`);\n\n    const filteredOptions = options.filter((option) => suffixesRegex.test(option.value as string));\n\n    return filteredOptions;\n  }\n\n  private static applyNameFilters(options: MetricOptions, names: string[]): MetricOptions {\n    const [namePatterns] = names;\n\n    const regexes = namePatterns\n      .split(',')\n      .map((p) => p.trim())\n      .filter(Boolean)\n      .map((r) => {\n        try {\n          return new RegExp(r);\n        } catch {\n          return null;\n        }\n      })\n      .filter(Boolean) as RegExp[];\n\n    return options.filter((option) => regexes.some((regex) => regex.test(option.value as string)));\n  }\n\n  private static buildRegex(pattern: string, flags?: string) {\n    try {\n      return new RegExp(pattern, flags);\n    } catch {\n      return new RegExp('.*');\n    }\n  }\n\n  private notifyUpdate() {\n    // hack to force SceneByVariableRepeater to re-render\n    this.variable.publishEvent(new SceneVariableValueChangedEvent(this.variable), true);\n  }\n}\n","import leven from 'leven';\n\nexport function sortRelatedMetrics(metricList: string[], metric: string) {\n  return metricList.sort((aValue, bValue) => {\n    const a = getLevenDistances(aValue, metric);\n    const b = getLevenDistances(bValue, metric);\n\n    return a.halfLeven + a.wholeLeven - (b.halfLeven + b.wholeLeven);\n  });\n}\n\ntype LevenDistances = { halfLeven: number; wholeLeven: number };\ntype TargetToLevenDistances = Map<string, LevenDistances>;\n\nconst metricToTargetLevenDistances = new Map<string, TargetToLevenDistances>();\n\n// Provides the Levenshtein distance between a metric to be sorted\n// and a targetMetric compared to which all other metrics are being sorted\n// There are two distances: once for the first half and once for the whole string.\n// This operation is not expected to be symmetric; order of parameters matters\n// since only `metric` is split.\nfunction getLevenDistances(metric: string, targetMetric: string) {\n  let targetToDistances: TargetToLevenDistances | undefined = metricToTargetLevenDistances.get(metric);\n  if (!targetToDistances) {\n    targetToDistances = new Map<string, LevenDistances>();\n    metricToTargetLevenDistances.set(metric, targetToDistances);\n  }\n\n  let distances: LevenDistances | undefined = targetToDistances.get(targetMetric);\n  if (!distances) {\n    const metricSplit = metric.split('_');\n    const metricHalf = metricSplit.slice(0, metricSplit.length / 2).join('_');\n\n    const halfLeven = leven(metricHalf, targetMetric!) || 0;\n    const wholeLeven = leven(metric, targetMetric!) || 0;\n\n    distances = { halfLeven, wholeLeven };\n    targetToDistances.set(targetMetric, distances);\n  }\n\n  return distances;\n}\n","import { sceneGraph, SceneVariableValueChangedEvent, type QueryVariable } from '@grafana/scenes';\n\nimport { sortRelatedMetrics } from 'MetricScene/RelatedMetrics/sortRelatedMetrics';\nimport {\n  MetricsSorter,\n  sortMetricsByCount,\n  sortMetricsWithRecentFirst,\n  type SortingOption,\n} from 'MetricsReducer/list-controls/MetricsSorter/MetricsSorter';\nimport { type MetricUsageType } from 'MetricsReducer/list-controls/MetricsSorter/MetricUsageFetcher';\nimport { logger } from 'shared/logger/logger';\n\nimport { areArraysEqual } from './helpers/areArraysEqual';\n\nexport class MetricsVariableSortEngine {\n  private variable: QueryVariable;\n  private lastMetrics: string[];\n  private sortBy?: SortingOption | 'related';\n\n  constructor(variable: QueryVariable) {\n    this.variable = variable;\n    this.sortBy = undefined;\n    this.lastMetrics = [];\n  }\n\n  public async sort(sortBy = this.sortBy, options: Record<string, any> = {}) {\n    const metrics = this.variable.state.options.map((option) => option.value as string);\n\n    if (sortBy === this.sortBy && areArraysEqual(metrics, this.lastMetrics)) {\n      return;\n    }\n\n    let sortedMetrics: string[];\n\n    switch (sortBy) {\n      case 'dashboard-usage':\n      case 'alerting-usage':\n        sortedMetrics = await this.sortByUsage(metrics, sortBy);\n        break;\n\n      case 'related':\n        sortedMetrics = sortRelatedMetrics(metrics, options.metric);\n        break;\n\n      default:\n        sortedMetrics = sortMetricsWithRecentFirst(metrics);\n        break;\n    }\n\n    this.sortBy = sortBy;\n    this.lastMetrics = sortedMetrics;\n\n    this.variable.setState({\n      options: sortedMetrics.map((metricName) => ({\n        label: metricName,\n        value: metricName,\n      })),\n    });\n\n    this.notifyUpdate();\n  }\n\n  private async sortByUsage(metrics: string[], usageType: MetricUsageType) {\n    try {\n      const metricsSorter = sceneGraph.findByKeyAndType(this.variable, 'metrics-sorter', MetricsSorter);\n      if (!metricsSorter) {\n        logger.warn('Metrics sorter not found. Returning unsorted metrics.', { usageType });\n        return metrics;\n      }\n      const usageMetrics = await metricsSorter.getUsageMetrics(usageType);\n      return sortMetricsByCount(metrics, usageMetrics);\n    } catch (err) {\n      const error = typeof err === 'string' ? new Error(err) : (err as Error);\n      logger.error(error, {\n        usageType,\n      });\n      return metrics;\n    }\n  }\n\n  private notifyUpdate() {\n    // hack to force SceneByVariableRepeater to re-render\n    this.variable.publishEvent(new SceneVariableValueChangedEvent(this.variable), true);\n  }\n}\n","import {\n  MultiValueVariable,\n  sceneGraph,\n  SceneObjectBase,\n  VariableDependencyConfig,\n  type SceneComponentProps,\n  type SceneLayout,\n  type SceneObject,\n  type SceneObjectState,\n  type VariableValueOption,\n} from '@grafana/scenes';\nimport React from 'react';\n\nimport { logger } from 'shared/logger/logger';\n\n/**\n * This component has been borrowd from Scenes v5,41,1, which is the version Metrics Drilldown currently use.\n *\n * The main purpose of this new component is to create a Scene object that has the capabilities of the original SceneByVariableRepeater and\n * that also to provide:\n *\n *   1. lazy loading/pagination\n *   2. configurable loading/error/empty states\n *   4. minor details (like calling getLayoutChild() and passing an index for multi coloring timeseries)\n *\n *\n */\ninterface SceneByVariableRepeaterState extends SceneObjectState {\n  variableName: string;\n  body: SceneLayout;\n  getLayoutChild(option: VariableValueOption, index: number, options: VariableValueOption[]): SceneObject | null;\n  getLayoutLoading?: () => SceneObject;\n  getLayoutError?: (error: Error) => SceneObject;\n  getLayoutEmpty?: () => SceneObject;\n  currentBatchSize: number;\n  initialPageSize: number;\n  pageSizeIncrement: number;\n  loadingLayout?: SceneObject;\n  errorLayout?: SceneObject;\n  emptyLayout?: SceneObject;\n}\n\nconst DEFAULT_INITIAL_PAGE_SIZE = 6;\nconst DEFAULT_PAGE_SIZE_INCREMENT = 9;\n\nexport class SceneByVariableRepeater extends SceneObjectBase<SceneByVariableRepeaterState> {\n  protected _variableDependency: VariableDependencyConfig<SceneByVariableRepeaterState> = new VariableDependencyConfig(\n    this,\n    {\n      variableNames: [this.state.variableName],\n      onVariableUpdateCompleted: () => this.performRepeat(),\n    }\n  );\n\n  public constructor({\n    variableName,\n    body,\n    getLayoutChild,\n    getLayoutLoading,\n    getLayoutError,\n    getLayoutEmpty,\n    initialPageSize,\n    pageSizeIncrement,\n  }: {\n    variableName: SceneByVariableRepeaterState['variableName'];\n    body: SceneByVariableRepeaterState['body'];\n    getLayoutChild: SceneByVariableRepeaterState['getLayoutChild'];\n    getLayoutLoading?: SceneByVariableRepeaterState['getLayoutLoading'];\n    getLayoutError?: SceneByVariableRepeaterState['getLayoutError'];\n    getLayoutEmpty?: SceneByVariableRepeaterState['getLayoutEmpty'];\n    initialPageSize?: SceneByVariableRepeaterState['initialPageSize'];\n    pageSizeIncrement?: SceneByVariableRepeaterState['pageSizeIncrement'];\n  }) {\n    super({\n      variableName,\n      body,\n      getLayoutChild,\n      getLayoutLoading,\n      getLayoutError,\n      getLayoutEmpty,\n      currentBatchSize: 0,\n      initialPageSize: initialPageSize || DEFAULT_INITIAL_PAGE_SIZE,\n      pageSizeIncrement: pageSizeIncrement || DEFAULT_PAGE_SIZE_INCREMENT,\n      loadingLayout: undefined,\n      errorLayout: undefined,\n      emptyLayout: undefined,\n    });\n\n    this.addActivationHandler(() => this.performRepeat());\n  }\n\n  private performRepeat() {\n    if (this._variableDependency.hasDependencyInLoadingState()) {\n      this.setState({\n        loadingLayout: this.state.getLayoutLoading?.(),\n        errorLayout: undefined,\n        emptyLayout: undefined,\n        currentBatchSize: 0,\n      });\n      return;\n    }\n\n    const variable = sceneGraph.lookupVariable(this.state.variableName, this);\n    if (!(variable instanceof MultiValueVariable)) {\n      const error = new Error('SceneByVariableRepeater: variable is not a MultiValueVariable!');\n      logger.error(error);\n      return;\n    }\n\n    if (variable.state.error) {\n      this.setState({\n        errorLayout: this.state.getLayoutError?.(variable.state.error),\n        loadingLayout: undefined,\n        emptyLayout: undefined,\n        currentBatchSize: 0,\n      });\n      return;\n    }\n\n    const values = getMultiVariableValues(variable);\n\n    if (!values.length) {\n      this.setState({\n        emptyLayout: this.state.getLayoutEmpty?.(),\n        errorLayout: undefined,\n        loadingLayout: undefined,\n        currentBatchSize: 0,\n      });\n      return;\n    }\n\n    this.setState({\n      loadingLayout: undefined,\n      errorLayout: undefined,\n      emptyLayout: undefined,\n      currentBatchSize: this.state.initialPageSize,\n    });\n\n    const newChildren: SceneObject[] = values\n      .slice(0, this.state.initialPageSize)\n      .map((option, index) => this.state.getLayoutChild(option, index, values))\n      .filter(Boolean) as SceneObject[];\n\n    this.state.body.setState({\n      children: newChildren,\n    });\n  }\n\n  public increaseBatchSize() {\n    const variable = sceneGraph.lookupVariable(this.state.variableName, this) as MultiValueVariable;\n    const values = getMultiVariableValues(variable);\n\n    const newBatchSize = this.state.currentBatchSize + this.state.pageSizeIncrement;\n\n    const newChildren: SceneObject[] = values\n      .slice(this.state.currentBatchSize, newBatchSize)\n      .map((option, index) => this.state.getLayoutChild(option, this.state.currentBatchSize + index, values))\n      .filter(Boolean) as SceneObject[];\n\n    this.state.body.setState({\n      children: [...this.state.body.state.children, ...newChildren],\n    });\n\n    this.setState({\n      currentBatchSize: newBatchSize,\n    });\n  }\n\n  public useSizes() {\n    const { currentBatchSize, pageSizeIncrement } = this.useState();\n    const variable = sceneGraph.lookupVariable(this.state.variableName, this);\n    const total = (variable as MultiValueVariable).state.options.length;\n    const remaining = total - currentBatchSize;\n    const increment = remaining < pageSizeIncrement ? remaining : pageSizeIncrement;\n    return {\n      increment,\n      current: currentBatchSize,\n      total,\n    };\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<SceneByVariableRepeater>) => {\n    const { body, loadingLayout, errorLayout, emptyLayout } = model.useState();\n\n    if (loadingLayout) {\n      return <loadingLayout.Component model={loadingLayout} />;\n    }\n\n    if (errorLayout) {\n      return <errorLayout.Component model={errorLayout} />;\n    }\n\n    if (emptyLayout) {\n      return <emptyLayout.Component model={emptyLayout} />;\n    }\n\n    return <body.Component model={body} />;\n  };\n}\n\nexport function getMultiVariableValues(variable: MultiValueVariable): VariableValueOption[] {\n  const { value, text, options } = variable.state;\n\n  if (variable.hasAllValue()) {\n    return options;\n  }\n\n  if (Array.isArray(value) && Array.isArray(text)) {\n    return value.map((v, i) => ({ value: v, label: text[i] as string }));\n  }\n\n  return [{ value: value as string, label: text as string }];\n}\n","import { Button } from '@grafana/ui';\nimport React, { type MouseEventHandler } from 'react';\n\ntype ShowMoreButtonProps = {\n  label: string;\n  batchSizes: {\n    increment: number;\n    current: number;\n    total: number;\n  };\n  onClick: MouseEventHandler<HTMLButtonElement>;\n  tooltip?: string;\n};\n\nexport function ShowMoreButton({ label, batchSizes, onClick, tooltip }: Readonly<ShowMoreButtonProps>) {\n  return (\n    <Button variant=\"secondary\" fill=\"outline\" onClick={onClick} tooltip={tooltip} tooltipPlacement=\"top\">\n      Show {batchSizes.increment} more {batchSizes.increment === 1 ? label : `${label}s`} ({batchSizes.current}/\n      {batchSizes.total})\n    </Button>\n  );\n}\n","import { css, cx } from '@emotion/css';\nimport { type GrafanaTheme2, type IconName } from '@grafana/data';\nimport { Button, Dropdown, Icon, Menu, Tooltip, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { type MetricUsageType } from 'MetricsReducer/list-controls/MetricsSorter/MetricUsageFetcher';\n\nimport { type WithUsageDataPreviewPanelState } from './WithUsageDataPreviewPanel';\n\ninterface UsageSectionProps {\n  usageType: MetricUsageType;\n  usageCount: number;\n  singularUsageType: string;\n  pluralUsageType: string;\n  icon: IconName;\n  dashboardItems: WithUsageDataPreviewPanelState['dashboardItems'];\n}\n\nexport function UsageData({\n  usageType,\n  usageCount,\n  singularUsageType,\n  pluralUsageType,\n  icon,\n  dashboardItems,\n}: Readonly<UsageSectionProps>) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.usageContainer} data-testid=\"usage-data-panel\">\n      {usageType === 'dashboard-usage' ? (\n        <>\n          <Dropdown\n            placement=\"right-start\"\n            overlay={\n              <Menu style={{ maxWidth: '240px', maxHeight: '245px', overflowY: 'auto' }}>\n                {dashboardItems.map((item) => (\n                  <Menu.Item\n                    key={item.id}\n                    label=\"\"\n                    url={item.url}\n                    target=\"_blank\"\n                    className={styles.menuItem}\n                    component={() => (\n                      <Tooltip\n                        content={`Used ${item.count} ${item.count === 1 ? 'time' : 'times'} in ${item.label}`}\n                        placement=\"right\"\n                      >\n                        <div className={styles.menuItemContent}>\n                          <Icon name=\"external-link-alt\" /> {item.label} ({item.count})\n                        </div>\n                      </Tooltip>\n                    )}\n                  />\n                ))}\n              </Menu>\n            }\n          >\n            <Button\n              variant=\"secondary\"\n              size=\"sm\"\n              tooltip={`Metric used ${usageCount} ${\n                usageCount === 1 ? 'time' : 'times'\n              } in dashboard queries. Click to view the dashboards.`}\n              className={cx(styles.usageItem, styles.clickableUsageItem)}\n            >\n              <span data-testid={usageType}>\n                <Icon name={icon} style={{ marginRight: '4px' }} /> {usageCount}\n              </span>\n            </Button>\n          </Dropdown>\n        </>\n      ) : (\n        <Tooltip\n          content={`Metric is used in ${usageCount} ${usageCount === 1 ? singularUsageType : pluralUsageType}`}\n          placement=\"top\"\n        >\n          <span className={styles.usageItem} data-testid={usageType}>\n            <Icon name={icon} /> {usageCount}\n          </span>\n        </Tooltip>\n      )}\n    </div>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    usageContainer: css({\n      display: 'flex',\n      flexDirection: 'row',\n      justifyContent: 'flex-start',\n      gap: '17px',\n      padding: '8px 12px',\n      border: `1px solid ${theme.colors.border.weak}`,\n      borderTopWidth: 0,\n      backgroundColor: theme.colors.background.primary,\n      alignItems: 'center',\n    }),\n    usageItem: css({\n      display: 'flex',\n      alignItems: 'center',\n      gap: '4px',\n      color: theme.colors.text.secondary,\n      opacity: '65%',\n    }),\n    clickableUsageItem: css({\n      backgroundColor: 'transparent',\n      border: 'none',\n    }),\n    menuItem: css({\n      color: theme.colors.text.primary,\n      textDecoration: 'none',\n      '&:hover': {\n        color: theme.colors.text.link,\n      },\n    }),\n    menuItemContent: css({\n      overflow: 'hidden',\n      textOverflow: 'ellipsis',\n      whiteSpace: 'nowrap',\n      color: theme.colors.text.primary,\n      '&:hover': {\n        color: theme.colors.text.link,\n      },\n    }),\n  };\n}\n","import {\n  SceneCSSGridLayout,\n  sceneGraph,\n  SceneObjectBase,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { type IconName } from '@grafana/ui';\nimport React from 'react';\n\nimport {\n  MetricsSorter,\n  VAR_WINGMAN_SORT_BY,\n  type SortingOption,\n} from 'MetricsReducer/list-controls/MetricsSorter/MetricsSorter';\nimport { VAR_FILTERED_METRICS_VARIABLE } from 'MetricsReducer/metrics-variables/FilteredMetricsVariable';\nimport { MetricsReducer } from 'MetricsReducer/MetricsReducer';\nimport { type GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\nimport { logger } from 'shared/logger/logger';\nimport { isCustomVariable } from 'shared/utils/utils.variables';\n\nimport { UsageData } from './UsageData';\n\nexport const VIZ_PANEL_HEIGHT = '220px';\nexport const VIZ_PANEL_HEIGHT_WITH_USAGE_DATA_PREVIEW = '260px';\n\ntype SortBy = Exclude<SortingOption, 'related'>;\n\nexport type WithUsageDataPreviewPanelState = SceneObjectState & {\n  vizPanelInGridItem: GmdVizPanel;\n  metric: string;\n  sortBy: SortBy;\n  usageCount: number;\n  singularUsageType: string;\n  pluralUsageType: string;\n  icon: IconName;\n  dashboardItems: Array<{ id: string; label: string; count: number; url: string }>;\n};\n\nexport class WithUsageDataPreviewPanel extends SceneObjectBase<WithUsageDataPreviewPanelState> {\n  constructor(state: Pick<WithUsageDataPreviewPanelState, 'vizPanelInGridItem' | 'metric'>) {\n    super({\n      ...state,\n      sortBy: 'default',\n      usageCount: 0,\n      singularUsageType: '',\n      pluralUsageType: '',\n      icon: '' as IconName,\n      dashboardItems: [],\n    });\n\n    this.addActivationHandler(this._onActivate.bind(this));\n  }\n\n  private _onActivate() {\n    let metricsReducer;\n\n    try {\n      metricsReducer = sceneGraph.getAncestor(this, MetricsReducer);\n    } catch {\n      return;\n    }\n\n    const filteredMetricsEngine = metricsReducer.state.enginesMap.get(VAR_FILTERED_METRICS_VARIABLE);\n    if (!filteredMetricsEngine) {\n      return;\n    }\n\n    const metricsSorter = sceneGraph.findByKeyAndType(this, 'metrics-sorter', MetricsSorter);\n    const sortByVar = sceneGraph.getVariables(metricsSorter).getByName(VAR_WINGMAN_SORT_BY);\n\n    if (isCustomVariable(sortByVar)) {\n      this.updateSortBy(metricsSorter, sortByVar.getValue() as SortBy);\n\n      this._subs.add(\n        sortByVar.subscribeToState(({ value }) => {\n          this.updateSortBy(metricsSorter, value as SortBy);\n        })\n      );\n    }\n  }\n\n  private async updateSortBy(metricsSorter: MetricsSorter, sortBy: SortBy) {\n    this.setState({ sortBy });\n    this.updateLayout(sortBy);\n\n    if (sortBy === 'default') {\n      return;\n    }\n\n    const usage = await metricsSorter.getUsageDetailsForMetric(this.state.metric, sortBy);\n\n    switch (sortBy) {\n      case 'dashboard-usage':\n        // FIXME: we do this only to satisfy TS Lord\n        if (usage.usageType !== 'dashboard-usage') {\n          return;\n        }\n\n        const { dashboards } = usage;\n\n        this.setState({\n          usageCount: usage.count,\n          singularUsageType: 'dashboard panel query',\n          pluralUsageType: 'dashboard panel queries',\n          icon: 'apps',\n          dashboardItems: Object.entries(dashboards)\n            .map(([label, dashboardInfo]) => ({\n              id: dashboardInfo.uid,\n              label,\n              count: dashboardInfo.count,\n              url: dashboardInfo.url,\n            }))\n            .sort((a, b) => b.count - a.count),\n        });\n        break;\n\n      case 'alerting-usage':\n        this.setState({\n          usageCount: usage.count,\n          singularUsageType: 'alert rule',\n          pluralUsageType: 'alert rules',\n          icon: 'bell',\n        });\n        break;\n\n      default:\n        break;\n    }\n  }\n\n  private updateLayout(sortBy: WithUsageDataPreviewPanelState['sortBy']) {\n    const gridLayout = sceneGraph.getAncestor(this, SceneCSSGridLayout);\n    const currentGridLayoutHeight = gridLayout?.state.autoRows;\n\n    const expectedPanelHeight = sortBy === 'default' ? VIZ_PANEL_HEIGHT : VIZ_PANEL_HEIGHT_WITH_USAGE_DATA_PREVIEW;\n\n    if (currentGridLayoutHeight !== expectedPanelHeight) {\n      gridLayout.setState({ autoRows: expectedPanelHeight });\n    }\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<WithUsageDataPreviewPanel>) => {\n    const { vizPanelInGridItem, sortBy, usageCount, singularUsageType, pluralUsageType, icon, dashboardItems } =\n      model.useState();\n\n    if (!vizPanelInGridItem) {\n      logger.log('no viz panel');\n      return;\n    }\n\n    return (\n      <div data-testid=\"with-usage-data-preview-panel\">\n        <vizPanelInGridItem.Component model={vizPanelInGridItem} />\n        {sortBy !== 'default' && (\n          <UsageData\n            usageType={sortBy}\n            usageCount={usageCount}\n            singularUsageType={singularUsageType}\n            pluralUsageType={pluralUsageType}\n            icon={icon}\n            dashboardItems={dashboardItems}\n          />\n        )}\n      </div>\n    );\n  };\n}\n","import React from 'react';\n\nexport function GroupsIcon() {\n  return (\n    <svg stroke=\"currentColor\" width=\"17\" height=\"16\" viewBox=\"0 0 17 16\" fill=\"none\">\n      <circle cx=\"8.92688\" cy=\"3.63132\" r=\"2.375\" strokeWidth=\"1.5\" />\n      <path d=\"M13.6469 4.37965C14.6813 4.76699 15.3235 7.03139 14.9362 8.06582\" strokeWidth=\"1.5\" />\n      <path d=\"M4.35309 4.37965C3.31866 4.76699 2.67651 7.03139 3.06384 8.06582\" strokeWidth=\"1.5\" />\n      <path d=\"M10.3408 14.2531C9.75237 14.8415 8.11813 14.7799 7.50903 14.1708\" strokeWidth=\"1.5\" />\n      <circle cx=\"4.00195\" cy=\"12.251\" r=\"2.375\" strokeWidth=\"1.5\" />\n      <circle cx=\"13.8478\" cy=\"12.251\" r=\"2.375\" strokeWidth=\"1.5\" />\n    </svg>\n  );\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\ninterface EventConfigurePanelPayload {\n  metric: string;\n}\n\nexport class EventConfigurePanel extends BusEventWithPayload<EventConfigurePanelPayload> {\n  public static readonly type = 'configure-panel';\n}\n","import { css, cx } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { SceneObjectBase, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport { Button, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { PREF_KEYS } from 'shared/user-preferences/pref-keys';\nimport { userStorage } from 'shared/user-preferences/userStorage';\n\nimport { EventConfigurePanel } from './EventConfigurePanel';\n\ninterface ConfigurePanelActionState extends SceneObjectState {\n  metric: string;\n  disabled: boolean;\n  isAlreadyConfigured: boolean;\n}\n\nexport class ConfigurePanelAction extends SceneObjectBase<ConfigurePanelActionState> {\n  constructor({\n    metric,\n    disabled,\n  }: {\n    metric: ConfigurePanelActionState['metric'];\n    disabled?: ConfigurePanelActionState['disabled'];\n  }) {\n    const userPrefs = userStorage.getItem(PREF_KEYS.METRIC_PREFS) || {};\n\n    super({\n      metric,\n      disabled: disabled !== undefined ? disabled : false,\n      isAlreadyConfigured: Boolean(userPrefs[metric]?.config),\n    });\n  }\n\n  public onClick = () => {\n    this.publishEvent(new EventConfigurePanel({ metric: this.state.metric }), true);\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<ConfigurePanelAction>) => {\n    const styles = useStyles2(getStyles);\n    const { isAlreadyConfigured, disabled } = model.useState();\n\n    const label = isAlreadyConfigured ? 'Reconfigure Prometheus function' : 'Configure Prometheus function';\n\n    return (\n      <Button\n        className={cx(styles.selectButton, isAlreadyConfigured && styles.active)}\n        aria-label={label}\n        variant=\"secondary\"\n        size=\"sm\"\n        fill=\"text\"\n        onClick={model.onClick}\n        icon=\"cog\"\n        tooltip={label}\n        tooltipPlacement=\"top\"\n        disabled={disabled}\n        data-testid=\"configure-panel\"\n      />\n    );\n  };\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  selectButton: css`\n    margin: 0;\n    padding: 0;\n    margin-left: ${theme.spacing(1)};\n  `,\n  active: css`\n    color: ${theme.colors.text.maxContrast};\n  `,\n});\n","import { SceneObjectBase, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport { Button } from '@grafana/ui';\nimport React from 'react';\n\nimport { MetricSelectedEvent } from 'shared/shared';\n\ninterface SelectActionState extends SceneObjectState {\n  metric: string;\n  variant: 'primary' | 'secondary';\n  fill: 'solid' | 'outline' | 'text';\n}\n\nexport class SelectAction extends SceneObjectBase<SelectActionState> {\n  constructor({\n    metric,\n    variant,\n    fill,\n  }: {\n    metric: SelectActionState['metric'];\n    variant?: SelectActionState['variant'];\n    fill?: SelectActionState['fill'];\n  }) {\n    super({\n      key: `select-action-${metric}`,\n      metric,\n      variant: variant || 'primary',\n      fill: fill || 'outline',\n    });\n  }\n\n  public onClick = () => {\n    this.publishEvent(new MetricSelectedEvent({ metric: this.state.metric }), true);\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<SelectAction>) => {\n    const { variant, fill } = model.useState();\n\n    return (\n      <Button\n        variant={variant}\n        fill={fill}\n        size=\"sm\"\n        onClick={model.onClick}\n        data-testid={`select-action-${model.state.metric}`}\n      >\n        Select\n      </Button>\n    );\n  };\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\nimport { type PanelType } from '../types/available-panel-types';\n\ninterface EventPanelTypeChangedPayload {\n  panelType: PanelType;\n}\n\nexport class EventPanelTypeChanged extends BusEventWithPayload<EventPanelTypeChangedPayload> {\n  public static readonly type = 'panel-type-changed';\n}\n","import { type PanelOptions, type QueryOptions } from 'shared/GmdVizPanel/GmdVizPanel';\n\nexport const CONFIG_PRESETS = {\n  TIMESERIES_AVG: 'timeseries-avg',\n  TIMESERIES_SUM: 'timeseries-sum',\n  TIMESERIES_STDDEV: 'timeseries-stddev',\n  TIMESERIES_PERCENTILES: 'timeseries-percentiles',\n  TIMESERIES_MIN_MAX: 'timeseries-minmax',\n  TIMESERIES_AGE_TIME_MINUS_AVG: 'timeseries-age-time-minus-avg',\n  TIMESERIES_AGE_TIME_MINUS_MIN_MAX: 'timeseries-age-time-minus-min-max',\n  HISTOGRAM_HEATMAP: 'histogram-heatmap',\n  HISTOGRAM_PERCENTILES: 'histogram-percentiles',\n  STATUS_UPDOWN_HISTORY: 'status-updown-history',\n  STATUS_UPDOWN_STAT: 'status-updown-stat',\n} as const;\n\nexport type ConfigPresetId = (typeof CONFIG_PRESETS)[keyof typeof CONFIG_PRESETS];\n\nexport type PanelConfigPreset = {\n  id: ConfigPresetId;\n  name?: string;\n  panelOptions: PanelOptions;\n  queryOptions: QueryOptions;\n};\n","import { promql } from 'tsqtsq';\n\nconst PROMETHEUS_FUNCTIONS = [\n  // timeseries (rate and non-rate)\n  'avg',\n  'sum',\n  'stddev',\n  'quantile',\n  'min',\n  'max',\n  // histograms\n  'histogram_quantile',\n  // age\n  'time-avg(metric)',\n  'time-min(metric)',\n  'time-max(metric)',\n] as const;\n\nexport type PrometheusFunction = (typeof PROMETHEUS_FUNCTIONS)[number];\n\ntype MapEntry = {\n  name: PrometheusFunction;\n  fn: (args: any) => string;\n};\n\nexport const PROMQL_FUNCTIONS = new Map<PrometheusFunction, MapEntry>([\n  // methods exposed in the promql API\n  ...['avg', 'sum', 'stddev', 'quantile', 'min', 'max'].map(\n    (name) =>\n      [\n        name,\n        {\n          name,\n          fn: (args: any) => (promql as any)[name](args),\n        },\n      ] as [PrometheusFunction, MapEntry]\n  ),\n  // custom functions that we define ourselves\n  [\n    'histogram_quantile',\n    {\n      name: 'histogram_quantile',\n      // histogram_quantile is not available in the tsqtsq library\n      fn: ({ expr, parameter }: { expr: string; parameter: number }) => `histogram_quantile(${parameter},${expr})`,\n    },\n  ],\n  [\n    'time-avg(metric)',\n    {\n      name: 'time-avg(metric)',\n      fn: ({ expr }: { expr: string }) => `time()-avg(${expr})`,\n    },\n  ],\n  [\n    'time-min(metric)',\n    {\n      name: 'time-min(metric)',\n      fn: ({ expr }: { expr: string }) => `time()-min(${expr})`,\n    },\n  ],\n  [\n    'time-max(metric)',\n    {\n      name: 'time-max(metric)',\n      fn: ({ expr }: { expr: string }) => `time()-max(${expr})`,\n    },\n  ],\n]);\n","import { displayWarning } from 'MetricsReducer/helpers/displayStatus';\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\nimport { PREF_KEYS } from 'shared/user-preferences/pref-keys';\nimport { userStorage } from 'shared/user-preferences/userStorage';\n\nimport { CONFIG_PRESETS, type PanelConfigPreset } from './presets/types';\nimport { PROMQL_FUNCTIONS } from './promql-functions';\nimport { AVAILABLE_PANEL_TYPES } from '../types/available-panel-types';\n\nconst availableConfigPresetIds = new Set<string>(Object.values(CONFIG_PRESETS));\nconst availablePanelTypes = new Set<string>(AVAILABLE_PANEL_TYPES);\n\nexport function getPreferredConfigForMetric(metric: string): PanelConfigPreset | undefined {\n  const userPrefs = userStorage.getItem(PREF_KEYS.METRIC_PREFS) || {};\n  const metricConfig = userPrefs[metric]?.config;\n\n  if (!metricConfig) {\n    return undefined;\n  }\n\n  if (!isValid(metricConfig)) {\n    reportExploreMetrics('invalid_metric_config', { metricConfig });\n\n    delete userPrefs[metric]?.config;\n    userStorage.setItem(PREF_KEYS.METRIC_PREFS, userPrefs);\n\n    displayWarning([\n      `Invalid configuration found for metric ${metric}!`,\n      'The configuration has been deleted and will not be applied.',\n    ]);\n\n    return undefined;\n  }\n\n  return metricConfig;\n}\n\n/* eslint-disable sonarjs/prefer-single-boolean-return */\nexport function isValid(metricConfig: PanelConfigPreset): boolean {\n  if (!['id', 'panelOptions', 'queryOptions'].every((key) => key in metricConfig)) {\n    return false;\n  }\n\n  if (typeof metricConfig.id !== 'string' || !availableConfigPresetIds.has(metricConfig.id)) {\n    return false;\n  }\n\n  if (typeof metricConfig.panelOptions.type !== 'string' || !availablePanelTypes.has(metricConfig.panelOptions.type)) {\n    return false;\n  }\n\n  if (!Array.isArray(metricConfig.queryOptions.queries)) {\n    return false;\n  }\n\n  if (\n    !metricConfig.queryOptions.queries.every((q) => {\n      if (!PROMQL_FUNCTIONS.has(q.fn)) {\n        return false;\n      }\n\n      if (!['quantile', 'histogram_quantile'].includes(q.fn)) {\n        return true;\n      }\n\n      if (!Array.isArray(q.params?.percentiles) || !q.params.percentiles.length) {\n        return false;\n      }\n\n      return q.params.percentiles.every((p) => p >= 1 && p <= 99);\n    })\n  ) {\n    return false;\n  }\n\n  return true;\n}\n","export const AVAILABLE_PANEL_TYPES = [\n  'heatmap',\n  'percentiles',\n  'stat',\n  'statushistory',\n  'timeseries',\n  // TODO for info metrics, see https://github.com/grafana/metrics-drilldown/issues/450\n  // 'table',\n] as const;\n\nexport type PanelType = (typeof AVAILABLE_PANEL_TYPES)[number];\n","// height in pixels\nexport enum PANEL_HEIGHT {\n  S = 160,\n  M = 220,\n  L = 260,\n  XL = 280,\n}\n","// the resolution determines the maxDataPoints of the query runner (e.g. see src/GmdVizPanel/statushistory/getStatushistoryQueryRunnerParams.ts)\nexport enum QUERY_RESOLUTION {\n  HIGH = 'HIGH',\n  MEDIUM = 'MEDIUM',\n}\n","const STATUS_UPDOWN_METRIC_REGEX = /_up$/;\n\nexport const isStatusUpDownMetric = (metric: string) => metric === 'up' || STATUS_UPDOWN_METRIC_REGEX.test(metric);\n","import { type DataTrail } from 'AppDataTrail/DataTrail';\n\nimport { getMetricType } from './getMetricType';\nimport { isStatusUpDownMetric } from './isStatusUpDownMetric';\nimport { type HistogramType } from '../GmdVizPanel';\nimport { type PanelType } from '../types/available-panel-types';\n\n/**\n * These are functions that receive a metric name to determine in which panel type they should be displayed.\n * Note that they don't consider user preferences stored in user storage.\n */\nexport async function getPanelTypeForMetric(metric: string, dataTrail: DataTrail): Promise<PanelType> {\n  const metricType = await getMetricType(metric, dataTrail);\n\n  switch (metricType) {\n    case 'classic-histogram':\n    case 'native-histogram':\n      return 'heatmap';\n\n    case 'status-updown':\n      return 'statushistory';\n\n    case 'counter':\n    case 'age':\n    default:\n      return 'timeseries';\n  }\n}\n\n/**\n * A sync version to use when we already know the histogram type and performance is important\n */\nexport function getPanelTypeForMetricSync(metric: string, histogramType: HistogramType): PanelType {\n  if (histogramType === 'classic' || histogramType === 'native') {\n    return 'heatmap';\n  }\n\n  return isStatusUpDownMetric(metric) ? 'statushistory' : 'timeseries';\n}\n","export const DEFAULT_UNIT = 'none';\nexport const DEFAULT_RATE_UNIT = 'cps'; // Count per second\n\n// Unit constants\nexport const UNIT_BYTES = 'bytes';\nexport const UNIT_SECONDS = 'seconds';\nconst UNIT_PERCENT = 'percent';\nconst UNIT_COUNT = 'count';\n\n// Rate unit constants\nexport const RATE_BYTES_PER_SECOND = 'Bps';\n\nconst UNIT_MAP: Record<string, string> = {\n  [UNIT_BYTES]: UNIT_BYTES,\n  [UNIT_SECONDS]: 's',\n  [UNIT_PERCENT]: UNIT_PERCENT,\n  [UNIT_COUNT]: DEFAULT_UNIT,\n};\n\nconst UNIT_LIST = Object.keys(UNIT_MAP); // used to check if a metric name contains any of the supported units\n\nconst RATE_UNIT_MAP: Record<string, string> = {\n  [UNIT_BYTES]: RATE_BYTES_PER_SECOND,\n  // seconds per second is unitless\n  [UNIT_SECONDS]: DEFAULT_UNIT,\n  [UNIT_COUNT]: DEFAULT_RATE_UNIT,\n  [UNIT_PERCENT]: UNIT_PERCENT,\n};\n\n// Get unit from metric name (e.g. \"go_gc_duration_seconds\" -> \"seconds\")\nexport function getUnitFromMetric(metric: string) {\n  // Get last two parts of the metric name and check if they are valid units\n  const metricParts = metric.toLowerCase().split('_').slice(-2);\n  for (let i = metricParts.length - 1; i >= Math.max(0, metricParts.length - 2); i--) {\n    const part = metricParts[i];\n    if (UNIT_LIST.includes(part)) {\n      return part;\n    }\n  }\n\n  return null;\n}\n\n// Get Grafana unit for a panel (e.g. \"go_gc_duration_seconds\" -> \"s\")\nexport function getUnit(metricName: string) {\n  const metricPart = getUnitFromMetric(metricName);\n  return (metricPart && UNIT_MAP[metricPart.toLowerCase()]) || DEFAULT_UNIT;\n}\n\nexport function getPerSecondRateUnit(metricName: string) {\n  const metricPart = getUnitFromMetric(metricName);\n  return (metricPart && RATE_UNIT_MAP[metricPart]) || DEFAULT_RATE_UNIT;\n}\n","import { isValidLegacyName, utf8Support } from '@grafana/prometheus';\nimport { Expression, MatchingOperator, promql } from 'tsqtsq';\n\nimport { VAR_FILTERS } from 'shared/shared';\n\nexport type LabelMatcher = {\n  key: string;\n  operator: string;\n  value: string;\n};\n\nfunction expressionToString(expression: Expression) {\n  // see hacks in buildQueryExpression() below\n  return expression.toString().replaceAll('=\"__REMOVE__\"', '');\n}\n\ntype Options = {\n  metric: string;\n  labelMatchers?: LabelMatcher[];\n  addIgnoreUsageFilter?: boolean;\n  addExtremeValuesFiltering?: boolean;\n};\n\nexport function buildQueryExpression(options: Options): string {\n  const { metric, labelMatchers = [], addIgnoreUsageFilter = true, addExtremeValuesFiltering = false } = options;\n\n  const defaultSelectors = labelMatchers.map((m) => ({\n    label: utf8Support(m.key),\n    operator: m.operator as MatchingOperator,\n    value: m.value,\n  }));\n\n  if (addIgnoreUsageFilter) {\n    defaultSelectors.push({ label: '__ignore_usage__', operator: MatchingOperator.equal, value: '' });\n  }\n\n  const isUtf8Metric = !isValidLegacyName(metric);\n  if (isUtf8Metric) {\n    // hack to have the UTF-8 metric name in braces alongside labels\n    // but without extra quotes associated with an empty label value\n    defaultSelectors.push({ label: utf8Support(metric), operator: MatchingOperator.equal, value: '__REMOVE__' });\n  }\n\n  // hack for Scenes to interpolate the VAR_FILTERS variable\n  // added last so that, if filters are empty, the query is still valid\n  // and we're using :raw for variables containing special characters (like equal signs etc.)\n  defaultSelectors.push({ label: `\\${${VAR_FILTERS}:raw}`, operator: MatchingOperator.equal, value: '__REMOVE__' });\n\n  const expression = new Expression({\n    metric,\n    values: {},\n    defaultOperator: MatchingOperator.equal,\n    defaultSelectors,\n  });\n\n  const expressionString = expressionToString(expression);\n\n  if (addExtremeValuesFiltering) {\n    return promql.and({\n      left: expressionString,\n      right: `${expressionString} > -Inf`,\n    });\n  }\n\n  return expressionString;\n}\n","import { promql } from 'tsqtsq';\n\nimport { buildQueryExpression } from 'shared/GmdVizPanel/buildQueryExpression';\nimport { QUERY_RESOLUTION } from 'shared/GmdVizPanel/config/query-resolutions';\n\nimport { type GetQueryRunnerParamsOptions, type QueryRunnerParams } from '../panelBuilder';\n\nexport function getHeatmapQueryRunnerParams(options: GetQueryRunnerParamsOptions): QueryRunnerParams {\n  const { metric, histogramType, queryConfig } = options;\n  const expression = buildQueryExpression({\n    metric,\n    labelMatchers: queryConfig.labelMatchers,\n    addIgnoreUsageFilter: queryConfig.addIgnoreUsageFilter,\n    addExtremeValuesFiltering: queryConfig.addExtremeValuesFiltering,\n  });\n\n  const query =\n    histogramType === 'native'\n      ? promql.sum({ expr: promql.rate({ expr: expression }) })\n      : promql.sum({ expr: promql.rate({ expr: expression }), by: ['le'] });\n\n  return {\n    maxDataPoints: queryConfig.resolution === QUERY_RESOLUTION.HIGH ? 500 : 250,\n    queries: [\n      {\n        refId: `${metric}-heatmap`,\n        expr: query,\n        format: 'heatmap',\n        fromExploreMetrics: true,\n      },\n    ],\n  };\n}\n","const COUNTER_METRIC_REGEX = /_(count|total|sum)$/;\n\nexport const isCounterMetric = (metric: string) => COUNTER_METRIC_REGEX.test(metric);\n","import { type SceneDataQuery } from '@grafana/scenes';\nimport { promql } from 'tsqtsq';\n\nimport { buildQueryExpression } from 'shared/GmdVizPanel/buildQueryExpression';\nimport { PROMQL_FUNCTIONS } from 'shared/GmdVizPanel/config/promql-functions';\nimport { QUERY_RESOLUTION } from 'shared/GmdVizPanel/config/query-resolutions';\nimport { type QueryConfig, type QueryDefs } from 'shared/GmdVizPanel/GmdVizPanel';\n\nimport { isCounterMetric as isCounterMetricFn } from '../..//matchers/isCounterMetric';\nimport { type GetQueryRunnerParamsOptions, type QueryRunnerParams } from '../panelBuilder';\n\nconst DEFAULT_PERCENTILES = [99, 90, 50] as const;\n\nexport function getPercentilesQueryRunnerParams(options: GetQueryRunnerParamsOptions): QueryRunnerParams {\n  const { metric, histogramType, queryConfig } = options;\n  const isCounterMetric = isCounterMetricFn(metric);\n  const expression = buildQueryExpression({\n    metric,\n    labelMatchers: queryConfig.labelMatchers,\n    addIgnoreUsageFilter: queryConfig.addIgnoreUsageFilter,\n    addExtremeValuesFiltering: queryConfig.addExtremeValuesFiltering,\n  });\n\n  const queries =\n    histogramType === 'none'\n      ? buildNonHistogramQueries({\n          metric,\n          queryConfig,\n          isRateQuery: isCounterMetric,\n          expr: expression,\n        })\n      : buildHistogramQueries({\n          metric,\n          isNativeHistogram: histogramType === 'native',\n          queryConfig,\n          expr: expression,\n        });\n\n  return {\n    isRateQuery: histogramType !== 'none' ? true : isCounterMetric,\n    maxDataPoints: queryConfig.resolution === QUERY_RESOLUTION.HIGH ? 500 : 250,\n    queries,\n  };\n}\n\nfunction buildHistogramQueries({\n  metric,\n  isNativeHistogram,\n  queryConfig,\n  expr,\n}: {\n  metric: string;\n  isNativeHistogram: boolean;\n  queryConfig: QueryConfig;\n  expr: string;\n}): SceneDataQuery[] {\n  const queryDefs: QueryDefs = queryConfig.queries?.length\n    ? queryConfig.queries\n    : [{ fn: 'histogram_quantile', params: { percentiles: DEFAULT_PERCENTILES } }];\n\n  const queries: SceneDataQuery[] = [];\n\n  const newExpr = isNativeHistogram\n    ? promql.sum({ expr: promql.rate({ expr }) })\n    : promql.sum({ expr: promql.rate({ expr }), by: ['le'] });\n\n  for (const { fn, params } of queryDefs) {\n    const entry = PROMQL_FUNCTIONS.get(fn)!;\n    const fnName = entry.name;\n    const percentiles = params?.percentiles || DEFAULT_PERCENTILES;\n\n    for (const percentile of percentiles) {\n      const parameter = percentile / 100;\n      const query = entry.fn({ expr: newExpr, parameter });\n\n      queries.push({\n        refId: `${metric}-p${percentile}-${fnName}`,\n        expr: query,\n        legendFormat: `${percentile}th Percentile`,\n        fromExploreMetrics: true,\n      });\n    }\n  }\n\n  return queries;\n}\n\nfunction buildNonHistogramQueries({\n  metric,\n  queryConfig,\n  isRateQuery,\n  expr,\n}: {\n  metric: string;\n  queryConfig: QueryConfig;\n  isRateQuery: boolean;\n  expr: string;\n}): SceneDataQuery[] {\n  const queryDefs: QueryDefs = queryConfig.queries?.length\n    ? queryConfig.queries\n    : [{ fn: 'quantile', params: { percentiles: [99, 90, 50] } }];\n\n  const queries: SceneDataQuery[] = [];\n  const newExpr = isRateQuery ? promql.rate({ expr }) : expr;\n\n  for (const { fn, params } of queryDefs) {\n    const entry = PROMQL_FUNCTIONS.get(fn)!;\n    const fnName = isRateQuery ? `${entry.name}(rate)` : entry.name;\n\n    for (const percentile of params!.percentiles) {\n      const parameter = percentile / 100;\n      const query = entry.fn({ expr: newExpr, parameter });\n\n      queries.push({\n        refId: `${metric}-p${percentile}-${fnName}`,\n        expr: query,\n        legendFormat: `${percentile}th Percentile`,\n        fromExploreMetrics: true,\n      });\n    }\n  }\n\n  return queries;\n}\n","import { type SceneDataQuery } from '@grafana/scenes';\nimport { promql } from 'tsqtsq';\n\nimport { buildQueryExpression } from 'shared/GmdVizPanel/buildQueryExpression';\nimport { PROMQL_FUNCTIONS } from 'shared/GmdVizPanel/config/promql-functions';\nimport { QUERY_RESOLUTION } from 'shared/GmdVizPanel/config/query-resolutions';\nimport { type QueryConfig, type QueryDefs } from 'shared/GmdVizPanel/GmdVizPanel';\n\nimport { isCounterMetric } from '../../matchers/isCounterMetric';\nimport { type GetQueryRunnerParamsOptions, type QueryRunnerParams } from '../panelBuilder';\n\nexport function getStatQueryRunnerParams(options: GetQueryRunnerParamsOptions): QueryRunnerParams {\n  const { metric, queryConfig } = options;\n  const isRateQuery = isCounterMetric(metric);\n  const expression = buildQueryExpression({\n    metric,\n    labelMatchers: queryConfig.labelMatchers,\n    addIgnoreUsageFilter: queryConfig.addIgnoreUsageFilter,\n    addExtremeValuesFiltering: queryConfig.addExtremeValuesFiltering,\n  });\n\n  const expr = isRateQuery ? promql.rate({ expr: expression, interval: '$__rate_interval' }) : expression;\n\n  return {\n    isRateQuery,\n    maxDataPoints: queryConfig.resolution === QUERY_RESOLUTION.HIGH ? 500 : 250,\n    queries: buildQueriesWithPresetFunctions({ metric, queryConfig, isRateQuery, expr }),\n  };\n}\n\n// here we support preset functions\nfunction buildQueriesWithPresetFunctions({\n  metric,\n  queryConfig,\n  isRateQuery,\n  expr,\n}: {\n  metric: string;\n  queryConfig: QueryConfig;\n  isRateQuery: boolean;\n  expr: string;\n}): SceneDataQuery[] {\n  const defaultPromqlFn = isRateQuery ? 'sum' : 'avg';\n  const queryDefs: QueryDefs = queryConfig.queries?.length ? queryConfig.queries : [{ fn: defaultPromqlFn }];\n  const queries: SceneDataQuery[] = [];\n\n  for (const { fn } of queryDefs) {\n    const entry = PROMQL_FUNCTIONS.get(fn)!;\n    const query = entry.fn({ expr });\n    const fnName = isRateQuery ? `${entry.name}(rate)` : entry.name;\n\n    queries.push({\n      refId: `${metric}-${fnName}`,\n      expr: query,\n      legendFormat: fnName,\n      fromExploreMetrics: true,\n    });\n  }\n\n  return queries;\n}\n","import { type ValueMapping } from '@grafana/data';\nimport { MappingType } from '@grafana/schema';\n\nexport const UP_DOWN_VALUE_MAPPINGS: ValueMapping[] = [\n  {\n    type: MappingType.ValueToText,\n    options: {\n      '0': {\n        color: 'red',\n        text: 'down',\n      },\n      '1': {\n        color: 'green',\n        text: 'up',\n      },\n    },\n  },\n] as const;\n","import { promql } from 'tsqtsq';\n\nimport { buildQueryExpression } from 'shared/GmdVizPanel/buildQueryExpression';\nimport { QUERY_RESOLUTION } from 'shared/GmdVizPanel/config/query-resolutions';\n\nimport { type GetQueryRunnerParamsOptions, type QueryRunnerParams } from '../panelBuilder';\n\nexport function getStatushistoryQueryRunnerParams(options: GetQueryRunnerParamsOptions): QueryRunnerParams {\n  const { metric, queryConfig } = options;\n  const expression = buildQueryExpression({\n    metric,\n    labelMatchers: queryConfig.labelMatchers,\n    addIgnoreUsageFilter: queryConfig.addIgnoreUsageFilter,\n    addExtremeValuesFiltering: queryConfig.addExtremeValuesFiltering,\n  });\n\n  const query = promql.min({ expr: expression });\n\n  return {\n    maxDataPoints: queryConfig.resolution === QUERY_RESOLUTION.HIGH ? 200 : 100,\n    queries: [\n      {\n        refId: `${metric}-status`,\n        expr: query,\n        legendFormat: 'status',\n        fromExploreMetrics: true,\n      },\n    ],\n  };\n}\n","import { type SceneDataQuery } from '@grafana/scenes';\nimport { promql } from 'tsqtsq';\n\nimport { buildQueryExpression } from 'shared/GmdVizPanel/buildQueryExpression';\nimport { PROMQL_FUNCTIONS } from 'shared/GmdVizPanel/config/promql-functions';\nimport { QUERY_RESOLUTION } from 'shared/GmdVizPanel/config/query-resolutions';\nimport { type QueryConfig, type QueryDefs } from 'shared/GmdVizPanel/GmdVizPanel';\n\nimport { isCounterMetric } from '../../matchers/isCounterMetric';\n\ntype TimeseriesQueryRunnerParams = {\n  isRateQuery: boolean;\n  maxDataPoints: number;\n  queries: SceneDataQuery[];\n};\n\ntype Options = {\n  metric: string;\n  queryConfig: QueryConfig;\n  // When provided, overrides the name-based heuristic for applying rate().\n  // This lets callers flip rate vs raw after an async metadata check.\n  isRateQueryOverride?: boolean;\n};\n\nexport function getTimeseriesQueryRunnerParams(options: Options): TimeseriesQueryRunnerParams {\n  const { metric, queryConfig, isRateQueryOverride } = options;\n  // Prefer explicit override when available; otherwise fall back to heuristic.\n  const isRateQuery = typeof isRateQueryOverride === 'boolean' ? isRateQueryOverride : isCounterMetric(metric);\n\n  const expression = buildQueryExpression({\n    metric,\n    labelMatchers: queryConfig.labelMatchers,\n    addIgnoreUsageFilter: queryConfig.addIgnoreUsageFilter,\n    addExtremeValuesFiltering: queryConfig.addExtremeValuesFiltering,\n  });\n\n  const expr = isRateQuery ? promql.rate({ expr: expression, interval: '$__rate_interval' }) : expression;\n\n  return {\n    isRateQuery,\n    maxDataPoints: queryConfig.resolution === QUERY_RESOLUTION.HIGH ? 500 : 250,\n    queries: queryConfig.groupBy\n      ? buildGroupByQueries({ metric, queryConfig, isRateQuery, expr })\n      : buildQueriesWithPresetFunctions({ metric, queryConfig, isRateQuery, expr }),\n  };\n}\n\n// if grouped by, we don't provide support for preset functions\nfunction buildGroupByQueries({\n  metric,\n  queryConfig,\n  isRateQuery,\n  expr,\n}: {\n  metric: string;\n  queryConfig: QueryConfig;\n  isRateQuery: boolean;\n  expr: string;\n}): SceneDataQuery[] {\n  return [\n    {\n      refId: `${metric}-by-${queryConfig.groupBy}`,\n      expr: isRateQuery\n        ? promql.sum({ expr, by: [queryConfig.groupBy!] })\n        : promql.avg({ expr, by: [queryConfig.groupBy!] }),\n      legendFormat: `{{${queryConfig.groupBy}}}`,\n      fromExploreMetrics: true,\n    },\n  ];\n}\n\n// here we support preset functions\nfunction buildQueriesWithPresetFunctions({\n  metric,\n  queryConfig,\n  isRateQuery,\n  expr,\n}: {\n  metric: string;\n  queryConfig: QueryConfig;\n  isRateQuery: boolean;\n  expr: string;\n}): SceneDataQuery[] {\n  const defaultPromqlFn = isRateQuery ? 'sum' : 'avg';\n  const queryDefs: QueryDefs = queryConfig.queries?.length ? queryConfig.queries : [{ fn: defaultPromqlFn }];\n  const queries: SceneDataQuery[] = [];\n\n  for (const { fn } of queryDefs) {\n    const entry = PROMQL_FUNCTIONS.get(fn)!;\n    const query = entry.fn({ expr });\n    const fnName = isRateQuery ? `${entry.name}(rate)` : entry.name;\n\n    queries.push({\n      refId: `${metric}-${fnName}`,\n      expr: query,\n      legendFormat: fnName,\n      fromExploreMetrics: true,\n    });\n  }\n\n  return queries;\n}\n","import { type DataFrame, type Field } from '@grafana/data';\n\ninterface FieldWithEntitiesNaN extends Field<any> {\n  entities: {\n    NaN: number[];\n  };\n}\n\n/**\n * Checks if all data in the series contains only NaN values,\n * short-circuiting if any frame contains non-NaN values.\n */\nexport function isAllDataNaN(series: DataFrame[]): boolean {\n  return series.every(isDataFrameAllNaN);\n}\n\n/**\n * Checks if all the values in the DataFrame are NaN\n */\nfunction isDataFrameAllNaN(frame: DataFrame): boolean {\n  const valuesField = frame.fields.find((field) => field.name === 'Value');\n\n  if (!valuesField || !isFieldWithEntitiesNaN(valuesField)) {\n    return false;\n  }\n\n  return valuesField.entities.NaN.length === frame.length;\n}\n\nfunction isFieldWithEntitiesNaN(field: Field): field is FieldWithEntitiesNaN {\n  return 'entities' in field && Array.isArray((field as FieldWithEntitiesNaN).entities?.NaN);\n}\n","import { css } from '@emotion/css';\nimport { LoadingState, type GrafanaTheme2 } from '@grafana/data';\nimport { sceneGraph, SceneQueryRunner, type CancelActivationHandler, type VizPanel } from '@grafana/scenes';\nimport { Icon, Tooltip, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\nimport { isCounterMetric } from 'shared/GmdVizPanel/matchers/isCounterMetric';\nimport { getTimeseriesQueryRunnerParams } from 'shared/GmdVizPanel/types/timeseries/getTimeseriesQueryRunnerParams';\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\n\nimport { isAllDataNaN } from './isAllDataNaN';\n\n/**\n * A stateless function that detects when all data in a query result is NaN\n * and attempts to re-run the query with extreme value filtering.\n *\n * This addresses the issue where Prometheus metrics with extremely small values\n * (e.g., 9e-129) cause arithmetic operations during averaging to underflow\n * or become undefined, resulting in NaN for queries like `avg(some_metric_with_extreme_values)`.\n *\n * @remarks\n * Implementing this as a behavior allows us to apply the extreme values filtering\n * to only the queries that are affected by the extreme values, rather than all queries in the scene.\n * That way, we can keep queries simpler by default, and only apply the extreme values filtering\n * when it's necessary.\n */\nexport function extremeValueFilterBehavior(panel: VizPanel): CancelActivationHandler | void {\n  // works only for timeseries panels...\n  if (panel.state.pluginId !== 'timeseries') {\n    return;\n  }\n\n  // ...with a query runner attached...\n  const [queryRunner] = sceneGraph.findDescendents(panel, SceneQueryRunner);\n  if (!queryRunner) {\n    return;\n  }\n\n  // ...that has some queries...\n  const { queries } = queryRunner.state;\n  if (!queries?.length) {\n    return;\n  }\n\n  const { metric, queryConfig } = sceneGraph.getAncestor(panel, GmdVizPanel).state;\n\n  // ... and only for non-counter metrics, because counter metrics translate to rate queries (see getTimeseriesQueryRunnerParams.ts)\n  // and this the behavior does not support it\n  if (isCounterMetric(metric)) {\n    return;\n  }\n\n  // When the query runner's state changes, check if the data is all NaN.\n  // If it is, remove the extreme values from the query.\n  const queryRunnerSub = queryRunner.subscribeToState((newState, prevState) => {\n    // wait to receive series\n    if (\n      newState.data?.state !== LoadingState.Done ||\n      !newState.data.series?.length ||\n      newState.data.series === prevState.data?.series\n    ) {\n      return;\n    }\n\n    // discard the behaviour if non-timeseries data is received\n    const dataFrameType = newState.data.series[0].meta?.type;\n    if (dataFrameType && !dataFrameType.startsWith('timeseries')) {\n      return;\n    }\n\n    // act only if all data is NaN\n    if (!isAllDataNaN(newState.data.series)) {\n      return;\n    }\n\n    // rebuild query with extreme values filtering\n    const queryParams = getTimeseriesQueryRunnerParams({\n      metric,\n      queryConfig: { ...queryConfig, addExtremeValuesFiltering: true },\n    });\n\n    // update and run the new queries\n    queryRunner.setState({ queries: queryParams.queries });\n    queryRunner.runQueries();\n\n    panel.setState({\n      titleItems: (\n        <VizPanelExtremeValuesMessage\n          level=\"info\"\n          message=\"Panel data was re-fetched with a more complex query to handle extremely small values in the series\"\n        />\n      ),\n    });\n\n    reportExploreMetrics('extreme_value_filter_behavior_triggered', {\n      expression: sceneGraph.interpolate(queryRunner, queryRunner.state.queries[0].expr),\n    });\n  });\n\n  return () => {\n    queryRunnerSub.unsubscribe();\n  };\n}\n\ninterface VizPanelExtremeValuesMessageProps {\n  message: string;\n  level: 'warning' | 'info';\n}\n\nfunction VizPanelExtremeValuesMessage({ message, level }: Readonly<VizPanelExtremeValuesMessageProps>) {\n  const styles = useStyles2(getStyles, level);\n\n  return (\n    <div className={styles.extremeValuedisclaimer}>\n      <Tooltip content={message}>\n        <span className={styles.warningMessage}>\n          <Icon name={level === 'warning' ? 'exclamation-triangle' : 'info-circle'} aria-hidden=\"true\" />\n        </span>\n      </Tooltip>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2, level: 'warning' | 'info') => ({\n  extremeValuedisclaimer: css({\n    label: 'extreme-value-disclaimer',\n    display: 'flex',\n    alignItems: 'center',\n    gap: theme.spacing(1),\n  }),\n  warningMessage: css({\n    display: 'flex',\n    alignItems: 'center',\n    gap: theme.spacing(0.5),\n    color: level === 'warning' ? theme.colors.warning.main : theme.colors.info.main,\n    fontSize: theme.typography.bodySmall.fontSize,\n  }),\n});\n","import { type PromMetricsMetadataItem } from '@grafana/prometheus';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\n\n\n/**\n * Maps Prometheus `metadata.type` to a binary \"should use rate()\" decision for timeseries queries.\n *\n * Mapping:\n * - 'counter' -> true (use rate)\n * - 'gauge' -> false (do not use rate)\n * - 'histogram' | 'summary' | anything else or missing -> undefined (inconclusive; caller should fall back to existing logic)\n *\n * @param metadata Prometheus metrics metadata item for a specific metric name\n * @returns true if counter, false if definitively not a counter, otherwise undefined.\n */\nexport function computeIsCounterFromMetadata(\n  metadata?: PromMetricsMetadataItem\n): boolean | undefined {\n  const type = metadata?.type?.toLowerCase();\n  if (!type) {\n    return undefined;\n  }\n\n  if (type === 'counter') {\n    return true;\n  }\n\n  if (type === 'gauge') {\n    return false;\n  }\n\n  // Unknown/untyped or unsupported types -> inconclusive\n  return undefined;\n}\n\n/**\n * Fetches Prometheus metadata via DataTrail and applies `computeIsCounterFromMetadata`.\n * Errors and missing metadata are treated as inconclusive (undefined) so that callers\n * can preserve heuristic behavior.\n *\n * @param metric Metric name\n * @param dataTrail Scene's DataTrail to access datasource helper/cache\n * @returns Promise resolving to the same mapping as `computeIsCounterFromMetadata`.\n */\nexport async function getIsCounterFromMetadata(\n  metric: string,\n  dataTrail: DataTrail\n): Promise<boolean | undefined> {\n  try {\n    const metadata = await dataTrail.getMetadataForMetric(metric);\n    return computeIsCounterFromMetadata(metadata);\n  } catch {\n    return undefined;\n  }\n}\n\n\n","import { type SceneObject, type SceneQueryRunner } from '@grafana/scenes';\n\nexport function isSceneQueryRunner(input: SceneObject | null | undefined): input is SceneQueryRunner {\n  return typeof input !== 'undefined' && input !== null && 'state' in input && 'runQueries' in input;\n}\n","import { type DataFrame } from '@grafana/data';\nimport { map, type Observable } from 'rxjs';\n\nexport const addRefId = () => (source: Observable<DataFrame[]>) =>\n  source.pipe(\n    map((data: DataFrame[]) =>\n      data?.map((d, i) => {\n        d.refId = `${d.refId}-${i}`;\n        return d;\n      })\n    )\n  );\n","import { type DataFrame } from '@grafana/data';\nimport { map, type Observable } from 'rxjs';\n\nexport const addUnspecifiedLabel = (label: string) => () => (source: Observable<DataFrame[]>) =>\n  source.pipe(\n    map((data: DataFrame[]) => {\n      // eslint-disable-next-line sonarjs/no-nested-functions\n      return data?.map((d) => {\n        if (!d?.fields[1]) {\n          return d;\n        }\n\n        if (!d.fields[1].labels?.[label]) {\n          d.fields[1].labels = { ...d.fields[1].labels, [label]: `<unspecified ${label}>` };\n        }\n\n        return d;\n      });\n    })\n  );\n","import { type DataFrame } from '@grafana/data';\nimport { map, type Observable } from 'rxjs';\n\nconst SERIES_COUNT_STATS_NAME = 'seriesCount';\n\nexport const sliceSeries = (start: number, end: number) => () => (source: Observable<DataFrame[]>) =>\n  source.pipe(\n    map((data: DataFrame[]) =>\n      // eslint-disable-next-line sonarjs/no-nested-functions\n      data?.slice(start, end).map((d) => {\n        d.meta = { ...d.meta };\n        d.meta.stats ||= [];\n        d.meta.stats.unshift({ displayName: SERIES_COUNT_STATS_NAME, value: data.length });\n        return d;\n      })\n    )\n  );\n","import { PanelBuilders, SceneDataTransformer, SceneQueryRunner, type VizPanel } from '@grafana/scenes';\nimport { SortOrder, TooltipDisplayMode, type LegendPlacement } from '@grafana/schema';\n\nimport { extremeValueFilterBehavior } from 'shared/GmdVizPanel/behaviors/extremeValueFilterBehavior/extremeValueFilterBehavior';\nimport { getIsCounterFromMetadata } from 'shared/GmdVizPanel/matchers/isCounterFromMetadata';\nimport { trailDS } from 'shared/shared';\nimport { getColorByIndex, getTrailFor } from 'shared/utils/utils';\nimport { isSceneQueryRunner } from 'shared/utils/utils.queries';\n\nimport { getPerSecondRateUnit, getUnit } from '../../units/getUnit';\nimport { type BuildVizPanelOptions } from '../panelBuilder';\nimport { getTimeseriesQueryRunnerParams } from './getTimeseriesQueryRunnerParams';\nimport { addRefId } from './transformations/addRefId';\nimport { addUnspecifiedLabel } from './transformations/addUnspecifiedLabel';\nimport { sliceSeries } from './transformations/sliceSeries';\n\nexport function buildTimeseriesPanel(options: BuildVizPanelOptions): VizPanel {\n  if (options.queryConfig.groupBy) {\n    return buildGroupByPanel(options as Required<BuildVizPanelOptions>);\n  }\n\n  const { metric, panelConfig, queryConfig } = options;\n  // Build immediately using heuristic so UI renders quickly.\n  const queryParams = getTimeseriesQueryRunnerParams({ metric, queryConfig });\n  const unit = queryParams.isRateQuery ? getPerSecondRateUnit(metric) : getUnit(metric);\n\n  const $data =\n    queryConfig.data ||\n    new SceneQueryRunner({\n      datasource: trailDS,\n      maxDataPoints: queryParams.maxDataPoints,\n      queries: queryParams.queries,\n    });\n\n  const vizPanelBuilder = PanelBuilders.timeseries()\n    .setTitle(panelConfig.title)\n    .setDescription(panelConfig.description)\n    .setHeaderActions(panelConfig.headerActions({ metric, panelConfig }))\n    .setMenu(panelConfig.menu?.({ metric, panelConfig }))\n    .setShowMenuAlways(Boolean(panelConfig.menu))\n    .setData($data)\n    .setUnit(unit)\n    .setOption('legend', panelConfig.legend || { showLegend: true, placement: 'bottom' as LegendPlacement })\n    .setCustomFieldConfig('fillOpacity', 9)\n    .setBehaviors([extremeValueFilterBehavior, ...(panelConfig.behaviors || [])]);\n\n  if (queryParams.queries.length > 1) {\n    const startColorIndex = panelConfig.fixedColorIndex || 0;\n\n    vizPanelBuilder.setOverrides((b) => {\n      queryParams.queries.forEach((query, i) => {\n        b.matchFieldsByQuery(query.refId).overrideColor({\n          mode: 'fixed',\n          fixedColor: getColorByIndex(startColorIndex + i),\n        });\n      });\n    });\n  } else {\n    vizPanelBuilder.setColor(\n      panelConfig.fixedColorIndex\n        ? { mode: 'fixed', fixedColor: getColorByIndex(panelConfig.fixedColorIndex) }\n        : undefined\n    );\n  }\n\n  const vizPanel = vizPanelBuilder.build();\n\n  // Use Scenes lifecycle: run after this panel is activated/attached.\n  vizPanel.addActivationHandler(() => {\n    (async () => {\n      const dataTrail = getTrailFor(vizPanel);\n      const isCounter = await getIsCounterFromMetadata(metric, dataTrail);\n      \n      if (typeof isCounter !== 'boolean') {\n        return; // inconclusive; keep heuristic\n      }\n      \n      if (isCounter === queryParams.isRateQuery) {\n        return; // no need to correct\n      }\n      \n      const corrected = getTimeseriesQueryRunnerParams({ metric, queryConfig, isRateQueryOverride: isCounter });\n      // Prefer the panel's direct SceneQueryRunner; if it's wrapped, bail (group-by path handles separately).\n      const provider = vizPanel.state.$data as unknown as SceneQueryRunner;\n      if (provider && isSceneQueryRunner(provider)) {\n        provider.setState({\n          maxDataPoints: corrected.maxDataPoints,\n          queries: corrected.queries,\n        });\n        provider.runQueries();\n      }\n    })().catch(() => {});\n  });\n\n  return vizPanel;\n}\n\nexport const MAX_SERIES_TO_RENDER_WHEN_GROUPED_BY = 20;\n\nfunction buildGroupByPanel(options: Required<BuildVizPanelOptions>): VizPanel {\n  const { metric, panelConfig, queryConfig } = options;\n  const queryParams = getTimeseriesQueryRunnerParams({ metric, queryConfig });\n  const unit = queryParams.isRateQuery ? getPerSecondRateUnit(metric) : getUnit(metric);\n\n  const $data = new SceneDataTransformer({\n    $data: new SceneQueryRunner({\n      datasource: trailDS,\n      maxDataPoints: queryParams.maxDataPoints,\n      queries: queryParams.queries,\n    }),\n    transformations: [\n      sliceSeries(0, MAX_SERIES_TO_RENDER_WHEN_GROUPED_BY),\n      addUnspecifiedLabel(queryConfig.groupBy!),\n      addRefId, // for overriding colors below\n    ],\n  });\n\n  const { refId } = queryParams.queries[0];\n  const startColorIndex = panelConfig.fixedColorIndex || 0;\n\n  const vizPanel = PanelBuilders.timeseries()\n    .setTitle(panelConfig.title)\n    .setDescription(panelConfig.description)\n    .setHeaderActions(panelConfig.headerActions({ metric, panelConfig }))\n    .setMenu(panelConfig.menu?.({ metric, panelConfig }))\n    .setShowMenuAlways(Boolean(panelConfig.menu))\n    .setData($data)\n    .setUnit(unit)\n    .setOption('legend', panelConfig.legend || { showLegend: true, placement: 'right' as LegendPlacement })\n    .setOption('tooltip', { mode: TooltipDisplayMode.Multi, sort: SortOrder.Descending })\n    .setOverrides((b) => {\n      for (let i = 0; i < MAX_SERIES_TO_RENDER_WHEN_GROUPED_BY; i++) {\n        b.matchFieldsByQuery(`${refId}-${i}`).overrideColor({\n          mode: 'fixed',\n          fixedColor: getColorByIndex(startColorIndex + i),\n        });\n      }\n    })\n    .setBehaviors(panelConfig.behaviors)\n    .build();\n\n  return vizPanel;\n}\n","import { type SceneDataQuery, type VizPanel } from '@grafana/scenes';\n\nimport { type HistogramType, type PanelConfig, type QueryConfig } from '../GmdVizPanel';\nimport { type PanelType } from './available-panel-types';\nimport { buildHeatmapPanel } from './heatmap/buildHeatmapPanel';\nimport { getHeatmapQueryRunnerParams } from './heatmap/getHeatmapQueryRunnerParams';\nimport { buildPercentilesPanel } from './percentiles/buildPercentilesPanel';\nimport { getPercentilesQueryRunnerParams } from './percentiles/getPercentilesQueryRunnerParams';\nimport { buildStatPanel } from './stat/buildStatPanel';\nimport { getStatQueryRunnerParams } from './stat/getStatQueryRunnerParams';\nimport { buildStatushistoryPanel } from './statushistory/buildStatushistoryPanel';\nimport { getStatushistoryQueryRunnerParams } from './statushistory/getStatushistoryQueryRunnerParams';\nimport { buildTimeseriesPanel } from './timeseries/buildTimeseriesPanel';\nimport { getTimeseriesQueryRunnerParams } from './timeseries/getTimeseriesQueryRunnerParams';\n\nexport type BuildVizPanelOptions = {\n  metric: string;\n  panelConfig: PanelConfig;\n  queryConfig: QueryConfig;\n  histogramType?: HistogramType; // heatmap & percentiles\n};\n\nexport type GetQueryRunnerParamsOptions = {\n  metric: string;\n  queryConfig: QueryConfig;\n  histogramType?: HistogramType; //  heatmap & percentiles\n};\n\nexport type QueryRunnerParams = {\n  maxDataPoints: number;\n  queries: SceneDataQuery[];\n  isRateQuery?: boolean;\n};\n\nexport type Builders = {\n  buildVizPanel: (options: BuildVizPanelOptions) => VizPanel;\n  getQueryRunnerParams: (options: GetQueryRunnerParamsOptions) => QueryRunnerParams;\n};\n\nexport const PANEL_TYPE_TO_BUILDERS_LOOKUP = new Map<PanelType, Builders>([\n  [\n    'timeseries',\n    {\n      buildVizPanel: buildTimeseriesPanel,\n      getQueryRunnerParams: getTimeseriesQueryRunnerParams,\n    },\n  ],\n  [\n    'heatmap',\n    {\n      buildVizPanel: buildHeatmapPanel,\n      getQueryRunnerParams: getHeatmapQueryRunnerParams,\n    },\n  ],\n  [\n    'percentiles',\n    {\n      buildVizPanel: buildPercentilesPanel,\n      getQueryRunnerParams: getPercentilesQueryRunnerParams,\n    },\n  ],\n  [\n    'statushistory',\n    {\n      buildVizPanel: buildStatushistoryPanel,\n      getQueryRunnerParams: getStatushistoryQueryRunnerParams,\n    },\n  ],\n  [\n    'stat',\n    {\n      buildVizPanel: buildStatPanel,\n      getQueryRunnerParams: getStatQueryRunnerParams,\n    },\n  ],\n]);\n\nfunction getBuildersForPanelType(panelType: PanelType): Builders {\n  const buildersForPanelType = PANEL_TYPE_TO_BUILDERS_LOOKUP.get(panelType);\n  if (!buildersForPanelType) {\n    throw new TypeError(`Unsupported panel type \"${panelType}\"!`);\n  }\n  return buildersForPanelType;\n}\n\nexport const panelBuilder = {\n  buildVizPanel(options: BuildVizPanelOptions) {\n    return getBuildersForPanelType(options.panelConfig.type).buildVizPanel(options);\n  },\n  getQueryRunnerParams(options: GetQueryRunnerParamsOptions & { panelType: PanelType }) {\n    const { metric, queryConfig, panelType } = options;\n    return getBuildersForPanelType(panelType).getQueryRunnerParams({ metric, queryConfig });\n  },\n};\n","import { PanelBuilders, SceneQueryRunner, type VizPanel } from '@grafana/scenes';\nimport {\n  HeatmapColorMode,\n  type HeatmapLegend,\n} from '@grafana/schema/dist/esm/raw/composable/heatmap/panelcfg/x/HeatmapPanelCfg_types.gen';\n\nimport { trailDS } from 'shared/shared';\n\nimport { getUnit } from '../../units/getUnit';\nimport { type BuildVizPanelOptions } from '../panelBuilder';\nimport { getHeatmapQueryRunnerParams } from './getHeatmapQueryRunnerParams';\n\nexport function buildHeatmapPanel(options: BuildVizPanelOptions): VizPanel {\n  const { metric, histogramType, panelConfig, queryConfig } = options;\n  const queryParams = getHeatmapQueryRunnerParams({\n    metric,\n    queryConfig,\n    histogramType,\n  });\n  const unit = getUnit(metric);\n\n  const queryRunner =\n    queryConfig.data ||\n    new SceneQueryRunner({\n      datasource: trailDS,\n      maxDataPoints: queryParams.maxDataPoints,\n      queries: queryParams.queries,\n    });\n\n  return PanelBuilders.heatmap()\n    .setTitle(panelConfig.title)\n    .setDescription(panelConfig.description)\n    .setHeaderActions(panelConfig.headerActions({ metric, panelConfig }))\n    .setMenu(panelConfig.menu?.({ metric, panelConfig }))\n    .setShowMenuAlways(Boolean(panelConfig.menu))\n    .setData(queryRunner)\n    .setUnit(unit)\n    .setOption('calculate', false)\n    .setOption('color', {\n      mode: HeatmapColorMode.Scheme,\n      exponent: 0.5,\n      scheme: 'Spectral',\n      steps: 32,\n      reverse: false,\n    })\n    .setOption('legend', panelConfig.legend as HeatmapLegend)\n    .build();\n}\n","import { PanelBuilders, SceneQueryRunner } from '@grafana/scenes';\nimport { SortOrder, TooltipDisplayMode, type LegendPlacement } from '@grafana/schema';\n\nimport { getPerSecondRateUnit, getUnit } from 'shared/GmdVizPanel/units/getUnit';\nimport { trailDS } from 'shared/shared';\nimport { getColorByIndex } from 'shared/utils/utils';\n\nimport { type BuildVizPanelOptions } from '../panelBuilder';\nimport { getPercentilesQueryRunnerParams } from './getPercentilesQueryRunnerParams';\n\nexport function buildPercentilesPanel(options: BuildVizPanelOptions) {\n  const { metric, histogramType, panelConfig, queryConfig } = options;\n  const queryParams = getPercentilesQueryRunnerParams({ metric, histogramType, queryConfig });\n  const unit = queryParams.isRateQuery ? getPerSecondRateUnit(metric) : getUnit(metric);\n\n  const $data =\n    queryConfig.data ||\n    new SceneQueryRunner({\n      datasource: trailDS,\n      maxDataPoints: queryParams.maxDataPoints,\n      queries: queryParams.queries,\n    });\n\n  const startColorIndex = panelConfig.fixedColorIndex || 0;\n\n  return PanelBuilders.timeseries()\n    .setTitle(panelConfig.title)\n    .setDescription(panelConfig.description)\n    .setHeaderActions(panelConfig.headerActions({ metric, panelConfig }))\n    .setMenu(panelConfig.menu?.({ metric, panelConfig }))\n    .setShowMenuAlways(Boolean(panelConfig.menu))\n    .setData($data)\n    .setUnit(unit)\n    .setOption('legend', panelConfig.legend || { showLegend: true, placement: 'bottom' as LegendPlacement })\n    .setOption('tooltip', { mode: TooltipDisplayMode.Multi, sort: SortOrder.Descending })\n    .setCustomFieldConfig('fillOpacity', 9)\n    .setOverrides((b) => {\n      queryParams.queries.forEach((query, i) => {\n        b.matchFieldsByQuery(query.refId).overrideColor({\n          mode: 'fixed',\n          fixedColor: getColorByIndex(startColorIndex + i),\n        });\n      });\n    })\n    .setBehaviors(panelConfig.behaviors || [])\n    .build();\n}\n","import { PanelBuilders, SceneQueryRunner, type VizPanel } from '@grafana/scenes';\nimport { VisibilityMode, type LegendPlacement } from '@grafana/schema';\n\nimport { trailDS } from 'shared/shared';\n\nimport { type BuildVizPanelOptions } from '../panelBuilder';\nimport { getStatushistoryQueryRunnerParams } from './getStatushistoryQueryRunnerParams';\nimport { UP_DOWN_VALUE_MAPPINGS } from './value-mappings';\n\nexport function buildStatushistoryPanel(options: BuildVizPanelOptions): VizPanel {\n  const { metric, panelConfig, queryConfig } = options;\n  const queryParams = getStatushistoryQueryRunnerParams({ metric, queryConfig });\n  const unit = 'none';\n\n  const queryRunner =\n    queryConfig.data ||\n    new SceneQueryRunner({\n      datasource: trailDS,\n      maxDataPoints: queryParams.maxDataPoints,\n      queries: queryParams.queries,\n    });\n\n  return (\n    PanelBuilders.statushistory()\n      .setTitle(panelConfig.title)\n      .setDescription(panelConfig.description)\n      .setHeaderActions(panelConfig.headerActions({ metric, panelConfig }))\n      .setMenu(panelConfig.menu?.({ metric, panelConfig }))\n      .setShowMenuAlways(Boolean(panelConfig.menu))\n      .setData(queryRunner)\n      .setUnit(unit)\n      // Use value mappings for both color and text display\n      .setColor({ mode: 'palette-classic' })\n      .setOption('showValue', VisibilityMode.Never)\n      .setOption('legend', panelConfig.legend || { showLegend: true, placement: 'bottom' as LegendPlacement })\n      .setOption('perPage', 0) // hide pagination at the bottom of the panel\n      .setMappings(UP_DOWN_VALUE_MAPPINGS) // current support is only for up/down values\n      .build()\n  );\n}\n","import { PanelBuilders, SceneQueryRunner, type VizPanel } from '@grafana/scenes';\n\nimport { trailDS } from 'shared/shared';\nimport { getColorByIndex } from 'shared/utils/utils';\n\nimport { type BuildVizPanelOptions } from '../panelBuilder';\nimport { getStatQueryRunnerParams } from './getStatQueryRunnerParams';\nimport { UP_DOWN_VALUE_MAPPINGS } from '../statushistory/value-mappings';\n\nexport function buildStatPanel(options: BuildVizPanelOptions): VizPanel {\n  const { metric, panelConfig, queryConfig } = options;\n  const queryParams = getStatQueryRunnerParams({ metric, queryConfig });\n  const unit = 'none';\n\n  const queryRunner =\n    queryConfig.data ||\n    new SceneQueryRunner({\n      datasource: trailDS,\n      maxDataPoints: queryParams.maxDataPoints,\n      queries: queryParams.queries,\n    });\n\n  return PanelBuilders.stat()\n    .setTitle(panelConfig.title)\n    .setDescription(panelConfig.description)\n    .setHeaderActions(panelConfig.headerActions({ metric, panelConfig }))\n    .setMenu(panelConfig.menu?.({ metric, panelConfig }))\n    .setShowMenuAlways(Boolean(panelConfig.menu))\n    .setData(queryRunner)\n    .setUnit(unit)\n    .setColor({ mode: 'fixed', fixedColor: getColorByIndex(panelConfig.fixedColorIndex || 0) })\n    .setMappings(UP_DOWN_VALUE_MAPPINGS) // current support is only for up/down values\n    .build();\n}\n","import { css } from '@emotion/css';\nimport { DataFrameType, LoadingState, type GrafanaTheme2, type ValueMapping } from '@grafana/data';\nimport {\n  SceneObjectBase,\n  type SceneComponentProps,\n  type SceneDataProvider,\n  type SceneObjectState,\n  type VizPanel,\n  type VizPanelState,\n} from '@grafana/scenes';\nimport { useStyles2, type VizLegendOptions } from '@grafana/ui';\nimport { isEqual } from 'lodash';\nimport React from 'react';\n\nimport { getTrailFor } from 'shared/utils/utils';\n\nimport { type LabelMatcher } from './buildQueryExpression';\nimport { EventPanelTypeChanged } from './components/EventPanelTypeChanged';\nimport { SelectAction } from './components/SelectAction';\nimport { getPreferredConfigForMetric } from './config/getPreferredConfigForMetric';\nimport { PANEL_HEIGHT } from './config/panel-heights';\nimport { type PrometheusFunction } from './config/promql-functions';\nimport { QUERY_RESOLUTION } from './config/query-resolutions';\nimport { getPanelTypeForMetricSync } from './matchers/getPanelTypeForMetric';\nimport { isClassicHistogramMetric } from './matchers/isClassicHistogramMetric';\nimport { type PanelType } from './types/available-panel-types';\nimport { panelBuilder } from './types/panelBuilder';\n\n/* Panel config */\n\ntype HeaderActionAndMenuArgs = { metric: string; panelConfig: PanelConfig };\n\nexport type PanelConfig = {\n  type: PanelType;\n  title: string;\n  height: PANEL_HEIGHT;\n  headerActions: (headerActionsArgs: HeaderActionAndMenuArgs) => VizPanelState['headerActions'];\n  fixedColorIndex?: number;\n  description?: string;\n  menu?: (menuArgs: HeaderActionAndMenuArgs) => VizPanelState['menu'];\n  legend?: Partial<VizLegendOptions>;\n  mappings?: ValueMapping[];\n  behaviors?: VizPanelState['$behaviors'];\n};\n\nexport type PanelOptions = {\n  type?: PanelConfig['type'];\n  height?: PanelConfig['height'];\n  fixedColorIndex?: PanelConfig['fixedColorIndex'];\n  title?: PanelConfig['title'];\n  description?: PanelConfig['description'];\n  headerActions?: PanelConfig['headerActions'];\n  menu?: PanelConfig['menu'];\n  legend?: PanelConfig['legend'];\n  mappings?: PanelConfig['mappings'];\n  behaviors?: PanelConfig['behaviors'];\n};\n\n/* Query config */\n\nexport type QueryDefs = Array<{\n  fn: PrometheusFunction;\n  params?: Record<string, any>;\n}>;\n\nexport type QueryConfig = {\n  resolution: QUERY_RESOLUTION;\n  labelMatchers: LabelMatcher[];\n  addIgnoreUsageFilter: boolean;\n  addExtremeValuesFiltering?: boolean;\n  groupBy?: string;\n  queries?: QueryDefs;\n  data?: SceneDataProvider;\n};\n\nexport type QueryOptions = {\n  resolution?: QueryConfig['resolution'];\n  labelMatchers?: QueryConfig['labelMatchers'];\n  groupBy?: string;\n  queries?: QueryDefs;\n  data?: QueryConfig['data'];\n};\n\n/* GmdVizPanelState */\n\nexport type HistogramType = 'native' | 'classic' | 'none';\n\ninterface GmdVizPanelState extends SceneObjectState {\n  metric: string;\n  histogramType: HistogramType;\n  panelConfig: PanelConfig;\n  queryConfig: QueryConfig;\n  body?: VizPanel;\n}\n\nexport class GmdVizPanel extends SceneObjectBase<GmdVizPanelState> {\n  constructor({\n    key,\n    metric,\n    panelOptions,\n    queryOptions,\n    discardUserPrefs,\n  }: {\n    key?: string;\n    metric: GmdVizPanelState['metric'];\n    panelOptions?: PanelOptions;\n    queryOptions?: QueryOptions;\n    discardUserPrefs?: boolean;\n  }) {\n    const histogramType = isClassicHistogramMetric(metric) ? 'classic' : 'none';\n    const prefConfig = discardUserPrefs ? undefined : getPreferredConfigForMetric(metric);\n\n    super({\n      key,\n      metric,\n      histogramType,\n      panelConfig: {\n        // we want a panel type to be able to render the panel as soon as possible after activation\n        // so we don't determine if the metric is a native histogram here because it's an async process that will be done in onActivate()\n        type: panelOptions?.type || getPanelTypeForMetricSync(metric, histogramType),\n        title: metric,\n        height: PANEL_HEIGHT.M,\n        headerActions: ({ metric }) => [new SelectAction({ metric })],\n        ...panelOptions,\n        ...prefConfig?.panelOptions,\n      },\n      queryConfig: {\n        resolution: QUERY_RESOLUTION.MEDIUM,\n        labelMatchers: [],\n        addIgnoreUsageFilter: true,\n        ...queryOptions,\n        ...prefConfig?.queryOptions,\n      },\n      body: undefined,\n    });\n\n    this.addActivationHandler(() => {\n      this.onActivate(Boolean(panelOptions?.type || prefConfig?.panelOptions.type));\n    });\n  }\n\n  private async onActivate(discardPanelTypeUpdates: boolean) {\n    const { metric, panelConfig } = this.state;\n\n    this.buildVizPanel();\n\n    this.subscribeToStateChanges(discardPanelTypeUpdates);\n    this.subscribeToEvents();\n\n    const isNativeHistogram = await getTrailFor(this).isNativeHistogram(metric);\n    if (isNativeHistogram) {\n      this.setState({\n        histogramType: 'native',\n        panelConfig: discardPanelTypeUpdates\n          ? panelConfig\n          : { description: 'Native Histogram ', ...panelConfig, type: 'heatmap' },\n      });\n    }\n  }\n\n  private subscribeToStateChanges(discardPanelTypeUpdates: boolean) {\n    const { histogramType, body, panelConfig } = this.state;\n\n    // in addition to using the metadata fetched in src/helpers/MetricDatasourceHelper.ts to determine if the metric is a native histogram or not,\n    // we give another chance to display it properly by looking into the data frame type received\n    if (!discardPanelTypeUpdates && histogramType === 'none') {\n      const bodySub = (body?.state.$data as SceneDataProvider)?.subscribeToState((newState) => {\n        if (newState.data?.state !== LoadingState.Done) {\n          return;\n        }\n\n        const dataFrameType = newState.data.series[0]?.meta?.type;\n        if (!dataFrameType) {\n          return;\n        }\n\n        if (dataFrameType === DataFrameType.HeatmapCells) {\n          this.setState({\n            histogramType: 'native',\n            panelConfig: { description: 'Native Histogram ', ...panelConfig, type: 'heatmap' },\n          });\n        }\n\n        bodySub.unsubscribe();\n      });\n\n      this._subs.add(bodySub);\n    }\n\n    this.subscribeToState((newState, prevState) => {\n      if (\n        newState.histogramType !== prevState.histogramType ||\n        !isEqual(newState.panelConfig, prevState.panelConfig) ||\n        !isEqual(newState.queryConfig, prevState.queryConfig)\n      ) {\n        this.buildVizPanel();\n      }\n    });\n  }\n\n  private subscribeToEvents() {\n    this.subscribeToEvent(EventPanelTypeChanged, (event) => {\n      this.setState({\n        panelConfig: {\n          ...this.state.panelConfig,\n          type: event.payload.panelType,\n        },\n      });\n    });\n  }\n\n  private buildVizPanel() {\n    const { metric, panelConfig, queryConfig, histogramType } = this.state;\n\n    this.setState({\n      body: panelBuilder.buildVizPanel({\n        metric,\n        panelConfig,\n        queryConfig,\n        histogramType,\n      }),\n    });\n  }\n\n  public update(panelOptions: PanelOptions, queryOptions: QueryOptions) {\n    const { panelConfig, queryConfig } = this.state;\n\n    this.setState({\n      panelConfig: {\n        ...panelConfig,\n        ...panelOptions,\n      },\n      queryConfig: {\n        ...queryConfig,\n        ...queryOptions,\n      },\n    });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<GmdVizPanel>) => {\n    const { body, panelConfig } = model.useState();\n    const styles = useStyles2(getStyles, panelConfig.height);\n\n    return (\n      <div className={styles.container} data-testid=\"gmd-vizpanel\">\n        {body && <body.Component model={body} />}\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2, height: PANEL_HEIGHT) {\n  return {\n    container: css`\n      width: 100%;\n      height: ${height}px;\n    `,\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport {\n  behaviors,\n  SceneCSSGridItem,\n  SceneCSSGridLayout,\n  sceneGraph,\n  SceneObjectBase,\n  SceneReactObject,\n  type MultiValueVariable,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { DashboardCursorSync } from '@grafana/schema';\nimport { Spinner, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { InlineBanner } from 'App/InlineBanner';\nimport { SceneByVariableRepeater } from 'MetricsReducer/components/SceneByVariableRepeater';\nimport { ShowMoreButton } from 'MetricsReducer/components/ShowMoreButton';\nimport { LayoutSwitcher, LayoutType, type LayoutSwitcherState } from 'MetricsReducer/list-controls/LayoutSwitcher';\nimport { ConfigurePanelAction } from 'shared/GmdVizPanel/components/ConfigurePanelAction';\nimport { SelectAction } from 'shared/GmdVizPanel/components/SelectAction';\nimport { GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\n\nimport { VIZ_PANEL_HEIGHT, WithUsageDataPreviewPanel } from './WithUsageDataPreviewPanel';\n\nexport const GRID_TEMPLATE_COLUMNS = 'repeat(auto-fit, minmax(400px, 1fr))';\nexport const GRID_TEMPLATE_ROWS = '1fr';\n\ninterface MetricsListState extends SceneObjectState {\n  variableName: string;\n  body: SceneByVariableRepeater;\n}\n\nexport class MetricsList extends SceneObjectBase<MetricsListState> {\n  constructor({ variableName }: { variableName: MetricsListState['variableName'] }) {\n    super({\n      key: 'metrics-list',\n      variableName,\n      body: new SceneByVariableRepeater({\n        variableName,\n        initialPageSize: 120,\n        pageSizeIncrement: 9,\n        body: new SceneCSSGridLayout({\n          children: [],\n          isLazy: true,\n          templateColumns: GRID_TEMPLATE_COLUMNS,\n          autoRows: VIZ_PANEL_HEIGHT,\n          $behaviors: [\n            new behaviors.CursorSync({\n              key: 'metricCrosshairSync',\n              sync: DashboardCursorSync.Crosshair,\n            }),\n          ],\n        }),\n        getLayoutLoading: () =>\n          new SceneReactObject({\n            reactNode: <Spinner inline />,\n          }),\n        getLayoutEmpty: () =>\n          new SceneReactObject({\n            reactNode: (\n              <InlineBanner title=\"\" severity=\"info\">\n                No metrics found for the current filters and time range.\n              </InlineBanner>\n            ),\n          }),\n        getLayoutError: (error: Error) =>\n          new SceneReactObject({\n            reactNode: <InlineBanner severity=\"error\" title=\"Error while loading metrics!\" error={error} />,\n          }),\n        getLayoutChild: (option, colorIndex) => {\n          const metric = option.value as string;\n\n          return new SceneCSSGridItem({\n            body: new WithUsageDataPreviewPanel({\n              metric: option.value as string,\n              vizPanelInGridItem: new GmdVizPanel({\n                metric,\n                panelOptions: {\n                  fixedColorIndex: colorIndex,\n                  headerActions: () => [new ConfigurePanelAction({ metric }), new SelectAction({ metric })],\n                },\n              }),\n            }),\n          });\n        },\n      }),\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.subscribeToLayoutChange();\n  }\n\n  private subscribeToLayoutChange() {\n    const layoutSwitcher = sceneGraph.findByKeyAndType(this, 'layout-switcher', LayoutSwitcher);\n    const body = this.state.body.state.body as SceneCSSGridLayout;\n\n    const onChangeState = (newState: LayoutSwitcherState, prevState?: LayoutSwitcherState) => {\n      if (newState.layout !== prevState?.layout) {\n        body.setState({\n          templateColumns: newState.layout === LayoutType.ROWS ? GRID_TEMPLATE_ROWS : GRID_TEMPLATE_COLUMNS,\n        });\n      }\n    };\n\n    onChangeState(layoutSwitcher.state); // ensure layout when landing on the page\n\n    this._subs.add(layoutSwitcher.subscribeToState(onChangeState));\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<MetricsList>) => {\n    const { variableName, body } = model.useState();\n    const styles = useStyles2(getStyles);\n\n    const variable = sceneGraph.lookupVariable(variableName, model) as MultiValueVariable;\n    const { loading, error } = variable.useState();\n\n    const batchSizes = body.useSizes();\n    const shouldDisplayShowMoreButton =\n      !loading && !error && batchSizes.total > 0 && batchSizes.current < batchSizes.total;\n\n    const onClickShowMore = () => {\n      body.increaseBatchSize();\n    };\n\n    return (\n      <div data-testid=\"metrics-list\">\n        <div className={styles.container}>\n          <body.Component model={body} />\n        </div>\n        {shouldDisplayShowMoreButton && (\n          <div className={styles.footer}>\n            <ShowMoreButton label=\"metric\" batchSizes={batchSizes} onClick={onClickShowMore} />\n          </div>\n        )}\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({}),\n    footer: css({\n      display: 'flex',\n      justifyContent: 'center',\n      alignItems: 'center',\n      marginTop: theme.spacing(4),\n\n      '& button': {\n        height: '40px',\n        borderRadius: '8px',\n      },\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { DashboardCursorSync, type GrafanaTheme2 } from '@grafana/data';\nimport {\n  behaviors,\n  SceneCSSGridItem,\n  SceneCSSGridLayout,\n  sceneGraph,\n  SceneObjectBase,\n  SceneReactObject,\n  SceneVariableSet,\n  type AdHocFiltersVariable,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { Button, CollapsableSection, Spinner, useStyles2 } from '@grafana/ui';\nimport React, { useState } from 'react';\n\nimport { SceneByVariableRepeater } from 'MetricsReducer/components/SceneByVariableRepeater';\nimport { ShowMoreButton } from 'MetricsReducer/components/ShowMoreButton';\nimport { LayoutSwitcher, LayoutType, type LayoutSwitcherState } from 'MetricsReducer/list-controls/LayoutSwitcher';\nimport { MetricsVariable } from 'MetricsReducer/metrics-variables/MetricsVariable';\nimport {\n  VIZ_PANEL_HEIGHT_WITH_USAGE_DATA_PREVIEW,\n  WithUsageDataPreviewPanel,\n} from 'MetricsReducer/MetricsList/WithUsageDataPreviewPanel';\nimport { GroupsIcon } from 'MetricsReducer/SideBar/custom-icons/GroupsIcon';\nimport { ConfigurePanelAction } from 'shared/GmdVizPanel/components/ConfigurePanelAction';\nimport { SelectAction } from 'shared/GmdVizPanel/components/SelectAction';\nimport { GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\nimport { VAR_FILTERS } from 'shared/shared';\n\nimport { GRID_TEMPLATE_COLUMNS, GRID_TEMPLATE_ROWS } from '..//MetricsList/MetricsList';\nimport { InlineBanner } from '../../App/InlineBanner';\nimport { NULL_GROUP_BY_VALUE } from '../labels/LabelsDataSource';\nimport { VAR_WINGMAN_GROUP_BY, type LabelsVariable } from '../labels/LabelsVariable';\n\ninterface MetricsGroupByRowState extends SceneObjectState {\n  index: number;\n  labelName: string;\n  labelValue: string;\n  labelCardinality: number;\n  $variables: SceneVariableSet;\n  body: SceneByVariableRepeater;\n}\n\nexport class MetricsGroupByRow extends SceneObjectBase<MetricsGroupByRowState> {\n  public constructor({\n    index,\n    labelName,\n    labelValue,\n    labelCardinality,\n  }: {\n    index: MetricsGroupByRowState['index'];\n    labelName: MetricsGroupByRowState['labelName'];\n    labelValue: MetricsGroupByRowState['labelValue'];\n    labelCardinality: MetricsGroupByRowState['labelCardinality'];\n  }) {\n    const variableName = `var-metrics-${labelName}-${labelValue}`;\n\n    super({\n      index,\n      labelName,\n      labelValue,\n      labelCardinality,\n      key: `${labelName}-${labelValue}`,\n      $variables: new SceneVariableSet({\n        variables: [\n          new MetricsVariable({\n            key: variableName,\n            name: variableName,\n            labelMatcher: { key: labelName, operator: '=', value: labelValue },\n            addLifeCycleEvents: true,\n          }),\n        ],\n      }),\n      body: new SceneByVariableRepeater({\n        variableName: variableName,\n        initialPageSize: 3,\n        body: new SceneCSSGridLayout({\n          children: [],\n          isLazy: true,\n          templateColumns: GRID_TEMPLATE_COLUMNS,\n          autoRows: VIZ_PANEL_HEIGHT_WITH_USAGE_DATA_PREVIEW,\n          $behaviors: [\n            new behaviors.CursorSync({\n              key: 'metricCrosshairSync',\n              sync: DashboardCursorSync.Crosshair,\n            }),\n          ],\n        }),\n        getLayoutLoading: () =>\n          new SceneReactObject({\n            reactNode: <Spinner inline />,\n          }),\n        getLayoutEmpty: () =>\n          new SceneReactObject({\n            reactNode: (\n              <InlineBanner title=\"\" severity=\"info\">\n                No metrics found for the current filters and time range.\n              </InlineBanner>\n            ),\n          }),\n        getLayoutError: (error: Error) =>\n          new SceneReactObject({\n            reactNode: <InlineBanner severity=\"error\" title=\"Error while loading metrics!\" error={error} />,\n          }),\n        getLayoutChild: (option, colorIndex) => {\n          const metric = option.value as string;\n\n          return new SceneCSSGridItem({\n            body: new WithUsageDataPreviewPanel({\n              metric,\n              vizPanelInGridItem: new GmdVizPanel({\n                metric,\n                panelOptions: {\n                  fixedColorIndex: colorIndex,\n                  headerActions: () => [new SelectAction({ metric }), new ConfigurePanelAction({ metric })],\n                },\n                queryOptions: {\n                  labelMatchers: [{ key: labelName, operator: '=', value: labelValue }],\n                },\n              }),\n            }),\n          });\n        },\n      }),\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.subscribeToLayoutChange();\n  }\n\n  private subscribeToLayoutChange() {\n    const layoutSwitcher = sceneGraph.findByKeyAndType(this, 'layout-switcher', LayoutSwitcher);\n    const body = this.state.body.state.body as SceneCSSGridLayout;\n\n    const onChangeState = (newState: LayoutSwitcherState, prevState?: LayoutSwitcherState) => {\n      if (newState.layout !== prevState?.layout) {\n        body.setState({\n          templateColumns: newState.layout === LayoutType.ROWS ? GRID_TEMPLATE_ROWS : GRID_TEMPLATE_COLUMNS,\n        });\n      }\n    };\n\n    onChangeState(layoutSwitcher.state); // ensure layout when landing on the page\n\n    this._subs.add(layoutSwitcher.subscribeToState(onChangeState));\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<MetricsGroupByRow>) => {\n    const [isCollapsed, setIsCollapsed] = useState(false);\n    const styles = useStyles2(getStyles);\n\n    const { index, labelName, labelValue, labelCardinality, $variables, body } = model.useState();\n\n    const variable = $variables.state.variables[0] as MetricsVariable;\n    const { loading, error } = variable.useState();\n\n    const batchSizes = body.useSizes();\n    const shouldDisplayShowMoreButton =\n      !loading && !error && batchSizes.total > 0 && batchSizes.current < batchSizes.total;\n\n    const onClickShowMore = () => {\n      body.increaseBatchSize();\n    };\n\n    const onClickSelect = () => {\n      const adHocFiltersVariable = sceneGraph.lookupVariable(VAR_FILTERS, model) as AdHocFiltersVariable;\n\n      adHocFiltersVariable.setState({\n        // TOOD: keep unique filters\n        filters: [...adHocFiltersVariable.state.filters, { key: labelName, operator: '=', value: labelValue }],\n      });\n\n      (sceneGraph.lookupVariable(VAR_WINGMAN_GROUP_BY, model) as LabelsVariable)?.changeValueTo(NULL_GROUP_BY_VALUE);\n    };\n\n    return (\n      <div className={styles.container} data-testid={`${labelName}-${labelValue}-metrics-group`}>\n        <div className={styles.containerHeader}>\n          <div className={styles.headerButtons}>\n            <Button\n              className={styles.selectButton}\n              variant=\"secondary\"\n              onClick={onClickSelect}\n              tooltip={`See metrics with ${labelName}=${labelValue}`}\n              tooltipPlacement=\"top\"\n            >\n              Select\n            </Button>\n          </div>\n        </div>\n\n        {\n          <CollapsableSection\n            isOpen={!isCollapsed}\n            onToggle={() => setIsCollapsed(!isCollapsed)}\n            label={\n              <div className={styles.groupName}>\n                <GroupsIcon />\n                <div className={styles.labelValue}>{labelValue}</div>\n                {labelCardinality > 1 && (\n                  <div className={styles.index}>\n                    ({index + 1}/{labelCardinality})\n                  </div>\n                )}\n              </div>\n            }\n          >\n            <div className={styles.collapsableSectionBody}>\n              <body.Component model={body} />\n            </div>\n\n            {shouldDisplayShowMoreButton && (\n              <div className={styles.footer}>\n                <ShowMoreButton\n                  label=\"metric\"\n                  batchSizes={batchSizes}\n                  onClick={onClickShowMore}\n                  tooltip={`Show more metrics for ${labelName}=\"${labelValue}\"`}\n                />\n              </div>\n            )}\n          </CollapsableSection>\n        }\n\n        {/* required to trigger its activation handlers */}\n        <div className={styles.variable}>\n          <variable.Component key={variable.state.name} model={variable} />\n        </div>\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      background: theme.colors.background.canvas,\n      margin: theme.spacing(1, 0, 0, 0),\n\n      '& div:focus-within': {\n        boxShadow: 'none !important',\n      },\n    }),\n    containerHeader: css({\n      display: 'flex',\n      alignItems: 'center',\n      gap: '8px',\n      marginBottom: '-36px',\n      paddingBottom: theme.spacing(1.5),\n      borderBottom: `1px solid ${theme.colors.border.medium}`,\n    }),\n    headerButtons: css({\n      position: 'relative',\n      top: '3px',\n      marginLeft: 'auto',\n      marginRight: '30px',\n      zIndex: 100,\n    }),\n    selectButton: css({\n      height: '28px',\n    }),\n    collapsableSectionBody: css({\n      display: 'flex',\n      flexDirection: 'column',\n      gap: '24px',\n      padding: theme.spacing(1),\n    }),\n    groupName: css({\n      display: 'flex',\n      alignItems: 'center',\n      fontSize: '1.3rem',\n      lineHeight: '1.3rem',\n    }),\n    labelValue: css({\n      fontSize: '16px',\n      marginLeft: '8px',\n    }),\n    index: css({\n      fontSize: '12px',\n      color: theme.colors.text.secondary,\n      marginLeft: '8px',\n    }),\n    footer: css({\n      display: 'flex',\n      justifyContent: 'center',\n      alignItems: 'center',\n      marginTop: theme.spacing(1),\n\n      '& button': {\n        height: '40px',\n      },\n    }),\n    variable: css({\n      display: 'none',\n    }),\n  };\n}\n","import { VariableHide, VariableRefresh } from '@grafana/data';\nimport { QueryVariable } from '@grafana/scenes';\nimport React from 'react';\n\nimport { LabelsDataSource } from './LabelsDataSource';\n\nexport const VAR_LABEL_VALUES = 'wingmanLabelValues';\n\nexport class LabelValuesVariable extends QueryVariable {\n  constructor({ labelName }: { labelName: string }) {\n    super({\n      name: VAR_LABEL_VALUES,\n      datasource: { uid: LabelsDataSource.uid },\n      // just some syntax we make up so that the data source can decide what to fetch\n      query: `valuesOf(${labelName})`,\n      isMulti: false,\n      allowCustomValue: false,\n      refresh: VariableRefresh.onTimeRangeChanged,\n      hide: VariableHide.hideVariable,\n      // BOTH \"value\" and \"includeAll\" below ensure the repetition in SceneByVariableRepeater\n      // // (if not set, it'll render only the 1st variable option)\n      value: '$__all',\n      includeAll: true,\n    });\n  }\n\n  public static readonly Component = () => {\n    return <></>;\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport {\n  SceneCSSGridItem,\n  SceneCSSGridLayout,\n  SceneObjectBase,\n  SceneReactObject,\n  SceneVariableSet,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { Spinner, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { SceneByVariableRepeater } from 'MetricsReducer/components/SceneByVariableRepeater';\nimport { ShowMoreButton } from 'MetricsReducer/components/ShowMoreButton';\n\nimport { MetricsGroupByRow } from './MetricsGroupByRow';\nimport { InlineBanner } from '../../App/InlineBanner';\nimport { LabelValuesVariable, VAR_LABEL_VALUES } from '../labels/LabelValuesVariable';\n\ninterface MetricsGroupByListState extends SceneObjectState {\n  labelName: string;\n  $variables: SceneVariableSet;\n  body: SceneByVariableRepeater;\n}\n\nexport class MetricsGroupByList extends SceneObjectBase<MetricsGroupByListState> {\n  constructor({ labelName }: { labelName: MetricsGroupByListState['labelName'] }) {\n    super({\n      key: 'metrics-group-list',\n      labelName,\n      $variables: new SceneVariableSet({\n        variables: [new LabelValuesVariable({ labelName })],\n      }),\n      body: new SceneByVariableRepeater({\n        variableName: VAR_LABEL_VALUES,\n        initialPageSize: 20,\n        pageSizeIncrement: 10,\n        body: new SceneCSSGridLayout({\n          children: [],\n          isLazy: true,\n          templateColumns: '1fr',\n          autoRows: 'auto',\n          rowGap: 1,\n        }),\n        getLayoutLoading: () =>\n          new SceneReactObject({\n            reactNode: <Spinner inline />,\n          }),\n        getLayoutEmpty: () =>\n          new SceneReactObject({\n            reactNode: (\n              <InlineBanner title=\"\" severity=\"info\">\n                No label values found for label &quot;{labelName}&quot;.\n              </InlineBanner>\n            ),\n          }),\n        getLayoutError: (error: Error) =>\n          new SceneReactObject({\n            reactNode: (\n              <InlineBanner severity=\"error\" title={`Error while loading label \"${labelName}\" values!`} error={error} />\n            ),\n          }),\n        getLayoutChild: (option, index, options) => {\n          return new SceneCSSGridItem({\n            body: new MetricsGroupByRow({\n              index,\n              labelName,\n              labelValue: option.value as string,\n              labelCardinality: options.length,\n            }),\n          });\n        },\n      }),\n    });\n  }\n\n  static readonly Component = ({ model }: SceneComponentProps<MetricsGroupByList>) => {\n    const styles = useStyles2(getStyles);\n    const { body, $variables, labelName } = model.useState();\n\n    const variable = $variables.state.variables[0] as LabelValuesVariable;\n    const { loading, error } = variable.useState();\n\n    const batchSizes = body.useSizes();\n    const shouldDisplayShowMoreButton =\n      !loading && !error && batchSizes.total > 0 && batchSizes.current < batchSizes.total;\n\n    const onClickShowMore = () => {\n      body.increaseBatchSize();\n    };\n\n    return (\n      <div data-testid=\"metrics-groupby-list\">\n        <body.Component model={body} />\n\n        {shouldDisplayShowMoreButton && (\n          <div className={styles.footer}>\n            <ShowMoreButton label={`\"${labelName}\" value`} batchSizes={batchSizes} onClick={onClickShowMore} />\n          </div>\n        )}\n\n        {/* required to trigger its activation handlers */}\n        <div className={styles.variable}>\n          <variable.Component key={variable.state.name} model={variable} />\n        </div>\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    footer: css({\n      display: 'flex',\n      justifyContent: 'center',\n      alignItems: 'center',\n      margin: theme.spacing(3, 0, 1, 0),\n\n      '& button': {\n        height: '40px',\n      },\n    }),\n    variable: css({\n      display: 'none',\n    }),\n  };\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\nimport { type MetricFilters } from 'MetricsReducer/metrics-variables/MetricsVariableFilterEngine';\n\ninterface EventFiltersChangedPayload {\n  type: keyof MetricFilters;\n  filters: string[];\n}\n\nexport class EventFiltersChanged extends BusEventWithPayload<EventFiltersChangedPayload> {\n  public static readonly type = 'filters-changed';\n}\n","export const RULE_GROUP_LABELS = {\n  metrics: 'Non-rules metrics',\n  rules: 'Recording rules',\n} as const;\n\nexport type RuleGroupLabel = (typeof RULE_GROUP_LABELS)[keyof typeof RULE_GROUP_LABELS];\n","import { BusEventWithPayload } from '@grafana/data';\n\ninterface EventSectionValueChangedPayload {\n  key: string;\n  values: string[];\n}\n\nexport class EventSectionValueChanged extends BusEventWithPayload<EventSectionValueChangedPayload> {\n  public static readonly type = 'section-value-changed';\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { Icon, Tooltip, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\ntype SectionTitleProps = {\n  title: string;\n  description: string;\n};\n\nexport function SectionTitle({ title, description }: Readonly<SectionTitleProps>) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <h6 className={styles.title}>\n      <span>{title}</span>\n      <Tooltip content={description} placement=\"top\">\n        <Icon name=\"info-circle\" size=\"sm\" className={styles.infoIcon} />\n      </Tooltip>\n    </h6>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    title: css({\n      fontSize: '15px',\n      fontWeight: theme.typography.fontWeightLight,\n      borderBottom: `1px solid ${theme.colors.border.weak}`,\n      paddingBottom: theme.spacing(0.5),\n    }),\n    infoIcon: css({\n      marginLeft: theme.spacing(1),\n      cursor: 'pointer',\n      color: theme.colors.text.secondary,\n      position: 'relative',\n      top: '-4px',\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { Checkbox, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nexport const CheckboxWithCount = ({\n  label,\n  count,\n  checked,\n  onChange,\n}: {\n  label: string;\n  count: number;\n  checked: boolean;\n  onChange: (e: React.ChangeEvent<HTMLInputElement>) => void;\n}) => {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.checkboxWrapper} title={label}>\n      <Checkbox label={label} value={checked} onChange={onChange} />\n      <span className={styles.count}>({count})</span>\n    </div>\n  );\n};\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    checkboxWrapper: css({\n      display: 'flex',\n      alignItems: 'center',\n      width: '100%',\n      '& label *': {\n        fontSize: '14px !important',\n        whiteSpace: 'nowrap',\n        overflow: 'hidden',\n        textOverflow: 'ellipsis',\n      },\n    }),\n    count: css({\n      color: theme.colors.text.secondary,\n      marginLeft: theme.spacing(0.5),\n      display: 'inline-block',\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { Button, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { type RuleGroupLabel } from 'MetricsReducer/SideBar/sections/MetricsFilterSection/rule-group-labels';\n\nimport { CheckboxWithCount } from './CheckboxWithCount';\nimport { type MetricsFilterSectionState } from './MetricsFilterSection';\n\ntype CheckBoxListProps = {\n  groups: MetricsFilterSectionState['groups'];\n  selectedGroups: MetricsFilterSectionState['selectedGroups'];\n  onSelectionChange: (newGroups: MetricsFilterSectionState['selectedGroups']) => void;\n};\n\nexport function CheckBoxList({ groups, selectedGroups, onSelectionChange }: Readonly<CheckBoxListProps>) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <>\n      <div className={styles.checkboxListHeader}>\n        <div>{selectedGroups.length} selected</div>\n        <Button variant=\"secondary\" fill=\"text\" onClick={() => onSelectionChange([])} disabled={!selectedGroups.length}>\n          clear\n        </Button>\n      </div>\n\n      {!groups.length && <div className={styles.noResults}>No results.</div>}\n\n      {groups.length > 0 && (\n        <ul className={styles.checkboxList} data-testid=\"checkbox-filters-list\">\n          {groups.map((group) => (\n            <li key={group.value} className={styles.checkboxItem}>\n              <CheckboxWithCount\n                label={group.label}\n                count={group.count}\n                checked={selectedGroups.some((g) => g.value === group.value)}\n                onChange={(e) => {\n                  const newGroups = e.currentTarget.checked\n                    ? [...selectedGroups, { label: group.label as RuleGroupLabel, value: group.value }]\n                    : selectedGroups.filter((v) => v.value !== group.value);\n\n                  onSelectionChange(newGroups);\n                }}\n              />\n            </li>\n          ))}\n        </ul>\n      )}\n    </>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    checkboxListHeader: css({\n      display: 'flex',\n      justifyContent: 'space-between',\n      alignItems: 'center',\n      color: theme.colors.text.secondary,\n      margin: theme.spacing(0),\n      padding: theme.spacing(0, 0, 0, 1),\n    }),\n    checkboxList: css({\n      height: '100%',\n      margin: 0,\n      padding: theme.spacing(0, 1, 1, 1),\n      overflowY: 'auto',\n      '& .css-1n4u71h-Label': {\n        fontSize: '14px !important',\n      },\n      '&::-webkit-scrollbar': {\n        '-webkit-appearance': 'none',\n        width: '7px',\n      },\n      '&::-webkit-scrollbar-thumb': {\n        borderRadius: '4px',\n        backgroundColor: theme.colors.secondary.main,\n        '-webkit-box-shadow': `0 0 1px ${theme.colors.secondary.shade}`,\n      },\n    }),\n    checkboxItem: css({\n      display: 'flex',\n      alignItems: 'center',\n      width: '100%',\n      padding: theme.spacing(0.5, 0),\n    }),\n    noResults: css({\n      fontStyle: 'italic',\n      padding: theme.spacing(0, 1, 1, 1),\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport {\n  sceneGraph,\n  SceneObjectBase,\n  SceneObjectUrlSyncConfig,\n  VariableDependencyConfig,\n  type MultiValueVariable,\n  type SceneComponentProps,\n  type SceneObjectUrlValues,\n} from '@grafana/scenes';\nimport { Icon, IconButton, Input, Spinner, Switch, useStyles2 } from '@grafana/ui';\nimport React, { useMemo, useState, type KeyboardEventHandler } from 'react';\n\nimport {\n  VAR_FILTERED_METRICS_VARIABLE,\n  type FilteredMetricsVariable,\n} from 'MetricsReducer/metrics-variables/FilteredMetricsVariable';\nimport {\n  VAR_METRICS_VARIABLE,\n  type MetricOptions,\n  type MetricsVariable,\n} from 'MetricsReducer/metrics-variables/MetricsVariable';\nimport {\n  MetricsVariableFilterEngine,\n  type MetricFilters,\n} from 'MetricsReducer/metrics-variables/MetricsVariableFilterEngine';\nimport { MetricsReducer } from 'MetricsReducer/MetricsReducer';\nimport {\n  RULE_GROUP_LABELS,\n  type RuleGroupLabel,\n} from 'MetricsReducer/SideBar/sections/MetricsFilterSection/rule-group-labels';\nimport { logger } from 'shared/logger/logger';\n\nimport { reportExploreMetrics } from '../../../../shared/tracking/interactions';\nimport { EventSectionValueChanged } from '../EventSectionValueChanged';\nimport { SectionTitle } from '../SectionTitle';\nimport { type SideBarSectionState } from '../types';\nimport { CheckBoxList } from './CheckBoxList';\nimport { EventFiltersChanged } from './EventFiltersChanged';\n\nexport interface MetricsFilterSectionState extends SideBarSectionState {\n  type: keyof MetricFilters;\n  computeGroups: (\n    options: Array<{ label: string; value: string }>\n  ) => Array<{ label: string; value: string; count: number }>;\n  showHideEmpty: boolean;\n  showSearch: boolean;\n  groups: Array<{ label: string; value: string; count: number }>;\n  selectedGroups: Array<{ label: RuleGroupLabel; value: string }>; // we need labels for displaying tooltips in `SideBar.tsx`\n  loading: boolean;\n}\n\nexport class MetricsFilterSection extends SceneObjectBase<MetricsFilterSectionState> {\n  protected _variableDependency = new VariableDependencyConfig(this, {\n    variableNames: [VAR_METRICS_VARIABLE, VAR_FILTERED_METRICS_VARIABLE],\n    onReferencedVariableValueChanged: (variable) => {\n      const { name, options } = (variable as MultiValueVariable).state;\n\n      if (name === VAR_METRICS_VARIABLE) {\n        this.updateLists(options as MetricOptions);\n        return;\n      }\n\n      if (name === VAR_FILTERED_METRICS_VARIABLE) {\n        this.updateCounts();\n      }\n    },\n  });\n\n  protected _urlSync = new SceneObjectUrlSyncConfig(this, { keys: [this.state.key] });\n\n  getUrlState() {\n    return {\n      [this.state.key]: this.state.selectedGroups.map((g) => g.value).join(','),\n    };\n  }\n\n  updateFromUrl(values: SceneObjectUrlValues) {\n    const stateUpdate: Partial<MetricsFilterSectionState> = {};\n\n    if (\n      typeof values[this.state.key] === 'string' &&\n      values[this.state.key] !== this.state.selectedGroups.map((g) => g.value).join(',')\n    ) {\n      stateUpdate.selectedGroups = (values[this.state.key] as string)\n        .split(',')\n        .map((v) => ({ label: v as RuleGroupLabel, value: v })) as Array<{ label: RuleGroupLabel; value: string }>;\n    }\n\n    this.setState(stateUpdate);\n  }\n\n  constructor({\n    key,\n    type,\n    title,\n    description,\n    icon,\n    computeGroups,\n    showHideEmpty,\n    showSearch,\n    disabled,\n    active,\n  }: {\n    key: MetricsFilterSectionState['key'];\n    type: MetricsFilterSectionState['type'];\n    title: MetricsFilterSectionState['title'];\n    description: MetricsFilterSectionState['description'];\n    icon: MetricsFilterSectionState['icon'];\n    computeGroups: MetricsFilterSectionState['computeGroups'];\n    showHideEmpty?: MetricsFilterSectionState['showHideEmpty'];\n    showSearch?: MetricsFilterSectionState['showSearch'];\n    disabled?: MetricsFilterSectionState['disabled'];\n    active?: MetricsFilterSectionState['active'];\n  }) {\n    super({\n      key,\n      type,\n      title,\n      description,\n      icon,\n      groups: [],\n      computeGroups,\n      selectedGroups: [],\n      loading: true,\n      showHideEmpty: showHideEmpty ?? true,\n      showSearch: showSearch ?? true,\n      disabled: disabled ?? false,\n      active: active ?? false,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    const metricsVariable = sceneGraph.lookupVariable(VAR_METRICS_VARIABLE, this) as MetricsVariable;\n    const filteredMetricsVariable = sceneGraph.lookupVariable(\n      VAR_FILTERED_METRICS_VARIABLE,\n      this\n    ) as FilteredMetricsVariable;\n\n    this.updateLists(metricsVariable.state.options as MetricOptions);\n    this.updateCounts();\n\n    const { selectedGroups } = this.state;\n\n    this.setState({\n      loading: filteredMetricsVariable.state.loading,\n      active: selectedGroups.length > 0,\n    });\n  }\n\n  private updateLists(options: MetricOptions) {\n    this.setState({\n      groups: this.state.computeGroups(options),\n      loading: false,\n    });\n  }\n\n  private updateCounts() {\n    const { groups, computeGroups, type } = this.state;\n\n    // Access the original unfiltered options\n    const metricsVariable = sceneGraph.lookupVariable(VAR_METRICS_VARIABLE, this) as MetricsVariable;\n    const originalOptions = metricsVariable.state.options as MetricOptions;\n\n    const metricsReducer = sceneGraph.getAncestor(this, MetricsReducer);\n    const filterEngine = metricsReducer.state.enginesMap.get(VAR_FILTERED_METRICS_VARIABLE)?.filterEngine;\n\n    if (!filterEngine) {\n      logger.warn('MetricsFilterSection: No filter engine found');\n      return;\n    }\n\n    // Create a copy of current filters excluding the current filter type\n    const filtersWithoutCurrentType = { ...filterEngine.getFilters(), [type]: [] };\n\n    // Get options filtered by everything except the current filter type\n    const optionsForCounting = MetricsVariableFilterEngine.getFilteredOptions(\n      originalOptions,\n      filtersWithoutCurrentType\n    );\n\n    // Calculate counts based on these options\n    const newGroups = new Map<string, number>(\n      computeGroups(optionsForCounting).map((option) => [option.label, option.count])\n    );\n\n    const newGroupsWithCount = groups.map((group) => ({\n      ...group,\n      count: newGroups.get(group.label) ?? 0,\n    }));\n\n    this.setState({\n      groups: newGroupsWithCount,\n      loading: false,\n    });\n  }\n\n  private onSelectionChange = (selectedGroups: MetricsFilterSectionState['selectedGroups']) => {\n    this.setState({ selectedGroups, active: selectedGroups.length > 0 });\n\n    this.publishEvent(\n      new EventFiltersChanged({ type: this.state.type, filters: selectedGroups.map((g) => g.value) }),\n      true\n    );\n\n    this.publishEvent(\n      new EventSectionValueChanged({ key: this.state.key, values: selectedGroups.map((g) => g.label) }),\n      true\n    );\n\n    if (this.state.type === 'prefixes') {\n      reportExploreMetrics('sidebar_prefix_filter_applied', {\n        filter_count: selectedGroups.length,\n      });\n    } else if (this.state.type === 'suffixes') {\n      reportExploreMetrics('sidebar_suffix_filter_applied', {\n        filter_count: selectedGroups.length,\n      });\n    }\n\n    // Track rule filter selection events\n    if (this.state.key === 'filters-rule' && selectedGroups.length > 0) {\n      // Map the label to the appropriate filter_type for the event\n      selectedGroups.forEach((group) => {\n        let filterType: 'non_rules_metrics' | 'recording_rules' | 'alerting_rules';\n\n        switch (group.label) {\n          case RULE_GROUP_LABELS.metrics:\n            filterType = 'non_rules_metrics';\n            break;\n          case RULE_GROUP_LABELS.rules:\n            filterType = 'recording_rules';\n            break;\n          default:\n            return; // Skip if it's not a recognized rules filter\n        }\n\n        reportExploreMetrics('sidebar_rules_filter_selected', { filter_type: filterType });\n      });\n    }\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<MetricsFilterSection>) => {\n    const styles = useStyles2(getStyles);\n    const { groups, selectedGroups, loading, title, description, showHideEmpty, showSearch } = model.useState();\n\n    const [hideEmpty, setHideEmpty] = useState(false);\n    const [searchValue, setSearchValue] = useState('');\n\n    const filteredGroups = useMemo(() => {\n      const filters: Array<(item: { label: string; value: string; count: number }) => boolean> = [];\n\n      if (hideEmpty) {\n        filters.push((item) => item.count > 0);\n      }\n\n      filters.push((item) => item.label.toLowerCase().includes(searchValue.toLowerCase()));\n\n      return groups.filter((group) => filters.every((filter) => filter(group)));\n    }, [hideEmpty, groups, searchValue]);\n\n    const onKeyDown: KeyboardEventHandler<HTMLInputElement> = (e) => {\n      if (e.key === 'Escape') {\n        e.preventDefault();\n        setSearchValue('');\n      }\n    };\n\n    return (\n      <div className={styles.container}>\n        <SectionTitle title={title} description={description} />\n\n        {showHideEmpty && (\n          <div className={styles.switchContainer}>\n            <span className={styles.switchLabel}>Hide empty</span>\n            <Switch value={hideEmpty} onChange={(e) => setHideEmpty(e.currentTarget.checked)} />\n          </div>\n        )}\n\n        {showSearch && (\n          <Input\n            className={styles.searchInput}\n            prefix={<Icon name=\"search\" />}\n            placeholder=\"Search...\"\n            value={searchValue}\n            onChange={(e) => setSearchValue(e.currentTarget.value)}\n            onKeyDown={onKeyDown}\n            suffix={\n              <IconButton name=\"times\" variant=\"secondary\" tooltip=\"Clear search\" onClick={() => setSearchValue('')} />\n            }\n          />\n        )}\n\n        {loading && <Spinner inline />}\n\n        {!loading && (\n          <CheckBoxList\n            groups={filteredGroups}\n            selectedGroups={selectedGroups}\n            onSelectionChange={model.onSelectionChange}\n          />\n        )}\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(1),\n      height: '100%',\n      overflowY: 'hidden',\n    }),\n    switchContainer: css({\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'flex-end',\n      gap: theme.spacing(1),\n    }),\n    switchLabel: css({\n      fontSize: '12px',\n      color: theme.colors.text.primary,\n    }),\n    searchInput: css({\n      flexBasis: '32px',\n      flexShrink: 0,\n      marginBottom: theme.spacing(1),\n      padding: theme.spacing(0, 0.5),\n    }),\n  };\n}\n","import { localeCompare } from 'MetricsReducer/helpers/localCompare';\n\nconst NONE_PREFIX = '<none>';\n\nexport function computeMetricPrefixGroups(options: Array<{ label: string; value: string }>) {\n  const rawPrefixesMap = new Map<string, string[]>();\n\n  for (const option of options) {\n    const parts = option.value.split(/[^a-z0-9]/i);\n    const key = parts.length <= 1 ? option.value : parts[0];\n    const values = rawPrefixesMap.get(key) ?? [];\n\n    values.push(option.value);\n    rawPrefixesMap.set(key || NONE_PREFIX, values);\n  }\n\n  const prefixesMap = new Map<string, number>();\n\n  for (const [prefix, values] of rawPrefixesMap) {\n    prefixesMap.set(prefix, values.length);\n  }\n\n  return Array.from(prefixesMap.entries())\n    .sort((a, b) => {\n      if (a[1] !== b[1]) {\n        return b[1] - a[1];\n      }\n\n      return localeCompare(a[0], b[0]);\n    })\n    .map(([value, count]) => ({\n      value,\n      count,\n      label: value,\n    }));\n}\n","import { localeCompare } from 'MetricsReducer/helpers/localCompare';\n\nconst NONE_SUFFIX = '<none>';\n\nexport function computeMetricSuffixGroups(options: Array<{ label: string; value: string }>) {\n  const rawSuffixesMap = new Map<string, string[]>();\n\n  for (const option of options) {\n    const parts = option.value.split(/[^a-z0-9]/i);\n    const key = parts.length <= 1 ? option.value : parts[parts.length - 1];\n    const values = rawSuffixesMap.get(key) ?? [];\n\n    values.push(option.value);\n    rawSuffixesMap.set(key || NONE_SUFFIX, values);\n  }\n\n  const suffixesMap = new Map<string, number>();\n\n  for (const [suffix, values] of rawSuffixesMap) {\n    suffixesMap.set(suffix, values.length);\n  }\n\n  return Array.from(suffixesMap.entries())\n    .sort((a, b) => {\n      if (a[1] !== b[1]) {\n        return b[1] - a[1];\n      }\n\n      return localeCompare(a[0], b[0]);\n    })\n    .map(([value, count]) => ({\n      value,\n      count,\n      label: value,\n    }));\n}\n","import { RULE_GROUP_LABELS } from '../SideBar/sections/MetricsFilterSection/rule-group-labels';\n\ntype MetricType = 'metrics' | 'rules';\n\n/**\n * Checks if a metric name follows Prometheus recording rule naming conventions.\n *\n * @remarks Recording rules follow the pattern: `level:metric:operations` or `level:metric`.\n * The `level` component might be empty. Where `level` and `operations` can contain\n * underscores and alphanumeric characters. The `metric` part can contain any character, but can't be empty.\n */\nfunction isRecordingRule(value: string): boolean {\n  // Matches patterns like:\n  // - instance_path:requests:rate5m\n  // - path:requests:rate5m\n  // - job:request_failures_per_requests:ratio_rate5m\n  // - apiserver_request:availability30d\n  // - asserts:container_memory\n  // - :requests:rate5m\n  return /^\\w*:.*?(?::\\w+)?$/.test(value);\n}\n\nexport function computeRulesGroups(options: Array<{ label: string; value: string }>) {\n  const rulesMap = new Map<MetricType, string[]>([\n    ['metrics', []],\n    ['rules', []],\n  ]);\n\n  for (const option of options) {\n    const { value } = option;\n    const key: MetricType = isRecordingRule(value) ? 'rules' : 'metrics';\n\n    const values = rulesMap.get(key) ?? [];\n    values.push(value);\n    rulesMap.set(key, values);\n  }\n\n  return [\n    { value: '^(?!.*:.*)', label: RULE_GROUP_LABELS.metrics, count: rulesMap.get('metrics')!.length },\n    { value: ':', label: RULE_GROUP_LABELS.rules, count: rulesMap.get('rules')!.length },\n  ];\n}\n","import { config } from '@grafana/runtime';\nimport { DataSourceVariable } from '@grafana/scenes';\n\nimport { logger } from 'shared/logger/logger';\nimport { VAR_DATASOURCE } from 'shared/shared';\nimport { PREF_KEYS } from 'shared/user-preferences/pref-keys';\nimport { userStorage } from 'shared/user-preferences/userStorage';\nimport { isPrometheusDataSource } from 'shared/utils/utils.datasource';\n\nexport class MetricsDrilldownDataSourceVariable extends DataSourceVariable {\n  constructor({ initialDS }: { initialDS?: string }) {\n    super({\n      key: VAR_DATASOURCE,\n      name: VAR_DATASOURCE,\n      pluginId: 'prometheus',\n      label: 'Data source',\n      description: 'Only prometheus data sources are supported',\n      // if no initialDS is passed to the constructor, we bypass Scenes native behaviour by determining the data source ourselves (see getCurrentDataSource())...\n      skipUrlSync: !initialDS,\n      // ... by doing this, we make sure that we'll always have a data source when the \"var-ds\" URL search param is missing, incorrect, etc.\n      value: initialDS || MetricsDrilldownDataSourceVariable.getCurrentDataSource(),\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.setState({ skipUrlSync: false }); // restore URL sync\n\n    this.subscribeToState((newState, prevState) => {\n      if (newState.value && newState.value !== prevState.value) {\n        // store the new value for future visits\n        userStorage.setItem(PREF_KEYS.DATASOURCE, newState.value as string);\n      }\n    });\n  }\n\n  private static getCurrentDataSource(): string {\n    const prometheusDataSources = Object.values(config.datasources).filter((ds) => isPrometheusDataSource(ds));\n\n    const uidFromUrl = new URL(window.location.href).searchParams.get(`var-${VAR_DATASOURCE}`);\n    const uidFromLocalStorage = userStorage.getItem(PREF_KEYS.DATASOURCE);\n\n    const currentDataSource =\n      prometheusDataSources.find((ds) => ds.uid === uidFromUrl) ||\n      prometheusDataSources.find((ds) => ds.uid === uidFromLocalStorage) ||\n      prometheusDataSources.find((ds) => ds.isDefault) ||\n      prometheusDataSources[0];\n\n    if (!currentDataSource) {\n      logger.warn('Cannot find any Prometheus data source!');\n      return 'no-data-source-configured';\n    }\n\n    return currentDataSource.uid;\n  }\n}\n","import { type SceneObjectUrlValues } from '@grafana/scenes';\n\nfunction filterUrlValues(urlValues: SceneObjectUrlValues) {\n  delete urlValues.actionView;\n  delete urlValues.layout;\n  delete urlValues.refresh;\n\n  if (Array.isArray(urlValues['var-filters'])) {\n    urlValues['var-filters'] = urlValues['var-filters'].filter(Boolean);\n  }\n\n  return urlValues;\n}\n\nexport function genBookmarkKey(urlValues: SceneObjectUrlValues) {\n  return JSON.stringify(filterUrlValues(urlValues));\n}\n","import { css } from '@emotion/css';\nimport { dateTimeFormat, type GrafanaTheme2 } from '@grafana/data';\nimport { type SceneObjectUrlValues } from '@grafana/scenes';\nimport { Card, IconButton, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { type Bookmark } from 'shared/bookmarks/useBookmarks';\nimport { VAR_FILTERS } from 'shared/shared';\n\nimport { getMetricName } from '../../../../shared/utils/utils';\n\n// Helper function to truncate the value for a single key:value pair\nconst truncateValue = (key: string, value: string, maxLength: number) => {\n  const combinedLength = key.length + 2 + value.length; // 2 for \": \"\n  if (combinedLength > maxLength) {\n    return value.substring(0, maxLength - key.length - 5) + '...'; // 5 for \": \" and \"...\"\n  }\n  return value;\n};\n\nconst getFiltersFromUrl = (urlValues: SceneObjectUrlValues) => {\n  // the filters are always represented as an array of strings in urlValues\n  // e.g. ['job|=|prometheus', 'branch|=|HEAD']\n  const filtersFromUrl = urlValues[`var-${VAR_FILTERS}`] as string[];\n  if (!filtersFromUrl.length) {\n    return [];\n  }\n  return filtersFromUrl.map((f) => f.split('|'));\n};\n\ntype BookmarkListItemProps = {\n  bookmark: Bookmark;\n  onSelect: () => void;\n  onDelete: () => void;\n  wide?: boolean;\n  compactHeight?: boolean;\n};\n\nexport function BookmarkListItem(props: Readonly<BookmarkListItemProps>) {\n  const styles = useStyles2(getStyles);\n  const { onSelect, onDelete, bookmark } = props;\n\n  const { createdAt, urlValues } = bookmark;\n  const metric = (urlValues.metric as string) || '?';\n  const filters = getFiltersFromUrl(urlValues);\n\n  const heading = truncateValue('', getMetricName(metric), 27);\n  const cardHeightClassName = `${props.compactHeight && filters.length > 0 ? styles.cardTall : ''}`;\n  const cardClassName = `${styles.card} ${props.wide ? styles.cardWide : ''} ${cardHeightClassName}`;\n\n  return (\n    <article data-testid={`data-trail-card ${metric}`}>\n      <Card onClick={onSelect} className={cardClassName}>\n        <Card.Heading>\n          <div className={styles.metricValue}>{heading}</div>\n        </Card.Heading>\n        <Card.Meta className={styles.meta}>\n          {filters.map(([key, operator, value], i) => (\n            <div key={i} className={styles.filter}>\n              <span className={styles.secondaryFont}>\n                {key} {operator}\n              </span>\n              <span className={styles.primaryFont}> {truncateValue(key, value, 44)}</span>\n            </div>\n          ))}\n        </Card.Meta>\n        <div className={styles.deleteButton}>\n          <Card.SecondaryActions>\n            <IconButton\n              key=\"delete\"\n              name=\"trash-alt\"\n              className={styles.secondary}\n              tooltip=\"Remove bookmark\"\n              tooltipPlacement=\"top\"\n              onClick={onDelete}\n            />\n          </Card.SecondaryActions>\n        </div>\n      </Card>\n      <div className={styles.date}>\n        <div className={styles.secondaryFont}>Date created: </div>\n        <div className={styles.primaryFont}>{createdAt > 0 && dateTimeFormat(createdAt, { format: 'YYYY-MM-DD' })}</div>\n      </div>\n    </article>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    metricValue: css({\n      display: 'inline',\n      color: theme.colors.text.primary,\n      fontWeight: 500,\n      wordBreak: 'break-all',\n    }),\n    card: css({\n      position: 'relative',\n      width: '318px',\n      padding: `12px ${theme.spacing(2)} ${theme.spacing(1)} ${theme.spacing(2)}`,\n      alignItems: 'start',\n      marginBottom: 0,\n      borderTop: `1px solid ${theme.colors.border.weak}`,\n      borderRight: `1px solid ${theme.colors.border.weak}`,\n      borderLeft: `1px solid ${theme.colors.border.weak}`,\n      borderBottom: 'none', // Remove the bottom border\n      borderRadius: '2px 2px 0 0', // Top-left and top-right corners are 2px, bottom-left and bottom-right are 0; cannot use theme.shape.radius.default because need bottom corners to be 0\n    }),\n    cardWide: css({\n      width: '100%',\n    }),\n    cardTall: css({\n      height: '110px',\n    }),\n    secondary: css({\n      color: theme.colors.text.secondary,\n      fontSize: '12px',\n    }),\n    date: css({\n      border: `1px solid ${theme.colors.border.weak}`,\n      borderRadius: '0 0 2px 2px',\n      padding: `${theme.spacing(1)} ${theme.spacing(2)}`,\n      backgroundColor: theme.colors.background.primary,\n    }),\n    meta: css({\n      flexWrap: 'wrap',\n      overflow: 'hidden',\n      textOverflow: 'ellipsis',\n      maxHeight: '36px', // 2 lines * 18px line-height\n      margin: 0,\n      gridArea: 'Meta',\n      color: theme.colors.text.secondary,\n      whiteSpace: 'nowrap',\n    }),\n    filter: css({\n      overflow: 'hidden',\n      textOverflow: 'ellipsis',\n      whiteSpace: 'nowrap',\n    }),\n    primaryFont: css({\n      display: 'inline',\n      color: theme.colors.text.primary,\n      fontSize: '12px',\n      fontWeight: '500',\n      letterSpacing: '0.018px',\n    }),\n    secondaryFont: css({\n      display: 'inline',\n      color: theme.colors.text.secondary,\n      fontSize: '12px',\n      fontWeight: '400',\n      lineHeight: '18px' /* 150% */,\n      letterSpacing: '0.018px',\n    }),\n    deleteButton: css({\n      position: 'absolute',\n      bottom: theme.spacing(1.5),\n      right: theme.spacing(0.5),\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { SceneObjectBase, type SceneComponentProps } from '@grafana/scenes';\nimport { useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { useBookmarks } from 'shared/bookmarks/useBookmarks';\n\nimport { BookmarkListItem } from './BookmarkListItem';\nimport { reportExploreMetrics } from '../../../../shared/tracking/interactions';\nimport { SectionTitle } from '../SectionTitle';\nimport { type SideBarSectionState } from '../types';\n\ninterface BookmarksListState extends SideBarSectionState {}\n\nexport class BookmarksList extends SceneObjectBase<BookmarksListState> {\n  constructor({\n    key,\n    title,\n    description,\n    icon,\n    disabled,\n  }: {\n    key: BookmarksListState['key'];\n    title: BookmarksListState['title'];\n    description: BookmarksListState['description'];\n    icon: BookmarksListState['icon'];\n    disabled?: BookmarksListState['disabled'];\n  }) {\n    super({\n      key,\n      title,\n      description,\n      icon,\n      disabled: disabled ?? false,\n      active: false,\n    });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<BookmarksList>) => {\n    const styles = useStyles2(getStyles);\n    const { title, description } = model.useState();\n    const { bookmarks, gotoBookmark, removeBookmark } = useBookmarks(model);\n\n    const onSelect = (bookmarkKey: string) => {\n      reportExploreMetrics('exploration_started', { cause: 'bookmark_clicked' });\n      gotoBookmark(bookmarkKey);\n    };\n\n    const onDelete = (bookmarkKey: string) => {\n      reportExploreMetrics('bookmark_changed', { action: 'deleted' });\n      removeBookmark(bookmarkKey);\n    };\n\n    return (\n      <div className={styles.container}>\n        <SectionTitle title={title} description={description} data-testid=\"bookmarks-list-sidebar\" />\n        {bookmarks.length > 0 ? (\n          <div className={styles.bookmarksList}>\n            {bookmarks.map((bookmark) => (\n              <BookmarkListItem\n                key={bookmark.key}\n                bookmark={bookmark}\n                onSelect={() => onSelect(bookmark.key)}\n                onDelete={() => onDelete(bookmark.key)}\n                wide={true}\n                compactHeight={true}\n              />\n            ))}\n          </div>\n        ) : (\n          <div className={styles.emptyState}>\n            <div>No bookmarks yet for the</div>\n            <div>current data source.</div>\n          </div>\n        )}\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(1),\n      height: '100%',\n    }),\n    bookmarksList: css({\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(1.5),\n      overflowY: 'auto',\n      paddingRight: theme.spacing(1),\n    }),\n    emptyState: css({\n      display: 'flex',\n      flexDirection: 'column',\n      alignItems: 'center',\n      height: '100px',\n      color: theme.colors.text.secondary,\n      fontStyle: 'italic',\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2, type SelectableValue } from '@grafana/data';\nimport { Button, RadioButtonList, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { NULL_GROUP_BY_VALUE } from 'MetricsReducer/labels/LabelsDataSource';\n\ntype LabelsListProps = {\n  labels: Array<SelectableValue<string>>;\n  selectedLabel: string;\n  onSelectLabel: (label: string) => void;\n  onClearSelection: () => void;\n};\n\nexport function LabelsList({ labels, selectedLabel, onSelectLabel, onClearSelection }: Readonly<LabelsListProps>) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <>\n      <div className={styles.listHeader}>\n        <div className={styles.selected}>\n          {selectedLabel === NULL_GROUP_BY_VALUE ? 'No selection' : `Selected: \"${selectedLabel}\"`}\n        </div>\n        <Button\n          variant=\"secondary\"\n          fill=\"text\"\n          onClick={onClearSelection}\n          disabled={selectedLabel === NULL_GROUP_BY_VALUE}\n        >\n          clear\n        </Button>\n      </div>\n\n      {!labels.length && <div className={styles.noResults}>No results.</div>}\n\n      {labels.length > 0 && (\n        <div className={styles.list} data-testid=\"labels-list\">\n          {/* TODO: use a custom one to have option labels with ellipsis and title/tooltip when hovering\n      now we're customizing too much the component CSS */}\n          <RadioButtonList name=\"labels-list\" options={labels} onChange={onSelectLabel} value={selectedLabel} />\n        </div>\n      )}\n    </>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    listHeader: css({\n      display: 'flex',\n      justifyContent: 'space-between',\n      alignItems: 'center',\n      color: theme.colors.text.secondary,\n      margin: theme.spacing(0),\n      padding: theme.spacing(0, 0, 0, 1),\n    }),\n    selected: css({\n      overflow: 'hidden',\n      whiteSpace: 'nowrap',\n      textOverflow: 'ellipsis',\n    }),\n    list: css({\n      display: 'flex',\n      flex: 1,\n      flexDirection: 'column',\n      gap: 0,\n      overflowY: 'auto',\n\n      '& [role=\"radiogroup\"]': {\n        gap: 0,\n      },\n\n      '& label': {\n        cursor: 'pointer',\n        padding: theme.spacing(0.5, 1),\n        '&:hover': {\n          background: theme.colors.background.secondary,\n        },\n      },\n\n      '& label div': {\n        whiteSpace: 'nowrap',\n        overflow: 'hidden',\n        textOverflow: 'ellipsis',\n      },\n    }),\n    noResults: css({\n      fontStyle: 'italic',\n      padding: theme.spacing(0, 1, 1, 1),\n    }),\n  };\n}\n","import { sceneGraph, sceneUtils, type SceneObject, type SceneObjectUrlValues } from '@grafana/scenes';\nimport { useEffect, useMemo, useState } from 'react';\n\nimport { MetricsDrilldownDataSourceVariable } from 'AppDataTrail/MetricsDrilldownDataSourceVariable';\nimport { displayError } from 'MetricsReducer/helpers/displayStatus';\nimport { MetricSelectedEvent, VAR_DATASOURCE } from 'shared/shared';\nimport { getTrailFor } from 'shared/utils/utils';\n\nimport { genBookmarkKey } from './genBookmarkKey';\nimport { PREF_KEYS } from '../user-preferences/pref-keys';\nimport { userStorage } from '../user-preferences/userStorage';\n\nexport type Bookmark = {\n  key: string;\n  urlValues: SceneObjectUrlValues & { metric: string };\n  createdAt: number;\n};\n\nexport type BookmarkFromStorage = Omit<Bookmark, 'key'>;\n\nexport function useBookmarks(sceneObject: SceneObject) {\n  const [allBookmarks, setAllBookmarks] = useState<Record<string, Bookmark>>({});\n  const trail = getTrailFor(sceneObject);\n\n  useEffect(() => {\n    const bookmarksFromStorage: BookmarkFromStorage[] = userStorage.getItem(PREF_KEYS.BOOKMARKS) || [];\n    const bookmarks: Record<string, Bookmark> = {};\n\n    for (const b of bookmarksFromStorage) {\n      // to store the min amount of data, we don't store the key in user storage, we compute it on-the-fly here, when it's retrieved\n      const key = genBookmarkKey(b.urlValues);\n      bookmarks[key] = { ...b, key };\n    }\n\n    setAllBookmarks(bookmarks);\n  }, []);\n\n  const { value: dsValue } = sceneGraph\n    .findByKeyAndType(trail, VAR_DATASOURCE, MetricsDrilldownDataSourceVariable)\n    .useState();\n\n  const bookmarks = useMemo(\n    () => Object.values(allBookmarks).filter((b) => b.urlValues[`var-${VAR_DATASOURCE}`] === (dsValue as string)),\n    [allBookmarks, dsValue]\n  );\n\n  const addBookmark = () => {\n    const newBookmark = {\n      urlValues: sceneUtils.getUrlState(trail) as Bookmark['urlValues'],\n      createdAt: Date.now(),\n    };\n    const bookmarksForStorage = Object.values(allBookmarks).map((b) => ({ ...b, key: undefined }));\n\n    userStorage.setItem(PREF_KEYS.BOOKMARKS, [...bookmarksForStorage, newBookmark]);\n\n    const newKey = genBookmarkKey(newBookmark.urlValues);\n    setAllBookmarks({ ...allBookmarks, [newKey]: { ...newBookmark, key: newKey } });\n  };\n\n  const removeBookmark = (bookmarkKey: string) => {\n    delete allBookmarks[bookmarkKey];\n    const bookmarksForStorage = Object.values(allBookmarks).map((b) => ({ ...b, key: undefined }));\n\n    userStorage.setItem(PREF_KEYS.BOOKMARKS, bookmarksForStorage);\n\n    setAllBookmarks({ ...allBookmarks });\n  };\n\n  const gotoBookmark = (bookmarkKey: string) => {\n    const bookmark = allBookmarks[bookmarkKey];\n    if (!bookmark) {\n      const error = new Error('Bookmark not found!');\n      displayError(error, [error.toString()]);\n      return;\n    }\n\n    trail.publishEvent(\n      new MetricSelectedEvent({\n        metric: bookmark.urlValues.metric,\n        urlValues: bookmark.urlValues,\n      }),\n      true\n    );\n  };\n\n  return { bookmarks, addBookmark, removeBookmark, gotoBookmark };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2, type SelectableValue } from '@grafana/data';\nimport { sceneGraph, SceneObjectBase, type SceneComponentProps } from '@grafana/scenes';\nimport { Icon, IconButton, Input, Spinner, useStyles2 } from '@grafana/ui';\nimport React, { useMemo, useState } from 'react';\n\nimport { NULL_GROUP_BY_VALUE } from 'MetricsReducer/labels/LabelsDataSource';\nimport { type LabelsVariable } from 'MetricsReducer/labels/LabelsVariable';\n\nimport { reportExploreMetrics } from '../../../../shared/tracking/interactions';\nimport { SectionTitle } from '../SectionTitle';\nimport { type SideBarSectionState } from '../types';\nimport { LabelsList } from './LabelsList';\n\ninterface LabelsBrowserState extends SideBarSectionState {\n  variableName: string;\n}\n\nexport class LabelsBrowser extends SceneObjectBase<LabelsBrowserState> {\n  constructor({\n    key,\n    variableName,\n    title,\n    description,\n    icon,\n    disabled,\n    active,\n  }: {\n    key: LabelsBrowserState['key'];\n    variableName: LabelsBrowserState['variableName'];\n    title: LabelsBrowserState['title'];\n    description: LabelsBrowserState['description'];\n    icon: LabelsBrowserState['icon'];\n    disabled?: LabelsBrowserState['disabled'];\n    active?: LabelsBrowserState['active'];\n  }) {\n    super({\n      key,\n      variableName,\n      title,\n      description,\n      icon,\n      disabled: disabled ?? false,\n      active: active ?? false,\n    });\n  }\n\n  private selectLabel(label: string) {\n    const labelsVariable = sceneGraph.lookupVariable(this.state.variableName, this) as LabelsVariable;\n    labelsVariable.changeValueTo(label);\n\n    const active = Boolean(label && label !== NULL_GROUP_BY_VALUE);\n\n    this.setState({ active });\n  }\n\n  private onSelectLabel = (label: string) => {\n    reportExploreMetrics('sidebar_group_by_label_filter_applied', { label });\n    this.selectLabel(label);\n  };\n\n  private onClearSelection = () => {\n    this.selectLabel(NULL_GROUP_BY_VALUE);\n  };\n\n  private useLabelsBrowser = () => {\n    const { variableName, title, description } = this.useState();\n\n    const labelsVariable = sceneGraph.lookupVariable(variableName, this) as LabelsVariable;\n    const { loading, options: labels, value: labelValue } = labelsVariable.useState();\n\n    const [searchValue, setSearchValue] = useState('');\n\n    const labelsList: Array<SelectableValue<string>> = useMemo(() => {\n      const filters = [\n        (item: string) => item !== NULL_GROUP_BY_VALUE,\n        (item: string) => item.toLowerCase().includes(searchValue.toLowerCase()),\n      ];\n\n      return labels.filter((item) => filters.every((filter) => filter(item.value as string))) as Array<\n        SelectableValue<string>\n      >;\n    }, [labels, searchValue]);\n\n    const onInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n      setSearchValue(e.currentTarget.value);\n    };\n\n    const onInputKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n      if (e.key === 'Escape') {\n        e.preventDefault();\n        setSearchValue('');\n      }\n    };\n\n    const onInputClear = () => {\n      setSearchValue('');\n    };\n\n    return {\n      title,\n      description,\n      loading,\n      selectedLabel: labelValue as string,\n      labelsList,\n      searchValue,\n      onInputChange,\n      onInputKeyDown,\n      onInputClear,\n    };\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<LabelsBrowser>) => {\n    const styles = useStyles2(getStyles);\n\n    const {\n      title,\n      description,\n      loading,\n      labelsList,\n      selectedLabel,\n      searchValue,\n      onInputChange,\n      onInputKeyDown,\n      onInputClear,\n    } = model.useLabelsBrowser();\n\n    return (\n      <div className={styles.container} data-testid=\"labels-browser\">\n        <SectionTitle title={title} description={description} />\n\n        <Input\n          className={styles.search}\n          prefix={<Icon name=\"search\" />}\n          placeholder=\"Search...\"\n          value={searchValue}\n          onChange={onInputChange}\n          onKeyDown={onInputKeyDown}\n          suffix={<IconButton name=\"times\" variant=\"secondary\" tooltip=\"Clear search\" onClick={onInputClear} />}\n        />\n\n        {loading && <Spinner inline />}\n\n        {!loading && (\n          <LabelsList\n            labels={labelsList}\n            selectedLabel={selectedLabel}\n            onSelectLabel={model.onSelectLabel}\n            onClearSelection={model.onClearSelection}\n          />\n        )}\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(1),\n      height: '100%',\n      overflowY: 'hidden',\n    }),\n    search: css({\n      marginBottom: theme.spacing(1),\n      padding: theme.spacing(0, 0.5),\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { SceneObjectBase, type SceneComponentProps } from '@grafana/scenes';\nimport { useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { SectionTitle } from './SectionTitle';\nimport { type SideBarSectionState } from './types';\n\ninterface SettingsState extends SideBarSectionState {}\n\nexport class Settings extends SceneObjectBase<SettingsState> {\n  constructor({\n    key,\n    title,\n    description,\n    icon,\n    disabled,\n  }: {\n    key: SettingsState['key'];\n    title: SettingsState['title'];\n    description: SettingsState['description'];\n    icon: SettingsState['icon'];\n    disabled?: SettingsState['disabled'];\n  }) {\n    super({\n      key,\n      title,\n      description,\n      icon,\n      disabled: disabled ?? false,\n      active: false,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {}\n\n  public static readonly Component = ({ model }: SceneComponentProps<Settings>) => {\n    const styles = useStyles2(getStyles);\n    const { title, description } = model.useState();\n\n    return (\n      <div className={styles.container}>\n        <SectionTitle title={title} description={description} />\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(1),\n      height: '100%',\n      overflowY: 'hidden',\n    }),\n  };\n}\n","import { css, cx } from '@emotion/css';\nimport { availableIconsIndex, type GrafanaTheme2, type IconName } from '@grafana/data';\nimport { Button, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { GroupsIcon } from './custom-icons/GroupsIcon';\nimport { RulesIcon } from './custom-icons/RulesIcon';\n\nconst CustomIcons = new Map<string, React.FC>([\n  ['rules', RulesIcon],\n  ['groups', GroupsIcon],\n]);\n\ntype SideBarButtonProps = {\n  ariaLabel: string;\n  disabled: boolean;\n  visible: boolean;\n  active: boolean;\n  tooltip: string;\n  onClick: () => void;\n  iconOrText: string | IconName;\n};\n\nexport function SideBarButton({\n  ariaLabel,\n  disabled,\n  visible,\n  active,\n  tooltip,\n  iconOrText,\n  onClick,\n}: Readonly<SideBarButtonProps>) {\n  const styles = useStyles2(getStyles);\n\n  let buttonIcon;\n  let ButtonChild;\n\n  if (iconOrText in availableIconsIndex) {\n    buttonIcon = iconOrText as IconName;\n  } else if (CustomIcons.has(iconOrText)) {\n    // some icons are not available in the Saga Design System and have been added as SVG files to the code base\n    ButtonChild = CustomIcons.get(iconOrText);\n  } else {\n    ButtonChild = function ButtonChildText() {\n      return <>{iconOrText}</>;\n    };\n  }\n\n  return (\n    <Button\n      className={cx(styles.button, disabled && 'disabled', visible && 'visible', active && 'active')}\n      size=\"md\"\n      variant=\"secondary\"\n      fill=\"text\"\n      icon={buttonIcon}\n      aria-label={ariaLabel}\n      tooltip={tooltip}\n      tooltipPlacement=\"right\"\n      onClick={onClick}\n      disabled={disabled}\n    >\n      {ButtonChild && <ButtonChild />}\n    </Button>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    button: css({\n      margin: 0,\n      color: theme.colors.text.secondary,\n      '&:hover': {\n        color: theme.colors.text.maxContrast,\n        background: 'transparent',\n      },\n      '&.disabled:hover': {\n        color: theme.colors.text.secondary,\n      },\n      '&.visible': {\n        color: theme.colors.text.maxContrast,\n      },\n      '&.active': {\n        color: theme.colors.text.maxContrast,\n      },\n    }),\n  };\n}\n","import React from 'react';\n\nexport function RulesIcon() {\n  return (\n    <svg stroke=\"currentColor\" width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\">\n      <rect x=\"1.25\" y=\"1.625\" width=\"5.25\" height=\"5.25\" rx=\"1\" strokeWidth=\"1.5\" />\n      <circle cx=\"12.25\" cy=\"4.25\" r=\"2.75\" strokeWidth=\"1.5\" />\n      <circle cx=\"3.75\" cy=\"11.75\" r=\"2.75\" strokeWidth=\"1.5\" />\n      <rect x=\"9.5\" y=\"9.125\" width=\"5.25\" height=\"5.25\" rx=\"1\" strokeWidth=\"1.5\" />\n    </svg>\n  );\n}\n","import { css, cx } from '@emotion/css';\nimport { VariableHide, type GrafanaTheme2 } from '@grafana/data';\nimport {\n  AdHocFiltersVariable,\n  sceneGraph,\n  SceneObjectBase,\n  type AdHocFilterWithLabels,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { IconButton, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { NULL_GROUP_BY_VALUE } from 'MetricsReducer/labels/LabelsDataSource';\nimport { LabelsVariable, VAR_WINGMAN_GROUP_BY } from 'MetricsReducer/labels/LabelsVariable';\nimport { computeMetricPrefixGroups } from 'MetricsReducer/metrics-variables/computeMetricPrefixGroups';\nimport { computeMetricSuffixGroups } from 'MetricsReducer/metrics-variables/computeMetricSuffixGroups';\nimport { computeRulesGroups } from 'MetricsReducer/metrics-variables/computeRulesGroups';\nimport { VAR_OTHER_METRIC_FILTERS } from 'shared/shared';\nimport { PREF_KEYS } from 'shared/user-preferences/pref-keys';\nimport { userStorage } from 'shared/user-preferences/userStorage';\nimport { getTrailFor } from 'shared/utils/utils';\nimport { isAdHocFiltersVariable } from 'shared/utils/utils.variables';\n\nimport { BookmarksList } from './sections/BookmarksList/BookmarksList';\nimport { EventSectionValueChanged } from './sections/EventSectionValueChanged';\nimport { LabelsBrowser } from './sections/LabelsBrowser/LabelsBrowser';\nimport { MetricsFilterSection } from './sections/MetricsFilterSection/MetricsFilterSection';\nimport { Settings } from './sections/Settings';\nimport { SideBarButton } from './SideBarButton';\nimport { reportExploreMetrics } from '../../shared/tracking/interactions';\nimport { HGFeatureToggles, isFeatureToggleEnabled } from '../../shared/utils/utils.feature-toggles';\n\ntype Section = MetricsFilterSection | LabelsBrowser | BookmarksList | Settings;\n\ninterface SideBarState extends SceneObjectState {\n  sections: Section[];\n  visibleSection: Section | null;\n  sectionValues: Map<string, string[]>;\n}\n\nconst metricFiltersVariables = ['filters-rule', 'filters-prefix', 'filters-suffix'] as const;\ntype MetricFiltersVariable = (typeof metricFiltersVariables)[number];\n\nexport class SideBar extends SceneObjectBase<SideBarState> {\n  constructor(state: Partial<SideBarState>) {\n    const sectionValues = SideBar.getSectionValuesFromUrl();\n\n    super({\n      key: 'sidebar',\n      visibleSection: null,\n      sections: [\n        new MetricsFilterSection({\n          key: 'filters-rule',\n          type: 'categories',\n          title: 'Rules filters',\n          description: 'Filter metrics and recording rules',\n          icon: 'rules',\n          computeGroups: computeRulesGroups,\n          showHideEmpty: false,\n          showSearch: false,\n          active: Boolean(sectionValues.get('filters-rule')?.length),\n        }),\n        new MetricsFilterSection({\n          key: 'filters-prefix',\n          type: 'prefixes',\n          title: 'Prefix filters',\n          description: 'Filter metrics based on their name prefix (Prometheus namespace)',\n          icon: 'A_',\n          computeGroups: computeMetricPrefixGroups,\n          active: Boolean(sectionValues.get('filters-prefix')?.length),\n        }),\n        new MetricsFilterSection({\n          key: 'filters-suffix',\n          type: 'suffixes',\n          title: 'Suffix filters',\n          description: 'Filter metrics based on their name suffix',\n          icon: '_Z',\n          computeGroups: computeMetricSuffixGroups,\n          active: Boolean(sectionValues.get('filters-suffix')?.length),\n        }),\n        new LabelsBrowser({\n          key: 'groupby-labels',\n          variableName: VAR_WINGMAN_GROUP_BY,\n          title: 'Group by labels',\n          description: 'Group metrics by their label values',\n          icon: 'groups',\n        }),\n        new BookmarksList({\n          key: 'bookmarks',\n          title: 'Bookmarks',\n          description: 'Access your saved metrics for quick reference',\n          icon: 'star',\n        }),\n        new Settings({\n          key: 'settings',\n          title: 'Settings',\n          description: 'Settings',\n          icon: 'cog',\n          disabled: true,\n        }),\n      ],\n      sectionValues,\n      ...state,\n    });\n\n    // FIXME: rule values are regexes, we do this only to disable adding the values to the button tooltip\n    // we need to provide the corresponding label instead\n    sectionValues.set('filters-rule', []);\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    const cleanupOtherMetricsVar = this.initOtherMetricsVar();\n\n    this.subscribeToEvent(EventSectionValueChanged, (event) => {\n      const { key, values } = event.payload;\n      const { sectionValues } = this.state;\n      const newSectionValues = new Map(sectionValues).set(key, values);\n      this.setOtherMetricFilters(newSectionValues);\n      this.setState({ sectionValues: newSectionValues });\n    });\n\n    // Open the sidebar to the most recently selected section if the \"Default Open Sidebar\" experiment is enabled\n    if (!this.state.visibleSection?.state.key && isFeatureToggleEnabled(HGFeatureToggles.sidebarOpenByDefault)) {\n      this.setActiveSection(userStorage.getItem(PREF_KEYS.SIDEBAR_SECTION) || 'filters-prefix');\n    }\n\n    return () => {\n      cleanupOtherMetricsVar();\n    };\n  }\n\n  private setOtherMetricFilters(sectionValues: Map<string, string[]>) {\n    const otherMetricFiltersVar = sceneGraph.lookupVariable(VAR_OTHER_METRIC_FILTERS, this);\n    if (!isAdHocFiltersVariable(otherMetricFiltersVar)) {\n      return;\n    }\n\n    const varToTextMap: Record<MetricFiltersVariable, string> = {\n      'filters-rule': 'rule group',\n      'filters-prefix': 'prefix',\n      'filters-suffix': 'suffix',\n    };\n\n    const newFilters = Array.from(sectionValues.entries()).reduce<Array<AdHocFilterWithLabels<{}>>>(\n      (acc, [key, value]) => {\n        if (value.length && metricFiltersVariables.includes(key as MetricFiltersVariable)) {\n          acc.push({\n            key,\n            operator: '=',\n            value: value.join(', '),\n            keyLabel: varToTextMap[key as MetricFiltersVariable],\n          });\n        }\n\n        return acc;\n      },\n      []\n    );\n\n    otherMetricFiltersVar.setState({\n      filters: newFilters,\n      hide: newFilters.length ? VariableHide.hideLabel : VariableHide.hideVariable,\n    });\n  }\n\n  /**\n   * Initialize the other metrics variable and set the filters from the current sidebar selections.\n   * This powers the read-only, \"other metric filters\" UI next to the label filters.\n   * The purpose of this is to provide users with at-a-glance feedback about the current sidebar\n   * selections, without needing to interact with the sidebar.\n   */\n  private initOtherMetricsVar() {\n    const currentVariableSet = getTrailFor(this).state.$variables;\n    if (!currentVariableSet) {\n      return () => {};\n    }\n\n    const otherMetricFiltersVar = new AdHocFiltersVariable({\n      name: VAR_OTHER_METRIC_FILTERS,\n      readOnly: true,\n      skipUrlSync: true,\n      datasource: null,\n      hide: VariableHide.hideVariable,\n      layout: 'combobox',\n      applyMode: 'manual',\n      allowCustomValue: true,\n    });\n\n    currentVariableSet.setState({\n      variables: [...currentVariableSet.state.variables, otherMetricFiltersVar],\n    });\n\n    this.setOtherMetricFilters(this.state.sectionValues);\n\n    return () => {\n      currentVariableSet.setState({\n        variables: [...currentVariableSet.state.variables.filter((v) => v !== otherMetricFiltersVar)],\n      });\n    };\n  }\n\n  private static getSectionValuesFromUrl() {\n    const urlSearchParams = new URLSearchParams(window.location.search);\n    const sectionValues = new Map();\n\n    for (const filterKey of metricFiltersVariables) {\n      const filterValueFromUrl = urlSearchParams.get(filterKey);\n      sectionValues.set(filterKey, filterValueFromUrl ? filterValueFromUrl.split(',').map((v) => v.trim()) : []);\n    }\n\n    return sectionValues;\n  }\n\n  private setActiveSection(sectionKey: string) {\n    const { visibleSection, sections } = this.state;\n\n    if (!sectionKey || sectionKey === visibleSection?.state.key) {\n      // Report closing the sidebar\n      reportExploreMetrics('metrics_sidebar_toggled', {\n        action: 'closed',\n        section: visibleSection?.state.key,\n      });\n\n      this.setState({ visibleSection: null });\n      return;\n    }\n\n    // Keep track of the section that the user has most recently selected\n    userStorage.setItem(PREF_KEYS.SIDEBAR_SECTION, sectionKey);\n\n    // Report opening the sidebar with the selected section\n    reportExploreMetrics('metrics_sidebar_toggled', {\n      action: 'opened',\n      section: sectionKey,\n    });\n\n    if (sectionKey === 'filters-prefix') {\n      reportExploreMetrics('sidebar_prefix_filter_section_clicked', {});\n    } else if (sectionKey === 'filters-suffix') {\n      reportExploreMetrics('sidebar_suffix_filter_section_clicked', {});\n    }\n\n    this.setState({\n      visibleSection: sections.find((section) => section.state.key === sectionKey) ?? null,\n    });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<SideBar>) => {\n    const styles = useStyles2(getStyles);\n    const { sections, visibleSection, sectionValues } = model.useState();\n\n    const labelsVariableValue = sceneGraph\n      .findByKeyAndType(model, VAR_WINGMAN_GROUP_BY, LabelsVariable)\n      .useState().value;\n\n    return (\n      <div className={styles.container}>\n        <div className={styles.buttonsBar} data-testid=\"sidebar-buttons\">\n          {sections.map((section) => {\n            const { key, title, icon: iconOrText, disabled, active } = section.state;\n            const visible = visibleSection?.state.key === key;\n            let isActive;\n            let tooltip;\n\n            if (key === 'groupby-labels') {\n              isActive = Boolean(labelsVariableValue && labelsVariableValue !== NULL_GROUP_BY_VALUE);\n              tooltip = `${title}: ${labelsVariableValue}`;\n            } else {\n              isActive = active;\n              tooltip = sectionValues.get(key)?.length ? `${title}: ${sectionValues.get(key)?.join(', ')}` : title;\n            }\n\n            return (\n              <div\n                key={key}\n                className={cx(\n                  styles.buttonContainer,\n                  visible && 'visible',\n                  isActive && 'active',\n                  disabled && 'disabled'\n                )}\n              >\n                <SideBarButton\n                  key={key}\n                  ariaLabel={title}\n                  disabled={disabled}\n                  visible={visible}\n                  active={isActive}\n                  tooltip={tooltip}\n                  onClick={() => model.setActiveSection(key)}\n                  iconOrText={iconOrText}\n                />\n              </div>\n            );\n          })}\n        </div>\n        {visibleSection && (\n          <div className={styles.content} data-testid=\"sidebar-content\">\n            <IconButton\n              className={styles.closeButton}\n              name=\"times\"\n              aria-label=\"Close\"\n              tooltip=\"Close\"\n              tooltipPlacement=\"top\"\n              onClick={() => model.setActiveSection('')}\n            />\n            {/* TODO: find a better way */}\n            {visibleSection instanceof MetricsFilterSection && <visibleSection.Component model={visibleSection} />}\n            {visibleSection instanceof LabelsBrowser && <visibleSection.Component model={visibleSection} />}\n            {visibleSection instanceof BookmarksList && <visibleSection.Component model={visibleSection} />}\n            {visibleSection instanceof Settings && <visibleSection.Component model={visibleSection} />}\n          </div>\n        )}\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      position: 'relative',\n      display: 'flex',\n      flexDirection: 'row',\n      height: '100%',\n      overflow: 'hidden',\n    }),\n    buttonsBar: css({\n      display: 'flex',\n      flexDirection: 'column',\n      alignItems: 'center',\n      gap: 0,\n      width: '42px',\n      padding: 0,\n      margin: 0,\n      boxSizing: 'border-box',\n      border: `1px solid ${theme.colors.border.weak}`,\n      borderRadius: theme.shape.radius.default,\n      backgroundColor: theme.colors.background.primary,\n      borderTopLeftRadius: 0,\n      borderBottomLeftRadius: 0,\n      position: 'relative',\n    }),\n    buttonContainer: css({\n      marginTop: theme.spacing(1),\n      '&::before': {\n        transition: '0.5s ease',\n        content: '\"\"',\n        position: 'absolute',\n        left: 0,\n        height: '32px',\n        borderLeft: `2px solid ${theme.colors.action.selectedBorder}`,\n        boxSizing: 'border-box',\n        opacity: 0,\n        visibility: 'hidden',\n      },\n      '&:hover::before': {\n        opacity: 1,\n        visibility: 'visible',\n      },\n      '&.visible::before': {\n        opacity: 1,\n        visibility: 'visible',\n      },\n      '&.disabled::before': {\n        opacity: 0,\n        visibility: 'hidden',\n      },\n      '&.active::after': {\n        content: '\"\"',\n        position: 'absolute',\n        right: 0,\n        width: '8px',\n        height: '8px',\n        backgroundColor: theme.colors.action.selectedBorder,\n        borderRadius: '50%',\n        margin: '2px 4px 0 0',\n      },\n    }),\n    content: css({\n      width: 'calc(300px - 42px)', // we want 300px in total\n      boxSizing: 'border-box',\n      border: `1px solid ${theme.colors.border.weak}`,\n      borderLeft: 'none',\n      borderRadius: theme.shape.radius.default,\n      backgroundColor: theme.colors.background.canvas,\n      padding: theme.spacing(1.5),\n    }),\n    closeButton: css({\n      position: 'absolute',\n      top: theme.spacing(1.5),\n      right: theme.spacing(1),\n      margin: 0,\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { useChromeHeaderHeight } from '@grafana/runtime';\nimport {\n  sceneGraph,\n  SceneObjectBase,\n  SceneVariableSet,\n  VariableDependencyConfig,\n  type CustomVariable,\n  type QueryVariable,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\n\nimport { NULL_GROUP_BY_VALUE } from './labels/LabelsDataSource';\nimport { VAR_WINGMAN_GROUP_BY, type LabelsVariable } from './labels/LabelsVariable';\nimport { ListControls } from './list-controls/ListControls';\nimport { EventSortByChanged } from './list-controls/MetricsSorter/events/EventSortByChanged';\nimport { MetricsSorter, VAR_WINGMAN_SORT_BY, type SortingOption } from './list-controls/MetricsSorter/MetricsSorter';\nimport { EventQuickSearchChanged } from './list-controls/QuickSearch/EventQuickSearchChanged';\nimport { QuickSearch } from './list-controls/QuickSearch/QuickSearch';\nimport { EventMetricsVariableActivated } from './metrics-variables/events/EventMetricsVariableActivated';\nimport { EventMetricsVariableDeactivated } from './metrics-variables/events/EventMetricsVariableDeactivated';\nimport { EventMetricsVariableLoaded } from './metrics-variables/events/EventMetricsVariableLoaded';\nimport { FilteredMetricsVariable, VAR_FILTERED_METRICS_VARIABLE } from './metrics-variables/FilteredMetricsVariable';\nimport { MetricsVariableFilterEngine, type MetricFilters } from './metrics-variables/MetricsVariableFilterEngine';\nimport { MetricsVariableSortEngine } from './metrics-variables/MetricsVariableSortEngine';\nimport { MetricsGroupByList } from './MetricsGroupByList/MetricsGroupByList';\nimport { MetricsList } from './MetricsList/MetricsList';\nimport { EventFiltersChanged } from './SideBar/sections/MetricsFilterSection/EventFiltersChanged';\nimport { MetricsFilterSection } from './SideBar/sections/MetricsFilterSection/MetricsFilterSection';\nimport { SideBar } from './SideBar/SideBar';\n\ninterface MetricsReducerState extends SceneObjectState {\n  listControls: ListControls;\n  sidebar: SideBar;\n  body?: SceneObjectBase;\n  enginesMap: Map<string, { filterEngine: MetricsVariableFilterEngine; sortEngine: MetricsVariableSortEngine }>;\n}\n\nexport class MetricsReducer extends SceneObjectBase<MetricsReducerState> {\n  protected _variableDependency = new VariableDependencyConfig(this, {\n    variableNames: [VAR_WINGMAN_GROUP_BY],\n    onReferencedVariableValueChanged: (variable) => {\n      this.updateBasedOnGroupBy((variable as LabelsVariable).state.value as string);\n    },\n  });\n\n  public constructor() {\n    super({\n      $variables: new SceneVariableSet({\n        variables: [new FilteredMetricsVariable()],\n      }),\n      listControls: new ListControls({}),\n      sidebar: new SideBar({}),\n      body: undefined,\n      enginesMap: new Map(),\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    const groupByValue = (sceneGraph.lookupVariable(VAR_WINGMAN_GROUP_BY, this) as LabelsVariable).state\n      .value as string;\n\n    this.updateBasedOnGroupBy(groupByValue);\n\n    this.subscribeToEvents();\n  }\n\n  private updateBasedOnGroupBy(groupByValue: string) {\n    const hasGroupByValue = Boolean(groupByValue && groupByValue !== NULL_GROUP_BY_VALUE);\n\n    sceneGraph.findByKeyAndType(this, 'quick-search', QuickSearch).toggleCountsDisplay(!hasGroupByValue);\n\n    if (!hasGroupByValue && this.state.body instanceof MetricsList) {\n      return;\n    }\n\n    if (\n      hasGroupByValue &&\n      this.state.body instanceof MetricsGroupByList &&\n      this.state.body.state.labelName === groupByValue\n    ) {\n      return;\n    }\n\n    this.setState({\n      body: hasGroupByValue\n        ? (new MetricsGroupByList({ labelName: groupByValue }) as unknown as SceneObjectBase)\n        : (new MetricsList({ variableName: VAR_FILTERED_METRICS_VARIABLE }) as unknown as SceneObjectBase),\n    });\n  }\n\n  private subscribeToEvents() {\n    this.initVariablesFilteringAndSorting();\n  }\n\n  /**\n   * The centralized filtering and sorting mechanism implemented here is decoupled via the usage of events.\n   * In order to work, the variables to be filtered/sorted must emit lifecycle events.\n   * This is done via the `withLifecycleEvents` decorator function.\n   *\n   * For example, check the `FilteredMetricsVariable` class.\n   */\n  private initVariablesFilteringAndSorting() {\n    this.subscribeToEvent(EventMetricsVariableActivated, (event) => {\n      // register engines\n      const { key } = event.payload;\n      const filteredMetricsVariable = sceneGraph.findByKey(this, key) as QueryVariable;\n\n      this.state.enginesMap.set(key, {\n        filterEngine: new MetricsVariableFilterEngine(filteredMetricsVariable),\n        sortEngine: new MetricsVariableSortEngine(filteredMetricsVariable),\n      });\n    });\n\n    this.subscribeToEvent(EventMetricsVariableDeactivated, (event) => {\n      // unregister engines\n      this.state.enginesMap.delete(event.payload.key);\n    });\n\n    const quickSearch = sceneGraph.findByKeyAndType(this, 'quick-search', QuickSearch);\n    const filterSections = sceneGraph.findAllObjects(\n      this,\n      (o) => o instanceof MetricsFilterSection\n    ) as MetricsFilterSection[];\n    const metricsSorter = sceneGraph.findByKeyAndType(this, 'metrics-sorter', MetricsSorter);\n    const sortByVariable = metricsSorter.state.$variables.getByName(VAR_WINGMAN_SORT_BY) as CustomVariable;\n\n    this.subscribeToEvent(EventMetricsVariableLoaded, (event) => {\n      // filter and sort on initial load\n      const { key, options } = event.payload;\n      const { filterEngine, sortEngine } = this.state.enginesMap.get(key)!;\n\n      filterEngine.setInitOptions(options);\n\n      const filters: Partial<MetricFilters> = {\n        names: quickSearch.state.value ? [quickSearch.state.value] : [],\n      };\n\n      for (const filterSection of filterSections) {\n        filters[filterSection.state.type] = filterSection.state.selectedGroups.map((g) => g.value);\n      }\n\n      filterEngine.applyFilters(filters, { forceUpdate: true, notify: false });\n      sortEngine.sort(sortByVariable.state.value as SortingOption);\n    });\n\n    /* Filters */\n\n    this.subscribeToEvent(EventQuickSearchChanged, (event) => {\n      const { searchText } = event.payload;\n\n      for (const [, { filterEngine, sortEngine }] of this.state.enginesMap) {\n        filterEngine.applyFilters({ names: searchText ? [searchText] : [] });\n        sortEngine.sort(sortByVariable.state.value as SortingOption);\n      }\n    });\n\n    this.subscribeToEvent(EventFiltersChanged, (event) => {\n      const { type, filters } = event.payload;\n\n      for (const [, { filterEngine, sortEngine }] of this.state.enginesMap) {\n        filterEngine.applyFilters({ [type]: filters });\n        sortEngine.sort(sortByVariable.state.value as SortingOption);\n      }\n    });\n\n    /* Sorting */\n\n    this.subscribeToEvent(EventSortByChanged, (event) => {\n      const { sortBy } = event.payload;\n      reportExploreMetrics('sorting_changed', { from: 'metrics-reducer', sortBy });\n\n      for (const [, { sortEngine }] of this.state.enginesMap) {\n        sortEngine.sort(sortBy);\n      }\n    });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<MetricsReducer>) => {\n    const chromeHeaderHeight = useChromeHeaderHeight() ?? 0;\n    const styles = useStyles2(getStyles, chromeHeaderHeight);\n\n    const { $variables, body, listControls, sidebar } = model.useState();\n\n    return (\n      <>\n        <div className={styles.listControls} data-testid=\"list-controls\">\n          <listControls.Component model={listControls} />\n        </div>\n        <div className={styles.body}>\n          <div className={styles.sidebar} data-testid=\"sidebar\">\n            <sidebar.Component model={sidebar} />\n          </div>\n          <div className={styles.list}>{body && <body.Component model={body} />}</div>\n        </div>\n        <div className={styles.variables}>\n          {$variables?.state.variables.map((variable) => (\n            <variable.Component key={variable.state.name} model={variable} />\n          ))}\n        </div>\n      </>\n    );\n  };\n}\n\n// the height of header between Grafana's chrome header and the metrics list container.\nconst APP_HEADER_HEIGHT = 144;\n\nfunction getStyles(theme: GrafanaTheme2, chromeHeaderHeight: number) {\n  return {\n    listControls: css({\n      marginBottom: theme.spacing(1.5),\n    }),\n    body: css({\n      display: 'flex',\n      flexDirection: 'row',\n      gap: theme.spacing(1),\n      height: `calc(100vh - ${chromeHeaderHeight + APP_HEADER_HEIGHT}px)`,\n    }),\n    list: css({\n      width: '100%',\n      overflowY: 'auto',\n    }),\n    sidebar: css({\n      flex: '0 0 auto',\n      overflowY: 'auto',\n    }),\n    variables: css({\n      display: 'none',\n    }),\n  };\n}\n","import { type DataTrail } from 'AppDataTrail/DataTrail';\n\nimport { isAgeMetric } from './isAgeMetric';\nimport { isClassicHistogramMetric } from './isClassicHistogramMetric';\nimport { isCounterMetric } from './isCounterMetric';\nimport { isStatusUpDownMetric } from './isStatusUpDownMetric';\n\nexport type MetricType = 'status-updown' | 'classic-histogram' | 'native-histogram' | 'age' | 'counter' | 'gauge';\n\nexport async function getMetricType(metric: string, dataTrail: DataTrail): Promise<MetricType> {\n  let metricType = getMetricTypeSync(metric);\n\n  if (metricType === 'gauge') {\n    if (await dataTrail.isNativeHistogram(metric)) {\n      metricType = 'native-histogram';\n    }\n  }\n\n  return metricType as MetricType;\n}\n\n/**\n * A sync version to use when performance is important or when the metadata for determing native histograms is missing\n */\nexport function getMetricTypeSync(metric: string): Omit<MetricType, 'native-histogram'> {\n  if (isCounterMetric(metric)) {\n    return 'counter';\n  }\n\n  if (isClassicHistogramMetric(metric)) {\n    return 'classic-histogram';\n  }\n\n  if (isAgeMetric(metric)) {\n    return 'age';\n  }\n\n  if (isStatusUpDownMetric(metric)) {\n    return 'status-updown';\n  }\n\n  return 'gauge';\n}\n","/**\n * Identifies gauge metrics with a value measured as a Unix timestamp in seconds\n */\nexport const isAgeMetric = (metric: string) => metric.endsWith('_timestamp_seconds');\n","import { CONFIG_PRESETS, type ConfigPresetId, type PanelConfigPreset } from './types';\n\nexport const DEFAULT_TIMESERIES_AGE_PRESETS: Partial<Record<ConfigPresetId, PanelConfigPreset>> = {\n  [CONFIG_PRESETS.TIMESERIES_AGE_TIME_MINUS_AVG]: {\n    id: CONFIG_PRESETS.TIMESERIES_AGE_TIME_MINUS_AVG,\n    name: 'Average age',\n    panelOptions: {\n      type: 'timeseries',\n      description:\n        'Suitable only for metrics that store unix timestamps (usually containing \"timestamp_seconds\" in their name) to calculate an average age. Calculates the age by subtracting the average timestamp value from current time.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'time-avg(metric)' }],\n    },\n  },\n  [CONFIG_PRESETS.TIMESERIES_AGE_TIME_MINUS_MIN_MAX]: {\n    id: CONFIG_PRESETS.TIMESERIES_AGE_TIME_MINUS_MIN_MAX,\n    name: 'Minimum and maximum ages',\n    panelOptions: {\n      type: 'timeseries',\n      description:\n        'Suitable only for metrics that store unix timestamps (usually containing \"timestamp_seconds\" in their name) to calculate a minimum and a maximum age. Calculates the ages by subtracting the min and the max timestamp values from current time.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'time-min(metric)' }, { fn: 'time-max(metric)' }],\n    },\n  },\n} as const;\n","import { CONFIG_PRESETS, type ConfigPresetId, type PanelConfigPreset } from './types';\n\nexport const DEFAULT_HISTOGRAMS_PRESETS: Partial<Record<ConfigPresetId, PanelConfigPreset>> = {\n  [CONFIG_PRESETS.HISTOGRAM_HEATMAP]: {\n    id: CONFIG_PRESETS.HISTOGRAM_HEATMAP,\n    name: 'Heatmap (default)',\n    panelOptions: {\n      type: 'heatmap',\n      description:\n        'Visualizes the full distribution of histogram data over time using color intensity. Perfect for spotting patterns, identifying performance degradation, and understanding latency distribution changes. Shows density of values across different buckets.',\n    },\n    queryOptions: {\n      queries: [],\n    },\n  },\n  [CONFIG_PRESETS.HISTOGRAM_PERCENTILES]: {\n    id: CONFIG_PRESETS.HISTOGRAM_PERCENTILES,\n    name: 'Percentiles',\n    panelOptions: {\n      type: 'percentiles',\n      description:\n        'Extracts specific percentile values from histogram data. Essential for SLA monitoring and performance analysis, showing how response times or other metrics behave for different user experience tiers.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'histogram_quantile', params: { percentiles: [99, 90, 50] } }],\n    },\n  },\n} as const;\n","import { CONFIG_PRESETS, type ConfigPresetId, type PanelConfigPreset } from './types';\n\nexport const DEFAULT_STATUS_UP_DOWN_PRESETS: Partial<Record<ConfigPresetId, PanelConfigPreset>> = {\n  [CONFIG_PRESETS.STATUS_UPDOWN_HISTORY]: {\n    id: CONFIG_PRESETS.STATUS_UPDOWN_HISTORY,\n    name: 'Status History (default)',\n    panelOptions: {\n      type: 'statushistory',\n      description:\n        'Displays binary status changes over time as colored bars (green=up, red=down). Perfect for monitoring service availability, health checks, or any binary state metrics. Shows patterns in uptime/downtime and helps identify recurring issues.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'min' }],\n    },\n  },\n  [CONFIG_PRESETS.STATUS_UPDOWN_STAT]: {\n    id: CONFIG_PRESETS.STATUS_UPDOWN_STAT,\n    name: 'Stat with latest value',\n    panelOptions: {\n      type: 'stat',\n      description:\n        'Shows the current status as a single value display with color coding (green=up, red=down). Ideal for dashboards where you need an at-a-glance view of service health or binary state. Uses minimum value to ensure any \"down\" status is highlighted.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'min' }],\n    },\n  },\n} as const;\n","import { CONFIG_PRESETS, type ConfigPresetId, type PanelConfigPreset } from './types';\n\nexport const DEFAULT_TIMESERIES_PRESETS: Partial<Record<ConfigPresetId, PanelConfigPreset>> = {\n  [CONFIG_PRESETS.TIMESERIES_AVG]: {\n    id: CONFIG_PRESETS.TIMESERIES_AVG,\n    name: 'Average (default)',\n    panelOptions: {\n      type: 'timeseries',\n      description:\n        'Shows the average value across all time series. Ideal for understanding typical behavior and smoothing out variations between different targets. For rate queries, displays average throughput per target.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'avg' }],\n    },\n  },\n  [CONFIG_PRESETS.TIMESERIES_SUM]: {\n    id: CONFIG_PRESETS.TIMESERIES_SUM,\n    name: 'Sum',\n    panelOptions: {\n      type: 'timeseries',\n      description:\n        'Aggregates total values across all time series. Perfect for measuring overall system throughput, total resource consumption, or fleet-wide capacity. Essential for rate queries showing total request rates.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'sum' }],\n    },\n  },\n  [CONFIG_PRESETS.TIMESERIES_STDDEV]: {\n    id: CONFIG_PRESETS.TIMESERIES_STDDEV,\n    name: 'Standard deviation',\n    panelOptions: {\n      type: 'timeseries',\n      description:\n        'Measures variability and consistency across time series. High values indicate uneven load distribution or inconsistent behavior. Useful for detecting load balancing issues or identifying when some targets behave differently.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'stddev' }],\n    },\n  },\n  [CONFIG_PRESETS.TIMESERIES_PERCENTILES]: {\n    id: CONFIG_PRESETS.TIMESERIES_PERCENTILES,\n    name: 'Percentiles',\n    panelOptions: {\n      type: 'percentiles',\n      description:\n        'Displays percentiles to show value distribution. Excellent for SLA monitoring and understanding outlier behavior without being skewed by extreme values. Critical for performance analysis.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'quantile', params: { percentiles: [99, 90, 50] } }],\n    },\n  },\n  [CONFIG_PRESETS.TIMESERIES_MIN_MAX]: {\n    id: CONFIG_PRESETS.TIMESERIES_MIN_MAX,\n    name: 'Minimum and maximum',\n    panelOptions: {\n      type: 'timeseries',\n      description:\n        'Shows the range between lowest and highest values across time series. Useful for capacity planning, identifying idle resources (min), and spotting overloaded targets (max). Helps detect outliers and resource utilization patterns.',\n    },\n    queryOptions: {\n      queries: [{ fn: 'min' }, { fn: 'max' }],\n    },\n  },\n} as const;\n\n// the presets are arranged so the first one is always the default one\n// this is why we define the default rate presets and we don't use DEFAULT_TIMESERIES_PRESETS in GmdVizPanel.tsx\nexport const DEFAULT_TIMESERIES_RATE_PRESETS: Partial<Record<ConfigPresetId, PanelConfigPreset>> = {\n  [CONFIG_PRESETS.TIMESERIES_SUM]: {\n    ...DEFAULT_TIMESERIES_PRESETS[CONFIG_PRESETS.TIMESERIES_SUM],\n    name: 'Sum (default)',\n    id: CONFIG_PRESETS.TIMESERIES_SUM,\n  } as PanelConfigPreset,\n  [CONFIG_PRESETS.TIMESERIES_AVG]: {\n    ...DEFAULT_TIMESERIES_PRESETS[CONFIG_PRESETS.TIMESERIES_AVG],\n    name: 'Average',\n  } as PanelConfigPreset,\n  [CONFIG_PRESETS.TIMESERIES_STDDEV]: DEFAULT_TIMESERIES_PRESETS[CONFIG_PRESETS.TIMESERIES_STDDEV] as PanelConfigPreset,\n  [CONFIG_PRESETS.TIMESERIES_PERCENTILES]: DEFAULT_TIMESERIES_PRESETS[\n    CONFIG_PRESETS.TIMESERIES_PERCENTILES\n  ] as PanelConfigPreset,\n  [CONFIG_PRESETS.TIMESERIES_MIN_MAX]: DEFAULT_TIMESERIES_PRESETS[\n    CONFIG_PRESETS.TIMESERIES_MIN_MAX\n  ] as PanelConfigPreset,\n} as const;\n","import { type DataTrail } from 'AppDataTrail/DataTrail';\nimport { getMetricType } from 'shared/GmdVizPanel/matchers/getMetricType';\n\nimport { DEFAULT_TIMESERIES_AGE_PRESETS } from './config-presets-ages';\nimport { DEFAULT_HISTOGRAMS_PRESETS } from './config-presets-histograms';\nimport { DEFAULT_STATUS_UP_DOWN_PRESETS } from './config-presets-status-updown';\nimport { DEFAULT_TIMESERIES_PRESETS, DEFAULT_TIMESERIES_RATE_PRESETS } from './config-presets-timeseries';\nimport { type PanelConfigPreset } from './types';\n\nexport async function getConfigPresetsForMetric(metric: string, dataTrail: DataTrail): Promise<PanelConfigPreset[]> {\n  const metricType = await getMetricType(metric, dataTrail);\n\n  switch (metricType) {\n    case 'counter':\n      return Object.values(DEFAULT_TIMESERIES_RATE_PRESETS);\n\n    case 'classic-histogram':\n    case 'native-histogram':\n      return Object.values(DEFAULT_HISTOGRAMS_PRESETS);\n\n    case 'age':\n      return [Object.values(DEFAULT_TIMESERIES_PRESETS)[0], ...Object.values(DEFAULT_TIMESERIES_AGE_PRESETS)];\n\n    case 'status-updown':\n      return Object.values(DEFAULT_STATUS_UP_DOWN_PRESETS);\n\n    default:\n      return Object.values(DEFAULT_TIMESERIES_PRESETS);\n  }\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\nimport { type PanelConfigPreset } from 'shared/GmdVizPanel/config/presets/types';\n\ninterface EventApplyPanelConfigPayload {\n  metric: string;\n  config: PanelConfigPreset;\n  restoreDefault?: boolean;\n}\n\nexport class EventApplyPanelConfig extends BusEventWithPayload<EventApplyPanelConfigPayload> {\n  public static readonly type = 'apply-panel-config';\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\ninterface EventCancelConfigurePanelPayload {\n  metric: string;\n}\n\nexport class EventCancelConfigurePanel extends BusEventWithPayload<EventCancelConfigurePanelPayload> {\n  public static readonly type = 'cancel-configure-panel';\n}\n","export const AVAILABLE_PERCENTILES_OPTIONS = [\n  { value: 99, label: 'P99' },\n  { value: 95, label: 'P95' },\n  { value: 90, label: 'P90' },\n  { value: 75, label: 'P75' },\n  { value: 50, label: 'P50' },\n] as const;\n","import { css, cx } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { SceneObjectBase, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport { Tooltip, useStyles2 } from '@grafana/ui';\nimport { cloneDeep } from 'lodash';\nimport React from 'react';\n\nimport { AVAILABLE_PERCENTILES_OPTIONS } from 'shared/GmdVizPanel/config/percentiles-options';\nimport { type ConfigPresetId } from 'shared/GmdVizPanel/config/presets/types';\nimport { type GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\n\ninterface WithConfigPanelOptionsState extends SceneObjectState {\n  presetId: ConfigPresetId;\n  body: GmdVizPanel;\n  isSelected: boolean;\n  onSelect: (presetId: ConfigPresetId) => void;\n  // currently, only percentiles are handheld by the app\n  // in the future, if we add more parameters, this code will have to be more generic\n  queryParams: {\n    show: boolean;\n    options: Array<{ value: any; label: string; checked: boolean }>;\n    type?: 'percentiles';\n  };\n}\n\nexport class WithConfigPanelOptions extends SceneObjectBase<WithConfigPanelOptionsState> {\n  constructor({\n    body,\n    presetId,\n    isSelected,\n    onSelect,\n  }: {\n    body: WithConfigPanelOptionsState['body'];\n    presetId: WithConfigPanelOptionsState['presetId'];\n    isSelected: WithConfigPanelOptionsState['isSelected'];\n    onSelect: WithConfigPanelOptionsState['onSelect'];\n  }) {\n    super({\n      presetId,\n      body,\n      isSelected,\n      onSelect,\n      queryParams: {\n        show: false,\n        options: [],\n      },\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.initPercentilesParams();\n  }\n\n  private initPercentilesParams() {\n    const queryConfig = this.state.body.state.queryConfig;\n\n    const percentiles = new Set(queryConfig.queries?.find((q) => q.params?.percentiles)?.params?.percentiles || []);\n\n    const options =\n      percentiles.size > 0\n        ? AVAILABLE_PERCENTILES_OPTIONS.map((o) => ({ ...o, checked: percentiles.has(o.value) }))\n        : [];\n\n    this.setState({\n      queryParams: {\n        show: options.length > 0,\n        options,\n      },\n    });\n  }\n\n  private onTogglePercentile = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const { queryParams, body } = this.state;\n    const value = Number(event.target.value);\n\n    const option = queryParams.options.find((o) => o.value === value);\n    if (!option) {\n      return;\n    }\n\n    // update in situ, for simplicity (so we don't have to clone queryParams)\n    option.checked = !option.checked;\n\n    const checkedOptions = queryParams.options.filter((o) => o.checked);\n    if (!checkedOptions.length) {\n      return; // prevent invalid config\n    }\n\n    // we have to clone queryConfig so that the body state update below triggers\n    // a re-render of the panel (see GmdVizPanel.subscribeToEvents())\n    const newQueryConfig = cloneDeep(body.state.queryConfig);\n\n    newQueryConfig.queries?.some((q) => {\n      if (q.params?.percentiles) {\n        q.params.percentiles = checkedOptions.map((o) => o.value);\n        return true;\n      }\n      return false;\n    });\n\n    body.update({}, newQueryConfig);\n\n    this.setState({ queryParams });\n  };\n\n  private onClickPreset = () => {\n    this.state.onSelect(this.state.presetId);\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<WithConfigPanelOptions>) => {\n    const styles = useStyles2(getStyles);\n    const { body, isSelected, queryParams } = model.useState();\n\n    return (\n      <div\n        className={cx(styles.container, isSelected && styles.selected)}\n        onClick={!isSelected ? model.onClickPreset : undefined}\n      >\n        <div className={cx(styles.bodyAndParams)}>\n          <body.Component model={body} />\n\n          {queryParams.show && (\n            <div className={styles.paramsContainer}>\n              {queryParams.options.map((o) => (\n                <label key={o.value} className={cx('param', styles.param)} htmlFor={`checkbox-${o.value}`}>\n                  <input\n                    id={`checkbox-${o.value}`}\n                    type=\"checkbox\"\n                    value={o.value}\n                    checked={o.checked}\n                    onChange={model.onTogglePercentile}\n                  />\n                  <span>{o.label}</span>\n                </label>\n              ))}\n            </div>\n          )}\n        </div>\n        <div className={styles.radioContainer}>\n          <Tooltip\n            content={!isSelected ? 'Click to select this configuration' : 'Current configuration'}\n            placement=\"top\"\n          >\n            <input type=\"radio\" name=\"select-config\" checked={isSelected} />\n          </Tooltip>\n        </div>\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css`\n      display: flex;\n      flex-direction: column;\n      gap: ${theme.spacing(1)};\n      padding: ${theme.spacing(1, 1, 1.25, 1)};\n      border: 1px solid transparent;\n      transition: all 0.2s ease-in-out;\n\n      &:hover {\n        border: 1px solid ${theme.colors.border.weak};\n        border-color: ${theme.colors.primary.border};\n      }\n      &:focus {\n        border: 1px solid ${theme.colors.border.weak};\n        outline: 1px solid ${theme.colors.primary.main};\n        outline-offset: 1px;\n      }\n    `,\n    selected: css`\n      cursor: default;\n      border: 1px solid ${theme.colors.border.weak};\n      border-color: ${theme.colors.primary.border};\n    `,\n    bodyAndParams: css`\n      display: flex;\n      flex-direction: row;\n      gap: ${theme.spacing(1.25)};\n      width: 100%;\n    `,\n    paramsContainer: css`\n      margin-top: ${theme.spacing(1)};\n    `,\n    param: css`\n      display: flex;\n      align-items: center;\n      gap: ${theme.spacing(0.5)};\n      margin-bottom: ${theme.spacing(0.5)};\n      font-size: 12px;\n      cursor: pointer;\n\n      & [type='checkbox'] {\n        cursor: pointer;\n      }\n    `,\n    radioContainer: css`\n      display: flex;\n      align-items: center;\n      justify-content: center;\n\n      & [type='radio'] {\n        cursor: pointer;\n      }\n    `,\n  };\n}\n","import { css } from '@emotion/css';\nimport { DashboardCursorSync, type GrafanaTheme2 } from '@grafana/data';\nimport {\n  behaviors,\n  SceneCSSGridItem,\n  SceneCSSGridLayout,\n  sceneGraph,\n  SceneObjectBase,\n  SceneRefreshPicker,\n  SceneTimePicker,\n  SceneTimeRange,\n  type SceneComponentProps,\n  type SceneObject,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { Button, ConfirmModal, useStyles2 } from '@grafana/ui';\nimport { cloneDeep, omit } from 'lodash';\nimport React from 'react';\n\nimport { DataTrail } from 'AppDataTrail/DataTrail';\nimport { displayError } from 'MetricsReducer/helpers/displayStatus';\nimport { GRID_TEMPLATE_COLUMNS } from 'MetricsReducer/MetricsList/MetricsList';\nimport { getPreferredConfigForMetric } from 'shared/GmdVizPanel/config/getPreferredConfigForMetric';\nimport { PANEL_HEIGHT } from 'shared/GmdVizPanel/config/panel-heights';\nimport { getConfigPresetsForMetric } from 'shared/GmdVizPanel/config/presets/getConfigPresetsForMetric';\nimport { type PanelConfigPreset } from 'shared/GmdVizPanel/config/presets/types';\nimport { GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\nimport { PREF_KEYS } from 'shared/user-preferences/pref-keys';\nimport { userStorage } from 'shared/user-preferences/userStorage';\nimport { getTrailFor } from 'shared/utils/utils';\n\nimport { EventApplyPanelConfig } from './EventApplyPanelConfig';\nimport { EventCancelConfigurePanel } from './EventCancelConfigurePanel';\nimport { WithConfigPanelOptions } from './WithConfigPanelOptions';\n\ninterface ConfigurePanelFormState extends SceneObjectState {\n  metric: string;\n  $timeRange: SceneTimeRange;\n  controls: SceneObject[];\n  isConfirmModalOpen: boolean;\n  presets: PanelConfigPreset[];\n  selectedPresetId?: string;\n  body?: SceneCSSGridLayout;\n}\n\nexport class ConfigurePanelForm extends SceneObjectBase<ConfigurePanelFormState> {\n  constructor({ metric }: { metric: ConfigurePanelFormState['metric'] }) {\n    super({\n      metric,\n      $timeRange: new SceneTimeRange({}),\n      controls: [new SceneTimePicker({}), new SceneRefreshPicker({})],\n      isConfirmModalOpen: false,\n      presets: [],\n      selectedPresetId: undefined,\n      body: undefined,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.syncTimeRange();\n    this.buildBody();\n    this.subscribeToEvents();\n  }\n\n  private syncTimeRange() {\n    const metricScene = sceneGraph.getAncestor(this, DataTrail);\n    const { from, to, timeZone, value } = sceneGraph.getTimeRange(metricScene).state;\n    sceneGraph.getTimeRange(this).setState({ from, to, timeZone, value });\n  }\n\n  private async buildBody() {\n    const { metric } = this.state;\n    const prefConfig = getPreferredConfigForMetric(metric);\n    const presets = await getConfigPresetsForMetric(metric, getTrailFor(this));\n\n    // if not found in the user preferences, we use the first preset\n    // it always works because the presets are organized to always have the default one as the first element (see GmdVizPanel/config/presets)\n    const selectedPresetId = (prefConfig || presets[0]).id;\n\n    const body = new SceneCSSGridLayout({\n      templateColumns: GRID_TEMPLATE_COLUMNS,\n      autoRows: PANEL_HEIGHT.M + 46, // see css in WithConfigPanelOptions\n      isLazy: true,\n      $behaviors: [\n        new behaviors.CursorSync({\n          key: 'metricCrosshairSync',\n          sync: DashboardCursorSync.Crosshair,\n        }),\n      ],\n      children: presets.map((option, colorIndex) => {\n        return new SceneCSSGridItem({\n          body: new WithConfigPanelOptions({\n            presetId: option.id,\n            isSelected: selectedPresetId === option.id,\n            onSelect: (presetId) => this.onSelectPreset(presetId),\n            body: new GmdVizPanel({\n              key: `panel-${option.id}`,\n              // we make sure that, if the user has previously configured some query parameters (like percentiles),\n              // they are applied here\n              discardUserPrefs: option.id !== prefConfig?.id,\n              metric,\n              panelOptions: {\n                ...option.panelOptions,\n                title: option.name,\n                fixedColorIndex: colorIndex,\n                headerActions: () => [],\n              },\n              queryOptions: option.queryOptions,\n            }),\n          }),\n        });\n      }),\n    });\n\n    this.setState({ presets, selectedPresetId, body });\n  }\n\n  private onSelectPreset = (presetId: string) => {\n    for (const panel of sceneGraph.findDescendents(this, WithConfigPanelOptions)) {\n      panel.setState({ isSelected: panel.state.presetId === presetId });\n    }\n\n    this.setState({ selectedPresetId: presetId });\n  };\n\n  private subscribeToEvents() {\n    const { metric } = this.state;\n\n    this.subscribeToEvent(EventApplyPanelConfig, (event) => {\n      const { config, restoreDefault } = event.payload;\n      const userPrefs = userStorage.getItem(PREF_KEYS.METRIC_PREFS) || {};\n      const userPrefForMetric = userPrefs[metric];\n\n      if (restoreDefault && userPrefForMetric) {\n        delete userPrefs[metric].config;\n      } else {\n        userPrefs[metric] = { ...userPrefForMetric, config };\n      }\n\n      userStorage.setItem(PREF_KEYS.METRIC_PREFS, userPrefs);\n    });\n  }\n\n  private onClickRestoreDefault = () => {\n    this.setState({ isConfirmModalOpen: true });\n  };\n\n  private onClickConfirmRestoreDefault = () => {\n    const { metric, presets } = this.state;\n    const [defaultPreset] = presets;\n\n    if (!defaultPreset) {\n      displayError(new Error(`No default config found for metric ${metric}!`), [\n        'Cannot restore default configuration.',\n      ]);\n      return;\n    }\n\n    this.publishEvent(\n      new EventApplyPanelConfig({\n        metric,\n        config: ConfigurePanelForm.getPanelConfigFromPreset(defaultPreset),\n        restoreDefault: true,\n      }),\n      true\n    );\n\n    this.closeConfirmModal();\n  };\n\n  private closeConfirmModal = () => {\n    this.setState({ isConfirmModalOpen: false });\n  };\n\n  private onClickCancel = () => {\n    this.publishEvent(new EventCancelConfigurePanel({ metric: this.state.metric }), true);\n  };\n\n  private onClickApplyConfig = () => {\n    const { metric, presets, selectedPresetId } = this.state;\n\n    const presetPanel = sceneGraph.findByKeyAndType(this, `panel-${selectedPresetId}`, GmdVizPanel);\n    if (!presetPanel) {\n      throw new Error(`Panel not found for preset id=\"${selectedPresetId}\"!`);\n    }\n\n    const preset = presets.find((preset) => preset.id === selectedPresetId);\n    if (!preset) {\n      throw new Error(`Preset with id=\"${selectedPresetId}\" not found!`);\n    }\n\n    // we clone the preset to update its queries property to\n    // ensure that some customized parameters (like percentiles) are properly applied\n    const presetWithQueryParams: PanelConfigPreset = cloneDeep(preset);\n    presetWithQueryParams.queryOptions.queries = presetPanel.state.queryConfig.queries;\n\n    this.publishEvent(\n      new EventApplyPanelConfig({\n        metric,\n        config: ConfigurePanelForm.getPanelConfigFromPreset(presetWithQueryParams),\n      }),\n      true\n    );\n  };\n\n  private static getPanelConfigFromPreset(preset: PanelConfigPreset) {\n    return omit(preset, ['name', 'panelOptions.description']) as PanelConfigPreset;\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<ConfigurePanelForm>) => {\n    const styles = useStyles2(getStyles);\n    const { metric, body, controls, isConfirmModalOpen } = model.useState();\n\n    return (\n      <div>\n        <div className={styles.controlsContainer}>\n          <Button variant=\"secondary\" size=\"md\" onClick={model.onClickRestoreDefault}>\n            Restore default config\n          </Button>\n          <div className={styles.controls}>\n            {controls.map((control) => (\n              <control.Component key={control.state.key} model={control} />\n            ))}\n          </div>\n        </div>\n\n        <div className={styles.messageContainer}>\n          <p>Select a Prometheus function that will be used by default to display the {metric} metric.</p>\n        </div>\n\n        {body && <body.Component model={body} />}\n\n        <div className={styles.formButtonsContainer}>\n          <Button variant=\"primary\" size=\"md\" onClick={model.onClickApplyConfig}>\n            Apply\n          </Button>\n          <Button variant=\"secondary\" size=\"md\" onClick={model.onClickCancel}>\n            Cancel\n          </Button>\n        </div>\n\n        <ConfirmModal\n          isOpen={isConfirmModalOpen}\n          title=\"Restore default configuration\"\n          body={`Are you sure you want to restore the default configuration for the ${metric} metric?`}\n          confirmText=\"Restore\"\n          onConfirm={model.onClickConfirmRestoreDefault}\n          onDismiss={model.closeConfirmModal}\n        />\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    controlsContainer: css`\n      display: flex;\n      justify-content: flex-end;\n      gap: ${theme.spacing(1)};\n      margin-bottom: ${theme.spacing(2)};\n    `,\n    messageContainer: css`\n      margin: ${theme.spacing(2.5, 0, 1, 0)};\n    `,\n    controls: css`\n      display: flex;\n    `,\n    formButtonsContainer: css`\n      display: flex;\n      justify-content: center;\n      gap: ${theme.spacing(2)};\n      position: sticky;\n      bottom: 0;\n      background: ${theme.colors.background.primary};\n      padding: ${theme.spacing(2, 0)};\n      border-top: 1px solid ${theme.colors.border.weak};\n    `,\n  };\n}\n","import { css, cx } from '@emotion/css';\nimport { useStyles2 } from '@grafana/ui';\nimport React, { memo } from 'react';\n\ntype PluginLogoProps = {\n  size: 'small' | 'large';\n};\n\nexport const PluginLogo = memo(function PluginLogoComponent({ size }: PluginLogoProps) {\n  const styles = useStyles2(getStyles);\n  return <img className={cx(styles.logo, size)} src=\"public/plugins/grafana-metricsdrilldown-app/img/logo.svg\" />;\n});\n\nconst getStyles = () => ({\n  logo: css`\n    &.small {\n      width: 24px;\n      height: 24px;\n      margin-right: 4px;\n      position: relative;\n      top: -2px;\n    }\n\n    &.large {\n      width: 40px;\n      height: 40px;\n    }\n  `,\n});\n","import { css } from '@emotion/css';\nimport { usePluginContext, type GrafanaTheme2 } from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport { Button, Dropdown, Menu, useStyles2 } from '@grafana/ui';\nimport React, { useEffect, useState } from 'react';\n\nimport { type PrometheusBuildInfo } from 'AppDataTrail/MetricDatasourceHelper/MetricDatasourceHelper';\nimport { logger } from 'shared/logger/logger';\nimport { GIT_COMMIT } from 'version';\n\nimport { PluginLogo } from './PluginLogo';\n\nconst pluginCommitSha: string = GIT_COMMIT;\nconst pluginCommitURL = `https://github.com/grafana/metrics-drilldown/commit/${pluginCommitSha}`;\n\nconst { buildInfo: grafanaBuildInfo } = config;\n\nfunction InfoMenuHeader() {\n  const styles = useStyles2(getStyles);\n\n  const {\n    meta: {\n      info: { version, updated },\n    },\n  } = usePluginContext() || { meta: { info: { version: '?.?.?', updated: '?' } } };\n\n  return (\n    <div className={styles.menuHeader}>\n      <h5>\n        <PluginLogo size=\"small\" />\n        Grafana Metrics Drilldown v{version}\n      </h5>\n      <div className={styles.subTitle}>Last update: {updated}</div>\n    </div>\n  );\n}\n\nfunction InfoMenu({ getPrometheusBuildInfo }: Readonly<PluginInfoProps>) {\n  const styles = useStyles2(getStyles);\n\n  const isDev = pluginCommitSha === 'dev';\n  const shortCommitSha = isDev ? pluginCommitSha : pluginCommitSha.slice(0, 8);\n\n  const [promBuildInfo, setPromBuildInfo] = useState<PrometheusBuildInfo>();\n  useEffect(() => {\n    getPrometheusBuildInfo()\n      .then((info) => setPromBuildInfo(info))\n      .catch((e) => {\n        logger.warn('Error while fetching Prometheus build info!');\n        logger.warn(e);\n        setPromBuildInfo(undefined);\n      });\n  }, [getPrometheusBuildInfo]);\n\n  return (\n    <Menu header={<InfoMenuHeader />}>\n      <Menu.Item\n        label={`Commit SHA: ${shortCommitSha}`}\n        icon=\"github\"\n        onClick={() => window.open(pluginCommitURL)}\n        disabled={isDev}\n      />\n      <Menu.Item\n        label=\"Changelog\"\n        icon=\"list-ul\"\n        onClick={() =>\n          window.open(\n            'https://github.com/grafana/metrics-drilldown/blob/main/CHANGELOG.md',\n            '_blank',\n            'noopener,noreferrer'\n          )\n        }\n      />\n      <Menu.Item\n        label=\"Contribute\"\n        icon=\"external-link-alt\"\n        onClick={() =>\n          window.open(\n            'https://github.com/grafana/metrics-drilldown/blob/main/docs/contributing.md',\n            '_blank',\n            'noopener,noreferrer'\n          )\n        }\n      />\n      <Menu.Item\n        label=\"Documentation\"\n        icon=\"document-info\"\n        onClick={() =>\n          window.open(\n            'https://grafana.com/docs/grafana/latest/explore/simplified-exploration/metrics',\n            '_blank',\n            'noopener,noreferrer'\n          )\n        }\n      />\n      <Menu.Item\n        label=\"Report an issue\"\n        icon=\"bug\"\n        onClick={() =>\n          window.open(\n            'https://github.com/grafana/metrics-drilldown/issues/new?template=bug_report.md',\n            '_blank',\n            'noopener,noreferrer'\n          )\n        }\n      />\n      <Menu.Divider />\n      <Menu.Item\n        label={`Grafana ${grafanaBuildInfo.edition} v${grafanaBuildInfo.version} (${grafanaBuildInfo.env})`}\n        icon=\"grafana\"\n        onClick={() =>\n          window.open(\n            `https://github.com/grafana/grafana/commit/${grafanaBuildInfo.commit}`,\n            '_blank',\n            'noopener,noreferrer'\n          )\n        }\n      />\n      {promBuildInfo && (\n        <Menu.Item\n          className={styles.promBuildInfo}\n          // eslint-disable-next-line sonarjs/no-nested-template-literals\n          label={`${promBuildInfo.application || '?'} ${promBuildInfo.version} ${\n            promBuildInfo.buildDate ? `(${promBuildInfo.buildDate})` : ''\n          }`}\n          icon=\"gf-prometheus\"\n          onClick={() =>\n            window.open(`${promBuildInfo.repository}/commit/${promBuildInfo.revision}`, '_blank', 'noopener,noreferrer')\n          }\n        />\n      )}\n    </Menu>\n  );\n}\n\ntype PluginInfoProps = { getPrometheusBuildInfo: () => Promise<PrometheusBuildInfo | undefined> };\n\nexport function PluginInfo({ getPrometheusBuildInfo }: Readonly<PluginInfoProps>) {\n  return (\n    <Dropdown overlay={() => <InfoMenu getPrometheusBuildInfo={getPrometheusBuildInfo} />} placement=\"bottom-end\">\n      <Button\n        icon=\"info-circle\"\n        variant=\"secondary\"\n        tooltip=\"Plugin info\"\n        tooltipPlacement=\"top\"\n        title=\"Plugin info\"\n        data-testid=\"plugin-info-button\"\n      />\n    </Dropdown>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  button: css`\n    position: relative;\n    display: flex;\n    align-items: center;\n    width: 32px;\n    height: 32px;\n    line-height: 30px;\n    border: 1px solid ${theme.colors.border.weak};\n    border-radius: 2px;\n    border-left: 0;\n    color: ${theme.colors.text.primary};\n    background: ${theme.colors.background.secondary};\n\n    &:hover {\n      border-color: ${theme.colors.border.medium};\n      background-color: ${theme.colors.background.canvas};\n    }\n  `,\n  menuHeader: css`\n    padding: ${theme.spacing(0.5, 1)};\n    white-space: nowrap;\n  `,\n  subTitle: css`\n    color: ${theme.colors.text.secondary};\n    font-size: ${theme.typography.bodySmall.fontSize};\n  `,\n  promBuildInfo: css`\n    & svg {\n      color: #e5502a;\n    }\n  `,\n});\n","export const UI_TEXT = {\n  SEARCH: {\n    TITLE: 'Search metrics',\n  },\n  METRIC_SELECT_SCENE: {\n    OPEN_EXPLORE_LABEL: 'Open in explore',\n    COPY_URL_LABEL: 'Copy url',\n    BOOKMARK_LABEL: 'Bookmark',\n    SELECT_NEW_METRIC_TOOLTIP: 'Remove existing metric and choose a new metric',\n  },\n};\n","import { SceneObjectBase, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport { LinkButton, ToolbarButton } from '@grafana/ui';\nimport React from 'react';\n\nimport { createAppUrl } from '../../extensions/links';\nimport { UI_TEXT } from '../../shared/constants/ui';\nimport { MetricSelectedEvent } from '../../shared/shared';\nimport { reportExploreMetrics } from '../../shared/tracking/interactions';\nimport { getTrailFor, getUrlForTrail } from '../../shared/utils/utils';\n\ninterface SelectNewMetricButtonState extends SceneObjectState {}\n\nexport class SelectNewMetricButton extends SceneObjectBase<SelectNewMetricButtonState> {\n  constructor(state: Partial<SelectNewMetricButtonState> = {}) {\n    super({\n      ...state,\n    });\n  }\n\n  private onSelectNewMetric = () => {\n    const trail = getTrailFor(this);\n    reportExploreMetrics('selected_metric_action_clicked', { action: 'unselect' });\n    trail.publishEvent(new MetricSelectedEvent({}));\n  };\n\n  static readonly Component = ({ model }: SceneComponentProps<SelectNewMetricButton>) => {\n    const trail = getTrailFor(model);\n    const { embedded } = trail.useState();\n\n    // In embedded mode, show \"Metrics Drilldown\" button to open full app\n    if (embedded) {\n      return (\n        <LinkButton\n          href={createAppUrl(getUrlForTrail(trail))}\n          variant={'secondary'}\n          icon=\"arrow-right\"\n          tooltip=\"Open in Metrics Drilldown\"\n          onClick={() => reportExploreMetrics('selected_metric_action_clicked', { action: 'open_from_embedded' })}\n          data-testid=\"open-metrics-drilldown-button\"\n        >\n          Metrics Drilldown\n        </LinkButton>\n      );\n    }\n\n    // In non-embedded mode, show \"Select new metric\" button\n    return (\n      <ToolbarButton\n        variant={'canvas'}\n        tooltip={UI_TEXT.METRIC_SELECT_SCENE.SELECT_NEW_METRIC_TOOLTIP}\n        onClick={model.onSelectNewMetric}\n        data-testid=\"select-new-metric-button\"\n      >\n        Select new metric\n      </ToolbarButton>\n    );\n  };\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\ninterface EventForceSyncYAxisPayload {}\n\nexport class EventForceSyncYAxis extends BusEventWithPayload<EventForceSyncYAxisPayload> {\n  public static readonly type = 'force-sync-y-axis';\n}\n","import { BusEventWithPayload } from '@grafana/data';\n\ninterface EventResetSyncYAxisPayload {}\n\nexport class EventResetSyncYAxis extends BusEventWithPayload<EventResetSyncYAxisPayload> {\n  public static readonly type = 'reset-sync-y-axis';\n}\n","import { BusEventWithPayload, type DataFrame } from '@grafana/data';\n\ninterface EventTimeseriesDataReceivedPayload {\n  panelKey: string;\n  series: DataFrame[];\n}\n\nexport class EventTimeseriesDataReceived extends BusEventWithPayload<EventTimeseriesDataReceivedPayload> {\n  public static readonly type = 'timeseries-data-received';\n}\n","import { type DataFrame } from '@grafana/data';\nimport { sceneGraph, VizPanel, type SceneObject, type SceneObjectState } from '@grafana/scenes';\nimport { cloneDeep, merge } from 'lodash';\n\nimport { EventForceSyncYAxis } from '../events/EventForceSyncYAxis';\nimport { EventResetSyncYAxis } from '../events/EventResetSyncYAxis';\nimport { EventTimeseriesDataReceived } from '../events/EventTimeseriesDataReceived';\n\n/**\n * Synchronizes the Y-axis ranges across children timeseries panels by listening to data updates from publishTimeseriesData.\n * When new data arrives, it calculates the global min/max values and updates all children panels to use the same scale.\n */\nexport function syncYAxis() {\n  const syncYAxis = (vizPanelsParent: SceneObject<SceneObjectState>) => {\n    let max = Number.NEGATIVE_INFINITY;\n    let min = Number.POSITIVE_INFINITY;\n\n    // reset after timerange changes\n    const timeRangeSub = sceneGraph.getTimeRange(vizPanelsParent).subscribeToState(() => {\n      max = Number.NEGATIVE_INFINITY;\n      min = Number.POSITIVE_INFINITY;\n    });\n\n    // reset after receiving the EventResetSyncYAxis event (see SceneByFrameRepeater when filtering/sorting)\n    const resetSub = vizPanelsParent.subscribeToEvent(EventResetSyncYAxis, () => {\n      max = Number.NEGATIVE_INFINITY;\n      min = Number.POSITIVE_INFINITY;\n    });\n\n    // force new panels update after receiving the EventForceSyncYAxis event (see SceneByFrameRepeater when paginating)\n    const forceSub = vizPanelsParent.subscribeToEvent(EventForceSyncYAxis, () => {\n      let [newMax, newMin] = [max, min];\n\n      const nonSyncedPanels = findTimeseriesPanels(vizPanelsParent).filter((t) => {\n        const { fieldConfig, $data } = t.state;\n\n        if ('min' in fieldConfig.defaults && 'max' in fieldConfig.defaults) {\n          return false; // we assume it's already synced (see updateTimeseriesAxis below)\n        }\n\n        [newMax, newMin] = findNewMaxMin($data?.state.data?.series || [], newMax, newMin);\n        return true;\n      });\n\n      if (newMax === max && newMin === min) {\n        updateTimeseriesAxis(vizPanelsParent, max, min, nonSyncedPanels);\n      } else {\n        [max, min] = [newMax, newMin];\n        updateTimeseriesAxis(vizPanelsParent, newMax, newMin);\n      }\n    });\n\n    // new data coming...\n    const dataReceivedSub = vizPanelsParent.subscribeToEvent(EventTimeseriesDataReceived, (event) => {\n      const { panelKey, series } = event.payload;\n      const [newMax, newMin] = findNewMaxMin(series, max, min);\n\n      // discard if no min/max have been determined or if they are the same (e.g. info metrics with a value of 1)\n      if (newMax !== newMin && newMax !== Number.NEGATIVE_INFINITY && newMin !== Number.POSITIVE_INFINITY) {\n        // new min or max?\n        if (newMax !== max || newMin !== min) {\n          [max, min] = [newMax, newMin];\n          // update all panels in the Scene\n          updateTimeseriesAxis(vizPanelsParent, newMax, newMin);\n        } else {\n          // update the new panel only\n          updateTimeseriesAxis(vizPanelsParent, max, min, [\n            sceneGraph.findByKeyAndType(vizPanelsParent, panelKey, VizPanel),\n          ]);\n        }\n      }\n    });\n\n    return () => {\n      dataReceivedSub.unsubscribe();\n      forceSub.unsubscribe();\n      resetSub.unsubscribe();\n      timeRangeSub.unsubscribe();\n    };\n  };\n\n  // we add an internal name to be able to detect which Scene objects have the behavior associated\n  // this is useful for a use case where we need to reset the behaviour in the Breakdown tab, after the user config is\n  // applied to all the panels present in the tab (check when the EventApplyPanelConfig event is received in DataTrail.tsx)\n  Object.defineProperty(syncYAxis, '__name__', {\n    value: 'syncYAxis',\n    configurable: false,\n    enumerable: true,\n    writable: false,\n  });\n\n  return syncYAxis;\n}\n\nfunction findNewMaxMin(series: DataFrame[], max: number, min: number) {\n  let [newMax, newMin] = [max, min];\n\n  for (const s of series || []) {\n    const values = s.fields[1]?.values.filter(Boolean);\n\n    if (values) {\n      newMax = Math.max(newMax, ...values);\n      newMin = Math.min(newMin, ...values);\n    }\n  }\n\n  return [newMax, newMin];\n}\n\nfunction findTimeseriesPanels(vizPanelsParent: SceneObject) {\n  // findAllObjects searches down the full scene graph\n  return sceneGraph.findAllObjects(\n    vizPanelsParent,\n    (o) => o instanceof VizPanel && o.state.pluginId === 'timeseries'\n  ) as VizPanel[];\n}\n\nfunction updateTimeseriesAxis(vizPanelsParent: SceneObject, max: number, min: number, panels?: VizPanel[]) {\n  for (const t of panels || findTimeseriesPanels(vizPanelsParent)) {\n    t.clearFieldConfigCache(); // required for the fieldConfig update below\n\n    t.setState({\n      fieldConfig: merge(cloneDeep(t.state.fieldConfig), { defaults: { min, max } }),\n    });\n  }\n}\n\nexport function resetYAxisSync(sceneObject: SceneObject) {\n  const objectsWithBehavior = sceneGraph.findAllObjects(\n    sceneObject,\n    (o) => Boolean(o.state.$behaviors?.some((b) => (b as any).__name__ === 'syncYAxis')) // see above\n  );\n\n  for (const o of objectsWithBehavior) {\n    o.publishEvent(new EventResetSyncYAxis({}), true);\n  }\n}\n","import { css } from '@emotion/css';\nimport { Combobox, RadioButtonGroup, useStyles2 } from '@grafana/ui';\nimport React, { useMemo } from 'react';\n\nimport { noOp } from 'shared/utils/utils';\n\nexport type GroupByOptions = Array<{ label: string; value: string }>;\n\ninterface GroupBySelectorProps {\n  options: GroupByOptions;\n  value: string;\n  onChange: (label: string, ignore?: boolean) => void;\n  loading?: boolean;\n}\n\nconst DEFAULT_ALL_OPTION = {\n  label: 'All',\n  value: '$__all',\n};\n\nconst MAX_RADIOGROUP_OPTIONS = 4;\nconst COMBOBOX_PLACEHOLDER = 'Select a label to group by';\n\nexport function GroupBySelector(props: Readonly<GroupBySelectorProps>) {\n  const styles = useStyles2(getStyles);\n  const { loading, options, value, onChange } = props;\n  const processedOptions = useMemo(() => [DEFAULT_ALL_OPTION, ...options], [options]);\n\n  if (loading) {\n    // prevent layout changes after loading\n    return <Combobox options={[]} placeholder={COMBOBOX_PLACEHOLDER} onChange={noOp} />;\n  }\n\n  // as per Grafana Design System guidelines (https://grafana.com/developers/saga/components/radio-button-group/#when-to-use)\n  const useRadios = processedOptions.length <= MAX_RADIOGROUP_OPTIONS;\n\n  if (useRadios) {\n    return (\n      <RadioButtonGroup\n        data-testid=\"group-by-selector-radio-group\"\n        options={processedOptions}\n        value={value}\n        onChange={onChange}\n      />\n    );\n  }\n\n  return (\n    <div className={styles.combobox}>\n      <Combobox\n        data-testid=\"group-by-selector-combobox\"\n        options={processedOptions}\n        value={value}\n        placeholder={COMBOBOX_PLACEHOLDER}\n        onChange={(option) => {\n          onChange(option ? option.value : DEFAULT_ALL_OPTION.value);\n        }}\n        isClearable\n      />\n    </div>\n  );\n}\n\nfunction getStyles() {\n  return {\n    combobox: css({\n      marginLeft: '4px',\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { QueryVariable, sceneGraph, type MultiValueVariable, type SceneComponentProps } from '@grafana/scenes';\nimport { Field, useStyles2 } from '@grafana/ui';\nimport React, { useCallback } from 'react';\n\nimport { trailDS, VAR_FILTERS, VAR_GROUP_BY, VAR_METRIC_EXPR } from 'shared/shared';\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\nimport { isAdHocFiltersVariable } from 'shared/utils/utils.variables';\n\nimport { GroupBySelector, type GroupByOptions } from './GroupBySelector/GroupBySelector';\n\nconst ALL_VARIABLE_VALUE = '$__all';\n\nexport class GroupByVariable extends QueryVariable {\n  constructor() {\n    super({\n      name: VAR_GROUP_BY,\n      label: 'Group by',\n      datasource: trailDS,\n      includeAll: true,\n      defaultToAll: true,\n      query: `label_names(${VAR_METRIC_EXPR})`,\n      value: '',\n      text: '',\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.filterOptions();\n\n    this.subscribeToState((newState, prevState) => {\n      if (newState.value && newState.value !== prevState.value) {\n        reportExploreMetrics('groupby_label_changed', { label: String(newState.value) });\n      }\n\n      if (newState.options !== prevState.options && newState.options.find((o) => o.value === 'le')) {\n        this.filterOptions(newState.options);\n      }\n    });\n\n    const filtersVariable = sceneGraph.lookupVariable(VAR_FILTERS, this);\n\n    if (isAdHocFiltersVariable(filtersVariable)) {\n      filtersVariable.subscribeToState((newState, prevState) => {\n        if (newState.filterExpression !== prevState.filterExpression) {\n          this.changeValueTo(ALL_VARIABLE_VALUE);\n        }\n      });\n    }\n  }\n\n  private filterOptions(options = this.state.options) {\n    this.setState({ options: options.filter((o) => o.value !== 'le') });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<MultiValueVariable>) => {\n    const styles = useStyles2(getStyles);\n    const { options, value, loading } = model.useState();\n\n    const onChange = useCallback(\n      (selected: string, ignore?: boolean) => {\n        const next = selected === 'All' ? '$__all' : selected;\n        model.changeValueTo(next, undefined, !ignore);\n      },\n      [model]\n    );\n\n    return (\n      <Field label=\"By label\" data-testid=\"breakdown-label-selector\" className={styles.field}>\n        <GroupBySelector\n          options={options as GroupByOptions}\n          value={value as string}\n          onChange={onChange}\n          loading={loading}\n        />\n      </Field>\n    );\n  };\n}\n\nfunction getStyles() {\n  return {\n    field: css({\n      marginBottom: 0,\n    }),\n  };\n}\n","import { type GrafanaTheme2 } from '@grafana/data';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\n\nexport function getAppBackgroundColor(theme: GrafanaTheme2, trail?: DataTrail): string {\n  // If DataTrail is in embedded mode, always use primary background\n  if (trail?.state.embedded) {\n    return theme.colors.background.primary;\n  }\n\n  // Otherwise, use the standard theme-based logic\n  return theme.isLight ? theme.colors.background.primary : theme.colors.background.canvas;\n}\n","import { LoadingState } from '@grafana/data';\nimport {\n  sceneGraph,\n  SceneQueryRunner,\n  type CancelActivationHandler,\n  type VizPanel,\n  type VizPanelState,\n} from '@grafana/scenes';\n\nimport { MAX_SERIES_TO_RENDER_WHEN_GROUPED_BY } from '../buildTimeseriesPanel';\n\nconst DEFAULT_CTA_TEXT_IN_DESCRIPTION = `Click on \"Select\" on this panel to view a breakdown of all the label's values.`;\n\ntype Options = {\n  description?: {\n    ctaText?: string;\n  };\n};\n\nexport const addCardinalityInfo =\n  (options: Options = {}) =>\n  (panel: VizPanel): CancelActivationHandler | void => {\n    const [queryRunner] = sceneGraph.findDescendents(panel, SceneQueryRunner);\n    if (!queryRunner) {\n      return;\n    }\n\n    const originalTitle = panel.state.title;\n\n    const dataSub = queryRunner.subscribeToState((newState) => {\n      if (newState.data?.state !== LoadingState.Done) {\n        return;\n      }\n\n      const { series } = newState.data;\n      if (!series?.length) {\n        return;\n      }\n\n      const stateUpdate: Partial<VizPanelState> = {\n        title: `${originalTitle} (${series.length})`,\n      };\n\n      if (series.length > MAX_SERIES_TO_RENDER_WHEN_GROUPED_BY) {\n        stateUpdate.description = `Showing only ${MAX_SERIES_TO_RENDER_WHEN_GROUPED_BY} series out of ${series.length} to keep the data easy to read.`;\n        stateUpdate.description +=\n          typeof options.description?.ctaText === 'string'\n            ? ` ${options.description?.ctaText}`\n            : ` ${DEFAULT_CTA_TEXT_IN_DESCRIPTION}`;\n      }\n\n      panel.setState(stateUpdate);\n    });\n\n    return () => {\n      dataSub.unsubscribe();\n    };\n  };\n","import { LoadingState } from '@grafana/data';\nimport { SceneDataTransformer, sceneGraph, type SceneDataProvider, type VizPanel } from '@grafana/scenes';\n\nimport { EventTimeseriesDataReceived } from '../events/EventTimeseriesDataReceived';\n\n/**\n * Publishes timeseries data events when new data arrives from the VizPanel data provider.\n * These events are used by the syncYAxis behaviour to coordinate updates across multiple panels.\n */\nexport function publishTimeseriesData() {\n  return (vizPanel: VizPanel) => {\n    if (vizPanel.state.pluginId !== 'timeseries') {\n      return;\n    }\n\n    let $data = sceneGraph.getData(vizPanel);\n    if ($data instanceof SceneDataTransformer) {\n      $data = $data.state.$data as SceneDataProvider;\n    }\n    const { data } = $data.state;\n\n    if (data?.state === LoadingState.Done && data.series?.length) {\n      vizPanel.publishEvent(\n        new EventTimeseriesDataReceived({\n          panelKey: vizPanel.state.key as string,\n          series: data.series,\n        }),\n        true\n      );\n    }\n\n    const sub = ($data as SceneDataProvider).subscribeToState((newState, prevState) => {\n      if (\n        newState.data?.state === LoadingState.Done &&\n        newState.data.series?.length &&\n        newState.data.series !== prevState.data?.series\n      ) {\n        const dataFrameType = newState.data.series[0].meta?.type;\n        if (dataFrameType && !dataFrameType.startsWith('timeseries')) {\n          return;\n        }\n\n        vizPanel.publishEvent(\n          new EventTimeseriesDataReceived({\n            panelKey: vizPanel.state.key as string,\n            series: newState.data.series,\n          }),\n          true\n        );\n      }\n    });\n\n    return () => {\n      sub.unsubscribe();\n    };\n  };\n}\n","import { sceneGraph, SceneObjectBase, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport { Button } from '@grafana/ui';\nimport React from 'react';\n\nimport { VAR_GROUP_BY } from 'shared/shared';\nimport { isQueryVariable } from 'shared/utils/utils.variables';\n\nimport { reportExploreMetrics } from '../../../shared/tracking/interactions';\n\ninterface SelectLabelActionState extends SceneObjectState {\n  label: string;\n}\n\nexport class SelectLabelAction extends SceneObjectBase<SelectLabelActionState> {\n  public onClick = () => {\n    const { label } = this.state;\n\n    reportExploreMetrics('breakdown_panel_selected', { label });\n\n    const groupByVariable = sceneGraph.lookupVariable(VAR_GROUP_BY, this)!;\n    if (!isQueryVariable(groupByVariable)) {\n      throw new Error('Group by variable not found');\n    }\n    groupByVariable.changeValueTo(label);\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<SelectLabelAction>) => {\n    return (\n      <Button variant=\"secondary\" size=\"sm\" fill=\"outline\" onClick={model.onClick}>\n        Select\n      </Button>\n    );\n  };\n}\n","import { css, cx } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { SceneObjectBase, sceneUtils, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport { Button, Icon, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { genBookmarkKey } from 'shared/bookmarks/genBookmarkKey';\nimport { type BookmarkFromStorage } from 'shared/bookmarks/useBookmarks';\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\nimport { PREF_KEYS } from 'shared/user-preferences/pref-keys';\nimport { userStorage } from 'shared/user-preferences/userStorage';\nimport { getTrailFor } from 'shared/utils/utils';\n\ninterface BookmarkHeaderActionState extends SceneObjectState {\n  isBookmarked: boolean;\n}\n\nexport class BookmarkHeaderAction extends SceneObjectBase<BookmarkHeaderActionState> {\n  constructor() {\n    super({\n      isBookmarked: false,\n    });\n\n    // Update bookmark state when component activates\n    this.addActivationHandler(() => {\n      const actualBookmarkState = this.isCurrentStateBookmarked();\n      this.setState({ isBookmarked: actualBookmarkState });\n    });\n  }\n\n  private isCurrentStateBookmarked(): boolean {\n    try {\n      const trail = getTrailFor(this);\n      const currentUrlState = sceneUtils.getUrlState(trail);\n      const currentKey = genBookmarkKey(currentUrlState);\n      const bookmarksFromStorage = userStorage.getItem(PREF_KEYS.BOOKMARKS) || [];\n      return bookmarksFromStorage.some((b: BookmarkFromStorage) => genBookmarkKey(b.urlValues) === currentKey);\n    } catch {\n      return false;\n    }\n  }\n\n  public onClick = () => {\n    const currentUrlState = sceneUtils.getUrlState(getTrailFor(this));\n    const currentKey = genBookmarkKey(currentUrlState);\n    const bookmarksFromStorage = userStorage.getItem(PREF_KEYS.BOOKMARKS) || [];\n    const isCurrentlyBookmarked = this.state.isBookmarked;\n\n    if (isCurrentlyBookmarked) {\n      // Remove bookmark\n      reportExploreMetrics('bookmark_changed', { action: 'toggled_off' });\n      const updatedBookmarks = bookmarksFromStorage.filter(\n        (b: BookmarkFromStorage) => genBookmarkKey(b.urlValues) !== currentKey\n      );\n      userStorage.setItem(PREF_KEYS.BOOKMARKS, updatedBookmarks);\n    } else {\n      // Add bookmark\n      reportExploreMetrics('bookmark_changed', { action: 'toggled_on' });\n      const newBookmark = {\n        urlValues: currentUrlState,\n        createdAt: Date.now(),\n      };\n      userStorage.setItem(PREF_KEYS.BOOKMARKS, [...bookmarksFromStorage, newBookmark]);\n    }\n\n    // Update state to trigger re-render\n    this.setState({ isBookmarked: !isCurrentlyBookmarked });\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<BookmarkHeaderAction>) => {\n    const styles = useStyles2(getStyles);\n    const { isBookmarked } = model.useState();\n\n    const label = isBookmarked ? 'Remove bookmark' : 'Add bookmark';\n\n    return (\n      <Button\n        className={cx(styles.bookmarkButton, isBookmarked && styles.active)}\n        aria-label={label}\n        variant=\"secondary\"\n        size=\"sm\"\n        fill=\"text\"\n        onClick={model.onClick}\n        icon={\n          isBookmarked ? (\n            <Icon name={'favorite'} type={'mono'} size={'lg'} />\n          ) : (\n            <Icon name={'star'} type={'default'} size={'lg'} />\n          )\n        }\n        tooltip={label}\n        tooltipPlacement=\"top\"\n        data-testid=\"bookmark-header-action\"\n      />\n    );\n  };\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  bookmarkButton: css`\n    margin: 0;\n    padding: 0;\n    margin-left: ${theme.spacing(1)};\n  `,\n  active: css`\n    color: ${theme.colors.text.maxContrast};\n  `,\n});\n","import { sceneGraph, SceneObjectBase, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport { RadioButtonGroup } from '@grafana/ui';\nimport React from 'react';\n\nimport { GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\nimport { type PanelType } from 'shared/GmdVizPanel/types/available-panel-types';\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\n\nimport { EventPanelTypeChanged } from './EventPanelTypeChanged';\n\ninterface GmdVizPanelVariantSelectorState extends SceneObjectState {\n  options: Array<{\n    label: string;\n    value: PanelType;\n  }>;\n  currentPanelType?: PanelType;\n}\n\n// currently used only for histogram metrics\nexport class GmdVizPanelVariantSelector extends SceneObjectBase<GmdVizPanelVariantSelectorState> {\n  constructor() {\n    super({\n      options: [\n        { value: 'percentiles' as PanelType, label: 'percentiles' },\n        { value: 'heatmap' as PanelType, label: 'heatmap' },\n      ],\n      currentPanelType: undefined,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    const vizPanel = sceneGraph.getAncestor(this, GmdVizPanel);\n\n    this.setState({\n      currentPanelType: vizPanel.state.panelConfig.type,\n    });\n\n    this._subs.add(\n      vizPanel.subscribeToState((newState, prevState) => {\n        if (newState.panelConfig.type !== prevState.panelConfig.type) {\n          this.setState({\n            currentPanelType: newState.panelConfig.type,\n          });\n        }\n      })\n    );\n  }\n\n  private onChange = (newPanelType: PanelType) => {\n    reportExploreMetrics('histogram_panel_type_changed', { panelType: newPanelType });\n\n    this.publishEvent(new EventPanelTypeChanged({ panelType: newPanelType }), true);\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<GmdVizPanelVariantSelector>) => {\n    const { options, currentPanelType } = model.useState();\n\n    if (!options.length) {\n      return null;\n    }\n\n    return <RadioButtonGroup size=\"sm\" options={options} value={currentPanelType} onChange={model.onChange} />;\n  };\n}\n","import { css, cx } from '@emotion/css';\nimport { DashboardCursorSync, type GrafanaTheme2 } from '@grafana/data';\nimport { useChromeHeaderHeight } from '@grafana/runtime';\nimport {\n  behaviors,\n  SceneFlexItem,\n  SceneFlexLayout,\n  sceneGraph,\n  SceneObjectBase,\n  type SceneComponentProps,\n  type SceneObject,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { useStyles2 } from '@grafana/ui';\nimport { useResizeObserver } from '@react-aria/utils';\nimport React, { useRef } from 'react';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\nimport { BookmarkHeaderAction } from 'shared/GmdVizPanel/components/BookmarkHeaderAction';\nimport { ConfigurePanelAction } from 'shared/GmdVizPanel/components/ConfigurePanelAction';\nimport { GmdVizPanelVariantSelector } from 'shared/GmdVizPanel/components/GmdVizPanelVariantSelector';\nimport { PANEL_HEIGHT } from 'shared/GmdVizPanel/config/panel-heights';\nimport { QUERY_RESOLUTION } from 'shared/GmdVizPanel/config/query-resolutions';\nimport { GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\nimport { isClassicHistogramMetric } from 'shared/GmdVizPanel/matchers/isClassicHistogramMetric';\n\nimport { MetricActionBar } from './MetricActionBar';\nimport { PanelMenu } from './PanelMenu/PanelMenu';\nimport { getMetricDescription } from '../AppDataTrail/MetricDatasourceHelper/MetricDatasourceHelper';\nimport { getTrailFor } from '../shared/utils/utils';\nimport { getAppBackgroundColor } from '../shared/utils/utils.styles';\n\nconst MAIN_PANEL_MIN_HEIGHT = PANEL_HEIGHT.XL;\nconst MAIN_PANEL_MAX_HEIGHT = '40%';\n\nexport const TOPVIEW_PANEL_MENU_KEY = 'topview-panel-menu';\n\ninterface MetricGraphSceneState extends SceneObjectState {\n  metric: string;\n  topView: SceneFlexLayout;\n  selectedTab?: SceneObject;\n  actionBar: MetricActionBar;\n}\n\nexport class MetricGraphScene extends SceneObjectBase<MetricGraphSceneState> {\n  public constructor({ metric }: { metric: MetricGraphSceneState['metric'] }) {\n    super({\n      metric,\n      topView: new SceneFlexLayout({\n        direction: 'column',\n        $behaviors: [new behaviors.CursorSync({ key: 'metricCrosshairSync', sync: DashboardCursorSync.Crosshair })],\n        children: [\n          new SceneFlexItem({\n            minHeight: MAIN_PANEL_MIN_HEIGHT,\n            maxHeight: MAIN_PANEL_MAX_HEIGHT,\n            body: new GmdVizPanel({\n              metric,\n              panelOptions: {\n                height: PANEL_HEIGHT.XL,\n                headerActions: isClassicHistogramMetric(metric)\n                  ? () => [\n                      new GmdVizPanelVariantSelector(),\n                      new ConfigurePanelAction({ metric }),\n                      new BookmarkHeaderAction(),\n                    ]\n                  : () => [new ConfigurePanelAction({ metric }), new BookmarkHeaderAction()],\n                menu: () => new PanelMenu({ key: TOPVIEW_PANEL_MENU_KEY, labelName: metric }),\n              },\n              queryOptions: {\n                resolution: QUERY_RESOLUTION.HIGH,\n              },\n            }),\n          }),\n        ],\n      }),\n      selectedTab: undefined,\n      actionBar: new MetricActionBar({}),\n    });\n\n    this.addActivationHandler(() => {\n      this.onActivate();\n    });\n  }\n\n  private async onActivate() {\n    const { metric } = this.state;\n    const [gmdVizPanel] = sceneGraph.findDescendents(this, GmdVizPanel);\n\n    if (gmdVizPanel.state.histogramType === 'classic') {\n      return;\n    }\n\n    const sub = gmdVizPanel.subscribeToState(async (newState, prevState) => {\n      if (prevState.histogramType !== 'native' && newState.histogramType === 'native') {\n        sub.unsubscribe();\n\n        const metadata = await getTrailFor(this).getMetadataForMetric(metric);\n\n        gmdVizPanel.update(\n          {\n            description: getMetricDescription(metadata),\n            headerActions: () => [\n              new GmdVizPanelVariantSelector(),\n              new ConfigurePanelAction({ metric }),\n              new BookmarkHeaderAction(),\n            ],\n          },\n          {}\n        );\n      }\n    });\n\n    this._subs.add(sub);\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<MetricGraphScene>) => {\n    const { topView, selectedTab, actionBar } = model.useState();\n    const chromeHeaderHeight = useChromeHeaderHeight();\n    const trail = getTrailFor(model);\n    const styles = useStyles2(getStyles, trail.state.embedded ? 0 : chromeHeaderHeight ?? 0, trail);\n    const controlsContainer = useRef<HTMLDivElement>(null);\n\n    useResizeObserver({\n      ref: controlsContainer,\n      onResize: () => {\n        const element = controlsContainer.current;\n        if (element) {\n          requestAnimationFrame(() => {\n            updateActionBarHeight(controlsContainer);\n          });\n        }\n      },\n    });\n\n    return (\n      <div className={styles.container}>\n        <div className={cx(styles.topView, styles.nonSticky)} data-testid=\"top-view\">\n          <topView.Component model={topView} />\n        </div>\n        <div className={cx(styles.topView, styles.stickyTop)} id=\"action-bar-container\" ref={controlsContainer}>\n          <actionBar.Component model={actionBar} />\n        </div>\n        {selectedTab && (\n          <div data-testid=\"tab-content\" className={styles.tabContent}>\n            <selectedTab.Component model={selectedTab} />\n          </div>\n        )}\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2, headerHeight: number, trail: DataTrail) {\n  return {\n    container: css({\n      display: 'flex',\n      flexDirection: 'column',\n      position: 'relative',\n      flexGrow: 1,\n    }),\n    tabContent: css({\n      height: '100%',\n    }),\n    topView: css({}),\n    stickyTop: css({\n      display: 'flex',\n      flexDirection: 'row',\n      background: getAppBackgroundColor(theme, trail),\n      position: 'sticky',\n      paddingTop: theme.spacing(1),\n      zIndex: 10,\n      // --app-controls-height is set dynamically by DataTrail component via ResizeObserver\n      // This ensures the main graph sticks below the app-controls in embedded mode\n      top: `calc(var(--app-controls-height, 0px) + ${headerHeight}px)`,\n    }),\n    nonSticky: css({\n      display: 'flex',\n      flexDirection: 'row',\n    }),\n  };\n}\n\nfunction updateActionBarHeight(controlsContainer: React.RefObject<HTMLDivElement>) {\n  const actionBar = controlsContainer.current;\n\n  if (!actionBar) {\n    return;\n  }\n\n  const { height } = actionBar.getBoundingClientRect();\n  document.documentElement.style.setProperty('--action-bar-height', `${height}px`);\n}\n","import { type PanelMenuItem } from '@grafana/data';\nimport { config } from '@grafana/runtime';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\nimport { PLUGIN_BASE_URL } from 'shared/constants/plugin';\n\nimport { displaySuccess } from '../../../MetricsReducer/helpers/displayStatus';\nimport { reportExploreMetrics } from '../../../shared/tracking/interactions';\nimport { getUrlForTrail } from '../../../shared/utils/utils';\n\nexport class CopyUrlAction {\n  static create(trail: DataTrail): PanelMenuItem {\n    return {\n      text: 'Copy URL',\n      iconClassName: 'copy',\n      onClick: () => {\n        if (navigator.clipboard) {\n          reportExploreMetrics('selected_metric_action_clicked', { action: 'share_url' });\n          const appUrl = config.appUrl.endsWith('/') ? config.appUrl.slice(0, -1) : config.appUrl;\n          const url = `${appUrl}${PLUGIN_BASE_URL}/${getUrlForTrail(trail)}`;\n          navigator.clipboard.writeText(url);\n          displaySuccess(['URL copied to clipboard']);\n        }\n      },\n    };\n  }\n}\n","import { type PanelMenuItem } from '@grafana/data';\nimport { getExploreURL, sceneGraph, VizPanel } from '@grafana/scenes';\n\nexport class ExploreAction {\n  static create(panelMenuInstance: any): PanelMenuItem {\n    let exploreUrl: Promise<string | undefined> | undefined;\n    \n    try {\n      const viz = sceneGraph.getAncestor(panelMenuInstance, VizPanel);\n      const panelData = sceneGraph.getData(viz).state.data;\n      if (!panelData) {\n        throw new Error('Cannot get link to explore, no panel data found');\n      }\n      // 'panelMenuInstance' scene object contain the variable for the metric name which is correctly interpolated into the explore url\n      // when used in the metric select scene case,\n      // this will get the explore url with interpolated variables and include the labels __ignore_usage__, this is a known issue\n      // in the metric scene we do not get use the __ignore_usage__ labels in the explore url\n      exploreUrl = getExploreURL(panelData, panelMenuInstance, panelData.timeRange, (query) => {\n        // remove __ignore_usage__=\"\" from the query\n        if ('expr' in query && typeof query.expr === 'string' && query.expr.includes('__ignore_usage__')) {\n          return {\n            ...query,\n            expr: query.expr.replace(/,?__ignore_usage__=\"\",?/, ''), // also remove leading/trailing comma if present\n          };\n        }\n\n        return query;\n      });\n    } catch {}\n\n    return {\n      text: 'Explore',\n      iconClassName: 'compass',\n      onClick: () => exploreUrl?.then((url) => url && window.open(url, '_blank')),\n      shortcut: 'p x',\n    };\n  }\n}\n","import { type DataFrame, type FieldConfig, type FieldConfigSource, type TimeRange } from '@grafana/data';\nimport { usePluginLinks } from '@grafana/runtime';\nimport {\n  sceneGraph,\n  SceneObjectBase,\n  VizPanel,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { type DataQuery, type DataSourceRef } from '@grafana/schema';\nimport { IconButton } from '@grafana/ui';\nimport React from 'react';\n\nimport MimirLogo from 'img/logo.svg';\nimport { findObjectOfType } from 'shared/utils/utils';\n\nimport pluginJson from '../../../../plugin.json';\nimport { VAR_DATASOURCE_EXPR } from '../../../../shared/shared';\nimport { isSceneQueryRunner } from '../../../../shared/utils/utils.queries';\n\nexport const investigationsPluginId = 'grafana-investigations-app';\nexport const extensionPointId = `${pluginJson.id}/investigation/v1`;\nexport const addToExplorationsButtonLabel = 'add panel to exploration';\n\ninterface AddToExplorationButtonState extends SceneObjectState {\n  frame?: DataFrame;\n  dsUid?: string;\n  labelName?: string;\n  fieldName?: string;\n  context?: ExtensionContext;\n\n  queries: DataQuery[];\n  fieldConfig?: FieldConfigSource;\n}\n\ninterface ExtensionContext {\n  timeRange: TimeRange;\n  queries: DataQuery[];\n  datasource: DataSourceRef;\n  origin: string;\n  url: string;\n  type: string;\n  title: string;\n  id: string;\n  logoPath: string;\n  note?: string;\n  drillDownLabel?: string;\n}\n\nexport class AddToExplorationButton extends SceneObjectBase<AddToExplorationButtonState> {\n  constructor(state: Omit<AddToExplorationButtonState, 'queries'>) {\n    super({ ...state, queries: [] });\n\n    this.addActivationHandler(this._onActivate.bind(this));\n  }\n\n  private _onActivate = () => {\n    this.subscribeToState(() => {\n      this.getQueries();\n      this.getContext();\n    });\n\n    const datasourceUid = sceneGraph.interpolate(this, VAR_DATASOURCE_EXPR);\n    this.setState({ dsUid: datasourceUid });\n  };\n\n  private readonly getQueries = () => {\n    const data = sceneGraph.getData(this);\n    const queryRunner = sceneGraph.findObject(data, isSceneQueryRunner);\n\n    if (isSceneQueryRunner(queryRunner)) {\n      const filter = this.state.frame ? getFilter(this.state.frame) : null;\n      const queries = queryRunner.state.queries.map((q) => ({\n        ...q,\n        expr: sceneGraph.interpolate(queryRunner, q.expr),\n        legendFormat: filter?.name ? `{{ ${filter.name} }}` : sceneGraph.interpolate(queryRunner, q.legendFormat),\n      }));\n\n      if (JSON.stringify(queries) !== JSON.stringify(this.state.queries)) {\n        this.setState({ queries });\n      }\n    }\n  };\n\n  private getPanelConfigAndDataFrames() {\n    const panel = findObjectOfType(this, (o) => o instanceof VizPanel, VizPanel);\n    const data = sceneGraph.getData(this);\n\n    return {\n      fieldConfig: panel?.state.fieldConfig,\n      frames: data?.state.data?.series,\n    };\n  }\n\n  private readonly updateFieldConfigOverrides = () => {\n    const { fieldConfig, frames } = this.getPanelConfigAndDataFrames();\n\n    if (!fieldConfig || !frames?.length) {\n      return undefined;\n    }\n\n    for (const frame of frames) {\n      for (const field of frame.fields) {\n        const configKeys = Object.keys(field.config);\n        const properties = configKeys.map((key) => ({\n          id: key,\n          value: field.config[key as keyof FieldConfig],\n        }));\n\n        // check if the override already exists\n        const existingOverride = fieldConfig.overrides.find(\n          (o) =>\n            o.matcher.options === (field.config.displayNameFromDS ?? field.config.displayName ?? field.name) &&\n            o.matcher.id === 'byName'\n        );\n\n        if (!existingOverride) {\n          // add as first override\n          fieldConfig.overrides.unshift({\n            matcher: {\n              id: 'byName',\n              options: field.config.displayNameFromDS ?? field.config.displayName ?? field.name,\n            },\n            properties,\n          });\n        }\n\n        if (existingOverride && JSON.stringify(existingOverride.properties) !== JSON.stringify(properties)) {\n          existingOverride.properties = properties;\n        }\n      }\n    }\n\n    return fieldConfig;\n  };\n\n  private readonly getContext = () => {\n    const fieldConfig = this.updateFieldConfigOverrides();\n    const { queries, dsUid, labelName, fieldName } = this.state;\n    const timeRange = sceneGraph.getTimeRange(this);\n\n    if (!timeRange || !queries || !dsUid) {\n      return;\n    }\n    const ctx = {\n      origin: 'Metrics Drilldown',\n      type: 'timeseries',\n      queries,\n      timeRange: { ...timeRange.state.value },\n      datasource: { uid: dsUid },\n      url: window.location.href,\n      id: `${JSON.stringify(queries)}${labelName}${fieldName}`,\n      title: labelName + (fieldName ? ` > ${fieldName}` : ''),\n      logoPath: MimirLogo,\n      drillDownLabel: fieldName,\n      fieldConfig,\n    };\n    if (JSON.stringify(ctx) !== JSON.stringify(this.state.context)) {\n      this.setState({ context: ctx });\n    }\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<AddToExplorationButton>) => {\n    const { context } = model.useState();\n    const { links } = usePluginLinks({ extensionPointId, context, limitPerPlugin: 1 });\n    const link = links.find((link) => link.pluginId === investigationsPluginId);\n\n    if (!link) {\n      return null;\n    }\n\n    return (\n      <IconButton\n        tooltip={link.description}\n        aria-label={addToExplorationsButtonLabel} // this is overriden by the `tooltip`\n        key={link.id}\n        name={link.icon ?? 'panel-add'}\n        onClick={(e) => {\n          if (link.onClick) {\n            link.onClick(e);\n          }\n        }}\n      />\n    );\n  };\n}\n\nconst getFilter = (frame: DataFrame) => {\n  const filterNameAndValueObj = frame.fields[1]?.labels ?? {};\n  const keys = Object.keys(filterNameAndValueObj);\n  if (keys.length !== 1) {\n    return;\n  }\n  const name = keys[0];\n  return { name, value: filterNameAndValueObj[name] };\n};\n","import { type DataFrame, type PanelMenuItem, type PluginExtensionLink } from '@grafana/data';\nimport { config, getObservablePluginLinks } from '@grafana/runtime';\nimport { firstValueFrom } from 'rxjs';\n\nimport { logger } from 'shared/logger/logger';\n\nimport { AddToExplorationButton, extensionPointId } from './AddToExplorationsButton';\n\nconst ADD_TO_INVESTIGATION_MENU_TEXT = 'Add to investigation';\nconst ADD_TO_INVESTIGATION_MENU_DIVIDER_TEXT = 'investigations_divider'; // Text won't be visible\nconst ADD_TO_INVESTIGATION_MENU_GROUP_TEXT = 'Investigations';\n\nexport class InvestigationAction {\n  static async create(\n    panelMenuInstance: any,\n    labelName?: string,\n    fieldName?: string,\n    frame?: DataFrame\n  ): Promise<PanelMenuItem[]> {\n    const addToExplorationsButton = new AddToExplorationButton({\n      labelName,\n      fieldName,\n      frame,\n    });\n\n    // Attach the button to the panel menu instance to provide scene graph context\n    panelMenuInstance.setState({\n      explorationsButton: addToExplorationsButton,\n    });\n\n    // Activate the button so it can access scene graph\n    if (panelMenuInstance.state.addExplorationsLink) {\n      addToExplorationsButton.activate();\n    }\n\n    const link = await getInvestigationLink(addToExplorationsButton);\n    const items: PanelMenuItem[] = [];\n\n    if (link) {\n      items.push(\n        {\n          text: ADD_TO_INVESTIGATION_MENU_DIVIDER_TEXT,\n          type: 'divider',\n        },\n        {\n          text: ADD_TO_INVESTIGATION_MENU_GROUP_TEXT,\n          type: 'group',\n        },\n        {\n          text: ADD_TO_INVESTIGATION_MENU_TEXT,\n          iconClassName: 'plus-square',\n          onClick: (e) => link.onClick && link.onClick(e),\n        }\n      );\n    }\n\n    return items;\n  }\n}\n\nconst getInvestigationLink = async (addToExplorations: AddToExplorationButton) => {\n  const context = addToExplorations.state.context;\n\n  // Check if we're running on Grafana v11\n  if (config.buildInfo.version.startsWith('11.')) {\n    try {\n      const runtime = await import('@grafana/runtime');\n      const getPluginLinkExtensions = (runtime as any).getPluginLinkExtensions;\n      if (getPluginLinkExtensions !== undefined) {\n        const links = getPluginLinkExtensions({\n          extensionPointId,\n          context,\n        });\n\n        return links.extensions[0];\n      }\n    } catch (e) {\n      // Ignore import error and fall through to v12 implementation\n      logger.error(e as Error, { message: 'Error importing getPluginLinkExtensions' });\n    }\n  }\n\n  // `getObservablePluginLinks` is introduced in Grafana v12\n  if (typeof getObservablePluginLinks === 'function') {\n    const links: PluginExtensionLink[] = await firstValueFrom(\n      getObservablePluginLinks({\n        extensionPointId,\n        context,\n      })\n    );\n\n    return links[0];\n  }\n\n  return undefined;\n};\n","import { type DataFrame, type PanelMenuItem } from '@grafana/data';\nimport { SceneObjectBase, VizPanelMenu, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport React from 'react';\n\nimport { getTrailFor } from '../../shared/utils/utils';\nimport { TOPVIEW_PANEL_MENU_KEY } from '../MetricGraphScene';\nimport { CopyUrlAction } from './actions/CopyUrlAction';\nimport { ExploreAction } from './actions/ExploreAction';\nimport { type AddToExplorationButton } from './actions/investigation/AddToExplorationsButton';\nimport { InvestigationAction } from './actions/investigation/InvestigationAction';\n\ninterface PanelMenuState extends SceneObjectState {\n  body?: VizPanelMenu;\n  frame?: DataFrame;\n  labelName?: string;\n  fieldName?: string;\n  addExplorationsLink?: boolean;\n  explorationsButton?: AddToExplorationButton;\n}\n\n/**\n * @todo the VizPanelMenu interface is overly restrictive, doesn't allow any member functions on this class, so everything is currently inlined\n */\nexport class PanelMenu extends SceneObjectBase<PanelMenuState> implements VizPanelMenu {\n  constructor(state: Omit<PanelMenuState, 'body'>) {\n    super({\n      ...state,\n      addExplorationsLink: state.addExplorationsLink ?? true,\n      body: new VizPanelMenu({}),\n    });\n\n    this.addActivationHandler(() => {\n      // Navigation group of options (all panels)\n      const items: PanelMenuItem[] = [\n        {\n          text: 'Navigation',\n          type: 'group',\n        },\n        ExploreAction.create(this),\n      ];\n\n      const isMainGraphPanel = this.state.key === TOPVIEW_PANEL_MENU_KEY;\n      if (isMainGraphPanel) {\n        // Only add Copy URL to the main metric graph panel\n        items.push(\n          {\n            text: 'Actions',\n            type: 'group',\n          },\n          CopyUrlAction.create(getTrailFor(this))\n        );\n      }\n\n      // Add investigation items if enabled (async)\n      if (this.state.addExplorationsLink) {\n        InvestigationAction.create(this, this.state.labelName, this.state.fieldName, this.state.frame).then(\n          (investigationItems) => {\n            if (investigationItems.length > 0) {\n              this.state.body?.setItems([...items, ...investigationItems]);\n            }\n          }\n        );\n      }\n\n      this.state.body?.setState({ items });\n    });\n  }\n\n  addItem(item: PanelMenuItem): void {\n    this.state.body?.addItem(item);\n  }\n\n  setItems(items: PanelMenuItem[]): void {\n    this.state.body?.setItems(items);\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<PanelMenu>) => {\n    const { body } = model.useState();\n    return <div data-testid=\"panel-menu\">{body && <body.Component model={body} />}</div>;\n  };\n}\n","import { css } from '@emotion/css';\nimport { DashboardCursorSync, type GrafanaTheme2 } from '@grafana/data';\nimport {\n  behaviors,\n  SceneCSSGridItem,\n  SceneCSSGridLayout,\n  sceneGraph,\n  SceneObjectBase,\n  SceneReactObject,\n  sceneUtils,\n  VizPanel,\n  type MultiValueVariable,\n  type SceneComponentProps,\n  type SceneObject,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { Field, Spinner, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { InlineBanner } from 'App/InlineBanner';\nimport { SceneByVariableRepeater } from 'MetricsReducer/components/SceneByVariableRepeater';\nimport { ShowMoreButton } from 'MetricsReducer/components/ShowMoreButton';\nimport { LayoutSwitcher, LayoutType, type LayoutSwitcherState } from 'MetricsReducer/list-controls/LayoutSwitcher';\nimport { GRID_TEMPLATE_COLUMNS, GRID_TEMPLATE_ROWS } from 'MetricsReducer/MetricsList/MetricsList';\nimport { PANEL_HEIGHT } from 'shared/GmdVizPanel/config/panel-heights';\nimport { QUERY_RESOLUTION } from 'shared/GmdVizPanel/config/query-resolutions';\nimport { addCardinalityInfo } from 'shared/GmdVizPanel/types/timeseries/behaviors/addCardinalityInfo';\nimport { buildTimeseriesPanel } from 'shared/GmdVizPanel/types/timeseries/buildTimeseriesPanel';\nimport { VAR_GROUP_BY } from 'shared/shared';\n\nimport { publishTimeseriesData } from './behaviors/publishTimeseriesData';\nimport { syncYAxis } from './behaviors/syncYAxis';\nimport { EventTimeseriesDataReceived } from './events/EventTimeseriesDataReceived';\nimport { SelectLabelAction } from './SelectLabelAction';\nimport { PanelMenu } from '../../PanelMenu/PanelMenu';\n\ninterface MetricLabelsListState extends SceneObjectState {\n  metric: string;\n  layoutSwitcher: LayoutSwitcher;\n  body: SceneByVariableRepeater;\n}\n\nexport class MetricLabelsList extends SceneObjectBase<MetricLabelsListState> {\n  constructor({ metric }: { metric: MetricLabelsListState['metric'] }) {\n    super({\n      key: 'metric-labels-list',\n      metric,\n      layoutSwitcher: new LayoutSwitcher({}),\n      body: new SceneByVariableRepeater({\n        variableName: VAR_GROUP_BY,\n        initialPageSize: 60,\n        pageSizeIncrement: 9,\n        body: new SceneCSSGridLayout({\n          children: [],\n          isLazy: true,\n          templateColumns: GRID_TEMPLATE_COLUMNS,\n          autoRows: PANEL_HEIGHT.M,\n          $behaviors: [\n            new behaviors.CursorSync({\n              key: 'metricCrosshairSync',\n              sync: DashboardCursorSync.Crosshair,\n            }),\n            syncYAxis(),\n          ],\n        }),\n        getLayoutLoading: () =>\n          new SceneReactObject({\n            reactNode: <Spinner inline />,\n          }),\n        getLayoutEmpty: () =>\n          new SceneReactObject({\n            reactNode: (\n              <InlineBanner title=\"\" severity=\"info\">\n                No labels found for the current filters and time range.\n              </InlineBanner>\n            ),\n          }),\n        getLayoutError: (error: Error) =>\n          new SceneReactObject({\n            reactNode: <InlineBanner severity=\"error\" title=\"Error while loading labels!\" error={error} />,\n          }),\n        getLayoutChild: (option, labelIndex) => {\n          const label = option.value as string;\n\n          return new SceneCSSGridItem({\n            body: buildTimeseriesPanel({\n              metric,\n              panelConfig: {\n                type: 'timeseries',\n                height: PANEL_HEIGHT.M,\n                title: label,\n                fixedColorIndex: labelIndex,\n                behaviors: [\n                  // publishTimeseriesData is required for the syncYAxis behavior (e.g. see MetricLabelsList)\n                  publishTimeseriesData(),\n                  addCardinalityInfo(),\n                ],\n                headerActions: () => [new SelectLabelAction({ label })],\n                menu: () => new PanelMenu({ labelName: label }),\n                legend: { placement: 'bottom' },\n              },\n              queryConfig: {\n                resolution: QUERY_RESOLUTION.MEDIUM,\n                groupBy: label,\n                labelMatchers: [],\n                addIgnoreUsageFilter: true,\n              },\n            }),\n          });\n        },\n      }),\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.subscribeToLayoutChange();\n    this.subscribeToEvents();\n  }\n\n  private subscribeToEvents() {\n    const actionsLookup = new Map<string, SceneObject[]>();\n\n    this.subscribeToEvent(EventTimeseriesDataReceived, (event) => {\n      const { panelKey, series } = event.payload;\n      const vizPanel = sceneGraph.findByKeyAndType(this, panelKey, VizPanel);\n\n      if (series.length === 1) {\n        if (!actionsLookup.has(panelKey)) {\n          actionsLookup.set(panelKey, (vizPanel.state.headerActions as SceneObject[]) || []);\n        }\n\n        vizPanel.setState({ headerActions: [] });\n        return;\n      }\n\n      if (actionsLookup.has(panelKey)) {\n        vizPanel.setState({ headerActions: actionsLookup.get(panelKey) });\n      }\n    });\n  }\n\n  private subscribeToLayoutChange() {\n    const layoutSwitcher = sceneGraph.findByKeyAndType(this, 'layout-switcher', LayoutSwitcher);\n    const body = this.state.body.state.body as SceneCSSGridLayout;\n\n    const onChangeState = (newState: LayoutSwitcherState, prevState?: LayoutSwitcherState) => {\n      if (newState.layout !== prevState?.layout) {\n        body.setState({\n          templateColumns: newState.layout === LayoutType.ROWS ? GRID_TEMPLATE_ROWS : GRID_TEMPLATE_COLUMNS,\n        });\n      }\n    };\n\n    // We ensure the proper layout when landing on the page:\n    // because MetricLabelsList is created dynamically when LabelBreakdownScene updates its body,\n    // LayoutSwitcher is not properly connected to the URL synchronization system\n    sceneUtils.syncStateFromSearchParams(layoutSwitcher, new URLSearchParams(window.location.search));\n    onChangeState(layoutSwitcher.state);\n\n    this._subs.add(layoutSwitcher.subscribeToState(onChangeState));\n  }\n\n  public Controls({ model }: { model: MetricLabelsList }) {\n    const styles = useStyles2(getStyles); // eslint-disable-line react-hooks/rules-of-hooks\n    const { layoutSwitcher } = model.useState();\n\n    return (\n      <Field label=\"View\" className={styles.field}>\n        <layoutSwitcher.Component model={layoutSwitcher} />\n      </Field>\n    );\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<MetricLabelsList>) => {\n    const { body } = model.useState();\n    const styles = useStyles2(getStyles);\n\n    const variable = sceneGraph.lookupVariable(VAR_GROUP_BY, model) as MultiValueVariable;\n    const { loading, error } = variable.useState();\n\n    const batchSizes = body.useSizes();\n    const shouldDisplayShowMoreButton =\n      !loading && !error && batchSizes.total > 0 && batchSizes.current < batchSizes.total;\n\n    const onClickShowMore = () => {\n      body.increaseBatchSize();\n    };\n\n    return (\n      <div data-testid=\"labels-list\">\n        <div className={styles.container}>\n          <body.Component model={body} />\n        </div>\n        {shouldDisplayShowMoreButton && (\n          <div className={styles.footer}>\n            <ShowMoreButton label=\"label\" batchSizes={batchSizes} onClick={onClickShowMore} />\n          </div>\n        )}\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({ width: '100%' }),\n    field: css({\n      marginBottom: 0,\n    }),\n    footer: css({\n      display: 'flex',\n      justifyContent: 'center',\n      alignItems: 'center',\n      marginTop: theme.spacing(4),\n\n      '& button': {\n        height: '40px',\n        borderRadius: '8px',\n      },\n    }),\n  };\n}\n","import { SceneObjectBase, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport { Button } from '@grafana/ui';\nimport React from 'react';\n\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\nimport { getTrailFor } from 'shared/utils/utils';\n\ninterface AddToFiltersGraphActionState extends SceneObjectState {\n  labelName: string;\n  labelValue: string;\n}\n\nexport class AddToFiltersGraphAction extends SceneObjectBase<AddToFiltersGraphActionState> {\n  public onClick = () => {\n    const { labelName, labelValue } = this.state;\n\n    reportExploreMetrics('label_filter_changed', { label: labelName, action: 'added', cause: 'breakdown' });\n\n    getTrailFor(this).addFilterWithoutReportingInteraction({\n      key: labelName,\n      operator: '=',\n      value: labelValue,\n    });\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<AddToFiltersGraphAction>) => {\n    return (\n      <Button variant=\"secondary\" size=\"sm\" fill=\"outline\" onClick={model.onClick}>\n        Add to filters\n      </Button>\n    );\n  };\n}\n","import { type DataFrame } from '@grafana/data';\n\nexport function getLabelValueFromDataFrame(frame: DataFrame) {\n  const labels = frame.fields[1]?.labels || {};\n\n  const keys = Object.keys(labels);\n  if (keys.length === 0) {\n    return '<unspecified>';\n  }\n\n  return labels[keys[0]];\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { SceneObjectBase, type SceneComponentProps, type SceneObjectState } from '@grafana/scenes';\nimport { Combobox, Field, IconButton, useStyles2, type ComboboxOption } from '@grafana/ui';\nimport React from 'react';\n\nimport { type SortSeriesByOption } from 'shared/services/sorting';\nimport { PREF_KEYS } from 'shared/user-preferences/pref-keys';\nimport { userStorage } from 'shared/user-preferences/userStorage';\n\nexport interface SortBySelectorState extends SceneObjectState {\n  target: 'fields' | 'labels';\n  options: Array<ComboboxOption<SortSeriesByOption>>;\n  value: ComboboxOption<SortSeriesByOption>;\n}\n\nexport class SortBySelector extends SceneObjectBase<SortBySelectorState> {\n  static readonly DEFAULT_OPTIONS = [\n    {\n      value: 'outliers' as SortSeriesByOption,\n      label: 'Outlying series',\n      description: 'Prioritizes values that show distinct behavior from others within the same label',\n    },\n    {\n      value: 'alphabetical' as SortSeriesByOption,\n      label: 'Name [A-Z]',\n      description: 'Alphabetical order',\n    },\n    {\n      value: 'alphabetical-reversed' as SortSeriesByOption,\n      label: 'Name [Z-A]',\n      description: 'Reversed alphabetical order',\n    },\n  ];\n\n  constructor(state: Pick<SortBySelectorState, 'target'>) {\n    const sortBy = userStorage.getItem(PREF_KEYS.BREAKDOWN_SORTBY);\n\n    super({\n      key: 'breakdown-sort-by',\n      target: state.target,\n      options: SortBySelector.DEFAULT_OPTIONS,\n      value:\n        (sortBy && SortBySelector.DEFAULT_OPTIONS.find((o) => o.value === sortBy)) || SortBySelector.DEFAULT_OPTIONS[0],\n    });\n  }\n\n  private onChange = (option: ComboboxOption<SortSeriesByOption>) => {\n    this.setState({ value: option });\n    userStorage.setItem(PREF_KEYS.BREAKDOWN_SORTBY, option.value);\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<SortBySelector>) => {\n    const styles = useStyles2(getStyles);\n    const { value, options } = model.useState();\n\n    return (\n      <Field\n        className={styles.field}\n        data-testid=\"sort-by-select\"\n        htmlFor=\"sort-by-criteria\"\n        label={\n          <div className={styles.sortByTooltip}>\n            Sort by\n            <IconButton\n              name={'info-circle'}\n              size=\"sm\"\n              variant={'secondary'}\n              tooltip=\"Sorts values using standard or smart time series calculations.\"\n            />\n          </div>\n        }\n      >\n        <Combobox\n          id=\"sort-by-criteria\"\n          placeholder=\"Choose criteria\"\n          width={20}\n          options={options}\n          value={value}\n          onChange={model.onChange}\n          isClearable={false}\n        />\n      </Field>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    sortByTooltip: css({\n      display: 'flex',\n      gap: theme.spacing(1),\n    }),\n    field: css({\n      marginBottom: 0,\n    }),\n  };\n}\n","import { LoadingState, type DataFrame, type PanelData } from '@grafana/data';\nimport {\n  sceneGraph,\n  SceneObjectBase,\n  type SceneComponentProps,\n  type SceneDataProvider,\n  type SceneLayout,\n  type SceneObject,\n  type SceneObjectState,\n  type SceneStatelessBehavior,\n} from '@grafana/scenes';\nimport React from 'react';\n\nimport { type CountsData } from 'MetricsReducer/list-controls/QuickSearch/CountsProvider/CountsProvider';\nimport { QuickSearch } from 'MetricsReducer/list-controls/QuickSearch/QuickSearch';\nimport { sortSeries, type SortSeriesByOption } from 'shared/services/sorting';\n\nimport { getLabelValueFromDataFrame } from './getLabelValueFromDataFrame';\nimport { SortBySelector } from './SortBySelector';\nimport { EventForceSyncYAxis } from '../MetricLabelsList/events/EventForceSyncYAxis';\nimport { EventResetSyncYAxis } from '../MetricLabelsList/events/EventResetSyncYAxis';\n\n/**\n * Same idea as in our custom SceneByVariableRepeater.tsx, we create a Scene object with more capabilities than the official Scene object.\n * Specifically, we're adding:\n *\n * 1. Support for pagination\n * 2. Support for filtering and sorting (we may consider externalizing this to a separate class in the future)\n * 3. Support for $behaviors, that is used to reset the y axis sync after filtering and/or sorting\n */\ninterface SceneByFrameRepeaterState extends SceneObjectState {\n  $behaviors: Array<SceneObject | SceneStatelessBehavior>;\n  body: SceneLayout;\n  getLayoutChild(data: PanelData, frame: DataFrame, frameIndex: number): SceneObject | null;\n  getLayoutLoading?: () => SceneObject;\n  getLayoutError?: (data: PanelData) => SceneObject;\n  getLayoutEmpty?: () => SceneObject;\n  currentBatchSize: number;\n  initialPageSize: number;\n  pageSizeIncrement: number;\n  loadingLayout?: SceneObject;\n  errorLayout?: SceneObject;\n  emptyLayout?: SceneObject;\n  counts: CountsData;\n  $data?: SceneDataProvider;\n}\n\nconst DEFAULT_INITIAL_PAGE_SIZE = 120;\nconst DEFAULT_PAGE_SIZE_INCREMENT = 9;\n\nexport class SceneByFrameRepeater extends SceneObjectBase<SceneByFrameRepeaterState> {\n  private searchText = '';\n  private sortBy?: SortSeriesByOption;\n\n  public constructor({\n    $behaviors,\n    body,\n    getLayoutChild,\n    getLayoutLoading,\n    getLayoutError,\n    getLayoutEmpty,\n    initialPageSize,\n    pageSizeIncrement,\n    $data,\n  }: {\n    $behaviors: SceneByFrameRepeaterState['$behaviors'];\n    body: SceneByFrameRepeaterState['body'];\n    getLayoutChild: SceneByFrameRepeaterState['getLayoutChild'];\n    getLayoutLoading?: SceneByFrameRepeaterState['getLayoutLoading'];\n    getLayoutError?: SceneByFrameRepeaterState['getLayoutError'];\n    getLayoutEmpty?: SceneByFrameRepeaterState['getLayoutEmpty'];\n    initialPageSize?: SceneByFrameRepeaterState['initialPageSize'];\n    pageSizeIncrement?: SceneByFrameRepeaterState['pageSizeIncrement'];\n    $data?: SceneByFrameRepeaterState['$data'];\n  }) {\n    super({\n      key: 'breakdown-by-frame-repeater',\n      $behaviors,\n      body,\n      getLayoutChild,\n      getLayoutLoading,\n      getLayoutError,\n      getLayoutEmpty,\n      currentBatchSize: 0,\n      initialPageSize: initialPageSize || DEFAULT_INITIAL_PAGE_SIZE,\n      pageSizeIncrement: pageSizeIncrement || DEFAULT_PAGE_SIZE_INCREMENT,\n      loadingLayout: undefined,\n      errorLayout: undefined,\n      emptyLayout: undefined,\n      counts: { current: 0, total: 0 },\n      $data,\n    });\n\n    this.addActivationHandler(() => {\n      const dataProvider = sceneGraph.getData(this);\n      if (!dataProvider) {\n        throw new Error('No data provider found!');\n      }\n\n      this.initFilterAndSort();\n\n      this._subs.add(\n        dataProvider.subscribeToState((newState) => {\n          if (newState.data) {\n            this.performRepeat(newState.data);\n          }\n        })\n      );\n\n      if (dataProvider.state.data) {\n        this.performRepeat(dataProvider.state.data);\n      }\n    });\n  }\n\n  private performRepeat(data: PanelData) {\n    if (data.state === LoadingState.Loading) {\n      this.setState({\n        loadingLayout: this.state.getLayoutLoading?.(),\n        errorLayout: undefined,\n        emptyLayout: undefined,\n        currentBatchSize: 0,\n      });\n      return;\n    }\n\n    if (data.state === LoadingState.Error) {\n      this.setState({\n        errorLayout: this.state.getLayoutError?.(data),\n        loadingLayout: undefined,\n        emptyLayout: undefined,\n        currentBatchSize: 0,\n      });\n      return;\n    }\n\n    const filteredSeries = this.filterAndSort(data.series);\n\n    if (!filteredSeries.length) {\n      this.setState({\n        emptyLayout: this.state.getLayoutEmpty?.(),\n        errorLayout: undefined,\n        loadingLayout: undefined,\n        currentBatchSize: 0,\n        counts: { current: 0, total: data.series.length },\n      });\n      return;\n    }\n\n    this.setState({\n      loadingLayout: undefined,\n      errorLayout: undefined,\n      emptyLayout: undefined,\n      currentBatchSize: this.state.initialPageSize,\n      counts: { current: filteredSeries.length, total: data.series.length },\n    });\n\n    const newChildren: SceneObject[] = filteredSeries\n      .slice(0, this.state.initialPageSize)\n      .map((s, i) => this.state.getLayoutChild(data, s, i))\n      .filter(Boolean) as SceneObject[];\n\n    this.state.body.setState({ children: newChildren });\n  }\n\n  private initFilterAndSort() {\n    this.searchText = sceneGraph.findByKeyAndType(this, 'quick-search', QuickSearch).state.value;\n    this.sortBy = sceneGraph.findByKeyAndType(this, 'breakdown-sort-by', SortBySelector).state.value.value;\n  }\n\n  private filterAndSort(series: PanelData['series']) {\n    let filteredSeries: DataFrame[] = [];\n\n    if (!this.searchText) {\n      filteredSeries = series;\n    } else {\n      const regexes = this.searchText\n        .split(',')\n        .map((p) => p.trim())\n        .filter(Boolean)\n        .map((r) => {\n          try {\n            return new RegExp(r);\n          } catch {\n            return null;\n          }\n        })\n        .filter(Boolean) as RegExp[];\n\n      for (let i = 0; i < series.length; i += 1) {\n        const s = series[i];\n\n        if (regexes.some((regex) => regex.test(getLabelValueFromDataFrame(s)))) {\n          filteredSeries.push(s);\n        }\n      }\n    }\n\n    if (this.sortBy) {\n      filteredSeries = sortSeries(filteredSeries, this.sortBy);\n    }\n\n    return filteredSeries;\n  }\n\n  public filter(searchText: string) {\n    this.searchText = searchText;\n\n    const { data } = sceneGraph.getData(this).state;\n    if (data) {\n      this.publishEvent(new EventResetSyncYAxis({}), true);\n      this.performRepeat(data);\n    }\n  }\n\n  public sort(sortBy: SortSeriesByOption) {\n    this.sortBy = sortBy;\n\n    const { data } = sceneGraph.getData(this).state;\n    if (data) {\n      this.publishEvent(new EventResetSyncYAxis({}), true);\n      this.performRepeat(data);\n    }\n  }\n\n  public increaseBatchSize() {\n    const { data } = sceneGraph.getData(this).state;\n    if (!data) {\n      return;\n    }\n\n    const newBatchSize = this.state.currentBatchSize + this.state.pageSizeIncrement;\n\n    const newChildren: SceneObject[] = this.filterAndSort(data.series)\n      .slice(this.state.currentBatchSize, newBatchSize)\n      .map((s, i) => this.state.getLayoutChild(data, s, i))\n      .filter(Boolean) as SceneObject[];\n\n    this.state.body.setState({\n      children: [...this.state.body.state.children, ...newChildren],\n    });\n\n    this.setState({\n      currentBatchSize: newBatchSize,\n    });\n\n    this.publishEvent(new EventForceSyncYAxis({}), true);\n  }\n\n  public useSizes() {\n    const { currentBatchSize, pageSizeIncrement } = this.useState();\n    const { data } = sceneGraph.getData(this).state;\n    const total = data ? this.filterAndSort(data.series).length : 0;\n    const remaining = total - currentBatchSize;\n    const increment = remaining < pageSizeIncrement ? remaining : pageSizeIncrement;\n\n    return {\n      increment,\n      current: currentBatchSize,\n      total,\n    };\n  }\n\n  public getCounts() {\n    const { data } = sceneGraph.getData(this).state;\n    return {\n      current: 0,\n      total: data ? data.series.length : 0,\n    };\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<SceneByFrameRepeater>) => {\n    const { body, loadingLayout, errorLayout, emptyLayout } = model.useState();\n\n    if (loadingLayout) {\n      return <loadingLayout.Component model={loadingLayout} />;\n    }\n\n    if (errorLayout) {\n      return <errorLayout.Component model={errorLayout} />;\n    }\n\n    if (emptyLayout) {\n      return <emptyLayout.Component model={emptyLayout} />;\n    }\n\n    return <body.Component model={body} />;\n  };\n}\n","import { sceneGraph } from '@grafana/scenes';\n\nimport { CountsProvider } from 'MetricsReducer/list-controls/QuickSearch/CountsProvider/CountsProvider';\n\nimport { SceneByFrameRepeater } from './SceneByFrameRepeater';\n\nexport class LabelValuesCountsProvider extends CountsProvider {\n  constructor() {\n    super({ key: 'LabelValuesCountsProvider' });\n\n    this.addActivationHandler(() => {\n      const byFrameRepeater = sceneGraph.findByKeyAndType(this, 'breakdown-by-frame-repeater', SceneByFrameRepeater);\n\n      this._subs.add(\n        byFrameRepeater.subscribeToState((newState, prevState) => {\n          if (newState.counts !== prevState.counts) {\n            this.setState({ counts: newState.counts });\n          }\n        })\n      );\n    });\n  }\n}\n","import { css, cx } from '@emotion/css';\nimport { DashboardCursorSync, LoadingState, type DataFrame, type GrafanaTheme2, type PanelData } from '@grafana/data';\nimport {\n  behaviors,\n  SceneCSSGridItem,\n  SceneCSSGridLayout,\n  SceneDataTransformer,\n  sceneGraph,\n  SceneObjectBase,\n  SceneQueryRunner,\n  SceneReactObject,\n  sceneUtils,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { Field, Spinner, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { ShowMoreButton } from 'MetricsReducer/components/ShowMoreButton';\nimport { LayoutSwitcher, LayoutType, type LayoutSwitcherState } from 'MetricsReducer/list-controls/LayoutSwitcher';\nimport { EventQuickSearchChanged } from 'MetricsReducer/list-controls/QuickSearch/EventQuickSearchChanged';\nimport { QuickSearch } from 'MetricsReducer/list-controls/QuickSearch/QuickSearch';\nimport { GRID_TEMPLATE_COLUMNS, GRID_TEMPLATE_ROWS } from 'MetricsReducer/MetricsList/MetricsList';\nimport { getPreferredConfigForMetric } from 'shared/GmdVizPanel/config/getPreferredConfigForMetric';\nimport { PANEL_HEIGHT } from 'shared/GmdVizPanel/config/panel-heights';\nimport { QUERY_RESOLUTION } from 'shared/GmdVizPanel/config/query-resolutions';\nimport { GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\nimport { addCardinalityInfo } from 'shared/GmdVizPanel/types/timeseries/behaviors/addCardinalityInfo';\nimport { getTimeseriesQueryRunnerParams } from 'shared/GmdVizPanel/types/timeseries/getTimeseriesQueryRunnerParams';\nimport { addUnspecifiedLabel } from 'shared/GmdVizPanel/types/timeseries/transformations/addUnspecifiedLabel';\nimport { trailDS } from 'shared/shared';\n\nimport { AddToFiltersGraphAction } from './AddToFiltersGraphAction';\nimport { getLabelValueFromDataFrame } from './getLabelValueFromDataFrame';\nimport { LabelValuesCountsProvider } from './LabelValuesCountProvider';\nimport { SceneByFrameRepeater } from './SceneByFrameRepeater';\nimport { SortBySelector, type SortBySelectorState } from './SortBySelector';\nimport { InlineBanner } from '../../../App/InlineBanner';\nimport { PanelMenu } from '../../PanelMenu/PanelMenu';\nimport { publishTimeseriesData } from '../MetricLabelsList/behaviors/publishTimeseriesData';\nimport { syncYAxis } from '../MetricLabelsList/behaviors/syncYAxis';\n\ninterface MetricLabelsValuesListState extends SceneObjectState {\n  metric: string;\n  label: string;\n  layoutSwitcher: LayoutSwitcher;\n  quickSearch: QuickSearch;\n  sortBySelector: SortBySelector;\n  body?: SceneByFrameRepeater | GmdVizPanel;\n}\n\nexport class MetricLabelValuesList extends SceneObjectBase<MetricLabelsValuesListState> {\n  constructor({\n    metric,\n    label,\n  }: {\n    metric: MetricLabelsValuesListState['metric'];\n    label: MetricLabelsValuesListState['label'];\n  }) {\n    const queryParams = getTimeseriesQueryRunnerParams({\n      metric,\n      queryConfig: {\n        resolution: QUERY_RESOLUTION.MEDIUM,\n        labelMatchers: [],\n        addIgnoreUsageFilter: true,\n        groupBy: label,\n      },\n    });\n\n    super({\n      key: 'metric-label-values-list',\n      metric,\n      label,\n      layoutSwitcher: new LayoutSwitcher({\n        urlSearchParamName: 'breakdownLayout',\n        options: [\n          { label: 'Single', value: LayoutType.SINGLE },\n          { label: 'Grid', value: LayoutType.GRID },\n          { label: 'Rows', value: LayoutType.ROWS },\n        ],\n      }),\n      quickSearch: new QuickSearch({\n        urlSearchParamName: 'breakdownSearchText',\n        targetName: 'label value',\n        countsProvider: new LabelValuesCountsProvider(),\n        displayCounts: true,\n      }),\n      sortBySelector: new SortBySelector({ target: 'labels' }),\n      $data: new SceneDataTransformer({\n        $data: new SceneQueryRunner({\n          datasource: trailDS,\n          maxDataPoints: queryParams.maxDataPoints,\n          queries: queryParams.queries,\n        }),\n        transformations: [addUnspecifiedLabel(label)],\n      }),\n      body: undefined,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.subscribeToLayoutChange();\n  }\n\n  private subscribeToQuickSearchChange() {\n    // We ensure the proper quick search value when landing on the page:\n    // because MetricLabelValuesList is created dynamically when LabelBreakdownScene updates its body,\n    // QuickSearch is not properly connected to the URL synchronization system\n    sceneUtils.syncStateFromSearchParams(this.state.quickSearch, new URLSearchParams(window.location.search));\n\n    this._subs.add(\n      this.subscribeToEvent(EventQuickSearchChanged, (event) => {\n        const byFrameRepeater = sceneGraph.findDescendents(this, SceneByFrameRepeater)[0];\n        if (byFrameRepeater) {\n          byFrameRepeater.filter(event.payload.searchText);\n        }\n      })\n    );\n  }\n\n  private subscribeToSortByChange() {\n    const { sortBySelector } = this.state;\n\n    this._subs.add(\n      sortBySelector.subscribeToState((newState: SortBySelectorState, prevState?: SortBySelectorState) => {\n        if (newState.value.value !== prevState?.value.value) {\n          const byFrameRepeater = sceneGraph.findDescendents(this, SceneByFrameRepeater)[0];\n          if (byFrameRepeater) {\n            byFrameRepeater.sort(newState.value.value);\n          }\n        }\n      })\n    );\n  }\n\n  private subscribeToLayoutChange() {\n    const { layoutSwitcher } = this.state;\n\n    // We ensure the proper layout when landing on the page:\n    // because MetricLabelValuesList is created dynamically when LabelBreakdownScene updates its body,\n    // LayoutSwitcher is not properly connected to the URL synchronization system\n    sceneUtils.syncStateFromSearchParams(layoutSwitcher, new URLSearchParams(window.location.search));\n\n    const onChangeState = (newState: LayoutSwitcherState, prevState?: LayoutSwitcherState) => {\n      if (newState.layout !== prevState?.layout) {\n        this.updateBody(newState.layout);\n      }\n    };\n\n    onChangeState(layoutSwitcher.state);\n\n    this._subs.add(layoutSwitcher.subscribeToState(onChangeState));\n  }\n\n  private updateBody(layout: LayoutType) {\n    if (layout === LayoutType.SINGLE) {\n      this.setState({ body: this.buildSinglePanel() });\n      return;\n    }\n\n    const existingByFrameRepeater = sceneGraph.findDescendents(this, SceneByFrameRepeater)[0];\n    const byFrameRepeater = existingByFrameRepeater || this.buildByFrameRepeater();\n\n    (byFrameRepeater.state.body as SceneCSSGridLayout).setState({\n      templateColumns: layout === LayoutType.ROWS ? GRID_TEMPLATE_ROWS : GRID_TEMPLATE_COLUMNS,\n    });\n\n    this.setState({ body: byFrameRepeater });\n\n    if (!existingByFrameRepeater) {\n      // we have to re-subscribe every time we build a new SceneByFrameRepeater instance because these controls (QuickSerach and SortBy) are not rendered when switching to the \"Single\" layout\n      this.subscribeToQuickSearchChange();\n      this.subscribeToSortByChange();\n    }\n  }\n\n  private buildSinglePanel() {\n    const { metric, label } = this.state;\n\n    return new GmdVizPanel({\n      metric,\n      discardUserPrefs: true,\n      panelOptions: {\n        type: 'timeseries',\n        height: PANEL_HEIGHT.XL,\n        headerActions: () => [],\n        behaviors: [addCardinalityInfo({ description: { ctaText: '' } })],\n      },\n      queryOptions: {\n        groupBy: label,\n        data: sceneGraph.getData(this),\n      },\n    });\n  }\n\n  private buildByFrameRepeater() {\n    const { metric, label } = this.state;\n    const prefMetricConfig = getPreferredConfigForMetric(metric);\n\n    return new SceneByFrameRepeater({\n      // we set the syncYAxis behavior here to ensure that the EventResetSyncYAxis events that are published by SceneByFrameRepeater can be received\n      $behaviors: [\n        syncYAxis(),\n        new behaviors.CursorSync({\n          key: 'metricCrosshairSync',\n          sync: DashboardCursorSync.Crosshair,\n        }),\n      ],\n      body: new SceneCSSGridLayout({\n        children: [],\n        isLazy: true,\n        templateColumns: GRID_TEMPLATE_COLUMNS,\n        autoRows: PANEL_HEIGHT.M,\n      }),\n      getLayoutLoading: () =>\n        new SceneReactObject({\n          reactNode: <Spinner inline />,\n        }),\n      getLayoutEmpty: () =>\n        new SceneReactObject({\n          reactNode: (\n            <InlineBanner title=\"\" severity=\"info\">\n              No label values found for the current filters and time range.\n            </InlineBanner>\n          ),\n        }),\n      getLayoutError: (data: PanelData) =>\n        new SceneReactObject({\n          reactNode: (\n            <InlineBanner severity=\"error\" title=\"Error while loading metrics!\" error={data.errors![0] as Error} />\n          ),\n        }),\n      getLayoutChild: (data: PanelData, frame: DataFrame, frameIndex: number) => {\n        // hide frames that have less than 2 points\n        if (frame.length < 2) {\n          return null;\n        }\n\n        const labelValue = getLabelValueFromDataFrame(frame);\n        const canAddToFilters = !labelValue.startsWith('<unspecified'); // see the \"addUnspecifiedLabel\" data transformation\n\n        const vizPanel = new GmdVizPanel({\n          metric,\n          discardUserPrefs: true,\n          panelOptions: {\n            ...prefMetricConfig?.panelOptions,\n            title: labelValue,\n            fixedColorIndex: frameIndex,\n            description: '',\n            headerActions: canAddToFilters\n              ? () => [new AddToFiltersGraphAction({ labelName: label, labelValue })]\n              : () => [],\n            menu: () => new PanelMenu({ labelName: labelValue }),\n            // publishTimeseriesData is required for the syncYAxis behavior (see MetricLabelsList)\n            // no worries to add it for all panel types here as it will check if the panel is a timeseries\n            // and if the data frame received is a timeseries before acting\n            behaviors: [publishTimeseriesData()],\n          },\n          queryOptions: {\n            ...prefMetricConfig?.queryOptions,\n            labelMatchers: [{ key: label, operator: '=', value: labelValue }],\n          },\n        });\n\n        return new SceneCSSGridItem({ body: vizPanel });\n      },\n    });\n  }\n\n  public Controls({ model }: { model: MetricLabelValuesList }) {\n    const styles = useStyles2(getStyles); // eslint-disable-line react-hooks/rules-of-hooks\n    const { body, quickSearch, layoutSwitcher, sortBySelector } = model.useState();\n\n    return (\n      <>\n        {body instanceof SceneByFrameRepeater && (\n          <>\n            <Field className={cx(styles.field, styles.quickSearchField)} label=\"Search\">\n              <quickSearch.Component model={quickSearch} />\n            </Field>\n            <sortBySelector.Component model={sortBySelector} />\n          </>\n        )}\n        <Field label=\"View\" className={styles.field}>\n          <layoutSwitcher.Component model={layoutSwitcher} />\n        </Field>\n      </>\n    );\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<MetricLabelValuesList>) => {\n    const { body } = model.useState();\n\n    return (\n      <>\n        {body instanceof GmdVizPanel && <MetricLabelValuesList.SingleMetricPanelComponent model={model} />}\n        {body instanceof SceneByFrameRepeater && <MetricLabelValuesList.ByFrameRepeaterComponent model={model} />}\n      </>\n    );\n  };\n\n  private static readonly SingleMetricPanelComponent = ({ model }: SceneComponentProps<MetricLabelValuesList>) => {\n    const styles = useStyles2(getStyles);\n    const { body } = model.useState();\n\n    return (\n      <div data-testid=\"single-metric-panel\">\n        <div className={styles.singlePanelContainer}>\n          {body instanceof GmdVizPanel && <body.Component model={body} />}\n        </div>\n      </div>\n    );\n  };\n\n  private static readonly ByFrameRepeaterComponent = ({ model }: SceneComponentProps<MetricLabelValuesList>) => {\n    const styles = useStyles2(getStyles);\n    const { body } = model.useState();\n\n    const dataProvider = sceneGraph.getData(model);\n    const { state, errors } = dataProvider.useState().data || {};\n\n    const byFrameRepeater = body as SceneByFrameRepeater;\n\n    const batchSizes = byFrameRepeater.useSizes();\n    const shouldDisplayShowMoreButton =\n      state !== LoadingState.Loading &&\n      !errors?.length &&\n      batchSizes.total > 0 &&\n      batchSizes.current < batchSizes.total;\n\n    const onClickShowMore = () => {\n      byFrameRepeater.increaseBatchSize();\n    };\n\n    return (\n      <div data-testid=\"label-values-list\">\n        <div className={styles.listContainer}>\n          {body instanceof SceneByFrameRepeater && <body.Component model={body} />}\n        </div>\n        {shouldDisplayShowMoreButton && (\n          <div className={styles.listFooter}>\n            <ShowMoreButton label=\"label value\" batchSizes={batchSizes} onClick={onClickShowMore} />\n          </div>\n        )}\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    singlePanelContainer: css({\n      width: '100%',\n      height: '300px',\n    }),\n    listContainer: css({ width: '100%' }),\n    listFooter: css({\n      display: 'flex',\n      justifyContent: 'center',\n      alignItems: 'center',\n      marginTop: theme.spacing(4),\n\n      '& button': {\n        height: '40px',\n        borderRadius: '8px',\n      },\n    }),\n    quickSearchField: css({\n      flexGrow: 1,\n    }),\n    field: css({\n      marginBottom: 0,\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { config, useChromeHeaderHeight } from '@grafana/runtime';\nimport {\n  sceneGraph,\n  SceneObjectBase,\n  type QueryVariable,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\nimport { getTrailFor } from 'shared/utils/utils';\nimport { getAppBackgroundColor } from 'shared/utils/utils.styles';\n\nimport { MetricLabelsList } from './MetricLabelsList/MetricLabelsList';\nimport { MetricLabelValuesList } from './MetricLabelValuesList/MetricLabelValuesList';\nimport { RefreshMetricsEvent, VAR_GROUP_BY } from '../../shared/shared';\nimport { isQueryVariable } from '../../shared/utils/utils.variables';\n\ninterface LabelBreakdownSceneState extends SceneObjectState {\n  metric: string;\n  body?: MetricLabelsList | MetricLabelValuesList;\n}\n\nexport class LabelBreakdownScene extends SceneObjectBase<LabelBreakdownSceneState> {\n  constructor({ metric }: { metric: LabelBreakdownSceneState['metric'] }) {\n    super({\n      metric,\n      body: undefined,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    const groupByVariable = this.getVariable();\n\n    groupByVariable.subscribeToState((newState, oldState) => {\n      if (newState.value !== oldState.value) {\n        this.updateBody(groupByVariable);\n      }\n    });\n\n    if (config.featureToggles.enableScopesInMetricsExplore) {\n      this.subscribeToEvent(RefreshMetricsEvent, () => {\n        this.updateBody(groupByVariable);\n      });\n    }\n\n    this.updateBody(groupByVariable);\n  }\n\n  private getVariable(): QueryVariable {\n    const groupByVariable = sceneGraph.lookupVariable(VAR_GROUP_BY, this)!;\n    if (!isQueryVariable(groupByVariable)) {\n      throw new Error('Group by variable not found');\n    }\n    return groupByVariable;\n  }\n\n  private updateBody(groupByVariable: QueryVariable) {\n    const { metric } = this.state;\n\n    this.setState({\n      body: groupByVariable.hasAllValue()\n        ? new MetricLabelsList({ metric })\n        : new MetricLabelValuesList({ metric, label: groupByVariable.state.value as string }),\n    });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<LabelBreakdownScene>) => {\n    const chromeHeaderHeight = useChromeHeaderHeight();\n    const trail = getTrailFor(model);\n    const styles = useStyles2(getStyles, trail.state.embedded ? 0 : chromeHeaderHeight ?? 0, trail);\n    const { body } = model.useState();\n    const groupByVariable = model.getVariable();\n\n    return (\n      <div className={styles.container}>\n        <div className={styles.stickyControls} data-testid=\"breakdown-controls\">\n          <div className={styles.controls}>\n            <groupByVariable.Component model={groupByVariable} />\n            {body instanceof MetricLabelsList && <body.Controls model={body} />}\n            {body instanceof MetricLabelValuesList && <body.Controls model={body} />}\n          </div>\n        </div>\n        <div data-testid=\"panels-list\">\n          {body instanceof MetricLabelsList && <body.Component model={body} />}\n          {body instanceof MetricLabelValuesList && <body.Component model={body} />}\n        </div>\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2, headerHeight: number, trail: DataTrail) {\n  return {\n    container: css({\n      flexGrow: 1,\n      display: 'flex',\n      minHeight: '100%',\n      flexDirection: 'column',\n    }),\n    stickyControls: css({\n      margin: theme.spacing(1, 0, 1.5, 0),\n      position: 'sticky',\n      top: `calc(var(--app-controls-height, 0px) + ${headerHeight}px + var(--action-bar-height, 0px))`,\n      zIndex: 10,\n      background: getAppBackgroundColor(theme, trail),\n      paddingBottom: theme.spacing(1),\n    }),\n    controls: css({\n      display: 'flex',\n      flexDirection: 'row',\n      justifyContent: 'space-between',\n      alignItems: 'end',\n      flexWrap: 'wrap',\n      gap: theme.spacing(1),\n    }),\n    searchField: css({\n      flexGrow: 1,\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport {\n  sceneGraph,\n  SceneObjectBase,\n  SceneObjectUrlSyncConfig,\n  VariableDependencyConfig,\n  type MultiValueVariable,\n  type SceneComponentProps,\n  type SceneObjectState,\n  type SceneObjectUrlValues,\n} from '@grafana/scenes';\nimport { Combobox, Icon, InlineField, InlineLabel, Tooltip, useStyles2, type ComboboxOption } from '@grafana/ui';\nimport React from 'react';\n\nimport { getMultiVariableValues } from 'MetricsReducer/components/SceneByVariableRepeater';\nimport { computeMetricPrefixGroups } from 'MetricsReducer/metrics-variables/computeMetricPrefixGroups';\nimport { VAR_METRICS_VARIABLE } from 'MetricsReducer/metrics-variables/MetricsVariable';\nimport { EventFiltersChanged } from 'MetricsReducer/SideBar/sections/MetricsFilterSection/EventFiltersChanged';\n\ninterface PrefixFilterDropdownState extends SceneObjectState {\n  loading: boolean;\n  error: Error | null;\n  options: ComboboxOption[];\n  value: string;\n}\n\nconst METRIC_PREFIX_ALL_OPTION = {\n  label: 'All metric names',\n  value: 'all',\n};\n\nexport class PrefixFilterDropdown extends SceneObjectBase<PrefixFilterDropdownState> {\n  protected _variableDependency: VariableDependencyConfig<PrefixFilterDropdownState> = new VariableDependencyConfig(\n    this,\n    {\n      variableNames: [VAR_METRICS_VARIABLE],\n      onVariableUpdateCompleted: () => this.parseMetricPrefixes(),\n    }\n  );\n\n  protected _urlSync = new SceneObjectUrlSyncConfig(this, { keys: ['metricPrefix'] });\n\n  getUrlState() {\n    return { metricPrefix: this.state.value };\n  }\n\n  updateFromUrl(values: SceneObjectUrlValues) {\n    if (typeof values.metricPrefix === 'string') {\n      if (this.state.value !== values.metricPrefix) {\n        this.setState({ value: values.metricPrefix });\n      }\n      return;\n    }\n\n    this.setState({ value: METRIC_PREFIX_ALL_OPTION.value });\n  }\n\n  constructor(state: Partial<PrefixFilterDropdownState>) {\n    super({\n      ...state,\n      key: 'related-prefix-filter',\n      loading: true,\n      error: null,\n      options: [METRIC_PREFIX_ALL_OPTION],\n      value: METRIC_PREFIX_ALL_OPTION.value,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.parseMetricPrefixes();\n  }\n\n  private parseMetricPrefixes() {\n    if (this._variableDependency.hasDependencyInLoadingState()) {\n      this.setState({ error: undefined, loading: true });\n      return;\n    }\n\n    const filteredMetricsVariable = sceneGraph.lookupVariable(VAR_METRICS_VARIABLE, this) as MultiValueVariable;\n\n    if (filteredMetricsVariable.state.error) {\n      this.setState({\n        error: filteredMetricsVariable.state.error,\n        loading: false,\n        options: [],\n      });\n      return;\n    }\n\n    const prefixGroups = computeMetricPrefixGroups(\n      getMultiVariableValues(filteredMetricsVariable) as Array<{ label: string; value: string }>\n    );\n\n    const newOptions = [\n      METRIC_PREFIX_ALL_OPTION,\n      ...prefixGroups.map((g) => ({\n        value: g.value,\n        label: `${g.label} (${g.count})`,\n      })),\n    ];\n\n    const { value } = this.state;\n    const newValue = newOptions.find((o) => o.value === value) ? (value as string) : METRIC_PREFIX_ALL_OPTION.value;\n\n    this.setState({\n      error: null,\n      loading: false,\n      options: newOptions,\n    });\n\n    this.selectOption({ value: newValue, label: newValue });\n  }\n\n  private selectOption = (option: ComboboxOption | null) => {\n    const value = option === null ? METRIC_PREFIX_ALL_OPTION.value : option.value;\n\n    this.setState({ value });\n\n    this.publishEvent(\n      new EventFiltersChanged({\n        type: 'prefixes',\n        filters: value === METRIC_PREFIX_ALL_OPTION.value ? [] : [value],\n      }),\n      true\n    );\n  };\n\n  public static readonly Component = ({ model }: SceneComponentProps<PrefixFilterDropdown>) => {\n    const styles = useStyles2(getStyles);\n    const { loading, options, value, error } = model.useState();\n\n    return (\n      <div className={styles.container} data-testid=\"prefix-filter-selector\">\n        <InlineField\n          disabled={loading}\n          error={error && error.toString()}\n          label={\n            <InlineLabel width=\"auto\" className={styles.label}>\n              <span>View by</span>\n              <Tooltip\n                content=\"View by the metric prefix. A metric prefix is a single word at the beginning of the metric name, relevant to the domain the metric belongs to.\"\n                placement=\"top\"\n              >\n                <Icon className={styles.tooltipIcon} name=\"info-circle\" size=\"sm\" />\n              </Tooltip>\n            </InlineLabel>\n          }\n        >\n          <Combobox value={value} onChange={model.selectOption} options={options} />\n        </InlineField>\n      </div>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css`\n      display: flex;\n\n      & > div {\n        margin: 0;\n      }\n    `,\n\n    label: css`\n      margin-right: 0;\n      background-color: ${theme.colors.background.primary};\n      border: 1px solid ${theme.colors.border.medium};\n      border-right: 0 none;\n      border-top-right-radius: 0;\n      border-bottom-right-radius: 0;\n    `,\n    tooltipIcon: css`\n      margin-left: ${theme.spacing(0.5)};\n    `,\n  };\n}\n","import { css } from '@emotion/css';\nimport { type SelectableValue } from '@grafana/data';\nimport {\n  EmbeddedScene,\n  SceneFlexItem,\n  SceneFlexLayout,\n  type SceneComponentProps,\n  type SceneObjectState,\n  type SceneReactObject,\n  type SceneVariableSet,\n} from '@grafana/scenes';\nimport { useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { LayoutSwitcher } from 'MetricsReducer/list-controls/LayoutSwitcher';\nimport { type CountsProvider } from 'MetricsReducer/list-controls/QuickSearch/CountsProvider/CountsProvider';\nimport { MetricVariableCountsProvider } from 'MetricsReducer/list-controls/QuickSearch/CountsProvider/MetricVariableCountsProvider';\nimport { QuickSearch } from 'MetricsReducer/list-controls/QuickSearch/QuickSearch';\n\nimport { PrefixFilterDropdown } from './PrefixFilterDropdown';\n\ninterface RelatedListControlsState extends SceneObjectState {\n  $variables?: SceneVariableSet;\n  inputControls?: SceneReactObject;\n  onChange?: (value: SelectableValue<string>) => void; // Keeping for backward compatibility\n}\n\nexport class RelatedListControls extends EmbeddedScene {\n  constructor(state: Partial<RelatedListControlsState>) {\n    super({\n      ...state,\n      key: 'related-list-controls',\n      body: new SceneFlexLayout({\n        direction: 'row',\n        width: '100%',\n        maxHeight: '32px',\n        children: [\n          new SceneFlexItem({\n            width: 'auto',\n            body: new PrefixFilterDropdown({}),\n          }),\n          new SceneFlexItem({\n            body: new QuickSearch({\n              urlSearchParamName: 'gmd-relatedSearchText',\n              targetName: 'related metric',\n              countsProvider: new MetricVariableCountsProvider() as unknown as CountsProvider,\n              displayCounts: true,\n            }),\n          }),\n          new SceneFlexItem({\n            width: 'auto',\n            body: new LayoutSwitcher({}),\n          }),\n        ],\n      }),\n    });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<RelatedListControls>) => {\n    const styles = useStyles2(getStyles);\n    const { body } = model.useState();\n\n    return (\n      <div className={styles.controls} data-testid=\"related-list-controls\">\n        <body.Component model={body} />\n      </div>\n    );\n  };\n}\n\nfunction getStyles() {\n  return {\n    controls: css({\n      display: 'flex',\n      alignItems: 'end',\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { useChromeHeaderHeight } from '@grafana/runtime';\nimport {\n  sceneGraph,\n  SceneObjectBase,\n  SceneVariableSet,\n  type QueryVariable,\n  type SceneComponentProps,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\nimport { EventQuickSearchChanged } from 'MetricsReducer/list-controls/QuickSearch/EventQuickSearchChanged';\nimport { QuickSearch } from 'MetricsReducer/list-controls/QuickSearch/QuickSearch';\nimport { EventMetricsVariableActivated } from 'MetricsReducer/metrics-variables/events/EventMetricsVariableActivated';\nimport { EventMetricsVariableDeactivated } from 'MetricsReducer/metrics-variables/events/EventMetricsVariableDeactivated';\nimport { EventMetricsVariableLoaded } from 'MetricsReducer/metrics-variables/events/EventMetricsVariableLoaded';\nimport {\n  FilteredMetricsVariable,\n  VAR_FILTERED_METRICS_VARIABLE,\n} from 'MetricsReducer/metrics-variables/FilteredMetricsVariable';\nimport {\n  MetricsVariableFilterEngine,\n  type MetricFilters,\n} from 'MetricsReducer/metrics-variables/MetricsVariableFilterEngine';\nimport { MetricsVariableSortEngine } from 'MetricsReducer/metrics-variables/MetricsVariableSortEngine';\nimport { MetricsList } from 'MetricsReducer/MetricsList/MetricsList';\nimport { EventFiltersChanged } from 'MetricsReducer/SideBar/sections/MetricsFilterSection/EventFiltersChanged';\n\nimport { RelatedListControls } from './RelatedListControls';\nimport { getTrailFor } from '../../shared/utils/utils';\nimport { getAppBackgroundColor } from '../../shared/utils/utils.styles';\n\ninterface RelatedMetricsSceneState extends SceneObjectState {\n  metric: string;\n  body: MetricsList;\n  listControls: RelatedListControls;\n}\n\nexport class RelatedMetricsScene extends SceneObjectBase<RelatedMetricsSceneState> {\n  constructor({ metric }: { metric: RelatedMetricsSceneState['metric'] }) {\n    super({\n      metric,\n      $variables: new SceneVariableSet({\n        variables: [new FilteredMetricsVariable()],\n      }),\n      key: 'RelatedMetricsScene',\n      body: new MetricsList({ variableName: VAR_FILTERED_METRICS_VARIABLE }),\n      listControls: new RelatedListControls({}),\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    this.subscribeToEvents();\n  }\n\n  private subscribeToEvents() {\n    this.initVariablesFilteringAndSorting();\n  }\n\n  /**\n   * The centralized filtering mechanism implemented here is decoupled via the usage of events.\n   * In order to work, the variables to be filtered/sorted must emit lifecycle events.\n   * This is done via the `withLifecycleEvents` decorator function.\n   *\n   * For example, check the `FilteredMetricsVariable` class.\n   */\n  private initVariablesFilteringAndSorting() {\n    const { metric } = this.state;\n\n    const enginesMap = new Map<\n      string,\n      { filterEngine: MetricsVariableFilterEngine; sortEngine: MetricsVariableSortEngine }\n    >();\n\n    this.subscribeToEvent(EventMetricsVariableActivated, (event) => {\n      // register engines\n      const { key } = event.payload;\n      const filteredMetricsVariable = sceneGraph.findByKey(this, key) as QueryVariable;\n\n      enginesMap.set(key, {\n        filterEngine: new MetricsVariableFilterEngine(filteredMetricsVariable),\n        sortEngine: new MetricsVariableSortEngine(filteredMetricsVariable),\n      });\n    });\n\n    this.subscribeToEvent(EventMetricsVariableDeactivated, (event) => {\n      // unregister engines\n      enginesMap.delete(event.payload.key);\n    });\n\n    const quickSearch = sceneGraph.findByKeyAndType(this, 'quick-search', QuickSearch);\n\n    this.subscribeToEvent(EventMetricsVariableLoaded, (event) => {\n      // filter  on initial load\n      const { key, options } = event.payload;\n      const { filterEngine, sortEngine } = enginesMap.get(key)!;\n\n      filterEngine.setInitOptions(options);\n\n      const filters: Partial<MetricFilters> = {\n        names: quickSearch.state.value ? [quickSearch.state.value] : [],\n      };\n\n      filterEngine.applyFilters(filters, { forceUpdate: true, notify: false });\n      sortEngine.sort('related', { metric });\n    });\n\n    /* Filters */\n\n    this.subscribeToEvent(EventQuickSearchChanged, (event) => {\n      const { searchText } = event.payload;\n\n      for (const [, { filterEngine, sortEngine }] of enginesMap) {\n        filterEngine.applyFilters({ names: searchText ? [searchText] : [] });\n        sortEngine.sort('related', { metric });\n      }\n    });\n\n    this.subscribeToEvent(EventFiltersChanged, (event) => {\n      const { type, filters } = event.payload;\n\n      for (const [, { filterEngine, sortEngine }] of enginesMap) {\n        filterEngine.applyFilters({ [type]: filters });\n        sortEngine.sort('related', { metric });\n      }\n    });\n  }\n\n  public static readonly Component = ({ model }: SceneComponentProps<RelatedMetricsScene>) => {\n    const chromeHeaderHeight = useChromeHeaderHeight();\n    const trail = getTrailFor(model);\n    const styles = useStyles2(getStyles, trail.state.embedded ? 0 : chromeHeaderHeight ?? 0, trail);\n    const { $variables, body, listControls } = model.useState();\n\n    return (\n      <>\n        <div className={styles.searchSticky}>\n          <listControls.Component model={listControls} />\n        </div>\n        <div data-testid=\"panels-list\">\n          <body.Component model={body} />\n        </div>\n        <div className={styles.variables}>\n          {$variables?.state.variables.map((variable) => (\n            <variable.Component key={variable.state.name} model={variable} />\n          ))}\n        </div>\n      </>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2, headerHeight: number, trail: DataTrail) {\n  return {\n    variables: css({\n      display: 'none',\n    }),\n    searchSticky: css({\n      margin: theme.spacing(1, 0, 1.5, 0),\n      position: 'sticky',\n      top: `calc(var(--app-controls-height, 0px) + ${headerHeight}px + var(--action-bar-height, 0px))`,\n      zIndex: 10,\n      background: getAppBackgroundColor(theme, trail),\n      paddingBottom: theme.spacing(1),\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport {\n  sceneGraph,\n  SceneObjectBase,\n  type SceneComponentProps,\n  type SceneObject,\n  type SceneObjectState,\n} from '@grafana/scenes';\nimport { Box, Stack, Tab, TabsBar, Tooltip, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\n\nimport { LabelBreakdownScene } from './Breakdown/LabelBreakdownScene';\nimport { MetricScene } from './MetricScene';\nimport { RelatedMetricsScene } from './RelatedMetrics/RelatedMetricsScene';\n\nexport const actionViews = {\n  breakdown: 'breakdown',\n  related: 'related',\n  relatedLogs: 'logs',\n} as const;\n\nexport type ActionViewType = (typeof actionViews)[keyof typeof actionViews];\n\ninterface ActionViewDefinition {\n  displayName: string;\n  value: ActionViewType;\n  description?: string;\n  getScene: (metricScene: MetricScene) => SceneObject<SceneObjectState>;\n}\n\nexport const actionViewsDefinitions: ActionViewDefinition[] = [\n  {\n    displayName: 'Breakdown',\n    value: actionViews.breakdown,\n    getScene: (metricScene: MetricScene) => new LabelBreakdownScene({ metric: metricScene.state.metric }),\n  },\n  {\n    displayName: 'Related metrics',\n    value: actionViews.related,\n    getScene: (metricScene: MetricScene) => new RelatedMetricsScene({ metric: metricScene.state.metric }),\n    description: 'Relevant metrics based on current label filters',\n  },\n  {\n    displayName: 'Related logs',\n    value: actionViews.relatedLogs,\n    getScene: (metricScene: MetricScene) => metricScene.createRelatedLogsScene(),\n    description: 'Relevant logs based on current label filters and time range',\n  },\n];\n\ninterface MetricActionBarState extends SceneObjectState {}\n\nexport class MetricActionBar extends SceneObjectBase<MetricActionBarState> {\n  public static readonly Component = ({ model }: SceneComponentProps<MetricActionBar>) => {\n    const metricScene = sceneGraph.getAncestor(model, MetricScene);\n    const styles = useStyles2(getStyles);\n    const { actionView } = metricScene.useState();\n\n    return (\n      <Box paddingY={1} data-testid=\"action-bar\" width=\"100%\">\n        <div className={styles.actions}>\n          <Stack gap={1}>{/* Action buttons moved to panel menu */}</Stack>\n        </div>\n\n        <TabsBar className={styles.customTabsBar}>\n          {actionViewsDefinitions.map((tab, index) => {\n            const label = tab.displayName;\n            const counter = tab.value === actionViews.relatedLogs ? metricScene.state.relatedLogsCount : undefined;\n            const isActive = actionView === tab.value;\n\n            const tabRender = (\n              <Tab\n                key={index}\n                label={label}\n                counter={counter}\n                active={isActive}\n                onChangeTab={() => {\n                  if (isActive) {\n                    return;\n                  }\n\n                  reportExploreMetrics('metric_action_view_changed', {\n                    view: tab.value,\n                    related_logs_count: metricScene.relatedLogsOrchestrator.checkConditionsMetForRelatedLogs()\n                      ? counter\n                      : undefined,\n                  });\n\n                  metricScene.setActionView(tab.value);\n                }}\n              />\n            );\n\n            if (tab.description) {\n              return (\n                <Tooltip key={index} content={tab.description} placement=\"top\" theme=\"info\">\n                  {tabRender}\n                </Tooltip>\n              );\n            }\n            return tabRender;\n          })}\n        </TabsBar>\n      </Box>\n    );\n  };\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    actions: css({\n      [theme.breakpoints.up(theme.breakpoints.values.md)]: {\n        position: 'absolute',\n        right: 0,\n        top: 16,\n        zIndex: 2,\n      },\n    }),\n    customTabsBar: css({\n      paddingBottom: theme.spacing(1),\n    }),\n  };\n}\n","import { type AdHocVariableFilter, type TimeRange } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { sceneGraph, type SceneObject } from '@grafana/scenes';\n\nimport { createMetricsLogsConnector, type FoundLokiDataSource } from './base';\nimport { VAR_FILTERS } from '../../shared/shared';\nimport { getTrailFor } from '../../shared/utils/utils';\nimport { getDataSourceFetcher } from '../../shared/utils/utils.datasource';\nimport { isAdHocFiltersVariable } from '../../shared/utils/utils.variables';\n\nconst knownLabelNameDiscrepancies = {\n  job: 'service_name', // `service.name` is `job` in Mimir and `service_name` in Loki\n  instance: 'service_instance_id', // `service.instance.id` is `instance` in Mimir and `service_instance_id` in Loki\n} as const;\n\nfunction isLabelNameThatShouldBeReplaced(x: string): x is keyof typeof knownLabelNameDiscrepancies {\n  return x in knownLabelNameDiscrepancies;\n}\n\nfunction replaceKnownLabelNames(labelName: string): string {\n  if (isLabelNameThatShouldBeReplaced(labelName)) {\n    return knownLabelNameDiscrepancies[labelName];\n  }\n\n  return labelName;\n}\n\n/**\n * Checks if a Loki data source has labels matching the current filters\n */\nasync function hasMatchingLabels(datasourceUid: string, filters: AdHocVariableFilter[], timeRange?: TimeRange) {\n  const ds = await getDataSourceSrv().get(datasourceUid);\n\n  // Get all available label keys for this data source\n  const labelKeys = await ds.getTagKeys?.({\n    timeRange,\n    filters: filters.map(({ key, operator, value }) => ({\n      key: replaceKnownLabelNames(key),\n      operator,\n      value,\n    })),\n  });\n\n  if (!Array.isArray(labelKeys)) {\n    return false;\n  }\n\n  const availableLabels = new Set(labelKeys.map((key) => key.text));\n\n  // Early return if none of our filter labels exist in this data source\n  const mappedFilterLabels = filters.map((f) => replaceKnownLabelNames(f.key));\n  const hasRequiredLabels = mappedFilterLabels.every((label) => availableLabels.has(label));\n  if (!hasRequiredLabels) {\n    return false;\n  }\n\n  // Check if each filter's value exists for its label\n  const results = await Promise.all(\n    filters.map(async (filter) => {\n      const lokiLabelName = replaceKnownLabelNames(filter.key);\n      const values = await ds.getTagValues?.({\n        key: lokiLabelName,\n        timeRange,\n        filters,\n      });\n\n      if (!Array.isArray(values)) {\n        return false;\n      }\n\n      return values.some((v) => v.text === filter.value);\n    })\n  );\n\n  // If any of the filters have no matching values, return false\n  return results.every(Boolean);\n}\n\nexport const createLabelsCrossReferenceConnector = (scene: SceneObject) => {\n  // In this connector, conditions have been met for related logs when label filters have been applied\n  let conditionsMetForRelatedLogs = false;\n\n  return createMetricsLogsConnector({\n    name: 'labelsCrossReference',\n    checkConditionsMetForRelatedLogs: () => conditionsMetForRelatedLogs,\n    async getDataSources(): Promise<FoundLokiDataSource[]> {\n      const trail = getTrailFor(scene);\n      const filtersVariable = sceneGraph.lookupVariable(VAR_FILTERS, trail);\n\n      if (!isAdHocFiltersVariable(filtersVariable) || !filtersVariable.state.filters.length) {\n        conditionsMetForRelatedLogs = false;\n        return [];\n      }\n\n      conditionsMetForRelatedLogs = true;\n      const filters = filtersVariable.state.filters.map(({ key, operator, value }) => ({ key, operator, value }));\n\n      // Get current time range if available\n      const timeRange = scene.state.$timeRange?.state.value;\n\n      const lokiDataSources = await getDataSourceFetcher().getHealthyDataSources('loki');\n      const results = await Promise.all(\n        lokiDataSources.map(async ({ uid, name }) => {\n          const hasLabels = await hasMatchingLabels(uid, filters, timeRange);\n          return hasLabels ? { uid, name } : null;\n        })\n      );\n\n      return results.filter((ds): ds is FoundLokiDataSource => ds !== null);\n    },\n    getLokiQueryExpr(): string {\n      const trail = getTrailFor(scene);\n      const filtersVariable = sceneGraph.lookupVariable(VAR_FILTERS, trail);\n\n      if (!isAdHocFiltersVariable(filtersVariable) || !filtersVariable.state.filters.length) {\n        return '';\n      }\n\n      const labelValuePairs = filtersVariable.state.filters.map(\n        (filter) => `${replaceKnownLabelNames(filter.key)}${filter.operator}\"${filter.value}\"`\n      );\n\n      return `{${labelValuePairs.join(',')}}`; // e.g. `{environment=\"dev\",region=\"us-west-1\"}`\n    },\n  });\n};\n","import { type DataSourceInstanceSettings, type DataSourceJsonData } from '@grafana/data';\nimport { MetricExpr, parser, PipelineExpr, Selector } from '@grafana/lezer-logql';\nimport { getBackendSrv, type BackendSrvRequest, type FetchResponse } from '@grafana/runtime';\nimport { type SyntaxNode } from '@lezer/common';\nimport { lastValueFrom } from 'rxjs';\n\nimport { createMetricsLogsConnector, type FoundLokiDataSource } from './base';\nimport { logger } from '../../shared/logger/logger';\nimport { getDataSourceFetcher } from '../../shared/utils/utils.datasource';\n\nexport interface RecordingRuleGroup {\n  name: string;\n  rules: RecordingRule[];\n}\n\nexport interface RecordingRule {\n  name: string;\n  query: string;\n  type: 'recording' | 'alerting' | string;\n  labels?: Record<string, string>;\n}\n\nexport interface ExtractedRecordingRule extends RecordingRule {\n  datasource: FoundLokiDataSource;\n  hasMultipleOccurrences?: boolean;\n}\n\nexport interface ExtractedRecordingRules {\n  [dataSourceUID: string]: ExtractedRecordingRule[];\n}\n\n/**\n * Fetch Loki recording rule groups from the specified datasource.\n *\n * @param datasourceSettings - The settings of the datasource instance.\n * @returns A promise that resolves to an array of recording rule groups.\n */\nasync function fetchRecordingRuleGroups(datasourceSettings: DataSourceInstanceSettings<DataSourceJsonData>) {\n  const recordingRuleUrl = `api/prometheus/${datasourceSettings.uid}/api/v1/rules`;\n  const recordingRules: BackendSrvRequest = { url: recordingRuleUrl, showErrorAlert: false, showSuccessAlert: false };\n  const res = await lastValueFrom<\n    FetchResponse<{\n      data: { groups: RecordingRuleGroup[] };\n    }>\n  >(getBackendSrv().fetch(recordingRules));\n\n  if (!res.ok) {\n    logger.warn(`Failed to fetch recording rules from Loki data source: ${datasourceSettings.name}`);\n    return [];\n  }\n\n  return res.data.data.groups;\n}\n\n/**\n * Extract recording rules from the provided rule groups and associate them with the given data source.\n *\n * @param ruleGroups - An array of recording rule groups to extract rules from.\n * @param ds - The data source instance settings to associate with the extracted rules.\n * @returns An array of extracted recording rules, each associated with the provided data source.\n */\nexport function extractRecordingRulesFromRuleGroups(\n  ruleGroups: RecordingRuleGroup[],\n  ds: DataSourceInstanceSettings<DataSourceJsonData>\n): ExtractedRecordingRule[] {\n  if (ruleGroups.length === 0) {\n    return [];\n  }\n\n  // We only want to return the first matching rule when there are multiple rules with same name\n  const extractedRules = new Map<string, ExtractedRecordingRule>();\n  ruleGroups.forEach((rg) => {\n    rg.rules\n      .filter((r) => r.type === 'recording')\n      .forEach(({ type, name, query }) => {\n        const isExist = extractedRules.has(name);\n        if (isExist) {\n          // We already have the rule.\n          const existingRule = extractedRules.get(name);\n          if (existingRule) {\n            existingRule.hasMultipleOccurrences = true;\n            extractedRules.set(name, existingRule);\n          }\n        } else {\n          extractedRules.set(name, {\n            type,\n            name,\n            query,\n            datasource: {\n              name: ds.name,\n              uid: ds.uid,\n            },\n            hasMultipleOccurrences: false,\n          });\n        }\n      });\n  });\n\n  return Array.from(extractedRules.values());\n}\n\n/**\n * Retrieve an array of Loki data sources that contain recording rules with the specified metric name.\n *\n * @param metricName - The name of the metric to search for within the recording rules.\n * @param extractedRecordingRules - An object containing extracted recording rules, where each key is a string and the value is an array of recording rules.\n * @returns An array of `FoundLokiDataSource` objects that contain recording rules with the specified metric name.\n */\nexport function getDataSourcesWithRecordingRulesContainingMetric(\n  metricName: string,\n  extractedRecordingRules: ExtractedRecordingRules\n): FoundLokiDataSource[] {\n  const foundLokiDataSources: FoundLokiDataSource[] = [];\n  Object.values(extractedRecordingRules).forEach((recRules) => {\n    recRules\n      .filter((rr) => rr.name === metricName)\n      .forEach((rr) => {\n        foundLokiDataSources.push(rr.datasource);\n      });\n  });\n\n  return foundLokiDataSources;\n}\n\n/**\n * Generate a Loki query string for a related metric based on the provided metric name, data source ID,\n * and extracted recording rules.\n *\n * @param metricName - The name of the metric for which to generate the Loki query.\n * @param dataSourceUid - The UID of the data source containing the recording rules.\n * @param extractedRecordingRules - An object containing recording rules, indexed by data source UID.\n * @returns The generated Loki query string, or an empty string if the data source UID or metric name is not found.\n */\nexport function getLokiQueryForRelatedMetric(\n  metricName: string,\n  dataSourceUid: string,\n  extractedRecordingRules: ExtractedRecordingRules\n): string {\n  if (!dataSourceUid || !extractedRecordingRules[dataSourceUid]) {\n    return '';\n  }\n  const targetRule = extractedRecordingRules[dataSourceUid].find((rule) => rule.name === metricName);\n  if (!targetRule) {\n    return '';\n  }\n  const lokiQuery = getLogQueryFromMetricsQuery(targetRule.query);\n\n  return lokiQuery;\n}\n\n/**\n * Fetch and extract Loki recording rules from all Loki data sources.\n *\n * @returns {Promise<ExtractedRecordingRules>} A promise that resolves to an object containing\n * the extracted recording rules, keyed by data source UID.\n *\n * @throws Will log a warning if fetching or extracting rules fails for any data source.\n */\nexport async function fetchAndExtractLokiRecordingRules() {\n  const lokiDataSources = await getDataSourceFetcher().getHealthyDataSources('loki');\n  const extractedRecordingRules: ExtractedRecordingRules = {};\n  await Promise.all(\n    lokiDataSources.map(async (dataSource) => {\n      try {\n        const ruleGroups: RecordingRuleGroup[] = await fetchRecordingRuleGroups(dataSource);\n        const extractedRules = extractRecordingRulesFromRuleGroups(ruleGroups, dataSource);\n        extractedRecordingRules[dataSource.uid] = extractedRules;\n      } catch (err) {\n        logger.warn(err);\n      }\n    })\n  );\n\n  return extractedRecordingRules;\n}\n\nexport const createLokiRecordingRulesConnector = () => {\n  let lokiRecordingRules: ExtractedRecordingRules = {};\n\n  // In this connector, conditions have been met for related logs\n  // when we find at least one data source with recording rules\n  // containing the selected metric\n  let conditionsMetForRelatedLogs = false;\n\n  return createMetricsLogsConnector({\n    name: 'lokiRecordingRules',\n    checkConditionsMetForRelatedLogs: () => conditionsMetForRelatedLogs,\n    async getDataSources(selectedMetric: string): Promise<FoundLokiDataSource[]> {\n      lokiRecordingRules = await fetchAndExtractLokiRecordingRules();\n      const lokiDataSources = getDataSourcesWithRecordingRulesContainingMetric(selectedMetric, lokiRecordingRules);\n      conditionsMetForRelatedLogs = Boolean(lokiDataSources.length);\n\n      return lokiDataSources;\n    },\n    getLokiQueryExpr(selectedMetric: string, datasourceUid: string): string {\n      return getLokiQueryForRelatedMetric(selectedMetric, datasourceUid, lokiRecordingRules);\n    },\n  });\n};\n\n/**\n * Returns whether the given query is a logs query (not a metrics query)\n * A query that's at least 3 characters long and doesn't contain a MetricExpr node is considered a logs query\n */\nfunction isLogsQuery(query: string): boolean {\n  if (query.trim().length <= 2) {\n    return false;\n  }\n\n  let hasMetricExpr = false;\n  const tree = parser.parse(query);\n\n  tree.iterate({\n    enter: ({ type }): false | void => {\n      if (type.id === MetricExpr) {\n        hasMetricExpr = true;\n        return false;\n      }\n    },\n  });\n\n  return !hasMetricExpr;\n}\n\n/**\n * Gets a node of the specified type from a LogQL query string\n * Returns undefined if no node of that type is found\n */\nfunction getNodeFromQuery(query: string, nodeType: number): SyntaxNode | undefined {\n  let foundNode: SyntaxNode | undefined;\n  const tree = parser.parse(query);\n\n  tree.iterate({\n    enter: (node): false | void => {\n      if (node.type.id === nodeType) {\n        foundNode = node.node;\n        return false;\n      }\n    },\n  });\n\n  return foundNode;\n}\n\n/**\n * Extracts the underlying log query from a metrics query\n * For metrics queries, it returns the selector and pipeline parts\n * For logs queries, it returns the original query unchanged\n * Returns an empty string if no valid query can be extracted\n *\n * @example\n * // Returns '{foo=\"bar\"} |= \"error\"'\n * getLogQueryFromMetricsQuery('rate({foo=\"bar\"} |= \"error\"[5m])')\n *\n * // Returns '{foo=\"bar\"}'\n * getLogQueryFromMetricsQuery('sum(rate({foo=\"bar\"}[5m]))')\n *\n * // Returns original query unchanged\n * getLogQueryFromMetricsQuery('{foo=\"bar\"} |= \"error\"')\n */\nexport function getLogQueryFromMetricsQuery(query: string): string {\n  // If it's already a logs query, return as-is\n  if (isLogsQuery(query)) {\n    return query;\n  }\n\n  // Get the selector node which contains the log query matchers\n  const selectorNode = getNodeFromQuery(query, Selector);\n  if (!selectorNode) {\n    return '';\n  }\n\n  const selector = query.substring(selectorNode.from, selectorNode.to);\n\n  // Get the pipeline expression node if it exists (contains filters, parsers etc.)\n  const pipelineExprNode = getNodeFromQuery(query, PipelineExpr);\n  const pipelineExpr = pipelineExprNode ? query.substring(pipelineExprNode.from, pipelineExprNode.to) : '';\n\n  // Combine selector with pipeline expression if it exists\n  return `${selector} ${pipelineExpr}`.trim();\n}\n","import { LoadingState } from '@grafana/data';\nimport { SceneQueryRunner, type QueryRunnerState } from '@grafana/scenes';\n\nimport { type MetricsLogsConnector } from '../../Integrations/logs/base';\nimport { createLabelsCrossReferenceConnector } from '../../Integrations/logs/labelsCrossReference';\nimport { createLokiRecordingRulesConnector } from '../../Integrations/logs/lokiRecordingRules';\nimport pluginJson from '../../plugin.json';\nimport { getDataSourceFetcher, type DataSource } from '../../shared/utils/utils.datasource';\nimport { type MetricScene } from '../MetricScene';\n\n/**\n * Manager class that handles the orchestration of related logs functionality.\n * This centralizes logs-related logic that was previously spread across multiple components.\n */\nexport class RelatedLogsOrchestrator {\n  private readonly _logsConnectors: MetricsLogsConnector[];\n  private readonly _metricScene: MetricScene;\n  private readonly _dataSourceFetcher = getDataSourceFetcher();\n  private readonly _changeHandlers = {\n    lokiDataSources: [] as Array<(dataSources: DataSource[]) => void>,\n    relatedLogsCount: [] as Array<(count: number) => void>,\n  };\n  /**\n   * Internal state that powers public properties defined by getters and setters.\n   */\n  private readonly _internalState = {\n    relatedLogsCount: 0,\n    lokiDataSources: [] as DataSource[],\n  };\n\n  constructor(metricScene: MetricScene) {\n    this._metricScene = metricScene;\n    this._logsConnectors = [createLokiRecordingRulesConnector(), createLabelsCrossReferenceConnector(metricScene)];\n  }\n\n  get lokiDataSources() {\n    return this._internalState.lokiDataSources;\n  }\n\n  set lokiDataSources(dataSources: DataSource[]) {\n    const currentDataSourcesSignature = this._internalState.lokiDataSources.map((ds) => ds.uid).join(',');\n    const newDataSourcesSignature = dataSources.map((ds) => ds.uid).join(',');\n\n    if (currentDataSourcesSignature && currentDataSourcesSignature === newDataSourcesSignature) {\n      return;\n    }\n\n    this._internalState.lokiDataSources = dataSources;\n    this._changeHandlers.lokiDataSources.forEach((handler) => handler(this._internalState.lokiDataSources));\n  }\n\n  set relatedLogsCount(count: number) {\n    this._internalState.relatedLogsCount = count;\n    this._changeHandlers.relatedLogsCount.forEach((handler) => handler(this._internalState.relatedLogsCount));\n  }\n\n  /**\n   * Add a listener that will be called when the lokiDataSources change.\n   */\n  addLokiDataSourcesChangeHandler(handler: (dataSources: DataSource[]) => void) {\n    this._changeHandlers.lokiDataSources.push(handler);\n  }\n\n  /**\n   * Add a listener that will be called when the relatedLogsCount changes.\n   */\n  addRelatedLogsCountChangeHandler(handler: (count: number) => void) {\n    this._changeHandlers.relatedLogsCount.push(handler);\n  }\n\n  /**\n   * Called when filters change to re-check for logs in datasources.\n   */\n  public handleFiltersChange(): void {\n    if (!this.lokiDataSources) {\n      return;\n    }\n\n    // When filters change, we need to reset our state to trigger updates in listeners\n    // Setting to empty array (vs undefined) signals we're actively checking\n    this.lokiDataSources = [];\n    this.relatedLogsCount = 0;\n\n    // Check all available datasources for logs after filter changes\n    this.findAndCheckAllDatasources();\n  }\n\n  /**\n   * Find all available datasources and check them for logs.\n   * This is used when filters change to ensure we're checking all possible datasources.\n   */\n  public async findAndCheckAllDatasources(): Promise<void> {\n    // Get all available Loki datasources\n    const allLokiDatasources = await this._dataSourceFetcher.getHealthyDataSources('loki');\n\n    // Check all datasources for logs\n    if (allLokiDatasources.length > 0) {\n      this.checkLogsInDataSources(allLokiDatasources);\n    } else {\n      // No datasources available\n      this.lokiDataSources = [];\n      this.relatedLogsCount = 0;\n    }\n  }\n\n  /**\n   * Get the Loki queries for a given datasource.\n   */\n  public getLokiQueries(\n    datasourceUid: string,\n    maxLines = 100\n  ): Array<{ refId: string; expr: string; maxLines: number }> {\n    const { metric } = this._metricScene.state;\n    const queriesByConnector = this._logsConnectors.reduce<Record<string, string>>((acc, connector, idx) => {\n      const lokiExpr = connector.getLokiQueryExpr(metric, datasourceUid);\n      if (lokiExpr) {\n        acc[connector.name ?? `connector-${idx}`] = lokiExpr;\n      }\n      return acc;\n    }, {});\n\n    const queries = Object.keys(queriesByConnector).map((connectorName) => ({\n      refId: `RelatedLogs-${connectorName}`,\n      expr: queriesByConnector[connectorName],\n      maxLines,\n      supportingQueryType: pluginJson.id,\n    }));\n\n    return queries;\n  }\n\n  /**\n   * Check each datasource for logs, then update the datasources and relatedLogsCount accordingly.\n   */\n  private checkLogsInDataSources(datasources: DataSource[]): void {\n    // Check each datasource for logs\n    const datasourcesWithLogs: DataSource[] = [];\n    let totalLogsCount = 0;\n    let totalChecked = 0;\n\n    // If no datasources to check, update immediately\n    if (datasources.length === 0) {\n      this.lokiDataSources = [];\n      this.relatedLogsCount = 0;\n      return;\n    }\n\n    // Check each datasource for logs\n    datasources.forEach((datasource) => {\n      const queryRunner = new SceneQueryRunner({\n        datasource: { uid: datasource.uid },\n        queries: [],\n        key: `related_logs_check_${datasource.uid}`,\n      });\n\n      // Build and set queries\n      queryRunner.setState({\n        queries: this.getLokiQueries(datasource.uid),\n      });\n\n      // Subscribe to results\n      queryRunner.subscribeToState((state) => {\n        if (state.data?.state === LoadingState.Done) {\n          totalChecked++;\n\n          // Check if we found logs in this datasource\n          if (state.data?.series) {\n            const rowCount = this.countLogsLines(state);\n            if (rowCount > 0) {\n              // This datasource has logs\n              datasourcesWithLogs.push(datasource);\n              totalLogsCount += rowCount;\n            }\n          }\n\n          // When all datasources have been checked\n          if (totalChecked === datasources.length) {\n            // Update state with our findings\n            this.lokiDataSources = datasourcesWithLogs;\n            this.relatedLogsCount = totalLogsCount;\n          }\n        }\n      });\n\n      // Activate query\n      queryRunner.activate();\n    });\n  }\n\n  /**\n   * Returns true if any of the connectors have conditions met for related logs to be shown.\n   */\n  public checkConditionsMetForRelatedLogs(): boolean {\n    return this._logsConnectors.some((connector) => connector.checkConditionsMetForRelatedLogs());\n  }\n\n  /**\n   * Given the state of a query runner running a Loki query, count the number of log lines.\n   */\n  public countLogsLines(state: QueryRunnerState): number {\n    return state.data?.series.reduce((sum: number, frame) => sum + frame.length, 0) ?? 0;\n  }\n}\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { Alert, Stack, Text, TextLink, useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nexport function NoRelatedLogs() {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <Stack direction=\"column\" gap={2}>\n      <Alert title=\"No related logs found\" severity=\"info\">\n        We couldn&apos;t find any logs related to the current metric with your selected filters.\n      </Alert>\n      <Text>\n        To find related logs, try the following:\n        <ul className={styles.list}>\n          <li>Adjust your label filters to include labels that exist in both the current metric and your logs</li>\n          <li>\n            Select a metric created by a{' '}\n            <TextLink external href=\"https://grafana.com/docs/loki/latest/alert/#recording-rules\">\n              Loki Recording Rule\n            </TextLink>\n          </li>\n          <li>Broaden the time range to include more data</li>\n        </ul>\n      </Text>\n      <Text variant=\"bodySmall\" color=\"secondary\">\n        Note: Related logs is an experimental feature.\n      </Text>\n    </Stack>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    list: css({\n      paddingLeft: theme.spacing(2),\n      marginTop: theme.spacing(1),\n    }),\n  };\n}\n","import { config, usePluginLinks } from '@grafana/runtime';\nimport { type SceneDataQuery, type SceneTimeRangeState } from '@grafana/scenes';\nimport { LinkButton } from '@grafana/ui';\nimport React, { useMemo } from 'react';\n\nimport { reportExploreMetrics } from '../../shared/tracking/interactions';\n\nconst extensionPointId = 'grafana-metricsdrilldown-app/open-in-logs-drilldown/v1';\n\nexport interface LogsDrilldownLinkContext {\n  targets: SceneDataQuery[];\n  timeRange?: SceneTimeRangeState;\n}\n\nexport function OpenInLogsDrilldownButton({ context }: Readonly<{ context: LogsDrilldownLinkContext }>) {\n  const memoizedContext = useMemo(() => context, [context]);\n  const { links, isLoading } = usePluginLinks({\n    extensionPointId,\n    limitPerPlugin: 1,\n    context: memoizedContext,\n  });\n  const logsDrilldownLink = useMemo(() => {\n    return links.find(({ pluginId }) => pluginId === 'grafana-lokiexplore-app');\n  }, [links]);\n\n  if (isLoading) {\n    return (\n      <LinkButton variant=\"secondary\" size=\"sm\" disabled>\n        Loading...\n      </LinkButton>\n    );\n  }\n\n  const logsDrilldownLinkExists = typeof logsDrilldownLink !== 'undefined';\n\n  return (\n    <LinkButton\n      href={\n        // We prefix with the appSubUrl for environments that don't host grafana at the root.\n        logsDrilldownLinkExists\n          ? `${config.appSubUrl}${logsDrilldownLink.path}`\n          : `${config.appSubUrl}/a/grafana-lokiexplore-app` // We fall back to the app's landing page if a link can't get generated using the supplied `context`\n      }\n      target=\"_blank\"\n      tooltip={\n        logsDrilldownLinkExists\n          ? 'Use the Logs Drilldown app to explore these logs'\n          : 'Navigate to the Logs Drilldown app'\n      }\n      variant=\"secondary\"\n      size=\"sm\"\n      onClick={() => reportExploreMetrics('related_logs_action_clicked', { action: 'open_logs_drilldown' })}\n    >\n      {logsDrilldownLinkExists ? 'Open in Logs Drilldown' : 'Open Logs Drilldown'}\n    </LinkButton>\n  );\n}\n","import { LoadingState } from '@grafana/data';\nimport {\n  CustomVariable,\n  PanelBuilders,\n  SceneFlexItem,\n  SceneFlexLayout,\n  sceneGraph,\n  SceneObjectBase,\n  SceneQueryRunner,\n  SceneReactObject,\n  SceneVariableSet,\n  VariableDependencyConfig,\n  VariableValueSelectors,\n  type QueryRunnerState,\n  type SceneComponentProps,\n  type SceneObject,\n  type SceneObjectState,\n  type SceneVariable,\n} from '@grafana/scenes';\nimport { Spinner, Stack } from '@grafana/ui';\nimport React from 'react';\n\nimport { NoRelatedLogs } from './NoRelatedLogsFound';\nimport { OpenInLogsDrilldownButton, type LogsDrilldownLinkContext } from './OpenInLogsDrilldownButton';\nimport { type RelatedLogsOrchestrator } from './RelatedLogsOrchestrator';\nimport { VAR_FILTERS, VAR_LOGS_DATASOURCE, VAR_LOGS_DATASOURCE_EXPR } from '../../shared/shared';\nimport { reportExploreMetrics } from '../../shared/tracking/interactions';\nimport { isCustomVariable } from '../../shared/utils/utils.variables';\n\ninterface RelatedLogsSceneProps {\n  orchestrator: RelatedLogsOrchestrator;\n}\n\ninterface RelatedLogsSceneState extends SceneObjectState, RelatedLogsSceneProps {\n  loading: boolean;\n  controls: SceneObject[];\n  body: SceneFlexLayout;\n  logsDrilldownLinkContext: LogsDrilldownLinkContext;\n}\n\nconst LOGS_PANEL_CONTAINER_KEY = 'related_logs/logs_panel_container';\nconst RELATED_LOGS_QUERY_KEY = 'related_logs/logs_query';\n\nexport class RelatedLogsScene extends SceneObjectBase<RelatedLogsSceneState> {\n  private _queryRunner?: SceneQueryRunner;\n\n  constructor(props: RelatedLogsSceneProps) {\n    super({\n      loading: false,\n      controls: [],\n      body: new SceneFlexLayout({\n        direction: 'column',\n        height: '100%',\n        minHeight: 500,\n        children: [\n          new SceneFlexItem({\n            key: LOGS_PANEL_CONTAINER_KEY,\n            body: undefined,\n          }),\n        ],\n      }),\n      orchestrator: props.orchestrator,\n      logsDrilldownLinkContext: {\n        targets: [],\n      },\n    });\n\n    this.addActivationHandler(() => {\n      this._onActivate();\n    });\n  }\n\n  private async _onActivate() {\n    // Register handler for future changes to lokiDataSources\n    this.state.orchestrator.addLokiDataSourcesChangeHandler(() => this.setupLogsPanel());\n\n    // If data sources have already been loaded, we don't need to fetch them again\n    if (!this.state.orchestrator.lokiDataSources.length) {\n      this.setState({ loading: true });\n      await this.state.orchestrator.findAndCheckAllDatasources();\n      this.setState({ loading: false });\n    } else {\n      this.setupLogsPanel();\n    }\n  }\n\n  private showNoLogsFound() {\n    const logsPanelContainer = sceneGraph.findByKeyAndType(this, LOGS_PANEL_CONTAINER_KEY, SceneFlexItem);\n    logsPanelContainer.setState({\n      body: new SceneReactObject({ component: NoRelatedLogs }),\n    });\n    this.setState({\n      controls: undefined,\n    });\n    this.state.orchestrator.relatedLogsCount = 0;\n  }\n\n  private _buildQueryRunner(): void {\n    this._queryRunner = new SceneQueryRunner({\n      datasource: { uid: VAR_LOGS_DATASOURCE_EXPR },\n      queries: [],\n      key: RELATED_LOGS_QUERY_KEY,\n    });\n    this._constructLogsDrilldownLinkContext(this._queryRunner.state);\n\n    // Set up subscription to query results\n    this._subs.add(\n      this._queryRunner.subscribeToState((state) => {\n        if (state.data?.state !== LoadingState.Done) {\n          // Only process completed query results\n          return;\n        }\n\n        const logLinesCount = this.state.orchestrator.countLogsLines(state);\n\n        if (logLinesCount === 0) {\n          // Show NoRelatedLogs if no logs found\n          this.showNoLogsFound();\n        }\n\n        this._constructLogsDrilldownLinkContext(state);\n      })\n    );\n  }\n\n  private setupLogsPanel(): void {\n    // Initialize query runner\n    this._buildQueryRunner();\n\n    // If no datasources can provide related logs given the current conditions, show the NoRelatedLogsScene\n    if (!this.state.orchestrator.lokiDataSources.length) {\n      this.showNoLogsFound();\n      return;\n    }\n\n    // Set up UI for logs panel\n    const logsPanelContainer = sceneGraph.findByKeyAndType(this, LOGS_PANEL_CONTAINER_KEY, SceneFlexItem);\n    logsPanelContainer.setState({\n      body: PanelBuilders.logs()\n        .setTitle('Logs')\n        .setOption('showLogContextToggle', true)\n        .setOption('showTime', true)\n        .setOption('showControls', true)\n        // See https://github.com/grafana/logs-drilldown/blob/5225d621bbf24756559a15ce68d71437be8ca83e/src/services/store.ts#L243\n        .setOption('controlsStorageKey', 'grafana.explore.logs')\n        .setData(this._queryRunner)\n        .build(),\n    });\n\n    // Set up variables for datasource selection\n    const logsDataSourceVariable = new CustomVariable({\n      name: VAR_LOGS_DATASOURCE,\n      label: 'Logs data source',\n      query: this.state.orchestrator.lokiDataSources.map((ds) => `${ds.name} : ${ds.uid}`).join(','),\n    });\n    this.setState({\n      $variables: new SceneVariableSet({ variables: [logsDataSourceVariable] }),\n      controls: [new VariableValueSelectors({ layout: 'vertical' })],\n    });\n    this._subs.add(\n      logsDataSourceVariable.subscribeToState((newState, prevState) => {\n        if (newState.value !== prevState.value) {\n          reportExploreMetrics('related_logs_action_clicked', { action: 'logs_data_source_changed' });\n        }\n      })\n    );\n\n    // Update Loki query\n    this.updateLokiQuery();\n  }\n\n  /**\n   * Construct the Logs Drilldown link context based on the query runner state\n   * @param state - The query runner state.\n   */\n  private _constructLogsDrilldownLinkContext(state: QueryRunnerState) {\n    const dsUid = (sceneGraph.lookupVariable(VAR_LOGS_DATASOURCE, this)?.getValue() ?? '') as string;\n    const queries = state.queries;\n    const targets: LogsDrilldownLinkContext['targets'] = [];\n\n    if (dsUid && queries.length) {\n      queries.forEach((query) => {\n        targets.push({\n          ...query,\n          datasource: {\n            uid: dsUid,\n            type: 'loki',\n          },\n        });\n      });\n    }\n\n    this.setState({\n      logsDrilldownLinkContext: { targets, timeRange: sceneGraph.getTimeRange(this).state },\n    });\n  }\n\n  /**\n   * Updates the Loki query based on the configured connectors, selected datasource, and current filters.\n   * This function is called when the selected datasource or filters change.\n   */\n  private updateLokiQuery() {\n    if (!this._queryRunner) {\n      return;\n    }\n\n    const selectedDatasourceVar = sceneGraph.lookupVariable(VAR_LOGS_DATASOURCE, this);\n\n    let selectedDatasourceUid: string | undefined = undefined;\n\n    if (isCustomVariable(selectedDatasourceVar)) {\n      selectedDatasourceUid = selectedDatasourceVar.getValue() as string;\n    }\n\n    if (!selectedDatasourceUid) {\n      return;\n    }\n\n    const queries = this.state.orchestrator.getLokiQueries(selectedDatasourceUid);\n\n    // If no queries were generated, show the NoRelatedLogsScene\n    if (queries.length === 0) {\n      this.showNoLogsFound();\n      return;\n    }\n\n    // Update queries - this will trigger the query runner to fetch new data\n    // The query results will be processed in the subscription handler\n    this._queryRunner.setState({ queries });\n  }\n\n  // Handle variable changes\n  protected _variableDependency = new VariableDependencyConfig(this, {\n    variableNames: [VAR_LOGS_DATASOURCE, VAR_FILTERS],\n    onReferencedVariableValueChanged: (variable: SceneVariable) => {\n      if (variable.state.name === VAR_FILTERS) {\n        this.state.orchestrator.handleFiltersChange();\n      } else if (variable.state.name === VAR_LOGS_DATASOURCE) {\n        this.updateLokiQuery();\n      }\n    },\n  });\n\n  static readonly Component = ({ model }: SceneComponentProps<RelatedLogsScene>) => {\n    const { controls, body, logsDrilldownLinkContext, loading } = model.useState();\n\n    if (loading) {\n      return <Spinner />;\n    }\n\n    return (\n      <Stack gap={1} direction={'column'} grow={1} height=\"100%\">\n        <Stack gap={1} direction={'row'} justifyContent={'space-between'} alignItems={'start'}>\n          <Stack gap={1}>\n            {controls?.map((control) => (\n              <control.Component key={control.state.key} model={control} />\n            ))}\n          </Stack>\n          <OpenInLogsDrilldownButton context={logsDrilldownLinkContext} />\n        </Stack>\n        <body.Component model={body} />\n      </Stack>\n    );\n  };\n}\n","import { css } from '@emotion/css';\nimport { config } from '@grafana/runtime';\nimport {\n  ConstantVariable,\n  SceneObjectBase,\n  SceneObjectUrlSyncConfig,\n  SceneVariableSet,\n  VariableDependencyConfig,\n  type SceneComponentProps,\n  type SceneObject,\n  type SceneObjectState,\n  type SceneObjectUrlValues,\n} from '@grafana/scenes';\nimport { VariableHide } from '@grafana/schema';\nimport { useStyles2 } from '@grafana/ui';\nimport React from 'react';\n\nimport { RefreshMetricsEvent, VAR_FILTERS, VAR_METRIC, type MakeOptional } from '../shared/shared';\nimport { GroupByVariable } from './Breakdown/GroupByVariable';\nimport { actionViews, actionViewsDefinitions, type ActionViewType } from './MetricActionBar';\nimport { MetricGraphScene } from './MetricGraphScene';\nimport { RelatedLogsOrchestrator } from './RelatedLogs/RelatedLogsOrchestrator';\nimport { RelatedLogsScene } from './RelatedLogs/RelatedLogsScene';\n\ninterface MetricSceneState extends SceneObjectState {\n  body: MetricGraphScene;\n  metric: string;\n  actionView?: ActionViewType;\n  relatedLogsCount?: number;\n}\n\nexport class MetricScene extends SceneObjectBase<MetricSceneState> {\n  public readonly relatedLogsOrchestrator = new RelatedLogsOrchestrator(this);\n  protected _urlSync = new SceneObjectUrlSyncConfig(this, { keys: ['actionView'] });\n  protected _variableDependency = new VariableDependencyConfig(this, {\n    variableNames: [VAR_FILTERS],\n    onReferencedVariableValueChanged: () => {\n      // When filters change, we need to re-check for related logs\n\n      this.relatedLogsOrchestrator.handleFiltersChange();\n    },\n  });\n\n  public constructor(state: MakeOptional<MetricSceneState, 'body'>) {\n    super({\n      $variables: state.$variables ?? getVariableSet(state.metric),\n      body: state.body ?? new MetricGraphScene({ metric: state.metric }),\n      ...state,\n    });\n\n    this.addActivationHandler(this._onActivate.bind(this));\n  }\n\n  private _onActivate() {\n    if (this.state.actionView === undefined) {\n      this.setActionView(actionViews.breakdown);\n    }\n\n    this.relatedLogsOrchestrator.findAndCheckAllDatasources();\n    this.relatedLogsOrchestrator.addRelatedLogsCountChangeHandler((count) => {\n      this.setState({ relatedLogsCount: count });\n    });\n\n    this.subscribeToEvents();\n  }\n\n  private subscribeToEvents() {\n    if (config.featureToggles.enableScopesInMetricsExplore) {\n      // Push the scopes change event to the tabs\n      // The event is not propagated because the tabs are not part of the scene graph\n      this.subscribeToEvent(RefreshMetricsEvent, (event) => {\n        this.state.body.state.selectedTab?.publishEvent(event);\n      });\n    }\n  }\n\n  getUrlState() {\n    return { actionView: this.state.actionView };\n  }\n\n  updateFromUrl(values: SceneObjectUrlValues) {\n    if (typeof values.actionView === 'string') {\n      if (this.state.actionView !== values.actionView) {\n        const actionViewDef = actionViewsDefinitions.find((v) => v.value === values.actionView);\n        if (actionViewDef) {\n          this.setActionView(actionViewDef.value);\n        }\n      }\n    } else if (values.actionView === null) {\n      this.setActionView(null);\n    }\n  }\n\n  public setActionView(actionViewType: ActionViewType | null) {\n    const { body } = this.state;\n    const actionViewDef = actionViewType ? actionViewsDefinitions.find((v) => v.value === actionViewType) : null;\n\n    if (actionViewDef && actionViewDef.value !== this.state.actionView) {\n      body.setState({ selectedTab: actionViewDef.getScene(this) });\n      this.setState({ actionView: actionViewDef.value });\n    } else {\n      body.setState({ selectedTab: undefined });\n      this.setState({ actionView: undefined });\n    }\n  }\n\n  static readonly Component = ({ model }: SceneComponentProps<MetricScene>) => {\n    const { body } = model.useState();\n    const styles = useStyles2(getStyles);\n\n    return (\n      <div className={styles.container} data-testid=\"metric-scene\">\n        <body.Component model={body} />\n      </div>\n    );\n  };\n\n  public createRelatedLogsScene(): SceneObject<SceneObjectState> {\n    return new RelatedLogsScene({\n      orchestrator: this.relatedLogsOrchestrator,\n    });\n  }\n}\n\nfunction getVariableSet(metric: string) {\n  return new SceneVariableSet({\n    variables: [\n      new ConstantVariable({\n        name: VAR_METRIC,\n        value: metric,\n        hide: VariableHide.hideVariable,\n      }),\n      new GroupByVariable(),\n    ],\n  });\n}\n\nconst getStyles = () => ({\n  container: css({\n    position: 'relative',\n    height: '100%',\n    width: '100%',\n    // Ensure proper flex behavior for sticky positioning\n    display: 'flex',\n    flexDirection: 'column',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { urlUtil, VariableHide, type AdHocVariableFilter, type GrafanaTheme2 } from '@grafana/data';\nimport { utf8Support } from '@grafana/prometheus';\nimport { config, useChromeHeaderHeight } from '@grafana/runtime';\nimport {\n  AdHocFiltersVariable,\n  SceneControlsSpacer,\n  sceneGraph,\n  SceneObjectBase,\n  SceneObjectUrlSyncConfig,\n  SceneRefreshPicker,\n  SceneTimePicker,\n  SceneTimeRange,\n  sceneUtils,\n  SceneVariableSet,\n  ScopesVariable,\n  UrlSyncContextProvider,\n  VariableDependencyConfig,\n  VariableValueSelectors,\n  type SceneComponentProps,\n  type SceneObject,\n  type SceneObjectState,\n  type SceneObjectUrlValues,\n  type SceneObjectWithUrlSync,\n  type SceneVariable,\n} from '@grafana/scenes';\nimport { useStyles2 } from '@grafana/ui';\nimport React, { useEffect } from 'react';\n\nimport { GiveFeedbackButton } from 'AppDataTrail/header/GiveFeedbackButton';\nimport { SceneDrawer } from 'MetricsReducer/components/SceneDrawer';\nimport { displaySuccess } from 'MetricsReducer/helpers/displayStatus';\nimport { registerRuntimeDataSources } from 'MetricsReducer/helpers/registerRuntimeDataSources';\nimport { LabelsDataSource } from 'MetricsReducer/labels/LabelsDataSource';\nimport { LabelsVariable } from 'MetricsReducer/labels/LabelsVariable';\nimport { addRecentMetric } from 'MetricsReducer/list-controls/MetricsSorter/MetricsSorter';\nimport { AdHocFiltersForMetricsVariable } from 'MetricsReducer/metrics-variables/AdHocFiltersForMetricsVariable';\nimport { MetricsVariable } from 'MetricsReducer/metrics-variables/MetricsVariable';\nimport { MetricsReducer } from 'MetricsReducer/MetricsReducer';\nimport { ConfigurePanelForm } from 'shared/GmdVizPanel/components/ConfigurePanelForm/ConfigurePanelForm';\nimport { EventApplyPanelConfig } from 'shared/GmdVizPanel/components/ConfigurePanelForm/EventApplyPanelConfig';\nimport { EventCancelConfigurePanel } from 'shared/GmdVizPanel/components/ConfigurePanelForm/EventCancelConfigurePanel';\nimport { EventConfigurePanel } from 'shared/GmdVizPanel/components/EventConfigurePanel';\nimport { GmdVizPanel } from 'shared/GmdVizPanel/GmdVizPanel';\nimport { getMetricType, getMetricTypeSync, type MetricType } from 'shared/GmdVizPanel/matchers/getMetricType';\n\nimport { PluginInfo } from './header/PluginInfo/PluginInfo';\nimport { SelectNewMetricButton } from './header/SelectNewMetricButton';\nimport { MetricDatasourceHelper } from './MetricDatasourceHelper/MetricDatasourceHelper';\nimport { MetricsDrilldownDataSourceVariable } from './MetricsDrilldownDataSourceVariable';\nimport { resetYAxisSync } from '../MetricScene/Breakdown/MetricLabelsList/behaviors/syncYAxis';\nimport { MetricScene } from '../MetricScene/MetricScene';\nimport { MetricSelectedEvent, trailDS, VAR_DATASOURCE, VAR_FILTERS } from '../shared/shared';\nimport { reportChangeInLabelFilters, reportExploreMetrics } from '../shared/tracking/interactions';\nimport { limitAdhocProviders } from '../shared/utils/utils';\nimport { getAppBackgroundColor } from '../shared/utils/utils.styles';\nimport { isAdHocFiltersVariable } from '../shared/utils/utils.variables';\n\nexport interface DataTrailState extends SceneObjectState {\n  topScene?: SceneObject;\n  embedded?: boolean;\n  controls: SceneObject[];\n  createdAt: number;\n\n  // wingman\n  dashboardMetrics?: Record<string, number>;\n  alertingMetrics?: Record<string, number>;\n\n  // just for the starting data source\n  initialDS?: string;\n  initialFilters?: AdHocVariableFilter[];\n\n  // Synced with url\n  metric?: string;\n\n  urlNamespace?: string; // optional namespace for url params, to avoid conflicts with other plugins in embedded mode\n\n  drawer: SceneDrawer;\n}\n\nexport class DataTrail extends SceneObjectBase<DataTrailState> implements SceneObjectWithUrlSync {\n  private disableReportFiltersInteraction = false;\n  private datasourceHelper = new MetricDatasourceHelper(this);\n\n  protected _variableDependency = new VariableDependencyConfig(this, {\n    variableNames: [VAR_DATASOURCE],\n    onReferencedVariableValueChanged: () => {\n      this.datasourceHelper.reset();\n    },\n  });\n\n  protected _urlSync = new SceneObjectUrlSyncConfig(this, {\n    keys: ['metric'],\n  });\n\n  getUrlState(): SceneObjectUrlValues {\n    return {\n      metric: this.state.metric,\n    };\n  }\n\n  updateFromUrl(values: SceneObjectUrlValues) {\n    this.updateStateForNewMetric((values.metric as string) || undefined);\n  }\n\n  public constructor(state: Partial<DataTrailState>) {\n    super({\n      $timeRange: state.$timeRange ?? new SceneTimeRange({}),\n      $variables: state.$variables ?? getVariableSet(state.initialDS, state.metric, state.initialFilters),\n      controls: state.controls ?? [\n        new VariableValueSelectors({ layout: 'vertical' }),\n        new SceneControlsSpacer(),\n        new SceneTimePicker({}),\n        new SceneRefreshPicker({}),\n      ],\n      createdAt: state.createdAt ?? new Date().getTime(),\n      dashboardMetrics: {},\n      alertingMetrics: {},\n      drawer: new SceneDrawer({}),\n      ...state,\n    });\n\n    this.addActivationHandler(this.onActivate.bind(this));\n  }\n\n  private onActivate() {\n    registerRuntimeDataSources([new LabelsDataSource()]);\n\n    // Delays init() to ensure proper initialization order and avoid race conditions.\n    // The variable dependency handler (onReferencedVariableValueChanged) calls reset()\n    // when landing, but we're uncertain whether it will always be called automatically\n    // in all scenarios. Using setTimeout ensures init() runs after variable changes\n    // are processed.\n    setTimeout(() => {\n      this.datasourceHelper.init();\n    }, 0);\n\n    this.updateStateForNewMetric(this.state.metric);\n    this.subscribeToEvent(MetricSelectedEvent, (event) => this.handleMetricSelectedEvent(event));\n\n    this.initFilters();\n    this.initConfigPrometheusFunction();\n  }\n\n  private updateStateForNewMetric(metric?: string) {\n    if (!this.state.topScene || metric !== this.state.metric) {\n      // Update controls based on whether a metric is selected\n      const baseControls = [new VariableValueSelectors({ layout: 'vertical' }), new SceneControlsSpacer()];\n\n      // Only add SelectNewMetricButton when a metric is selected\n      const controls = metric\n        ? [...baseControls, new SelectNewMetricButton(), new SceneTimePicker({}), new SceneRefreshPicker({})]\n        : [...baseControls, new SceneTimePicker({}), new SceneRefreshPicker({})];\n\n      this.setState({\n        metric,\n        topScene: metric ? new MetricScene({ metric }) : new MetricsReducer(),\n        controls,\n      });\n    }\n  }\n\n  private initFilters() {\n    const filtersVariable = sceneGraph.lookupVariable(VAR_FILTERS, this);\n    if (!isAdHocFiltersVariable(filtersVariable)) {\n      return;\n    }\n\n    limitAdhocProviders(this, filtersVariable, this.datasourceHelper);\n\n    // we ensure that, in the MetricsReducer, the Ad Hoc filters will display all the label names and values and\n    // we ensure that, in the MetricScene, the queries in the Scene graph will be considered and used as a filter\n    // to fetch label names and values\n    filtersVariable?.setState({\n      useQueriesAsFilterForOptions: Boolean(this.state.metric),\n    });\n\n    this.subscribeToState((newState, prevState) => {\n      if (newState.metric !== prevState.metric) {\n        const filtersVariable = sceneGraph.lookupVariable(VAR_FILTERS, this);\n\n        if (isAdHocFiltersVariable(filtersVariable)) {\n          filtersVariable.setState({\n            useQueriesAsFilterForOptions: Boolean(newState.metric),\n          });\n        }\n      }\n    });\n\n    this._subs.add(\n      filtersVariable?.subscribeToState((newState, prevState) => {\n        if (!this.disableReportFiltersInteraction && newState.filters !== prevState.filters) {\n          reportChangeInLabelFilters(newState.filters, prevState.filters);\n        }\n      })\n    );\n  }\n\n  private initConfigPrometheusFunction() {\n    this.subscribeToState((newState, prevState) => {\n      if (newState.metric !== prevState.metric) {\n        // ensures that the drawer is closed when using browser nav buttons\n        this.state.drawer.close();\n      }\n    });\n\n    this.subscribeToEvent(EventConfigurePanel, async (event) => {\n      const { metric } = event.payload;\n\n      getMetricType(metric, this)\n        .catch(() => getMetricTypeSync(metric) as MetricType)\n        .then((metricType) => {\n          reportExploreMetrics('configure_panel_opened', { metricType });\n        });\n\n      const metricType = await getMetricType(metric, this);\n\n      this.state.drawer.open({\n        title: 'Configure the Prometheus function',\n        subTitle: `${metric} (${metricType})`,\n        body: new ConfigurePanelForm({ metric }),\n      });\n    });\n\n    this.subscribeToEvent(EventCancelConfigurePanel, () => {\n      this.state.drawer.close();\n    });\n\n    this.subscribeToEvent(EventApplyPanelConfig, async (event) => {\n      const { metric, config, restoreDefault } = event.payload;\n\n      getMetricType(metric, this)\n        .catch(() => getMetricTypeSync(metric) as MetricType)\n        .then((metricType) => {\n          if (restoreDefault) {\n            reportExploreMetrics('default_panel_config_restored', { metricType });\n          } else {\n            reportExploreMetrics('panel_config_applied', { metricType, configId: config.id });\n          }\n        });\n\n      this.state.drawer.close();\n\n      // because the Prometheus function used to display the metric is going to be updated, the range of\n      // values for syncing the axis will certainly change (e.g. switching from sum to avg)\n      // so we reset it before updating all the panels\n      resetYAxisSync(this.state.topScene || this);\n\n      const panelsToUpdate = sceneGraph.findAllObjects(\n        this.state.topScene || this,\n        (o) => o instanceof GmdVizPanel && o.state.metric === metric && !o.state.queryConfig.groupBy\n      ) as GmdVizPanel[];\n\n      for (const panel of panelsToUpdate) {\n        panel.update(config.panelOptions, config.queryOptions);\n      }\n\n      displaySuccess([`Configuration successfully ${restoreDefault ? 'restored' : 'applied'} for metric ${metric}!`]);\n    });\n  }\n\n  private async handleMetricSelectedEvent(event: MetricSelectedEvent) {\n    const { metric, urlValues } = event.payload;\n\n    if (metric) {\n      addRecentMetric(metric);\n    }\n\n    // Add metric to adhoc filters baseFilter\n    const filterVar = sceneGraph.lookupVariable(VAR_FILTERS, this);\n    if (isAdHocFiltersVariable(filterVar)) {\n      filterVar.setState({\n        baseFilters: getBaseFiltersForMetric(metric),\n      });\n    }\n\n    this._urlSync.performBrowserHistoryAction(() => {\n      this.updateStateForNewMetric(metric);\n\n      if (urlValues) {\n        // make sure we reset the filters when navigating from a bookmark where urlsValues['var_vilters']: []\n        // it seems relevant to do it here and not anywhere else in the code base\n        if (!urlValues[`var-${VAR_FILTERS}`]?.length) {\n          urlValues[`var-${VAR_FILTERS}`] = [''];\n        }\n\n        const urlState = urlUtil.renderUrl('', urlValues);\n        sceneUtils.syncStateFromSearchParams(this, new URLSearchParams(urlState));\n      }\n    });\n  }\n\n  /**\n   * Assuming that the change in filter was already reported with a cause other than `'adhoc_filter'`,\n   * this will modify the adhoc filter variable and prevent the automatic reporting which would\n   * normally occur through the call to `reportChangeInLabelFilters`.\n   *\n   * See AddToFiltersGraphAction.tsx\n   */\n  public addFilterWithoutReportingInteraction(filter: AdHocVariableFilter) {\n    const variable = sceneGraph.lookupVariable(VAR_FILTERS, this);\n    if (!isAdHocFiltersVariable(variable)) {\n      return;\n    }\n\n    this.disableReportFiltersInteraction = true;\n    variable.setState({ filters: [...variable.state.filters, filter] });\n    this.disableReportFiltersInteraction = false;\n  }\n\n  public async getMetadataForMetric(metric: string) {\n    return this.datasourceHelper.getMetadataForMetric(metric);\n  }\n\n  public async isNativeHistogram(metric: string) {\n    return this.datasourceHelper.isNativeHistogram(metric);\n  }\n\n  getPrometheusBuildInfo = async () => {\n    return this.datasourceHelper.getPrometheusBuildInfo();\n  };\n\n  static readonly Component = ({ model }: SceneComponentProps<DataTrail>) => {\n    const { controls, topScene, embedded, drawer } = model.useState();\n\n    const chromeHeaderHeight = useChromeHeaderHeight() ?? 0;\n    const headerHeight = embedded ? 0 : chromeHeaderHeight;\n    const styles = useStyles2(getStyles, headerHeight, model);\n\n    // Set CSS custom property for app-controls height in embedded mode\n    useEffect(() => {\n      // Update on mount and when controls change\n      updateAppControlsHeight();\n\n      // Use ResizeObserver to watch for height changes\n      const appControls = document.querySelector('[data-testid=\"app-controls\"]');\n\n      if (!appControls) {\n        return;\n      }\n\n      const resizeObserver = new ResizeObserver(updateAppControlsHeight);\n      resizeObserver.observe(appControls);\n\n      return () => {\n        // Clean up\n        resizeObserver.disconnect();\n        document.documentElement.style.removeProperty('--app-controls-height');\n      };\n    }, [embedded, controls]);\n\n    return (\n      <>\n        <div className={styles.container}>\n          {controls && (\n            <div className={styles.controls} data-testid=\"app-controls\">\n              <GiveFeedbackButton />\n              {controls.map((control) => (\n                <control.Component key={control.state.key} model={control} />\n              ))}\n              <div className={styles.settingsInfo}>\n                <PluginInfo getPrometheusBuildInfo={model.getPrometheusBuildInfo} />\n              </div>\n            </div>\n          )}\n          {topScene && (\n            <UrlSyncContextProvider\n              scene={topScene}\n              createBrowserHistorySteps={true}\n              updateUrlOnInit={true}\n              namespace={model.state.urlNamespace}\n            >\n              <div className={styles.body}>{topScene && <topScene.Component model={topScene} />}</div>\n            </UrlSyncContextProvider>\n          )}\n        </div>\n        <drawer.Component model={drawer} />\n      </>\n    );\n  };\n}\n\nfunction getVariableSet(initialDS?: string, metric?: string, initialFilters?: AdHocVariableFilter[]) {\n  let variables: SceneVariable[] = [\n    new MetricsDrilldownDataSourceVariable({ initialDS }),\n    new MetricsVariable(),\n    new AdHocFiltersForMetricsVariable(),\n    new AdHocFiltersVariable({\n      key: VAR_FILTERS,\n      name: VAR_FILTERS,\n      label: 'Filters',\n      addFilterButtonText: 'Add label',\n      datasource: trailDS,\n      hide: VariableHide.dontHide,\n      layout: 'combobox',\n      filters: initialFilters ?? [],\n      baseFilters: getBaseFiltersForMetric(metric),\n      applyMode: 'manual',\n      allowCustomValue: true,\n      useQueriesAsFilterForOptions: false,\n      expressionBuilder: (filters: AdHocVariableFilter[]) => {\n        return (\n          filters\n            // remove any filters that include __name__ key in the expression\n            // to prevent the metric name from being set twice in the panel queries and causing an error\n            .filter((filter) => filter.key !== '__name__')\n            .map((filter) => `${utf8Support(filter.key)}${filter.operator}\"${filter.value}\"`)\n            .join(',')\n        );\n      },\n    }),\n    new LabelsVariable(),\n  ];\n\n  if (isScopesSupported()) {\n    variables.unshift(new ScopesVariable({ enable: true }));\n  }\n\n  return new SceneVariableSet({\n    variables,\n  });\n}\n\nfunction getStyles(theme: GrafanaTheme2, headerHeight: number, trail: DataTrail) {\n  const background = getAppBackgroundColor(theme, trail);\n\n  return {\n    container: css({\n      flexGrow: 1,\n      display: 'flex',\n      gap: theme.spacing(1),\n      flexDirection: 'column',\n      padding: theme.spacing(1, 2),\n      position: 'relative',\n      background,\n    }),\n    body: css({\n      flexGrow: 1,\n      display: 'flex',\n      flexDirection: 'column',\n      minHeight: 0, // Allow body to shrink below its content size\n    }),\n    controls: css({\n      display: 'flex',\n      gap: theme.spacing(1),\n      padding: theme.spacing(1, 0),\n      alignItems: 'flex-end',\n      flexWrap: 'wrap',\n      position: 'sticky',\n      background,\n      zIndex: theme.zIndex.navbarFixed,\n      top: headerHeight,\n      borderBottom: `1px solid ${theme.colors.border.weak}`,\n    }),\n    settingsInfo: css({\n      display: 'flex',\n      gap: theme.spacing(0.5),\n    }),\n  };\n}\n\nfunction getBaseFiltersForMetric(metric?: string): AdHocVariableFilter[] {\n  if (metric) {\n    return [{ key: '__name__', operator: '=', value: metric }];\n  }\n  return [];\n}\n\nfunction updateAppControlsHeight() {\n  const appControls = document.querySelector('[data-testid=\"app-controls\"]');\n\n  if (!appControls) {\n    return;\n  }\n\n  const { height } = appControls.getBoundingClientRect();\n  document.documentElement.style.setProperty('--app-controls-height', `${height}px`);\n}\n\nfunction isScopesSupported(): boolean {\n  return Boolean(\n    config.featureToggles.scopeFilters &&\n      config.featureToggles.enableScopesInMetricsExplore &&\n      // Scopes support in Grafana appears to begin with Grafana 12.0.0. We can remove\n      // the version check once the `dependencies.grafanaDependency` is updated to 12.0.0 or higher.\n      !config.buildInfo.version.startsWith('11.')\n  );\n}\n","import { registerRuntimeDataSource, type RuntimeDataSource } from '@grafana/scenes';\n\nimport { displayError } from './displayStatus';\n\nexport function registerRuntimeDataSources(dataSources: RuntimeDataSource[]) {\n  try {\n    for (const dataSource of dataSources) {\n      registerRuntimeDataSource({ dataSource });\n    }\n  } catch (error) {\n    const { message } = error as Error;\n\n    if (!/A runtime data source with uid (.+) has already been registered/.test(message)) {\n      displayError(error as Error, [\n        'Fail to register all the runtime data sources!',\n        'The application cannot work as expected, please try reloading the page or if the problem persists, contact your organization admin.',\n      ]);\n    }\n  }\n}\n","import { type Scope } from '@grafana/data';\nimport { SceneObjectBase, type SceneObjectState } from '@grafana/scenes';\n\nfunction getSelectedScopes(): Scope[] {\n  return [];\n}\n\nexport function getClosestScopesFacade(): ScopesFacade {\n  return new ScopesFacade();\n}\n\ninterface SelectedScope {\n  scope: Scope;\n  path: string[];\n}\n\ninterface ScopesFacadeState extends SceneObjectState {\n  // A callback that will be executed when new scopes are set\n  handler?: (facade: ScopesFacade) => void;\n  // The render count is a workaround to force the URL sync manager to update the URL with the latest scopes\n  // Basically it starts at 0, and it is increased with every scopes value update\n  renderCount?: number;\n}\n\nexport class ScopesFacade extends SceneObjectBase<ScopesFacadeState> {\n  private selectedScopes: SelectedScope[] = [];\n  private onScopesChangeCallbacks: Array<(scopes: SelectedScope[]) => void> = [];\n\n  constructor() {\n    super({});\n  }\n\n  public getSelectedScopes(): SelectedScope[] {\n    return this.selectedScopes;\n  }\n\n  public getSelectedScopesNames(): string[] {\n    return this.selectedScopes.map(({ scope }) => scope.metadata.name);\n  }\n\n  public setSelectedScopes(scopes: SelectedScope[]) {\n    this.selectedScopes = scopes;\n    this.notifySubscribers();\n  }\n\n  public onScopesChange(callback: (scopes: SelectedScope[]) => void) {\n    this.onScopesChangeCallbacks.push(callback);\n    return () => {\n      this.onScopesChangeCallbacks = this.onScopesChangeCallbacks.filter((cb) => cb !== callback);\n    };\n  }\n\n  private notifySubscribers() {\n    for (const callback of this.onScopesChangeCallbacks) {\n      callback(this.selectedScopes);\n    }\n  }\n\n  public get value() {\n    return getSelectedScopes();\n  }\n}\n","import { urlUtil, type AdHocVariableFilter, type GetTagResponse, type MetricFindValue } from '@grafana/data';\nimport { type PromQuery } from '@grafana/prometheus';\nimport { config } from '@grafana/runtime';\nimport {\n  sceneGraph,\n  SceneTimeRange,\n  sceneUtils,\n  type AdHocFiltersVariable,\n  type SceneObject,\n  type SceneQueryRunner,\n  type SceneVariable,\n  type SceneVariableState,\n} from '@grafana/scenes';\n\nimport { DataTrail, type DataTrailState } from 'AppDataTrail/DataTrail';\nimport { logger } from 'shared/logger/logger';\nimport { isSceneQueryRunner } from 'shared/utils/utils.queries';\n\nimport { ROUTES } from '../constants/routes';\nimport { LOGS_METRIC } from '../shared';\nimport { getClosestScopesFacade } from './utils.scopes';\nimport { isAdHocFiltersVariable } from './utils.variables';\nimport { type MetricDatasourceHelper } from '../../AppDataTrail/MetricDatasourceHelper/MetricDatasourceHelper';\n\nexport function getTrailFor(model: SceneObject): DataTrail {\n  return sceneGraph.getAncestor(model, DataTrail);\n}\n\nexport function newMetricsTrail(state?: Partial<DataTrailState>): DataTrail {\n  return new DataTrail({\n    initialDS: state?.initialDS,\n    $timeRange: state?.$timeRange ?? new SceneTimeRange({ from: 'now-1h', to: 'now' }),\n    embedded: state?.embedded ?? false,\n    urlNamespace: state?.embedded ? 'gmd' : undefined,\n    ...state,\n  });\n}\n\nexport function getUrlForTrail(trail: DataTrail) {\n  const params = sceneUtils.getUrlState(trail);\n  return urlUtil.renderUrl(ROUTES.Drilldown, params);\n}\n\nexport function getMetricName(metric?: string) {\n  if (!metric) {\n    return 'All metrics';\n  }\n\n  if (metric === LOGS_METRIC) {\n    return 'Logs';\n  }\n\n  return metric;\n}\n\nexport function getColorByIndex(index: number) {\n  const visTheme = config.theme2.visualization;\n  return visTheme.getColorByName(visTheme.palette[index % 8]);\n}\n\nfunction getQueries(sceneObject: SceneObject): PromQuery[] {\n  const allQueryRunners = sceneGraph.findAllObjects(sceneObject, isSceneQueryRunner) as SceneQueryRunner[];\n  return allQueryRunners.flatMap((sqr) =>\n    sqr.state.queries.map((q) => ({ ...q, expr: sceneGraph.interpolate(sqr, q.expr) }))\n  );\n}\n\n// frontend hardening limit\nconst MAX_ADHOC_VARIABLE_OPTIONS = 10000;\n\n/**\n * Add custom providers for the adhoc filters variable that limit the responses for labels keys and label values.\n * Currently hard coded to 10000.\n *\n * The current provider functions for adhoc filter variables are the functions getTagKeys and getTagValues in the data source.\n * This function still uses these functions from inside the data source helper.\n *\n * @param dataTrail\n * @param limitedFilterVariable this is the filters variable\n * @param datasourceHelper\n */\nexport function limitAdhocProviders(\n  dataTrail: DataTrail,\n  limitedFilterVariable: SceneVariable<SceneVariableState> | null,\n  datasourceHelper: MetricDatasourceHelper\n) {\n  if (!isAdHocFiltersVariable(limitedFilterVariable)) {\n    return;\n  }\n\n  limitedFilterVariable.setState({\n    getTagKeysProvider: async (): Promise<{\n      replace?: boolean;\n      values: GetTagResponse | MetricFindValue[];\n    }> => {\n      // For the Prometheus label names endpoint, '/api/v1/labels'\n      // get the previously selected filters from the variable\n      // to use in the query to filter the response\n      // using filters, e.g. {previously_selected_label:\"value\"},\n      // as the series match[] parameter in Prometheus labels endpoint\n      const filters = limitedFilterVariable.state.filters;\n      // call getTagKeys and truncate the response\n      // we're passing the queries so we get the labels that adhere to the queries\n      // we're also passing the scopes so we get the labels that adhere to the scopes filters\n\n      const opts = {\n        filters,\n        scopes: getClosestScopesFacade()?.value,\n        queries: limitedFilterVariable.state.useQueriesAsFilterForOptions ? getQueries(dataTrail) : [],\n      };\n\n      // if there are too many queries it takes to much time to process the requests.\n      // In this case we favour responsiveness over reducing the number of options.\n      if (opts.queries.length > 20) {\n        opts.queries = [];\n      }\n\n      let values = (await datasourceHelper.getTagKeys(opts)).slice(0, MAX_ADHOC_VARIABLE_OPTIONS);\n\n      // use replace: true to override the default lookup in adhoc filter variable\n      return { replace: true, values };\n    },\n    getTagValuesProvider: async (\n      _: AdHocFiltersVariable,\n      filter: AdHocVariableFilter\n    ): Promise<{\n      replace?: boolean;\n      values: GetTagResponse | MetricFindValue[];\n    }> => {\n      // For the Prometheus label values endpoint, /api/v1/label/${interpolatedName}/values\n      // get the previously selected filters from the variable\n      // to use in the query to filter the response\n      // using filters, e.g. {previously_selected_label:\"value\"},\n      // as the series match[] parameter in Prometheus label values endpoint\n      const filtersValues = limitedFilterVariable.state.filters;\n      // remove current selected filter if updating a chosen filter\n      const filters = filtersValues.filter((f) => f.key !== filter.key);\n      // call getTagValues and truncate the response\n      // we're passing the queries so we get the label values that adhere to the queries\n      // we're also passing the scopes so we get the label values that adhere to the scopes filters\n\n      const opts = {\n        key: filter.key,\n        filters,\n        scopes: getClosestScopesFacade()?.value,\n        queries: limitedFilterVariable.state.useQueriesAsFilterForOptions ? getQueries(dataTrail) : [],\n      };\n\n      // if there are too many queries it takes to much time to process the requests.\n      // In this case we favour responsiveness over reducing the number of options.\n      if (opts.queries.length > 20) {\n        opts.queries = [];\n      }\n\n      const values = (await datasourceHelper.getTagValues(opts)).slice(0, MAX_ADHOC_VARIABLE_OPTIONS);\n      // use replace: true to override the default lookup in adhoc filter variable\n      return { replace: true, values };\n    },\n  });\n}\n\ninterface SceneType<T> extends Function {\n  new (...args: never[]): T;\n}\n\nexport function findObjectOfType<T extends SceneObject>(\n  scene: SceneObject,\n  check: (obj: SceneObject) => boolean,\n  returnType: SceneType<T>\n) {\n  const obj = sceneGraph.findObject(scene, check);\n  if (obj instanceof returnType) {\n    return obj;\n  } else if (obj !== null) {\n    logger.warn(`invalid return type: ${returnType.toString()}`);\n  }\n\n  return null;\n}\n\nexport function noOp() {}\n"],"names":["PREF_KEYS","DATASOURCE","RECENT_METRICS","BOOKMARKS","METRIC_PREFS","BREAKDOWN_SORTBY","SIDEBAR_SECTION","ensureErrorObject","error","defaultMessage","Error","message","e","prop","Object","getOwnPropertyNames","useCatchExceptions","setError","useState","useEffect","onError","errorEvent","filename","URL","protocol","endsWith","logger","lineno","toString","colno","shouldTreatAsApplicationError","onUnHandledRejection","event","reason","type","undefined","window","addEventListener","removeEventListener","getLabelValueFromDataFrame","frame","labels","fields","keys","length","sortAlphabetical","series","direction","compareFn","a","b","localeCompare","sort","labelA","labelB","sortByFieldReducer","sortBy","fieldReducer","fieldReducers","get","seriesCalcs","map","dataFrame","field","value","reduce","doStandardCalcs","getOutliers","joined","outerJoinDataFrames","frames","points","filter","f","FieldType","number","Float64Array","values","OutlierDetector","dbscan","sensitivity","detect","calculateOutlierValue","outliers","index","seriesResults","isOutlier","outlierIntervals","sortSeries","memoize","origSeries","wasmSupported","sortByOutliers","msg","displayWarning","ReducerID","stdDev","firstTimestamp","seriesIsNotEmpty","lastTimestamp","support","WebAssembly","reportExploreMetrics","displayError","msgs","context","acc","i","handheldBy","getAppEvents","publish","AppEvents","alertError","name","payload","warn","alertWarning","displaySuccess","alertSuccess","ErrorView","styles","useStyles2","getStyles","navigate","useNavigate","pathname","search","useLocation","onClickReload","useCallback","searchParams","URLSearchParams","newSearchParams","key","has","forEach","set","location","reload","isCollapseOpen","setIsCollapseOpen","div","className","container","InlineBanner","severity","title","errorContext","p","TextLink","href","onClick","Collapse","callStack","collapsible","label","isOpen","onToggle","pre","code","stack","theme","css","margin","spacing","backgroundColor","border","paddingLeft","outline","boxShadow","marginLeft","marginRight","display","HGFeatureToggles","sidebarOpenByDefault","isFeatureToggleEnabled","featureToggle","featureToggles","userStorage","migrate","hasMigrations","migrations","legacyKey","newKey","existingItem","localStorage","getItem","JSON","parse","this","setItem","removeItem","buildStorageKey","service","storageKey","item","stringify","clear","constructor","pluginJson","INTERACTION_NAME_PREFIX","getFaro","reportInteraction","meta","appRelease","config","apps","PLUGIN_ID","version","appVersion","GIT_COMMIT","includes","api","pushEvent","fromEntries","entries","String","defaultOpenSidebar","reportLabelFilterChange","action","cause","reportChangeInLabelFilters","newFilters","oldFilters","oldFilter","newFilter","detectChangedFilters","some","detectRemovedFilters","detectAddedFilters","Intl","Collator","compare","children","errorObject","bannerTitle","Alert","infos","statusText","push","status","join","formatErrorMessage","br","defaultTrail","newMetricsTrail","AppContext","createContext","trail","useMetricsAppContext","useContext","Trail","lazy","TrailRedirect","Navigate","to","ROUTES","Drilldown","replace","AppRoutes","Routes","Route","path","element","trackUsage","GiveFeedbackButton","wrapper","feedback","target","rel","Icon","position","top","right","color","colors","text","secondary","fontSize","typography","bodySmall","link","SceneDrawer","SceneObjectBase","state","super","open","subTitle","body","setState","close","Component","model","Drawer","size","subtitle","closeOnMaskClick","onClose","areArraysEqual","array1","array2","isEqual","VAR_FILTERS","VAR_GROUP_BY","VAR_DATASOURCE","VAR_DATASOURCE_EXPR","VAR_LOGS_DATASOURCE","VAR_OTHER_METRIC_FILTERS","LOGS_METRIC","trailDS","uid","MetricSelectedEvent","BusEventWithPayload","RefreshMetricsEvent","BusEventBase","VAR_METRICS_VAR_FILTERS","AdHocFiltersForMetricsVariable","AdHocFiltersVariable","hide","VariableHide","hideVariable","allowCustomValue","applyMode","expressionBuilder","filters","utf8Support","operator","skipUrlSync","addActivationHandler","filtersVariable","sceneGraph","findByKeyAndType","update","newState","baseFilters","sub","subscribeToState","prevState","unsubscribe","EventMetricsVariableActivated","EventMetricsVariableDeactivated","EventMetricsVariableLoaded","withLifecycleEvents","variable","TypeError","publishEvent","loading","options","VAR_METRICS_VARIABLE","MetricsVariable","QueryVariable","labelMatcher","addLifeCycleEvents","datasource","query","includeAll","refresh","VariableRefresh","onTimeRangeChanged","VariableSort","alphabeticalAsc","isClassicHistogramMetric","metric","languageProviderVersionIs","ds","languageProvider","fetchLabelValues","queryLabelKeys","MetricDatasourceHelper","getRuntimeDatasource","getDataSourceSrv","__sceneObject","isPrometheusDataSource","init","initialized","reset","subs","metricsVariable","onNewMetrics","cache","metadata","Map","classicHistograms","Set","fetchMetricsMetadata","catch","metricsVariableOptions","metricData","add","getMetadataForMetric","response","request","queryMetadata","queryMetricsMetadata","Promise","resolve","metricsMetadata","getQueryMetricsMetadata","loadMetadata","retrieveMetricsMetadata","loadMetricsMetadata","then","getLoadMetricsMetadata","metricMetadata","getTagKeys","test","isWrappedInQuotes","slice","unwrapQuotes","getTagValues","fetchLabels","params","timeRange","matcher","fetchLabelsWithMatch","labelName","queryLabelValues","fetchSeriesValuesWithMatch","getPrometheusDataSourceForScene","sceneObject","dsVariable","findByKey","getPrometheusBuildInfo","application","repository","buildDate","getMetricDescription","help","unit","isAdHocFiltersVariable","isCustomVariable","isQueryVariable","NULL_GROUP_BY_VALUE","LabelsDataSource","RuntimeDataSource","LoadingState","Done","data","other","metricFindQuery","scopedVars","valueOf","match","labelOptions","getLabelsMatchAPISupport","getFiltersFromVariable","processLabelOptions","getTimeRange","hasLabelsMatchAPISupport","lookupVariable","startsWith","testDatasource","VAR_WINGMAN_GROUP_BY","LabelsVariable","onActivate","staticOptions","refreshOptions","o","_subs","DataSourceVariable","filterExpression","updateQuery","interpolate","placeholder","isMulti","bind","Label","background","primary","shape","radius","default","weak","EventSortByChanged","usageRequestOptions","showSuccessAlert","showErrorAlert","fetchAlertingMetrics","alertingRules","getBackendSrv","metricCounts","relevantRules","rule","queryPromises","expr","datasourceUid","metrics","extractMetricNames","all","parseAlertingRules","counts","result","usageType","count","transformCountsToAlertingUsage","err","dashboardRequestMap","getDashboardLimited","limitFunction","dashboardUid","url","dashboardRequestsFailedCount","promise","dashboard","finally","delete","concurrency","fetchDashboardMetrics","dashboards","limit","dashboardSearchResponse","dashboardData","panels","getDashboardsWithPanels","panel","getPanelsWithTargets","processTargetsForMetrics","targets","dashboardName","dashboardUrl","updateMetricUsage","MetricUsageFetcher","getUsageMetrics","_usageState","metricsPromise","fetcher","getUsageForMetric","metricName","getUsageDetailsForMetric","getRecentMetrics","recentMetrics","thirtyDaysAgo","Date","now","RECENT_METRICS_EXPIRY_DAYS","validMetrics","timestamp","sortByOptions","VAR_WINGMAN_SORT_BY","MetricsSorter","activationHandler","sortByVar","getVariables","getByName","supportedSortByOptions","getValue","changeValueTo","usageFetcher","metricsToCounts","$variables","SceneVariableSet","variables","CustomVariable","option","description","inputControls","VariableValueSelectors","layout","sortMetricsWithRecentFirst","allRecentMetrics","m","allRecentMetricsSet","recent","nonRecent","sortedNonRecent","sortMetricsAlphabetically","data-testid","LayoutType","LayoutSwitcher","getUrlState","urlSearchParamName","updateFromUrl","stateUpdate","newLayout","find","DEFAULT_LAYOUT","DEFAULT_OPTIONS","_urlSync","SceneObjectUrlSyncConfig","onChange","RadioButtonGroup","aria-label","fullWidth","VAR_FILTERED_METRICS_VARIABLE","FilteredMetricsVariable","CountsProvider","useCounts","current","total","MetricVariableCountsProvider","nonFilteredVariable","filteredVariable","setInitCounts","initCounts","EventQuickSearchChanged","QuickSearch","newValue","toggleCountsDisplay","displayCounts","updateValue","notifyValueChange","useHumanFriendlyCountsMessage","targetName","countsProvider","tagName","tooltipContent","Boolean","_variableDependency","VariableDependencyConfig","variableNames","onReferencedVariableValueChanged","debounce","searchText","currentTarget","onKeyDown","preventDefault","Input","prefix","suffix","Tooltip","content","placement","Tag","colorIndex","IconButton","variant","tooltip","disabled","ListControls","EmbeddedScene","SceneFlexLayout","width","maxHeight","SceneFlexItem","headerWrapper","alignItems","MetricsVariableFilterEngine","setInitOptions","initOptions","cloneDeep","getFilteredOptions","filteredOptions","categories","applyCategoryFilters","prefixes","applyPrefixFilters","suffixes","applySuffixFilters","names","applyNameFilters","applyFilters","settings","forceUpdate","notify","updatedFilters","notifyUpdate","category","categoryRegex","buildRegex","concat","pattern","split","prefixesRegex","s","suffixesRegex","namePatterns","regexes","trim","r","RegExp","regex","flags","SceneVariableValueChangedEvent","metricToTargetLevenDistances","getLevenDistances","targetMetric","targetToDistances","distances","metricSplit","metricHalf","halfLeven","leven","wholeLeven","MetricsVariableSortEngine","lastMetrics","sortedMetrics","sortByUsage","metricList","aValue","bValue","metricsSorter","usageMetrics","scoreA","scoreB","sortMetricsByCount","SceneByVariableRepeater","performRepeat","hasDependencyInLoadingState","loadingLayout","getLayoutLoading","errorLayout","emptyLayout","currentBatchSize","variableName","MultiValueVariable","getLayoutError","getMultiVariableValues","getLayoutEmpty","initialPageSize","newChildren","getLayoutChild","increaseBatchSize","newBatchSize","pageSizeIncrement","useSizes","remaining","increment","onVariableUpdateCompleted","hasAllValue","Array","isArray","v","ShowMoreButton","batchSizes","Button","fill","tooltipPlacement","UsageData","usageCount","singularUsageType","pluralUsageType","icon","dashboardItems","usageContainer","Dropdown","overlay","Menu","style","maxWidth","overflowY","Item","id","menuItem","component","menuItemContent","cx","usageItem","clickableUsageItem","span","flexDirection","justifyContent","gap","padding","borderTopWidth","opacity","textDecoration","overflow","textOverflow","whiteSpace","VIZ_PANEL_HEIGHT","VIZ_PANEL_HEIGHT_WITH_USAGE_DATA_PREVIEW","WithUsageDataPreviewPanel","_onActivate","metricsReducer","getAncestor","MetricsReducer","enginesMap","updateSortBy","updateLayout","usage","dashboardInfo","gridLayout","SceneCSSGridLayout","currentGridLayoutHeight","autoRows","expectedPanelHeight","GroupsIcon","svg","stroke","height","viewBox","circle","cy","strokeWidth","d","vizPanelInGridItem","log","EventConfigurePanel","ConfigurePanelAction","userPrefs","isAlreadyConfigured","selectButton","active","maxContrast","SelectAction","EventPanelTypeChanged","CONFIG_PRESETS","TIMESERIES_AVG","TIMESERIES_SUM","TIMESERIES_STDDEV","TIMESERIES_PERCENTILES","TIMESERIES_MIN_MAX","TIMESERIES_AGE_TIME_MINUS_AVG","TIMESERIES_AGE_TIME_MINUS_MIN_MAX","HISTOGRAM_HEATMAP","HISTOGRAM_PERCENTILES","STATUS_UPDOWN_HISTORY","STATUS_UPDOWN_STAT","PROMQL_FUNCTIONS","fn","args","parameter","availableConfigPresetIds","availablePanelTypes","getPreferredConfigForMetric","metricConfig","every","panelOptions","queryOptions","queries","q","percentiles","isValid","PANEL_HEIGHT","QUERY_RESOLUTION","STATUS_UPDOWN_METRIC_REGEX","isStatusUpDownMetric","getPanelTypeForMetricSync","histogramType","DEFAULT_UNIT","UNIT_BYTES","UNIT_SECONDS","UNIT_PERCENT","UNIT_COUNT","UNIT_MAP","UNIT_LIST","RATE_UNIT_MAP","getUnitFromMetric","metricParts","toLowerCase","Math","max","part","getUnit","metricPart","getPerSecondRateUnit","buildQueryExpression","labelMatchers","addIgnoreUsageFilter","addExtremeValuesFiltering","defaultSelectors","MatchingOperator","equal","isValidLegacyName","expressionString","expression","replaceAll","expressionToString","Expression","defaultOperator","promql","and","left","getHeatmapQueryRunnerParams","queryConfig","sum","rate","by","maxDataPoints","resolution","HIGH","refId","format","fromExploreMetrics","COUNTER_METRIC_REGEX","isCounterMetric","DEFAULT_PERCENTILES","getPercentilesQueryRunnerParams","isCounterMetricFn","isRateQuery","queryDefs","newExpr","entry","fnName","percentile","legendFormat","buildNonHistogramQueries","isNativeHistogram","buildHistogramQueries","getStatQueryRunnerParams","interval","buildQueriesWithPresetFunctions","defaultPromqlFn","UP_DOWN_VALUE_MAPPINGS","MappingType","ValueToText","getStatushistoryQueryRunnerParams","min","getTimeseriesQueryRunnerParams","isRateQueryOverride","groupBy","buildGroupByQueries","avg","isDataFrameAllNaN","valuesField","entities","NaN","extremeValueFilterBehavior","pluginId","queryRunner","findDescendents","SceneQueryRunner","GmdVizPanel","queryRunnerSub","dataFrameType","queryParams","runQueries","titleItems","VizPanelExtremeValuesMessage","level","extremeValuedisclaimer","warningMessage","aria-hidden","warning","main","info","getIsCounterFromMetadata","dataTrail","computeIsCounterFromMetadata","isSceneQueryRunner","input","addRefId","source","pipe","addUnspecifiedLabel","sliceSeries","start","end","stats","unshift","displayName","buildTimeseriesPanel","panelConfig","$data","SceneDataTransformer","transformations","MAX_SERIES_TO_RENDER_WHEN_GROUPED_BY","startColorIndex","fixedColorIndex","vizPanel","PanelBuilders","timeseries","setTitle","setDescription","setHeaderActions","headerActions","setMenu","menu","setShowMenuAlways","setData","setUnit","setOption","legend","showLegend","mode","TooltipDisplayMode","Multi","SortOrder","Descending","setOverrides","matchFieldsByQuery","overrideColor","fixedColor","getColorByIndex","setBehaviors","behaviors","build","buildGroupByPanel","vizPanelBuilder","setCustomFieldConfig","setColor","getTrailFor","isCounter","corrected","provider","PANEL_TYPE_TO_BUILDERS_LOOKUP","buildVizPanel","getQueryRunnerParams","heatmap","HeatmapColorMode","Scheme","exponent","scheme","steps","reverse","statushistory","VisibilityMode","Never","setMappings","stat","getBuildersForPanelType","panelType","buildersForPanelType","panelBuilder","discardPanelTypeUpdates","subscribeToStateChanges","subscribeToEvents","bodySub","DataFrameType","HeatmapCells","subscribeToEvent","discardUserPrefs","prefConfig","M","MEDIUM","GRID_TEMPLATE_COLUMNS","GRID_TEMPLATE_ROWS","MetricsList","subscribeToLayoutChange","layoutSwitcher","onChangeState","templateColumns","ROWS","isLazy","$behaviors","sync","DashboardCursorSync","Crosshair","SceneReactObject","reactNode","Spinner","inline","SceneCSSGridItem","footer","marginTop","borderRadius","shouldDisplayShowMoreButton","MetricsGroupByRow","labelValue","labelCardinality","canvas","containerHeader","marginBottom","paddingBottom","borderBottom","medium","headerButtons","zIndex","collapsableSectionBody","groupName","lineHeight","isCollapsed","setIsCollapsed","adHocFiltersVariable","CollapsableSection","VAR_LABEL_VALUES","LabelValuesVariable","MetricsGroupByList","rowGap","EventFiltersChanged","RULE_GROUP_LABELS","EventSectionValueChanged","SectionTitle","h6","infoIcon","fontWeight","fontWeightLight","cursor","CheckboxWithCount","checked","checkboxWrapper","Checkbox","CheckBoxList","groups","selectedGroups","onSelectionChange","checkboxListHeader","noResults","ul","checkboxList","group","li","checkboxItem","g","newGroups","shade","fontStyle","MetricsFilterSection","filteredMetricsVariable","updateLists","updateCounts","computeGroups","originalOptions","filterEngine","filtersWithoutCurrentType","getFilters","optionsForCounting","newGroupsWithCount","showHideEmpty","showSearch","filter_count","filterType","filter_type","switchContainer","switchLabel","searchInput","flexBasis","flexShrink","hideEmpty","setHideEmpty","searchValue","setSearchValue","filteredGroups","useMemo","Switch","computeMetricPrefixGroups","rawPrefixesMap","parts","prefixesMap","from","computeMetricSuffixGroups","rawSuffixesMap","suffixesMap","isRecordingRule","computeRulesGroups","rulesMap","MetricsDrilldownDataSourceVariable","getCurrentDataSource","prometheusDataSources","datasources","uidFromUrl","uidFromLocalStorage","currentDataSource","isDefault","initialDS","genBookmarkKey","urlValues","actionView","filterUrlValues","truncateValue","maxLength","substring","BookmarkListItem","props","onSelect","onDelete","bookmark","createdAt","filtersFromUrl","getFiltersFromUrl","heading","getMetricName","cardHeightClassName","compactHeight","cardTall","cardClassName","card","wide","cardWide","article","Card","Heading","metricValue","Meta","secondaryFont","primaryFont","deleteButton","SecondaryActions","date","dateTimeFormat","wordBreak","borderTop","borderRight","borderLeft","flexWrap","gridArea","letterSpacing","bottom","BookmarksList","bookmarksList","paddingRight","emptyState","LabelsList","selectedLabel","onSelectLabel","onClearSelection","listHeader","selected","list","RadioButtonList","flex","bookmarks","gotoBookmark","removeBookmark","allBookmarks","setAllBookmarks","bookmarksFromStorage","dsValue","addBookmark","newBookmark","sceneUtils","bookmarksForStorage","bookmarkKey","useBookmarks","LabelsBrowser","selectLabel","useLabelsBrowser","labelsVariable","labelsList","onInputChange","onInputKeyDown","onInputClear","Settings","CustomIcons","rect","x","y","rx","SideBarButton","ariaLabel","visible","iconOrText","buttonIcon","ButtonChild","availableIconsIndex","button","metricFiltersVariables","SideBar","cleanupOtherMetricsVar","initOtherMetricsVar","sectionValues","newSectionValues","setOtherMetricFilters","visibleSection","setActiveSection","otherMetricFiltersVar","varToTextMap","keyLabel","hideLabel","currentVariableSet","readOnly","getSectionValuesFromUrl","urlSearchParams","filterKey","filterValueFromUrl","sectionKey","sections","section","buttonsBar","boxSizing","borderTopLeftRadius","borderBottomLeftRadius","buttonContainer","transition","selectedBorder","visibility","closeButton","labelsVariableValue","isActive","groupByValue","updateBasedOnGroupBy","hasGroupByValue","initVariablesFilteringAndSorting","sortEngine","quickSearch","filterSections","findAllObjects","sortByVariable","filterSection","listControls","sidebar","useChromeHeaderHeight","chromeHeaderHeight","APP_HEADER_HEIGHT","getMetricType","metricType","getMetricTypeSync","isAgeMetric","DEFAULT_TIMESERIES_AGE_PRESETS","DEFAULT_HISTOGRAMS_PRESETS","DEFAULT_STATUS_UP_DOWN_PRESETS","DEFAULT_TIMESERIES_PRESETS","DEFAULT_TIMESERIES_RATE_PRESETS","getConfigPresetsForMetric","EventApplyPanelConfig","EventCancelConfigurePanel","AVAILABLE_PERCENTILES_OPTIONS","WithConfigPanelOptions","initPercentilesParams","show","presetId","isSelected","onTogglePercentile","newQueryConfig","Number","checkedOptions","onClickPreset","bodyAndParams","paramsContainer","param","radioContainer","htmlFor","ConfigurePanelForm","syncTimeRange","buildBody","metricScene","DataTrail","timeZone","presets","selectedPresetId","onSelectPreset","restoreDefault","userPrefForMetric","getPanelConfigFromPreset","preset","omit","$timeRange","SceneTimeRange","controls","SceneTimePicker","SceneRefreshPicker","isConfirmModalOpen","onClickRestoreDefault","onClickConfirmRestoreDefault","defaultPreset","closeConfirmModal","onClickCancel","onClickApplyConfig","presetPanel","presetWithQueryParams","controlsContainer","messageContainer","formButtonsContainer","control","ConfirmModal","confirmText","onConfirm","onDismiss","PluginLogo","memo","img","logo","src","pluginCommitSha","pluginCommitURL","buildInfo","grafanaBuildInfo","InfoMenuHeader","updated","usePluginContext","menuHeader","h5","InfoMenu","isDev","shortCommitSha","promBuildInfo","setPromBuildInfo","header","Divider","edition","env","commit","revision","PluginInfo","UI_TEXT","OPEN_EXPLORE_LABEL","COPY_URL_LABEL","BOOKMARK_LABEL","SELECT_NEW_METRIC_TOOLTIP","SelectNewMetricButton","onSelectNewMetric","embedded","LinkButton","createAppUrl","getUrlForTrail","ToolbarButton","EventForceSyncYAxis","EventResetSyncYAxis","EventTimeseriesDataReceived","syncYAxis","vizPanelsParent","NEGATIVE_INFINITY","POSITIVE_INFINITY","timeRangeSub","resetSub","forceSub","newMax","newMin","nonSyncedPanels","findTimeseriesPanels","t","fieldConfig","defaults","findNewMaxMin","updateTimeseriesAxis","dataReceivedSub","panelKey","VizPanel","defineProperty","configurable","enumerable","writable","clearFieldConfigCache","merge","DEFAULT_ALL_OPTION","COMBOBOX_PLACEHOLDER","GroupBySelector","processedOptions","Combobox","noOp","combobox","isClearable","GroupByVariable","filterOptions","defaultToAll","getAppBackgroundColor","isLight","ignore","next","Field","addCardinalityInfo","originalTitle","dataSub","ctaText","publishTimeseriesData","getData","SelectLabelAction","groupByVariable","BookmarkHeaderAction","isCurrentStateBookmarked","currentKey","isBookmarked","currentUrlState","isCurrentlyBookmarked","updatedBookmarks","actualBookmarkState","bookmarkButton","GmdVizPanelVariantSelector","currentPanelType","newPanelType","MAIN_PANEL_MIN_HEIGHT","XL","TOPVIEW_PANEL_MENU_KEY","MetricGraphScene","gmdVizPanel","topView","minHeight","PanelMenu","selectedTab","actionBar","MetricActionBar","headerHeight","flexGrow","tabContent","stickyTop","paddingTop","nonSticky","useRef","useResizeObserver","ref","onResize","requestAnimationFrame","getBoundingClientRect","document","documentElement","setProperty","updateActionBarHeight","CopyUrlAction","create","iconClassName","navigator","clipboard","appUrl","PLUGIN_BASE_URL","writeText","ExploreAction","panelMenuInstance","exploreUrl","viz","panelData","getExploreURL","shortcut","extensionPointId","AddToExplorationButton","getPanelConfigAndDataFrames","findObjectOfType","getQueries","getContext","dsUid","findObject","getFilter","updateFieldConfigOverrides","properties","existingOverride","overrides","displayNameFromDS","fieldName","ctx","origin","logoPath","MimirLogo","drillDownLabel","links","usePluginLinks","limitPerPlugin","filterNameAndValueObj","InvestigationAction","addToExplorationsButton","explorationsButton","addExplorationsLink","activate","getInvestigationLink","items","addToExplorations","getPluginLinkExtensions","extensions","getObservablePluginLinks","firstValueFrom","addItem","setItems","VizPanelMenu","investigationItems","MetricLabelsList","actionsLookup","syncStateFromSearchParams","Controls","labelIndex","AddToFiltersGraphAction","addFilterWithoutReportingInteraction","SortBySelector","sortByTooltip","SceneByFrameRepeater","Loading","filteredSeries","filterAndSort","initFilterAndSort","getCounts","dataProvider","LabelValuesCountsProvider","byFrameRepeater","MetricLabelValuesList","subscribeToQuickSearchChange","subscribeToSortByChange","sortBySelector","updateBody","SINGLE","buildSinglePanel","existingByFrameRepeater","buildByFrameRepeater","prefMetricConfig","errors","frameIndex","canAddToFilters","quickSearchField","GRID","singlePanelContainer","listContainer","listFooter","SingleMetricPanelComponent","ByFrameRepeaterComponent","LabelBreakdownScene","getVariable","oldState","enableScopesInMetricsExplore","stickyControls","searchField","METRIC_PREFIX_ALL_OPTION","PrefixFilterDropdown","metricPrefix","parseMetricPrefixes","prefixGroups","newOptions","selectOption","tooltipIcon","InlineField","InlineLabel","RelatedListControls","RelatedMetricsScene","searchSticky","actionViews","actionViewsDefinitions","getScene","createRelatedLogsScene","actions","breakpoints","up","md","customTabsBar","MetricScene","Box","paddingY","Stack","TabsBar","tab","counter","relatedLogsCount","tabRender","Tab","onChangeTab","view","related_logs_count","relatedLogsOrchestrator","checkConditionsMetForRelatedLogs","setActionView","knownLabelNameDiscrepancies","job","instance","replaceKnownLabelNames","createLabelsCrossReferenceConnector","scene","conditionsMetForRelatedLogs","getDataSources","lokiDataSources","getDataSourceFetcher","getHealthyDataSources","results","hasLabels","labelKeys","availableLabels","lokiLabelName","hasMatchingLabels","getLokiQueryExpr","getLokiQueryForRelatedMetric","dataSourceUid","extractedRecordingRules","targetRule","hasMetricExpr","tree","parser","iterate","enter","MetricExpr","isLogsQuery","selectorNode","getNodeFromQuery","Selector","selector","pipelineExprNode","PipelineExpr","pipelineExpr","getLogQueryFromMetricsQuery","fetchAndExtractLokiRecordingRules","dataSource","extractedRules","ruleGroups","rg","rules","existingRule","hasMultipleOccurrences","extractRecordingRulesFromRuleGroups","datasourceSettings","recordingRules","res","lastValueFrom","fetch","ok","createLokiRecordingRulesConnector","lokiRecordingRules","selectedMetric","foundLokiDataSources","recRules","rr","getDataSourcesWithRecordingRulesContainingMetric","nodeType","foundNode","node","RelatedLogsOrchestrator","_internalState","dataSources","currentDataSourcesSignature","newDataSourcesSignature","_changeHandlers","handler","addLokiDataSourcesChangeHandler","addRelatedLogsCountChangeHandler","findAndCheckAllDatasources","allLokiDatasources","_dataSourceFetcher","checkLogsInDataSources","maxLines","_metricScene","queriesByConnector","_logsConnectors","connector","idx","lokiExpr","connectorName","supportingQueryType","datasourcesWithLogs","totalLogsCount","totalChecked","getLokiQueries","rowCount","countLogsLines","NoRelatedLogs","Text","external","OpenInLogsDrilldownButton","memoizedContext","isLoading","logsDrilldownLink","logsDrilldownLinkExists","appSubUrl","LOGS_PANEL_CONTAINER_KEY","RelatedLogsScene","orchestrator","setupLogsPanel","showNoLogsFound","_buildQueryRunner","_queryRunner","_constructLogsDrilldownLinkContext","logs","logsDataSourceVariable","updateLokiQuery","logsDrilldownLinkContext","selectedDatasourceVar","selectedDatasourceUid","handleFiltersChange","grow","actionViewDef","actionViewType","ConstantVariable","updateStateForNewMetric","registerRuntimeDataSource","registerRuntimeDataSources","setTimeout","datasourceHelper","handleMetricSelectedEvent","initFilters","initConfigPrometheusFunction","topScene","baseControls","SceneControlsSpacer","limitAdhocProviders","useQueriesAsFilterForOptions","disableReportFiltersInteraction","drawer","configId","objectsWithBehavior","__name__","resetYAxisSync","panelsToUpdate","filteredMetrics","updatedMetrics","addRecentMetric","filterVar","getBaseFiltersForMetric","performBrowserHistoryAction","urlState","urlUtil","renderUrl","getVariableSet","initialFilters","getTime","dashboardMetrics","alertingMetrics","addFilterButtonText","dontHide","scopeFilters","ScopesVariable","enable","navbarFixed","settingsInfo","updateAppControlsHeight","appControls","querySelector","resizeObserver","ResizeObserver","observe","disconnect","removeProperty","UrlSyncContextProvider","createBrowserHistorySteps","updateUrlOnInit","namespace","urlNamespace","getClosestScopesFacade","ScopesFacade","getSelectedScopes","selectedScopes","getSelectedScopesNames","scope","setSelectedScopes","scopes","notifySubscribers","onScopesChange","callback","onScopesChangeCallbacks","cb","visTheme","theme2","visualization","getColorByName","palette","flatMap","sqr","MAX_ADHOC_VARIABLE_OPTIONS","limitedFilterVariable","getTagKeysProvider","opts","getTagValuesProvider","_","check","returnType","obj"],"sourceRoot":""}